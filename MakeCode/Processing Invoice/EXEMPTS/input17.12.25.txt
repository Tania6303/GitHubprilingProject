[
    {
        "input": [
            {
                "name": "learned_config",
                "value": {
                    "status": "success",
                    "supplier_id": "3710",
                    "supplier_name": "×“×¨×™×Ÿ ×˜×¨×’×œ ×•×©×•×ª`",
                    "vendor_tax_id_reference": "557149143",
                    "supplier_phone": "073-2400700",
                    "supplier_email": "",
                    "json_files_analyzed": 10,
                    "templates_detected": 1,
                    "templates_scanned": 1,
                    "templates_not_scanned": 0,
                    "supplier_config": {
                        "supplier_code": "3710",
                        "supplier_name": "×“×¨×™×Ÿ ×˜×¨×’×œ ×•×©×•×ª`",
                        "vendor_tax_id_reference": "557149143"
                    },
                    "rules": {
                        "invoice_date_format": "DD/MM/YY",
                        "doc_variation": ""
                    },
                    "validation": {
                        "TOTQUANT": 1
                    },
                    "critical_patterns": {
                        "vehicle_rules": {},
                        "partname_rules": {
                            "zzz02": {
                                "accnames": [
                                    "49998",
                                    "49902"
                                ],
                                "has_pdaccname": false,
                                "sample_description": "×“×•×— ×œ×©× ×ª 2024 ×—×œ×§ 2"
                            }
                        }
                    },
                    "templates": [
                        {
                            "template_index": 0,
                            "document_type": {
                                "type": "×—×©×‘×•× ×™×ª ×¨×’×™×œ×” ×¢× ×¤×™×¨×•×˜",
                                "accnames": [
                                    "49998",
                                    "49902"
                                ]
                            },
                            "structure": {
                                "has_import": false,
                                "has_purchase_orders": false,
                                "has_doc": false,
                                "has_date_range": false,
                                "has_budcode": false,
                                "has_pdaccname": false,
                                "inventory_management": "not_managed_inventory",
                                "debit_type": "D"
                            },
                            "template": {
                                "SUPNAME": "3710",
                                "CODE": "×©\"×—",
                                "DEBIT": "D",
                                "IVDATE": "29/11/25",
                                "BOOKNUM": "053472",
                                "DETAILS": "×“×•×— ×œ×©× ×ª 2024 ×—×œ×§ 2",
                                "PINVOICEITEMS_SUBFORM": [
                                    {
                                        "PARTNAME": "zzz02",
                                        "PDES": "×“×•×— ×œ×©× ×ª 2024 ×—×œ×§ 2",
                                        "TQUANT": 1,
                                        "TUNITNAME": "×™×—'",
                                        "PRICE": 22500,
                                        "VATFLAG": "Y",
                                        "ACCNAME": "49998"
                                    },
                                    {
                                        "PARTNAME": "zzz02",
                                        "PDES": "×¨×‘×¢×•×Ÿ 3 ×œ×©× ×ª 2025",
                                        "TQUANT": 1,
                                        "TUNITNAME": "×™×—'",
                                        "PRICE": 20000,
                                        "VATFLAG": "Y",
                                        "ACCNAME": "49902"
                                    }
                                ]
                            },
                            "sample": {
                                "IV": 1348583,
                                "VAT": 1350,
                                "CODE": "×©\"×—",
                                "DIFF": 7500,
                                "DEBIT": "D",
                                "FINAL": "Y",
                                "IVNUM": "25067090",
                                "FNCNUM": "25102571",
                                "IVDATE": "2025-09-11T00:00:00+03:00",
                                "IVTYPE": "P",
                                "QPRICE": 7500,
                                "SUPDES": "×“×¨×™×Ÿ ×˜×¨×’×œ ×•×©×•×ª`",
                                "BOOKNUM": "052785",
                                "DETAILS": "×“×¨×™×Ÿ 8/25",
                                "PAYDATE": "2025-09-11T00:00:00+03:00",
                                "STATDES": "×¡×•×¤×™×ª",
                                "SUPNAME": "3710",
                                "DISPRICE": 7500,
                                "TOTPRICE": 8850,
                                "TOTQUANT": 1,
                                "TYPEDDATE": "2025-09-17T00:00:00+03:00",
                                "OWNERLOGIN": "××•×¨× ×”",
                                "EXTFILEFLAG": "Y",
                                "TYPEDBYLOGIN": "××•×¨× ×”",
                                "PINVOICEITEMS_SUBFORM": [
                                    {
                                        "PARTNAME": "zzz02",
                                        "PDES": "×ª×œ×•×©×™ ×©×›×¨",
                                        "TQUANT": 1,
                                        "TUNITNAME": "×™×—'",
                                        "QUANT": 1,
                                        "UNITNAME": "×™×—'",
                                        "PRICE": 7500,
                                        "ICODE": "×©\"×—",
                                        "PRSOURCENAME": "×™×“× ×™",
                                        "QPRICE": 7500,
                                        "TOTPRICE": 8850,
                                        "CODE": "×©\"×—",
                                        "VATFLAG": "Y",
                                        "BARCODE": "zzz02",
                                        "ACCNAME": "49902",
                                        "ACCDES": "×”×•×¦××•×ª ×œ×©×œ×",
                                        "EXCH": 1,
                                        "USERLOGIN": "××•×¨× ×”",
                                        "UDATE": "2025-09-17T14:59:00+03:00",
                                        "KLINE": 1
                                    }
                                ],
                                "PINVOICESCONT_SUBFORM": [
                                    {
                                        "ADRS": "×”××œ××›×” 8 ××™×–×•×¨ ×ª×¢×©×™×” ×—×“×©",
                                        "STATE": "× ×ª× ×™×”",
                                        "COUNTRYNAME": "Israel",
                                        "ZIP": "42296",
                                        "PHONE": "073-2400700",
                                        "FAX": "8628554",
                                        "PAYCODE": "00",
                                        "PAYDES": "××–×•××Ÿ",
                                        "FNCPATNAME": "×—×¡×",
                                        "FNCPATDES2": "×—×©×‘×•× ×™×ª ×¡×¤×§ ××¨×›×–×ª",
                                        "TAXCODE": "002",
                                        "IVREF": "557149143",
                                        "USERLOGIN": "×—×Ÿ",
                                        "UDATE": "2025-09-30T09:50:00+03:00",
                                        "DEBIT": "D",
                                        "IVNUM": "25067090"
                                    }
                                ]
                            },
                            "docs": {
                                "list_of_docs": null,
                                "DOC_YES_NO": "N"
                            },
                            "imfp": {},
                            "azuretext": "×“×¨×™×Ÿ, ×˜×¨×’×œ ×•×©×•×ª' - ×¨×•××™ ×—×©×‘×•×Ÿ\n×¨×—×³ ×”××œ××›×” 8 ×ª.×“. 8642 ×.×ª. ×¤×•×œ×’ × ×ª× ×™×”\n×˜×œ×¤×•×Ÿ: 073-2400700 ×¤×§×¡: 09-8628554\n×¢×•×¡×§ ××•×¨×©×” 557149143\n×—×©×‘×•× ×™×ª ××¡ / ×§×‘×œ×” ××¡×¤×¨ 052785\n××¡××š ×××•×—×©×‘\n×œ×›×‘×•×“:\n××§×•×¨\n×˜.×¤.×™ ×¤×œ ×™× ×‘×¢×´×\n×”×§×˜×™×£ 11 ×¤××¨×§ ×ª×¢×©×™×•×ª\n×ª××¨×™×š ××¡××š: 11/09/2025\n×¢××§ ×—×¤×¨ 3877701\n××¡×¤×¨ ×œ×§×•×—: 260\naccount@t-p-y.co.il\n×. ×¢×•×¡×§ ×œ×§×•×—: 513327064\n×¤×¨×˜×™ ×”×—×©×‘×•× ×™×ª\n×ª××•×¨\n×›××•×ª\n××—×™×¨ ×‘ $\n××—×™×¨ ×‘×©×´×— ××—×•×– ×”× ×—×”\n×¡×”×´×› ×‘×©×´×—\n2025 ×¨×™×˜×™×™× ×¨ ××•×’×•×¡×˜\n1\n0.00\n7,500.00\n7,500.00\n×”× ×—×”/×ª×•×¡×¤×ª ×¢×™×’×•×œ\n0.00\n×¡×”×´×› ×œ×¤× ×™ ××¢×´×\n7,500.00\n% 18 ××¢×´×\n1,350.00\n×¡×”×´×› ×›×•×œ×œ ××¢×´×\n8,850.00\n×¤×¨×˜×™ ×”×ª×§×‘×•×œ×™×\n××•×¤×Ÿ ×ª×©×œ×•×\n××¡×¤×¨\n×‘× ×§\n×¡× ×™×£ ×—×©×‘×•×Ÿ\n×ª××¨×™×š ×¤×¨×¢×•×Ÿ\n×¡×›×•×\n×”×¢×‘×¨×”\n10\n744\n2230018\n10/09/2025\n8,850.00\n× ×™×›×•×™ ××¡ ×‘××§×•×¨\n×¡×”×´×› ×©×©×•×œ×\n8,850.00\n×”×•×¤×§ ×¢×´×™ ××©×¤×™×ª ×©×œ ×˜.×.×œ ×‘×ª××¨×™×š 11/09/2025 ×‘×©×¢×” 14:16:53 ×¢×¤×´×™ ×ª×¢×•×“×ª ×¨×™×©×•× (××´×”) ××¡×¤×¨ 97509\n××¡××š ×–×” × ×—×ª× ×‘×—×ª×™××” ×“×™×’×™×˜×œ×™×ª ×××•×‘×˜×—×ª",
                            "AZURE_RESULT": {
                                "structure": {
                                    "docType": "string",
                                    "fields": {
                                        "AmountDue_amount": "number",
                                        "AmountDue_currency": "string",
                                        "CustomerAddress": "string",
                                        "CustomerAddress_houseNumber": "string",
                                        "CustomerAddress_road": "string",
                                        "CustomerAddress_streetAddress": "string",
                                        "CustomerAddress_house": "string",
                                        "CustomerAddressRecipient": "string",
                                        "CustomerName": "string",
                                        "CustomerTaxId": "string",
                                        "InvoiceDate": "YYYY-MM-DD",
                                        "InvoiceId": "string",
                                        "InvoiceTotal_amount": "number",
                                        "InvoiceTotal_currency": "string",
                                        "SubTotal_amount": "number",
                                        "SubTotal_currency": "string",
                                        "TotalDiscount_amount": "number",
                                        "TotalDiscount_currency": "string",
                                        "TotalTax_amount": "number",
                                        "TotalTax_currency": "string",
                                        "VendorAddress": "string",
                                        "VendorAddress_houseNumber": "string",
                                        "VendorAddress_road": "string",
                                        "VendorAddress_poBox": "string",
                                        "VendorAddress_city": "string",
                                        "VendorAddress_streetAddress": "string",
                                        "VendorAddress_house": "string",
                                        "VendorAddressRecipient": "string",
                                        "VendorName": "string",
                                        "VendorTaxId": "string",
                                        "VendorTel": "string",
                                        "VendorFax": "string",
                                        "InvoiceTime": "HH:MM:SS",
                                        "DueDate": "YYYY-MM-DD",
                                        "CustomerEmail": "string",
                                        "UnidentifiedNumbers": [
                                            "object"
                                        ]
                                    },
                                    "Items": [
                                        {
                                            "TotalPrice": {
                                                "type": "number",
                                                "originalHeader": "×¡×›×•×"
                                            },
                                            "UnknownColumn_1": {
                                                "type": "string",
                                                "originalHeader": "×ª××¨×™×š ×¤×¨×¢×•×Ÿ"
                                            },
                                            "LineNumber": {
                                                "type": "string",
                                                "originalHeader": "×—×©×‘×•×Ÿ"
                                            },
                                            "UnknownColumn_3": {
                                                "type": "number",
                                                "originalHeader": "×¡× ×™×£"
                                            },
                                            "UnknownColumn_4": {
                                                "type": "number",
                                                "originalHeader": "×‘× ×§"
                                            }
                                        }
                                    ]
                                },
                                "data": {
                                    "docType": "invoice",
                                    "fields": {
                                        "AmountDue_amount": 8850,
                                        "AmountDue_currency": "ILS",
                                        "CustomerAddress": "×”×§×˜×™×£ 11 ×¤××¨×§ ×ª×¢×©×™×•×ª",
                                        "CustomerAddress_houseNumber": "11",
                                        "CustomerAddress_road": "×”×§×˜×™×£",
                                        "CustomerAddress_streetAddress": "11 ×”×§×˜×™×£",
                                        "CustomerAddress_house": "×¤××¨×§ ×ª×¢×©×™×•×ª",
                                        "CustomerAddressRecipient": "×˜.×¤.×™ ×¤×œ ×™× ×‘×¢×´×",
                                        "CustomerName": "×˜.×¤.×™ ×¤×œ ×™× ×‘×¢×´×",
                                        "CustomerTaxId": "513327064",
                                        "InvoiceDate": "2025-09-11",
                                        "InvoiceId": "052785",
                                        "InvoiceTotal_amount": 8850,
                                        "InvoiceTotal_currency": "ILS",
                                        "Items": [
                                            {
                                                "TotalPrice": 8850,
                                                "UnknownColumn_1": "10/09/2025",
                                                "LineNumber": "×”×¢×‘×¨×”",
                                                "UnknownColumn_3": 744,
                                                "UnknownColumn_4": 10
                                            }
                                        ],
                                        "SubTotal_amount": 7500,
                                        "SubTotal_currency": "ILS",
                                        "TotalDiscount_amount": 0,
                                        "TotalDiscount_currency": "ILS",
                                        "TotalTax_amount": 1350,
                                        "TotalTax_currency": "ILS",
                                        "VendorAddress": "×¨×—×³ ×”××œ××›×” 8 ×ª.×“. 8642 ×.×ª. ×¤×•×œ×’ × ×ª× ×™×”",
                                        "VendorAddress_houseNumber": "8",
                                        "VendorAddress_road": "×¨×—×³ ×”××œ××›×”",
                                        "VendorAddress_poBox": "×ª.×“. 8642",
                                        "VendorAddress_city": "× ×ª× ×™×”",
                                        "VendorAddress_streetAddress": "8 ×¨×—×³ ×”××œ××›×” ×ª.×“. 8642",
                                        "VendorAddress_house": "×.×ª. ×¤×•×œ×’",
                                        "VendorAddressRecipient": "×“×¨×™×Ÿ, ×˜×¨×’×œ ×•×©×•×ª' - ×¨×•××™ ×—×©×‘×•×Ÿ",
                                        "VendorName": "×“×¨×™×Ÿ, ×˜×¨×’×œ ×•×©×•×ª' - ×¨×•××™ ×—×©×‘×•×Ÿ",
                                        "VendorTaxId": "557149143",
                                        "VendorTel": "073-2400700",
                                        "VendorFax": "09-8628554",
                                        "InvoiceTime": "14:16:53",
                                        "DueDate": "2025-09-10",
                                        "CustomerEmail": "account@t-p-y.co.il",
                                        "UnidentifiedNumbers": [
                                            {
                                                "label": "×˜×œ×¤×•×Ÿ",
                                                "value": "073-2400700 ×¤×§×¡: 09-8628554"
                                            },
                                            {
                                                "label": "×¢××§ ×—×¤×¨",
                                                "value": 3877701
                                            },
                                            {
                                                "label": "××¡×¤×¨ ×œ×§×•×—",
                                                "value": 260
                                            },
                                            {
                                                "label": "××¡×¤×¨",
                                                "value": "2230018"
                                            }
                                        ]
                                    }
                                },
                                "metadata": {
                                    "modelId": "",
                                    "totalFields": 37,
                                    "uniqueDataFound": 4,
                                    "pageCount": 1
                                },
                                "status": "success"
                            },
                            "scan_status": "scanned"
                        }
                    ],
                    "merge_metadata": {
                        "merge_timestamp": "2025-12-16T09:28:04.070Z",
                        "source_templates_count": 1,
                        "aggregated_items_count": 1,
                        "matched_count": 1,
                        "unmatched_template_indexes": []
                    }
                }
            }
        ],
        "language": "javascript",
        "inputFormat": "string",
        "dependencies": [],
        "codeStringJavascript": "// ============================================================================\n// ×§×•×“ 2 - ×¢×™×‘×•×“ ×—×©×‘×•× ×™×•×ª (×’×¨×¡×” 5.1)\n// ×¢×“×›×•×Ÿ ××—×¨×•×Ÿ: 13.12.25 18:00\n//\n// âœ¨ ×©×™× ×•×™ ××‘× ×” ×§×œ×˜: ××§×‘×œ ×§×œ×˜ ×××•×—×“ ×-SupplierDataLearningConfig\n// ×‘××§×•× ×§×œ×˜×™× × ×¤×¨×“×™× (learned_config, docs_list, import_files, AZURE_RESULT)\n//\n// ×ª×™×§×•× ×™×:\n// - 18:00 ×ª××™××•×ª ×œ-v1.7: sample.BOOKNUM ×‘××§×•× sample.sample_booknum\n// - 16:00 ×ª××™×›×” ×‘×¢×˜×™×¤×ª learned_config ×-Make\n// - 15:30 ×ª××™×›×” ×‘×§×œ×˜ ×›××—×¨×•×–×ª JSON (JSON.parse)\n// - 15:00 ×”×’× ×•×ª ×¢×œ AZURE_RESULT null\n// - 14:30 ×œ×•×’×™× ××¤×•×¨×˜×™× ×œ×–×™×”×•×™ ××‘× ×” ×§×œ×˜\n//\n// ××—×–×™×¨: JSON ×œ×¤×¨×™×•×¨×™×˜×™ + ×“×•×— ×‘×™×¦×•×¢ + ×”×’×“×¨×•×ª frontend\n//\n// ğŸ“ ×§×‘×¦×™ ×‘×“×™×§×”: MakeCode/Processing Invoice/EXEMPTS/\n// ============================================================================\n\n// ============================================================================\n// ×¤×•× ×§×¦×™×™×ª ×¢×–×¨ - ×”××¨×ª ×§×œ×˜ ×-Make ×œ××‘× ×” ×”×¦×¤×•×™\n// ============================================================================\n\nfunction normalizeInput(rawInput) {\n    console.log(`ğŸ”„ normalizeInput v5.1 18:00 - rawInput type: ${typeof rawInput}, isArray: ${Array.isArray(rawInput)}`);\n\n    // âœ… ×× ×”×§×œ×˜ ×”×•× ××—×¨×•×–×ª JSON - ×œ×¤×¨×¡×¨ ××•×ª×”\n    if (typeof rawInput === 'string') {\n        console.log(`  ğŸ“ Input is string, parsing JSON...`);\n        try {\n            rawInput = JSON.parse(rawInput);\n            console.log(`  âœ… Successfully parsed JSON string`);\n        } catch (e) {\n            console.log(`  âŒ Failed to parse JSON string: ${e.message}`);\n            return rawInput;\n        }\n    }\n\n    console.log(`ğŸ”„ rawInput keys: ${rawInput ? Object.keys(rawInput).slice(0, 10).join(', ') : 'null'}`);\n\n    // âœ… ×—×“×©! ×× ×™×© learned_config - ×–×” ×¢×˜×™×¤×” ×-Make\n    if (rawInput.learned_config) {\n        console.log(`  ğŸ“¦ Found learned_config wrapper, extracting...`);\n        let learnedConfig = rawInput.learned_config;\n\n        // ×× learned_config ×”×•× ××—×¨×•×–×ª - ×œ×¤×¨×¡×¨\n        if (typeof learnedConfig === 'string') {\n            console.log(`  ğŸ“ learned_config is string, parsing...`);\n            try {\n                learnedConfig = JSON.parse(learnedConfig);\n                console.log(`  âœ… Successfully parsed learned_config`);\n            } catch (e) {\n                console.log(`  âŒ Failed to parse learned_config: ${e.message}`);\n                return rawInput;\n            }\n        }\n\n        // ×× ×™×© logs ×•-result ×‘×ª×•×š - ×œ×—×œ×¥ ××ª result\n        if (learnedConfig.result) {\n            console.log(`  âœ… Found result inside learned_config`);\n            return learnedConfig.result;\n        }\n\n        // ×× ×™×© status ×•-templates ×™×©×™×¨×•×ª - ×–×” ×”×§×œ×˜ ×”× ×›×•×Ÿ\n        if (learnedConfig.status && learnedConfig.templates) {\n            console.log(`  âœ… learned_config has status and templates`);\n            return learnedConfig;\n        }\n\n        return learnedConfig;\n    }\n\n    // ×× ×”×§×œ×˜ ×”×•× ××¢×¨×š ×¢× ×ª×•×¦××” (×¤×•×¨××˜ Make)\n    if (Array.isArray(rawInput)) {\n        console.log(`  ğŸ“¦ Input is array, length=${rawInput.length}`);\n        if (rawInput[0] && rawInput[0].result) {\n            console.log(`  âœ… Found result in array[0]`);\n            return rawInput[0].result;\n        }\n        if (rawInput[0] && rawInput[0].status) {\n            console.log(`  âœ… Found status in array[0], returning as-is`);\n            return rawInput[0];\n        }\n        console.log(`  ğŸ“¦ Array without result/status, taking first element`);\n        return rawInput[0];\n    }\n\n    // ×× ×™×© result ×‘×ª×•×š ×”×§×œ×˜ (×¤×•×¨××˜ Make ×¢× logs)\n    if (rawInput.result) {\n        console.log(`  âœ… Found result property`);\n        return rawInput.result;\n    }\n\n    // ×× ×™×© status ×•-templates - ×–×” ×”×§×œ×˜ ×”× ×›×•×Ÿ\n    if (rawInput.status && rawInput.templates) {\n        console.log(`  âœ… Input has status and templates - correct format`);\n        return rawInput;\n    }\n\n    // × ×¡×” ×œ××¦×•× ××ª ×”××‘× ×” ×”× ×›×•×Ÿ ×¢××•×§ ×™×•×ª×¨\n    if (rawInput.merged_config) {\n        console.log(`  âœ… Found merged_config property`);\n        return rawInput.merged_config;\n    }\n\n    // ××—×¨×ª - ×”×§×œ×˜ ×›××• ×©×”×•×\n    console.log(`  âš ï¸ Input structure unknown, returning as-is`);\n    console.log(`  âš ï¸ Has templates: ${!!rawInput.templates}, Has status: ${!!rawInput.status}`);\n    return rawInput;\n}\n\n// ============================================================================\n// ×¤×•× ×§×¦×™×™×ª ×¢×–×¨ - × ×™×§×•×™ invoice ×œ×¤× ×™ ×©×œ×™×—×” ×œ-Priority\n// ============================================================================\n\nfunction cleanInvoiceForPriority(invoice) {\n    const cleaned = JSON.parse(JSON.stringify(invoice));\n\n    if (cleaned.PINVOICEITEMS_SUBFORM) {\n        cleaned.PINVOICEITEMS_SUBFORM = cleaned.PINVOICEITEMS_SUBFORM.map(item => {\n            delete item.isNewVehicle;\n            delete item._learningNote;\n\n            if (item.SPECIALVATFLAG && item.SPECIALVATFLAG !== \"Y\") {\n                delete item.SPECIALVATFLAG;\n            }\n\n            return item;\n        });\n    }\n\n    return cleaned;\n}\n\n// ============================================================================\n// ×¤×•× ×§×¦×™×” ×¨××©×™×ª - ×¢×™×‘×•×“ ×”×§×œ×˜ ×”×××•×—×“\n// ============================================================================\n\nfunction processUnifiedConfig(mergedConfig) {\n    const executionReport = {\n        stage: \"\",\n        found: [],\n        not_found: [],\n        warnings: [],\n        errors: [],\n        templates_processed: []\n    };\n\n    try {\n        // ============================================================================\n        // ×©×œ×‘ 1: ××™××•×ª ××‘× ×” ×”×§×œ×˜\n        // ============================================================================\n\n        executionReport.stage = \"×©×œ×‘ 1: ××™××•×ª ××‘× ×”\";\n\n        if (!mergedConfig || mergedConfig.status !== 'success') {\n            throw new Error('×§×œ×˜ ×œ× ×ª×§×™×Ÿ - status ×œ× success');\n        }\n\n        if (!mergedConfig.templates || !Array.isArray(mergedConfig.templates)) {\n            throw new Error('×§×œ×˜ ×œ× ×ª×§×™×Ÿ - ××™×Ÿ ××¢×¨×š templates');\n        }\n\n        const scannedTemplates = mergedConfig.templates.filter(t => t.scan_status === 'scanned');\n        const notScannedTemplates = mergedConfig.templates.filter(t => t.scan_status !== 'scanned');\n\n        executionReport.found.push(`×¡×”\"×› ×ª×‘× ×™×•×ª: ${mergedConfig.templates.length}`);\n        executionReport.found.push(`×ª×‘× ×™×•×ª × ×¡×¨×§×•: ${scannedTemplates.length}`);\n\n        if (notScannedTemplates.length > 0) {\n            executionReport.warnings.push(`×ª×‘× ×™×•×ª ×œ× × ×¡×¨×§×•: ${notScannedTemplates.map(t => t.template_index).join(', ')}`);\n        }\n\n        // ============================================================================\n        // ×©×œ×‘ 2: ×¢×™×‘×•×“ ×›×œ ×ª×‘× ×™×ª ×©× ×¡×¨×§×”\n        // ============================================================================\n\n        executionReport.stage = \"×©×œ×‘ 2: ×¢×™×‘×•×“ ×ª×‘× ×™×•×ª\";\n\n        const allResults = [];\n\n        for (const template of scannedTemplates) {\n            console.log(`\\nğŸ”„ ××¢×‘×“ ×ª×‘× ×™×ª ${template.template_index}...`);\n\n            const templateResult = processTemplate(template, mergedConfig, executionReport);\n            allResults.push(templateResult);\n\n            executionReport.templates_processed.push({\n                template_index: template.template_index,\n                document_type: template.document_type?.type || '×œ× ×™×“×•×¢',\n                status: templateResult.status\n            });\n        }\n\n        // ============================================================================\n        // ×©×œ×‘ 3: ×‘× ×™×™×ª ×¤×œ×˜ ×××•×—×“\n        // ============================================================================\n\n        executionReport.stage = \"×©×œ×‘ 3: ×‘× ×™×™×ª ×¤×œ×˜\";\n\n        const supplierCode = mergedConfig.supplier_id;\n        const supplierName = mergedConfig.supplier_name;\n\n        // ×‘× ×™×™×ª all_templates ×¢×‘×•×¨ llm_prompt\n        const llmTemplates = allResults.map(r => {\n            const { supplier_code, supplier_name, ...rest } = r.llm_prompt || {};\n            return {\n                ...rest,\n                invoice_data: r.invoice_data\n            };\n        });\n\n        // ×‘× ×™×™×ª all_templates ×¢×‘×•×¨ technical_config\n        const technicalTemplates = allResults.map(r => {\n            const { supplier_code, supplier_name, ...rest } = r.technical_config || {};\n            return rest;\n        });\n\n        // ×‘× ×™×™×ª all_templates ×¢×‘×•×¨ processing_scenario\n        const processingScenarios = allResults.map(r => r.processing_scenario || {});\n\n        return {\n            status: \"success\",\n\n            // 1. ×”× ×—×™×•×ª ×œ-LLM\n            llm_prompt: {\n                supplier_code: supplierCode,\n                supplier_name: supplierName,\n                all_templates: llmTemplates\n            },\n\n            // 2. ×§×•× ×¤×™×’ ×˜×›× ×™\n            technical_config: {\n                supplier_code: supplierCode,\n                supplier_name: supplierName,\n                all_templates: technicalTemplates\n            },\n\n            // 3. ×¡×¦× ×¨×™×• ×¢×™×‘×•×“\n            processing_scenario: {\n                supplier_code: supplierCode,\n                supplier_name: supplierName,\n                all_templates: processingScenarios\n            },\n\n            // 4. ×“×•×— ×‘×™×¦×•×¢\n            execution_report: executionReport\n        };\n\n    } catch (error) {\n        return {\n            status: \"error\",\n            error_type: error.name || \"ProcessingError\",\n            message: error.message,\n            execution_report: executionReport\n        };\n    }\n}\n\n// ============================================================================\n// ×¢×™×‘×•×“ ×ª×‘× ×™×ª ×‘×•×“×“×ª\n// ============================================================================\n\nfunction processTemplate(template, mergedConfig, executionReport) {\n    console.log(`\\nğŸ“‹ processTemplate - template_index: ${template.template_index}`);\n    console.log(`   scan_status: ${template.scan_status}`);\n    console.log(`   has AZURE_RESULT: ${!!template.AZURE_RESULT}`);\n    console.log(`   has docs: ${!!template.docs}`);\n\n    const structure = template.structure || {};\n    const templateData = template.template || {};\n    const docs = template.docs;\n    const imfp = template.imfp;\n    const azureResult = template.AZURE_RESULT;\n    const azureText = template.azuretext || \"\";\n\n    // ×‘×“×™×§×ª ×ª×§×™× ×•×ª AZURE_RESULT\n    if (!azureResult) {\n        console.log(`   âš ï¸ AZURE_RESULT is null/undefined for template ${template.template_index}`);\n        executionReport.warnings.push(`×ª×‘× ×™×ª ${template.template_index}: ××™×Ÿ ×ª×•×¦××ª Azure`);\n    }\n\n    // ×‘×“×™×§×•×ª ×‘×¡×™×¡×™×•×ª\n    const hasImport = structure.has_import || false;\n    const hasDocs = checkDocsExist(docs);\n    const debitType = structure.debit_type || \"D\";\n\n    executionReport.found.push(`×ª×‘× ×™×ª ${template.template_index}: ×™×‘×•×=${hasImport}, ×ª×¢×•×“×•×ª=${hasDocs}, ×—×™×•×‘/×–×™×›×•×™=${debitType}`);\n\n    // ×—×™×œ×•×¥ ×“×¤×•×¡×™× ×-OCR - ×¢× ×”×’× ×•×ª\n    let ocrFields = {};\n    if (azureResult && azureResult.data && azureResult.data.fields) {\n        ocrFields = azureResult.data.fields;\n    } else if (azureResult && azureResult.fields) {\n        ocrFields = azureResult.fields;\n    }\n    console.log(`   ocrFields keys: ${Object.keys(ocrFields).slice(0, 5).join(', ')}`);\n\n    const documentPatterns = detectDocumentPatterns(ocrFields, azureText);\n\n    // ×—×•×§×™ ×¨×›×‘×™×\n    const vehicleRules = mergedConfig.critical_patterns?.vehicle_rules || null;\n\n    // ×—×™×¤×•×© × ×ª×•× ×™×\n    const searchResults = searchAllData(\n        ocrFields,\n        azureText,\n        template.sample,\n        structure,\n        imfp,\n        docs,\n        vehicleRules\n    );\n\n    // ×‘× ×™×™×ª ×—×©×‘×•× ×™×ª\n    const invoice = buildInvoiceFromTemplate(\n        templateData,\n        structure,\n        mergedConfig,\n        searchResults,\n        ocrFields,\n        docs\n    );\n\n    const cleanedInvoice = cleanInvoiceForPriority(invoice);\n\n    // ×™×¦×™×¨×ª LLM prompt\n    const llmPrompt = generateLLMPrompt(\n        mergedConfig,\n        ocrFields,\n        searchResults,\n        template.template_index,\n        structure,\n        documentPatterns,\n        vehicleRules\n    );\n\n    // ×™×¦×™×¨×ª technical config\n    const technicalConfig = generateTechnicalConfig(\n        mergedConfig,\n        ocrFields,\n        searchResults,\n        template.template_index,\n        structure,\n        documentPatterns,\n        vehicleRules\n    );\n\n    // ×™×¦×™×¨×ª processing scenario\n    const processingScenario = generateProcessingScenario(structure, vehicleRules);\n\n    return {\n        status: \"success\",\n        template_index: template.template_index,\n        invoice_data: { PINVOICES: [cleanedInvoice] },\n        llm_prompt: llmPrompt,\n        technical_config: technicalConfig,\n        processing_scenario: processingScenario\n    };\n}\n\n// ============================================================================\n// ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ - ×‘×“×™×§×•×ª\n// ============================================================================\n\nfunction checkDocsExist(docs) {\n    if (!docs) return false;\n\n    if (docs.DOC_YES_NO === \"Y\") {\n        return docs.list_of_docs && docs.list_of_docs.length > 0;\n    }\n\n    if (docs.list_of_docs && Array.isArray(docs.list_of_docs)) {\n        return docs.list_of_docs.length > 0 && docs.list_of_docs[0] !== \"\";\n    }\n\n    return false;\n}\n\nfunction detectDocumentPatterns(ocrFields, azureText) {\n    const detected = {\n        booknum_found: [],\n        docno_found: [],\n        booknum_pattern: null,\n        docno_pattern: null,\n        guidance: \"\"\n    };\n\n    const unidentified = ocrFields.UnidentifiedNumbers || [];\n\n    if (unidentified.length > 0) {\n        const values = typeof unidentified[0] === 'object'\n            ? unidentified.map(item => item.value).filter(v => v)\n            : unidentified;\n\n        values.forEach(val => {\n            if (/^10\\d{7}$/.test(val)) {\n                detected.booknum_found.push(val);\n            }\n            if (/^25\\d{6}$/.test(val)) {\n                detected.docno_found.push(val);\n            }\n        });\n    }\n\n    if (detected.booknum_found.length === 0 && azureText) {\n        const booknumMatches = azureText.match(/\\b10\\d{7}\\b/g);\n        if (booknumMatches) {\n            detected.booknum_found = [...new Set(booknumMatches)];\n        }\n    }\n\n    if (detected.docno_found.length === 0 && azureText) {\n        const docnoMatches = azureText.match(/\\b25\\d{6}\\b/g);\n        if (docnoMatches) {\n            detected.docno_found = [...new Set(docnoMatches)];\n        }\n    }\n\n    if (detected.booknum_found.length > 0) {\n        const firstBooknum = detected.booknum_found[0];\n        const prefix = firstBooknum.substring(0, 3);\n        detected.booknum_pattern = `\\\\b(${prefix}\\\\d{6})\\\\b`;\n        detected.guidance = `ğŸ” ×–×•×”×ª×” ×ª×‘× ×™×ª BOOKNUM: ${prefix}XXXXXX (${detected.booknum_found.length} ×“×•×’×××•×ª)`;\n    }\n\n    if (detected.docno_found.length > 0) {\n        detected.docno_pattern = `\\\\b(25\\\\d{6})\\\\b`;\n    }\n\n    return detected;\n}\n\n// ============================================================================\n// ×—×™×¤×•×© × ×ª×•× ×™×\n// ============================================================================\n\nfunction searchAllData(ocrFields, azureText, sample, structure, imfp, docs, vehicleRules) {\n    return {\n        booknum: searchBooknum(ocrFields, sample),\n        ivdate: searchIvdate(ocrFields),\n        details: searchDetails(ocrFields, azureText),\n        ordname: structure.has_purchase_orders || structure.has_import ? searchOrdname(ocrFields) : null,\n        impfnum: structure.has_import ? searchImpfnum(ocrFields, imfp) : null,\n        documents: structure.has_doc ? searchDocuments(ocrFields, azureText, docs) : null,\n        vehicles: vehicleRules ? extractVehicles(ocrFields, vehicleRules, azureText) : [],\n        items: ocrFields.Items || []\n    };\n}\n\nfunction searchBooknum(ocrFields, sample) {\n    let booknum = ocrFields.InvoiceId || \"\";\n    booknum = String(booknum).replace(/^SI/i, '');\n\n    // v1.7: sample ×”×•× ××•×‘×™×™×§×˜ ××œ× ×¢× BOOKNUM (×œ× sample_booknum)\n    if (sample && sample.BOOKNUM) {\n        const expectedLength = String(sample.BOOKNUM).length;\n        if (booknum.length > expectedLength) {\n            booknum = booknum.slice(-expectedLength);\n        }\n    }\n\n    return booknum;\n}\n\nfunction searchIvdate(ocrFields) {\n    const isoDate = ocrFields.InvoiceDate;\n    if (!isoDate) return \"\";\n\n    const date = new Date(isoDate);\n    const day = String(date.getDate()).padStart(2, '0');\n    const month = String(date.getMonth() + 1).padStart(2, '0');\n    const year = String(date.getFullYear()).slice(-2);\n\n    return `${day}/${month}/${year}`;\n}\n\nfunction searchDetails(ocrFields, azureText) {\n    if (ocrFields.InvoiceDescription) {\n        return ocrFields.InvoiceDescription;\n    }\n\n    if (azureText) {\n        const lines = azureText.split('\\n').filter(l => l.trim());\n        if (lines.length > 2) {\n            return lines[2].substring(0, 100);\n        }\n    }\n\n    return \"\";\n}\n\nfunction searchOrdname(ocrFields) {\n    const unidentified = ocrFields.UnidentifiedNumbers || [];\n    const ordPattern = /^\\d{10}$/;\n\n    if (unidentified.length > 0) {\n        if (typeof unidentified[0] === 'object' && unidentified[0].value) {\n            const orderItem = unidentified.find(item =>\n                item.label && (\n                    item.label.includes('×”×–×× ×”') ||\n                    item.label.toLowerCase().includes('order')\n                ) && ordPattern.test(item.value)\n            );\n\n            if (orderItem) return orderItem.value;\n\n            const anyOrder = unidentified.find(item => ordPattern.test(item.value));\n            return anyOrder ? anyOrder.value : \"\";\n        } else {\n            const match = unidentified.find(num => ordPattern.test(num));\n            return match || \"\";\n        }\n    }\n\n    return \"\";\n}\n\nfunction searchImpfnum(ocrFields, imfp) {\n    const unidentified = ocrFields.UnidentifiedNumbers || [];\n    const impPattern = /^\\d{2}c\\d{5}$/;\n\n    if (unidentified.length > 0) {\n        if (typeof unidentified[0] === 'object' && unidentified[0].value) {\n            const importItem = unidentified.find(item =>\n                impPattern.test(item.value)\n            );\n            if (importItem) return importItem.value;\n        } else {\n            const match = unidentified.find(num => impPattern.test(num));\n            if (match) return match;\n        }\n    }\n\n    // Fallback: ×—×¤×© ×‘-imfp\n    if (imfp && imfp.IMPFILES && imfp.IMPFILES.length > 0) {\n        try {\n            const parsed = JSON.parse('[' + imfp.IMPFILES[0] + ']');\n            if (parsed.length > 0 && parsed[0].IMPFNUM) {\n                return parsed[0].IMPFNUM;\n            }\n        } catch (e) {}\n    }\n\n    return \"\";\n}\n\nfunction searchDocuments(ocrFields, azureText, docs) {\n    const foundDocs = [];\n\n    if (!docs || !docs.list_of_docs || docs.list_of_docs.length === 0) {\n        return foundDocs;\n    }\n\n    let availableDocs = [];\n    try {\n        availableDocs = docs.list_of_docs.flatMap(d => {\n            if (typeof d === 'string') return JSON.parse(d);\n            return d;\n        });\n    } catch (e) {\n        return foundDocs;\n    }\n\n    const unidentified = ocrFields.UnidentifiedNumbers || [];\n\n    if (unidentified.length > 0) {\n        const values = typeof unidentified[0] === 'object'\n            ? unidentified.map(item => item.value).filter(v => v)\n            : unidentified;\n\n        for (const val of values) {\n            const match = availableDocs.find(doc => doc.BOOKNUM === val);\n            if (match) {\n                foundDocs.push({\n                    DOCNO: match.DOCNO,\n                    BOOKNUM: match.BOOKNUM,\n                    TOTQUANT: match.TOTQUANT || null\n                });\n            }\n        }\n    }\n\n    // Fallback: ×—×¤×© ×‘-azureText\n    if (foundDocs.length === 0 && azureText) {\n        for (const doc of availableDocs) {\n            const pattern = new RegExp('\\\\b' + doc.BOOKNUM + '\\\\b');\n            if (pattern.test(azureText)) {\n                foundDocs.push({\n                    DOCNO: doc.DOCNO,\n                    BOOKNUM: doc.BOOKNUM,\n                    TOTQUANT: doc.TOTQUANT || null\n                });\n            }\n        }\n    }\n\n    return foundDocs;\n}\n\nfunction extractVehicles(ocrFields, vehicleRules, azureText) {\n    if (!vehicleRules || !vehicleRules.vehicle_account_mapping) return [];\n\n    const foundVehicles = [];\n    const vehiclePattern = /\\d{3}-\\d{2}-\\d{3}/;\n    const unidentified = ocrFields.UnidentifiedNumbers || [];\n\n    unidentified.forEach(item => {\n        const value = typeof item === 'object' ? item.value : item;\n        const label = typeof item === 'object' ? (item.label || '') : '';\n        const context = typeof item === 'object' ? (item.context || '') : '';\n\n        const isValidVehicleNumber = vehiclePattern.test(value);\n        const looksLikeCardNumber = context.includes('×›×¨×˜×™×¡') || label.includes('×›×¨×˜×™×¡');\n\n        if (isValidVehicleNumber && !looksLikeCardNumber && !foundVehicles.includes(value)) {\n            foundVehicles.push(value);\n        }\n    });\n\n    // Fallback: ×—×¤×© ×‘-azureText\n    if (foundVehicles.length === 0 && azureText) {\n        const matches = azureText.match(/\\d{3}-\\d{2}-\\d{3}/g) || [];\n        matches.forEach(match => {\n            if (!foundVehicles.includes(match)) {\n                const contextStart = Math.max(0, azureText.indexOf(match) - 20);\n                const contextEnd = Math.min(azureText.length, azureText.indexOf(match) + match.length + 20);\n                const context = azureText.substring(contextStart, contextEnd);\n\n                if (!context.includes('×›×¨×˜×™×¡')) {\n                    foundVehicles.push(match);\n                }\n            }\n        });\n    }\n\n    return [...new Set(foundVehicles)];\n}\n\n// ============================================================================\n// ×‘× ×™×™×ª ×—×©×‘×•× ×™×ª\n// ============================================================================\n\nfunction buildInvoiceFromTemplate(templateData, structure, mergedConfig, searchResults, ocrFields, docs) {\n    const invoice = {\n        SUPNAME: mergedConfig.supplier_id,\n        CODE: templateData.CODE || \"×©\\\"×—\",\n        DEBIT: structure.debit_type,\n        IVDATE: searchResults.ivdate,\n        BOOKNUM: searchResults.booknum\n    };\n\n    if (searchResults.ordname) {\n        invoice.ORDNAME = searchResults.ordname;\n    }\n\n    if (searchResults.impfnum) {\n        invoice.IMPFNUM = searchResults.impfnum;\n    }\n\n    if (searchResults.details) {\n        invoice.DETAILS = searchResults.details;\n    }\n\n    // ×ª×¢×•×“×•×ª\n    if (structure.has_doc && searchResults.documents && searchResults.documents.length > 0) {\n        if (searchResults.documents.length === 1) {\n            invoice.DOCNO = searchResults.documents[0].DOCNO;\n        } else {\n            invoice.PIVDOC_SUBFORM = searchResults.documents.map(d => ({\n                DOCNO: d.DOCNO,\n                BOOKNUM: d.BOOKNUM\n            }));\n        }\n    }\n\n    // ×¤×¨×™×˜×™×\n    if (!structure.has_doc || !searchResults.documents || searchResults.documents.length === 0) {\n        const vehicleRules = mergedConfig.critical_patterns?.vehicle_rules;\n\n        if (searchResults.vehicles && searchResults.vehicles.length > 0 && vehicleRules) {\n            invoice.PINVOICEITEMS_SUBFORM = createVehicleItems(\n                searchResults.vehicles,\n                searchResults.items,\n                vehicleRules,\n                ocrFields\n            );\n        } else if (searchResults.items && searchResults.items.length > 0) {\n            invoice.PINVOICEITEMS_SUBFORM = buildItems(\n                searchResults.items,\n                templateData\n            );\n        }\n    }\n\n    if (templateData.PINVOICESCONT_SUBFORM) {\n        invoice.PINVOICESCONT_SUBFORM = templateData.PINVOICESCONT_SUBFORM;\n    }\n\n    return invoice;\n}\n\nfunction createVehicleItems(vehicles, ocrItems, vehicleRules, ocrFields) {\n    const vehicleItems = [];\n\n    const totalPrice = ocrFields.TotalTax_amount\n        ? (ocrFields.InvoiceTotal_amount || 0) - ocrFields.TotalTax_amount\n        : (ocrFields.SubTotal_amount || ocrFields.InvoiceTotal_amount || 0);\n    const pricePerVehicle = vehicles.length > 0 ? totalPrice / vehicles.length : totalPrice;\n\n    vehicles.forEach(vehicleNum => {\n        const mapping = vehicleRules.vehicle_account_mapping?.[vehicleNum];\n\n        const item = {\n            PARTNAME: \"car\",\n            PDES: extractShortDescription(ocrFields, vehicleNum),\n            TQUANT: 1,\n            TUNITNAME: \"×™×—'\",\n            PRICE: pricePerVehicle,\n            VATFLAG: mapping?.vat_pattern?.VATFLAG || \"Y\",\n            ACCNAME: mapping?.accname || \"\"\n        };\n\n        if (mapping?.vat_pattern?.SPECIALVATFLAG === \"Y\") {\n            item.SPECIALVATFLAG = \"Y\";\n        }\n\n        vehicleItems.push(item);\n    });\n\n    return vehicleItems;\n}\n\nfunction extractShortDescription(ocrFields, vehicleNum) {\n    if (ocrFields.Items && ocrFields.Items.length > 0) {\n        const item = ocrFields.Items.find(i =>\n            i.Description && (\n                i.Description.includes(vehicleNum) ||\n                i.Description.includes('×˜×™×¤×•×œ') ||\n                i.Description.includes('×¢×‘×•×“×”')\n            )\n        );\n\n        if (item && item.Description) {\n            const desc = item.Description.trim();\n            const servicePattern = /×˜×™×¤×•×œ\\s+[\\d,]+\\s*×§[×´\"]?×/i;\n            const match = desc.match(servicePattern);\n\n            if (match) {\n                return match[0].replace(/,/g, '').replace(/×§×/g, '×§\"×').replace(/×§×´×/g, '×§\"×');\n            }\n\n            const words = desc.split(/\\s+/);\n            let shortDesc = words.slice(0, 4).join(' ');\n            if (shortDesc.length > 50) {\n                shortDesc = shortDesc.substring(0, 47) + '...';\n            }\n            return shortDesc;\n        }\n    }\n\n    return '×˜×™×¤×•×œ';\n}\n\nfunction buildItems(ocrItems, templateData) {\n    const templateItem = templateData.PINVOICEITEMS_SUBFORM?.[0] || {};\n\n    return ocrItems.map(ocrItem => {\n        const item = {\n            PARTNAME: templateItem.PARTNAME || \"\",\n            TUNITNAME: templateItem.TUNITNAME || \"×™×—'\",\n            VATFLAG: templateItem.VATFLAG || \"Y\",\n            ACCNAME: templateItem.ACCNAME || \"\",\n            PDES: ocrItem.Description || \"\",\n            TQUANT: ocrItem.Quantity || 1,\n            PRICE: ocrItem.UnitPrice || ocrItem.UnitPrice_amount || 0\n        };\n\n        if (templateItem.SPECIALVATFLAG === \"Y\") {\n            item.SPECIALVATFLAG = \"Y\";\n        }\n\n        return item;\n    });\n}\n\n// ============================================================================\n// ×™×¦×™×¨×ª ×¤×œ×˜×™×\n// ============================================================================\n\nfunction generateLLMPrompt(mergedConfig, ocrFields, searchResults, templateIndex, structure, documentPatterns, vehicleRules) {\n    const fieldInstructions = {};\n\n    fieldInstructions.booknum = {\n        field_name: \"BOOKNUM\",\n        description: \"××¡×¤×¨ ×—×©×‘×•× ×™×ª\",\n        how_to_find: \"×—×¤×© ×‘×©×“×” InvoiceId ×‘-OCR\",\n        example: searchResults.booknum || \"\"\n    };\n\n    fieldInstructions.ivdate = {\n        field_name: \"IVDATE\",\n        description: \"×ª××¨×™×š ×—×©×‘×•× ×™×ª\",\n        how_to_find: \"×§×— ××ª InvoiceDate ×•×”××¨ ×œ-DD/MM/YY\",\n        example: searchResults.ivdate || \"\"\n    };\n\n    fieldInstructions.price = {\n        field_name: \"PRICE\",\n        description: \"××—×™×¨ ×œ×¤× ×™ ××¢\\\"×\",\n        how_to_calculate: \"InvoiceTotal_amount - TotalTax_amount\"\n    };\n\n    if (vehicleRules && vehicleRules.vehicle_account_mapping) {\n        fieldInstructions.vehicles = {\n            field_name: \"VEHICLES\",\n            description: \"××¡×¤×¨×™ ×¨×›×‘×™×\",\n            pattern: \"\\\\d{3}-\\\\d{2}-\\\\d{3}\",\n            example: searchResults.vehicles?.join(', ') || \"\"\n        };\n    }\n\n    let documentType = determineDocumentType(structure, vehicleRules);\n\n    const processingSteps = buildProcessingSteps(structure, vehicleRules, documentPatterns);\n\n    return {\n        template_index: templateIndex,\n        document_type: documentType,\n        instructions: {\n            overview: `×—×©×‘×•× ×™×ª ××¡×¤×§ ${mergedConfig.supplier_name}`,\n            processing_steps: processingSteps,\n            fields: fieldInstructions\n        }\n    };\n}\n\nfunction generateTechnicalConfig(mergedConfig, ocrFields, searchResults, templateIndex, structure, documentPatterns, vehicleRules) {\n    const extractionRules = {};\n\n    extractionRules.booknum = {\n        source: \"ocrFields.InvoiceId\",\n        transformations: [\n            { action: \"remove_prefix\", pattern: \"^SI\" },\n            { action: \"take_last_n_chars\", count: 7 }\n        ],\n        example: searchResults.booknum || \"\"\n    };\n\n    extractionRules.ivdate = {\n        source: \"ocrFields.InvoiceDate\",\n        format: \"DD/MM/YY\",\n        example: searchResults.ivdate || \"\"\n    };\n\n    extractionRules.price = {\n        calculation: {\n            formula: \"InvoiceTotal_amount - TotalTax_amount\"\n        }\n    };\n\n    if (vehicleRules && vehicleRules.vehicle_account_mapping) {\n        extractionRules.vehicles = {\n            pattern: \"\\\\d{3}-\\\\d{2}-\\\\d{3}\",\n            example: searchResults.vehicles || []\n        };\n    }\n\n    if (structure.has_doc) {\n        extractionRules.documents = {\n            booknum_pattern: documentPatterns?.booknum_pattern || \"\\\\b10\\\\d{7}\\\\b\",\n            docno_pattern: \"\\\\b25\\\\d{6}\\\\b\",\n            example: searchResults.documents || []\n        };\n    }\n\n    const documentTypeKey = determineDocumentTypeKey(structure, vehicleRules);\n\n    return {\n        template_index: templateIndex,\n        version: \"5.0\",\n        document_type: documentTypeKey,\n        extraction_rules: extractionRules,\n        validation_rules: {\n            required_fields: [\"SUPNAME\", \"CODE\", \"DEBIT\", \"IVDATE\", \"BOOKNUM\"]\n        }\n    };\n}\n\nfunction generateProcessingScenario(structure, vehicleRules) {\n    const hasVehicles = vehicleRules &&\n        vehicleRules.vehicle_account_mapping &&\n        Object.keys(vehicleRules.vehicle_account_mapping).length > 0;\n\n    return {\n        document_type: determineDocumentTypeKey(structure, vehicleRules),\n        check_docs: structure.has_doc || false,\n        check_import: structure.has_import || false,\n        check_vehicles: hasVehicles || false\n    };\n}\n\nfunction determineDocumentType(structure, vehicleRules) {\n    if (structure.has_import && structure.has_doc) {\n        return \"×—×©×‘×•× ×™×ª ×¢× ×ª×™×§ ×™×‘×•× ×¢× ×ª×¢×•×“×•×ª\";\n    } else if (structure.has_import) {\n        return \"×—×©×‘×•× ×™×ª ×™×‘×•×\";\n    } else if (structure.has_doc) {\n        return \"×—×©×‘×•× ×™×ª ×¢× ×ª×¢×•×“×•×ª\";\n    } else if (structure.debit_type === \"C\") {\n        return \"×–×™×›×•×™ ×¨×’×™×œ ×¢× ×¤×™×¨×•×˜\";\n    } else if (vehicleRules && Object.keys(vehicleRules.vehicle_account_mapping || {}).length > 0) {\n        return \"×—×©×‘×•× ×™×ª ×©×™×¨×•×ª×™ ×¨×›×‘ ×•××•×¡×š\";\n    }\n    return \"×—×©×‘×•× ×™×ª ×¨×’×™×œ×” ×¢× ×¤×™×¨×•×˜\";\n}\n\nfunction determineDocumentTypeKey(structure, vehicleRules) {\n    if (structure.has_import && structure.has_doc) {\n        return \"import_with_docs_invoice\";\n    } else if (structure.has_import) {\n        return \"import_invoice\";\n    } else if (structure.has_doc) {\n        return \"docs_invoice\";\n    } else if (structure.debit_type === \"C\") {\n        return \"credit_note\";\n    } else if (vehicleRules && Object.keys(vehicleRules.vehicle_account_mapping || {}).length > 0) {\n        return \"vehicle_service_invoice\";\n    }\n    return \"regular_invoice\";\n}\n\nfunction buildProcessingSteps(structure, vehicleRules, documentPatterns) {\n    const steps = [];\n    steps.push(\"1. ×–×”×” ××ª ××¡×¤×¨ ×”×—×©×‘×•× ×™×ª (BOOKNUM) ××ª×•×š InvoiceId\");\n    steps.push(\"2. ×—×œ×¥ ×ª××¨×™×š ×—×©×‘×•× ×™×ª (IVDATE) ××ª×•×š InvoiceDate\");\n\n    if (structure.has_import) {\n        steps.push(`${steps.length + 1}. ×–×”×” ××¡×¤×¨ ×™×‘×•× (IMPFNUM)`);\n    }\n\n    if (structure.has_doc) {\n        let docsGuidance = \"×–×”×” ×ª×¢×•×“×•×ª (DOCNO/BOOKNUM)\";\n        if (documentPatterns && documentPatterns.booknum_found.length > 0) {\n            const prefix = documentPatterns.booknum_found[0].substring(0, 3);\n            docsGuidance += ` - ×¤×•×¨××˜ ${prefix}XXXXXX`;\n        }\n        steps.push(`${steps.length + 1}. ${docsGuidance}`);\n    }\n\n    if (vehicleRules && Object.keys(vehicleRules.vehicle_account_mapping || {}).length > 0) {\n        steps.push(`${steps.length + 1}. ×—×œ×¥ ××¡×¤×¨×™ ×¨×›×‘×™× (×¤×•×¨××˜ XXX-XX-XXX)`);\n        steps.push(`${steps.length + 1}. ××¤×” ×›×œ ×¨×›×‘ ×œ×—×©×‘×•×Ÿ ×”× ×›×•×Ÿ`);\n    }\n\n    steps.push(`${steps.length + 1}. ×—×©×‘ ××—×™×¨: InvoiceTotal - TotalTax`);\n\n    return steps;\n}\n\n// ============================================================================\n// × ×§×•×“×ª ×›× ×™×¡×”\n// ============================================================================\n\nif (typeof input !== 'undefined') {\n    const normalizedInput = normalizeInput(input);\n    const result = processUnifiedConfig(normalizedInput);\n    console.log(JSON.stringify(result));\n    return result;\n}\n\nmodule.exports = {\n    processUnifiedConfig,\n    normalizeInput\n};\n"
    }
]
