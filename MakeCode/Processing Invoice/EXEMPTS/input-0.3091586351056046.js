[
    {
        "input": [
            {
                "name": "learned_config",
                "value": {
                    "status": "success",
                    "supplier_id": "2511",
                    "supplier_name": "×¤×œ×¡××•×Ÿ ×‘×¢\"×",
                    "vendor_tax_id_reference": "512865254",
                    "supplier_phone": "073-2333733",
                    "supplier_email": "megi.moshe@plasson.co.il",
                    "json_files_analyzed": 1,
                    "templates_detected": 1,
                    "config": {
                        "supplier_config": {
                            "supplier_code": "2511",
                            "supplier_name": "×¤×œ×¡××•×Ÿ ×‘×¢\"×",
                            "vendor_tax_id_reference": "512865254"
                        },
                        "structure": [
                            {
                                "has_import": false,
                                "has_purchase_orders": false,
                                "has_doc": true,
                                "has_date_range": false,
                                "has_budcode": false,
                                "has_pdaccname": false,
                                "inventory_management": "managed_inventory",
                                "debit_type": "D"
                            }
                        ],
                        "rules": {
                            "invoice_date_format": "DD/MM/YY",
                            "doc_variation": "×ª×¢×•×“×” ××—×ª (DOCNO) ××• ××¨×•×‘×•×ª (PIVDOC_SUBFORM) - ×©× ×™×”× ×‘×ª×‘× ×™×ª",
                            "validation_data": {
                                "TOTQUANT": 280
                            },
                            "critical_patterns": {
                                "vehicle_rules": {},
                                "partname_rules": {}
                            }
                        },
                        "document_types": [
                            {
                                "type": "×—×©×‘×•× ×™×ª ×¢× ×ª×¢×•×“×•×ª ×œ×œ× ×¤×™×¨×•×˜",
                                "accnames": [
                                    "63001"
                                ]
                            }
                        ]
                    },
                    "template": {
                        "PINVOICES": [
                            {
                                "SUPNAME": "2511",
                                "CODE": "×©\"×—",
                                "DEBIT": "D",
                                "IVDATE": "11/08/25",
                                "BOOKNUM": "258001213",
                                "DOCNO": "25025083",
                                "DETAILS": "××¡×¤×§×” ×™×•×œ×™",
                                "PIVDOC_SUBFORM": [
                                    {
                                        "DOCNO": "",
                                        "BOOKNUM": ""
                                    }
                                ]
                            }
                        ],
                        "document_types_count": 1
                    },
                    "recommended_samples": {
                        "samples": [
                            {
                                "sample_ivnum": "25065632",
                                "sample_booknum": "258001213",
                                "sample_impfnum": "",
                                "sample_supname": "2511"
                            }
                        ]
                    }
                }
            },
            {
                "name": "docs_list",
                "value": [
                    "{\"DOCNO\":\"25025083\",\"BOOKNUM\":\"107763233\",\"TOTQUANT\":280}"
                ]
            },
            {
                "name": "import_files",
                "value": [
                    ""
                ]
            },
            {
                "name": "AZURE_RESULT",
                "value": {
                    "structure": {
                        "docType": "string",
                        "fields": {
                            "BillingAddress": "string",
                            "BillingAddress_houseNumber": "string",
                            "BillingAddress_streetAddress": "string",
                            "BillingAddressRecipient": "string",
                            "CustomerAddress": "string",
                            "CustomerAddress_houseNumber": "string",
                            "CustomerAddress_road": "string",
                            "CustomerAddress_streetAddress": "string",
                            "CustomerAddress_house": "string",
                            "CustomerAddressRecipient": "string",
                            "CustomerName": "string",
                            "CustomerTaxId": "string",
                            "DueDate": "YYYY-MM-DD",
                            "InvoiceDate": "YYYY-MM-DD",
                            "InvoiceId": "string",
                            "InvoiceTotal_amount": "number",
                            "InvoiceTotal_currency": "string",
                            "PaymentTerm": "string",
                            "SubTotal_amount": "number",
                            "SubTotal_currency": "string",
                            "TotalTax_amount": "number",
                            "TotalTax_currency": "string",
                            "VendorAddress": "string",
                            "VendorAddress_house": "string",
                            "VendorAddressRecipient": "string",
                            "VendorName": "string",
                            "VendorTaxId": "string",
                            "VendorTel": "string",
                            "VendorFax": "string",
                            "CustomerTel": "string",
                            "VendorEmail": "string",
                            "UnidentifiedNumbers": [
                                "object"
                            ]
                        },
                        "Items": [
                            {
                                "LineNumber": {
                                    "type": "number",
                                    "originalHeader": "×¡×›×•×\n× ×˜×•\n×‘-×©×´×—"
                                },
                                "Discount": {
                                    "type": "number",
                                    "originalHeader": "××—×•×–\n×”× ×—×”"
                                },
                                "Quantity": {
                                    "type": "number",
                                    "originalHeader": "×›××•×ª"
                                },
                                "Unit": {
                                    "type": "string",
                                    "originalHeader": "×™×—×³\n××™×“×”"
                                },
                                "Description": {
                                    "type": "string",
                                    "originalHeader": "×ª×™××•×¨"
                                },
                                "ProductCode": {
                                    "type": "number",
                                    "originalHeader": "××§×´×˜ ×œ×§×•×—"
                                },
                                "Tax": {
                                    "type": "number",
                                    "originalHeader": "××¡×³"
                                }
                            }
                        ]
                    },
                    "data": {
                        "docType": "invoice",
                        "fields": {
                            "BillingAddress": "3877701",
                            "BillingAddress_houseNumber": "3877701",
                            "BillingAddress_streetAddress": "3877701",
                            "BillingAddressRecipient": "×˜.×¤.×™ ×¤×œ-×™× ×‘×¢×´×",
                            "CustomerAddress": "×”×§×˜×™×£ 11\n×¤××¨×§ ×ª×¢×©×™×•×ª ×¢××§ ×—×¤×¨",
                            "CustomerAddress_houseNumber": "11",
                            "CustomerAddress_road": "×”×§×˜×™×£",
                            "CustomerAddress_streetAddress": "11 ×”×§×˜×™×£",
                            "CustomerAddress_house": "×¤××¨×§ ×ª×¢×©×™×•×ª ×¢××§ ×—×¤×¨",
                            "CustomerAddressRecipient": "×˜.×¤.×™ ×¤×œ-×™× ×‘×¢×´×",
                            "CustomerName": "×˜.×¤.×™ ×¤×œ-×™× ×‘×¢×´×",
                            "CustomerTaxId": "513327064",
                            "DueDate": "2025-12-31",
                            "InvoiceDate": "2025-08-12",
                            "InvoiceId": "258001213",
                            "InvoiceTotal_amount": 43766.77,
                            "InvoiceTotal_currency": "ILS",
                            "Items": [
                                {
                                    "LineNumber": 135.35,
                                    "Discount": 0,
                                    "Quantity": 168,
                                    "Unit": "×™×—×™",
                                    "Description": "××™×›×œ ×§×œ×¡××•×Ÿ ×¦××•×“ ×œ×‘×Ÿ ××•×¨×›×‘",
                                    "ProductCode": 33007300,
                                    "Tax": 1
                                },
                                {
                                    "LineNumber": 128.14,
                                    "Discount": 0,
                                    "Quantity": 56,
                                    "Unit": "×™×—×™",
                                    "Description": "××™×›×œ ×©×™××•×Ÿ ×¤×¨×’××•×Ÿ ××•×¨×›×‘",
                                    "ProductCode": "33008405G",
                                    "Tax": 2
                                },
                                {
                                    "LineNumber": 128.14,
                                    "Discount": 0,
                                    "Quantity": 56,
                                    "Unit": "×™×—×™",
                                    "Description": "××™×›×œ ×©×™××•×Ÿ ×œ×‘×Ÿ ××•×¨×›×‘",
                                    "ProductCode": "33008400G",
                                    "Tax": 3
                                }
                            ],
                            "PaymentTerm": "×©×•×˜×£ + 120",
                            "SubTotal_amount": 37090.48,
                            "SubTotal_currency": "ILS",
                            "TotalTax_amount": 6676.29,
                            "TotalTax_currency": "ILS",
                            "VendorAddress": "××™×›××œ, ×“.× .",
                            "VendorAddress_house": "××™×›××œ, ×“.× .",
                            "VendorAddressRecipient": "×¤×œ×¡××•×Ÿ ×‘×¢×´×",
                            "VendorName": "PLASSONÂ®",
                            "VendorTaxId": "512865254",
                            "VendorTel": "04-6394721",
                            "VendorFax": "04-6394816",
                            "CustomerTel": "858 20250813",
                            "VendorEmail": "Yaels@plasson.co.il",
                            "UnidentifiedNumbers": [
                                {
                                    "label": "××¡' ×œ×§×•×—",
                                    "value": 1340
                                },
                                {
                                    "label": "××¡' ×”×§×¦××”",
                                    "value": "225028858 20250813092901465"
                                },
                                {
                                    "label": "×œ×¤×™×¨×¢×•×Ÿ ×¢×“",
                                    "value": "31/12/2025"
                                },
                                {
                                    "label": "×”×§××ª ×”×–×× ×”",
                                    "value": "Moshe, Megi"
                                },
                                {
                                    "label": "×”×¤×§×ª ×—×©×‘×•× ×™×ª",
                                    "value": "Sharett, Yael"
                                },
                                {
                                    "label": "××¡' ×ª×¢×•×“×ª ××©×œ×•×—",
                                    "value": "107763233"
                                },
                                {
                                    "label": "××¡×¤×¨",
                                    "value": "3780500"
                                },
                                {
                                    "label": "××¡×¤×¨",
                                    "value": "2501004288"
                                },
                                {
                                    "label": "××¡×¤×¨",
                                    "value": "60000004"
                                }
                            ]
                        }
                    },
                    "metadata": {
                        "modelId": "",
                        "totalFields": 33,
                        "uniqueDataFound": 9,
                        "pageCount": 1
                    },
                    "status": "success"
                }
            },
            {
                "name": "AZURE_TEXT",
                "value": "××¡××š ×××•×—×©×‘\n×—×ª×•× ×“×™×’×™×˜×œ×™×ª ×•×××•×©×¨\n×¢×œ ×™×“×™ ×’×•×¨× ×××©×¨\npersonal\n×¤×œ×¡××•×Ÿ ×‘×¢\"× | ××¡' ×¢×•×¡×§ ××•×¨×©×” 512865254 | ×¤×˜×•×¨ ×× ×™×›×•×™ ××¡ ×”×›× ×¡×” ×‘××§×•×¨ ×œ×¤×™ ××™×©×•×¨ ×¤×§×™×“ ×©×•××” ×—×™×¤×”\n××¢×’×Ÿ ××™×›××œ, ×“.× . ×× ×©×” 3780500 | ×˜×œ×¤×•×Ÿ: 04-6394721, ×¤×§×¡: 04-6394816 | www.plasson.co.il | Yaels@plasson.co.il\n-\nPLASSONÂ®\n×¢××•×“ 1 ××ª×•×š 1\n×—×©×‘×•× ×™×ª ××¡ ××¡×¤×¨: 258001213\n××§×•×¨\n××¡××š ×××•×—×©×‘\n×œ×›×‘×•×“:\n×™×¢×“ ×œ××©×œ×•×—:\n×ª××¨×™×š: 12/08/2025\n×˜.×¤.×™ ×¤×œ-×™× ×‘×¢\"×\n×˜.×¤.×™ ×¤×œ-×™× ×‘×¢\"×\n××¡' ×œ×§×•×—: 1340\n×¢.×. ×œ×§×•×—: 513327064\n×”×§×˜×™×£ 11\n×”×§×˜×™×£ 11\n××¡' ×”×–×× ×ª ×œ×§×•×—: 2501004288\n×¤××¨×§ ×ª×¢×©×™×•×ª ×¢××§ ×—×¤×¨ 3877701\n×¤××¨×§ ×ª×¢×©×™×•×ª ×¢××§ ×—×¤×¨ 3877701\n××¡' ×”×–×× ×ª ×¤×œ×¡××•×Ÿ: 60000004\n××¡' ×ª×¢×•×“×ª ××©×œ×•×—: 107763233\n××¡' ×”×§×¦××”: 225028858 20250813092901465\n×”×¢×¨×•×ª:\n××¡'\n××§\"×˜ ×œ×§×•×—\n××§\"×˜ ×¤×œ×¡××•×Ÿ\n×ª×™××•×¨\n×™×—'\n×›××•×ª\n××—×™×¨\n×¡×›×•×\n××—×•×–\n×¡×›×•×\n××™×“×”\n×™×—'\n×‘×¨×•×˜×•\n×”× ×—×”\n× ×˜×•\n×‘- ×©\"×—\n×‘-×©\"×—\n×‘-×©\"×—\n1\n33007300\n××™×›×œ ×§×œ×¡××•×Ÿ ×¦××•×“ ×œ×‘×Ÿ ××•×¨×›×‘\n×™×—×™\n168135.35\n22,738.80\n0.00\n22,738.80\n2\n33008405G\n××™×›×œ ×©×™××•×Ÿ ×¤×¨×’××•×Ÿ ××•×¨×›×‘\n×™×—×™\n56128.14\n7,175.84\n0.00\n7,175.84\n3\n33008400G\n××™×›×œ ×©×™××•×Ÿ ×œ×‘×Ÿ ××•×¨×›×‘\n×™×—×™\n56128.14\n7,175.84\n0.00\n7,175.84\n×œ×¤×™×¨×¢×•×Ÿ ×¢×“: 31/12/2025\n×¡×”\"×› ×‘×¨×•×˜×• ×‘×©\"×—:\n37,090.48\n×ª× ××™ ×ª×©×œ×•×: ×©×•×˜×£ + 120\n×”×§××ª ×”×–×× ×”: Moshe, Megi\n×¡×”\"×› × ×˜×•:\n37,090.48\n×”×¤×§×ª ×—×©×‘×•× ×™×ª: Sharett, Yael\n××¢\"× 18%:\n6,676.29\n×¤×œ×¡××•×Ÿ ×‘×¢\"×\n×¡×”\"×› ×œ×ª×©×œ×•× ×‘×©\"×—:\n43,766.77"
            }
        ],
        "language": "javascript",
        "inputFormat": "string",
        "dependencies": [],
        "codeStringJavascript": "// ============================================================================\n// ×§×•×“ 2 - ×¢×™×‘×•×“ ×—×©×‘×•× ×™×•×ª (×’×¨×¡×” 4.4 - 06.11.25.16:30)\n// ××§×‘×œ: OCR + ×”×’×“×¨×•×ª + ×ª×¢×•×“×•×ª + ×™×‘×•×\n// ××—×–×™×¨: JSON ×œ×¤×¨×™×•×¨×™×˜×™ + ×“×•×— ×‘×™×¦×•×¢ + ×–×™×”×•×™ ×¨×›×‘×™× ××©×•×¤×¨\n//\n// ğŸ“ ×§×‘×¦×™ ×‘×“×™×§×”: MakeCode/Processing Invoice/EXEMPTS/\n// ×œ×§×™×—×ª ×”×§×•×‘×¥ ×”×¢×“×›× ×™: ls -lt \"MakeCode/Processing Invoice/EXEMPTS\" | head -5\n//\n// âœ¨ ×—×“×© ×‘×’×¨×¡×” 4.4:\n// - ğŸ¯ ×–×™×”×•×™ ×“×™× ××™ ×©×œ ×ª×‘× ×™×•×ª ×ª×¢×•×“×•×ª: ××–×”×” ××•×˜×•××˜×™×ª ×ª×‘× ×™×ª BOOKNUM (107/108XXXXXX) ××”-OCR\n// - ğŸ“š ×”×¡×‘×¨×” ××©×•×¤×¨×ª ×œ-LLM: ×”× ×—×™×•×ª ××•×ª×××•×ª ××™×©×™×ª ×¢× ×“×•×’×××•×ª ×§×•× ×§×¨×˜×™×•×ª ××”-OCR\n// - ğŸ” ×œ×•×’ ××¤×•×¨×˜: \"âœ¨ ×–×•×”×ª×” ×ª×‘× ×™×ª BOOKNUM: 108XXXXXX (3 ×“×•×’×××•×ª: 108187003, 108187002...)\"\n//\n// âœ¨ ×—×“×© ×‘×’×¨×¡×” 4.3:\n// - fallback ×œ×—×™×¤×•×© ×¨×›×‘×™× ×‘-AZURE_TEXT (×›×©-Azure ×œ× ××–×”×” ××•×˜×•××˜×™×ª)\n// - ×œ×•×’×™× ××¤×•×¨×˜×™×: \"âš ï¸ ×œ× × ××¦××• ×¨×›×‘×™× ×‘××§×•××•×ª ×”××•×‘× ×™× - ××—×¤×© ×‘-AZURE_TEXT...\"\n// - ××•× ×¢ ×–×™×”×•×™ ××¡×¤×¨×™ ×›×¨×˜×™×¡ ×›×¨×›×‘×™× (×‘×“×™×§×ª context)\n//\n// âœ¨ ×—×“×© ×‘×’×¨×¡×” 4.2:\n// - ×ª×™×§×•×Ÿ ×—×™×©×•×‘ ××—×™×¨: InvoiceTotal - TotalTax = ×¡×”\"×› ×œ×¤× ×™ ××¢\"× (×¢×‘×•×“×•×ª + ×—×œ×§×™×)\n//\n// âœ¨ ×—×“×© ×‘×’×¨×¡×” 4.1:\n// - ×¤×•× ×§×¦×™×™×ª cleanInvoiceForPriority() - ×× ×§×” ×©×“×•×ª ×œ××™×“×” ×œ×¤× ×™ ×©×œ×™×—×”\n// - ×–×™×”×•×™ ×¨×›×‘×™× ××©×•×¤×¨ - ××•× ×¢ ×–×™×”×•×™ ×›×¨×˜×™×¡ ×›×¨×›×‘\n//\n// âœ¨ ×—×“×© ×‘×’×¨×¡×” 4.0:\n// - ×—×™×œ×•×¥ ×¨×›×‘×™× ××ª×§×“× ×œ×¤×™ vehicle_processing_rules.search_locations\n// - ×ª××™×›×” ×‘-VehicleNumbers (×©×“×” ×—×“×© ×-Azure v3.0)\n// - ×ª××™×›×” ×‘-Items[].VehicleNumber (×§×™×©×•×¨ ×™×©×™×¨)\n// - ×™×¦×™×¨×ª ×¤×¨×™×˜×™ ×¨×›×‘×™× ××•×˜×•××˜×™×ª\n// - ××™×¤×•×™ ×œ×—×©×‘×•× ×•×ª ×œ×¤×™ vehicle_account_mapping\n//\n// âœ¨ ××’×¨×¡×” 3.0:\n// - ×ª××™×›×” ×‘××‘× ×” ×”×—×“×© ×©×œ UnidentifiedNumbers (××¢×¨×š ××•×‘×™×™×§×˜×™×)\n// - × ×™×¦×•×œ ×”×ª×•×•×™×•×ª (label) ×•×”×”×§×©×¨ (context) ×œ×–×™×”×•×™ ×—×›× ×™×•×ª×¨\n// ============================================================================\n\n// ============================================================================\n// ×¤×•× ×§×¦×™×™×ª ×¢×–×¨ - × ×™×§×•×™ invoice ×œ×¤× ×™ ×©×œ×™×—×” ×œ-Priority\n// ============================================================================\n\nfunction cleanInvoiceForPriority(invoice) {\n    // ×™×¦×™×¨×ª ×¢×•×ª×§ ×¢××•×§ ×›×“×™ ×œ× ×œ×©× ×•×ª ××ª ×”××§×•×¨\n    const cleaned = JSON.parse(JSON.stringify(invoice));\n\n    // × ×™×§×•×™ ×©×“×•×ª ×©×œ× ×¦×¨×™×›×™× ××”×¤×¨×™×˜×™×\n    if (cleaned.PINVOICEITEMS_SUBFORM) {\n        cleaned.PINVOICEITEMS_SUBFORM = cleaned.PINVOICEITEMS_SUBFORM.map(item => {\n            // ××—×™×§×ª ×©×“×•×ª ×œ××™×“×”\n            delete item.isNewVehicle;\n            delete item._learningNote;\n\n            // ××—×™×§×ª SPECIALVATFLAG ×× ×–×” ×œ× \"Y\"\n            if (item.SPECIALVATFLAG && item.SPECIALVATFLAG !== \"Y\") {\n                delete item.SPECIALVATFLAG;\n            }\n\n            return item;\n        });\n    }\n\n    return cleaned;\n}\n\n// ============================================================================\n// ×¤×•× ×§×¦×™×” ×¨××©×™×ª\n// ============================================================================\n\nfunction processInvoiceComplete(input) {\n    const executionReport = {\n        stage: \"\",\n        found: [],\n        not_found: [],\n        warnings: [],\n        errors: []\n    };\n\n    try {\n        // ============================================================================\n        // ×©×œ×‘ 1: ×–×™×”×•×™ ×¡×•×’ ×—×©×‘×•× ×™×ª ×•×ª×‘× ×™×ª\n        // ============================================================================\n\n        executionReport.stage = \"×©×œ×‘ 1: ×–×™×”×•×™ ×¡×•×’ ×•×ª×‘× ×™×ª\";\n\n        // ×. ×‘×“×™×§×ª ×™×‘×•×\n        const hasImport = checkImportExists(input.import_files);\n\n        // ×‘. ×‘×“×™×§×ª ×ª×¢×•×“×•×ª - ×‘-OCR ××• ×‘-docs_list!\n        const hasDocsInOCR = checkDocsInOCR(\n            input.AZURE_RESULT.data.fields,\n            input.AZURE_TEXT\n        );\n        const hasDocsInList = checkDocsExist(input.docs_list);\n        const hasDocs = hasDocsInOCR || hasDocsInList;\n\n        // âœ¨ ×—×“×©! ×–×™×”×•×™ ×ª×‘× ×™×•×ª ×ª×¢×•×“×•×ª ××”-OCR\n        const documentPatterns = detectDocumentPatterns(\n            input.AZURE_RESULT.data.fields,\n            input.AZURE_TEXT\n        );\n        if (documentPatterns.guidance) {\n            executionReport.found.push(documentPatterns.guidance);\n        }\n\n        // ×’. ×–×™×”×•×™ ×—×™×•×‘/×–×™×›×•×™\n        const debitType = identifyDebitType(input.AZURE_RESULT.data.fields);\n\n        executionReport.found.push(`×¡×•×’: ×™×‘×•×=${hasImport}, ×ª×¢×•×“×•×ª=${hasDocs}, ×—×™×•×‘/×–×™×›×•×™=${debitType}`);\n\n        // ×“. ×—×™×¤×•×© ×ª×‘× ×™×ª ××ª××™××”\n        const config = input.learned_config.config;\n        const templateIndex = findMatchingTemplate(config.structure, hasImport, hasDocs, debitType);\n\n        if (templateIndex === -1) {\n            executionReport.errors.push(\"×œ× × ××¦××” ×ª×‘× ×™×ª ××ª××™××”!\");\n            throw new Error(\"×œ× × ××¦××” ×ª×‘× ×™×ª ××ª××™××”\");\n        }\n\n        const structure = config.structure[templateIndex];\n        const template = input.learned_config.template.PINVOICES[templateIndex];\n\n        executionReport.found.push(`×ª×‘× ×™×ª: index=${templateIndex}`);\n\n        // ============================================================================\n        // ×©×œ×‘ 2: ×”×›× ×” - ×”×‘× ×ª ×“×¤×•×¡×™×\n        // ============================================================================\n\n        executionReport.stage = \"×©×œ×‘ 2: ×”×‘× ×ª ×“×¤×•×¡×™×\";\n\n        const patterns = extractPatterns(\n            input.learned_config.recommended_samples,\n            input.docs_list\n        );\n\n        executionReport.found.push(`×“×¤×•×¡×™×: BOOKNUM=${JSON.stringify(patterns.booknum_pattern)}, ×ª×¢×•×“×•×ª=${JSON.stringify(patterns.docs_pattern)}`);\n\n        // âœ¨ ×—×“×©! ×§×¨×™××ª ×—×•×§×™ ×¨×›×‘×™×\n        const vehicleRules = config.rules?.critical_patterns?.vehicle_rules || null;\n        if (vehicleRules && vehicleRules.enabled) {\n            executionReport.found.push(`×—×•×§×™ ×¨×›×‘×™×: ×¤×¢×™×œ×™× (${Object.keys(vehicleRules.vehicle_account_mapping || {}).length} ×¨×›×‘×™× ×××•×¤×™×)`);\n        }\n\n        // ============================================================================\n        // ×©×œ×‘ 3: ×—×™×¤×•×© ×•×–×™×”×•×™ × ×ª×•× ×™×\n        // ============================================================================\n\n        executionReport.stage = \"×©×œ×‘ 3: ×—×™×¤×•×© × ×ª×•× ×™×\";\n\n        const ocrFields = input.AZURE_RESULT.data.fields;\n        const searchResults = searchAllData(\n            ocrFields,\n            input.AZURE_TEXT,\n            patterns,\n            structure,\n            input.import_files,\n            input.docs_list,\n            vehicleRules  // âœ¨ ×—×“×©!\n        );\n\n        // ×ª×™×¢×•×“ ××” × ××¦×\n        Object.keys(searchResults).forEach(key => {\n            if (key === 'documents' && searchResults.documents) {\n                if (searchResults.documents.length > 0) {\n                    const docsInfo = searchResults.documents.map(d =>\n                        `${d.BOOKNUM} (DOCNO: ${d.DOCNO || '×¨×™×§'})`\n                    ).join(', ');\n                    executionReport.found.push(`×ª×¢×•×“×•×ª: ${searchResults.documents.length} - ${docsInfo}`);\n                } else {\n                    executionReport.not_found.push('×ª×¢×•×“×•×ª');\n                }\n            } else if (key === 'vehicles' && searchResults.vehicles) {\n                if (searchResults.vehicles.length > 0) {\n                    executionReport.found.push(`×¨×›×‘×™×: ${searchResults.vehicles.length} - ${searchResults.vehicles.join(', ')}`);\n                } else {\n                    executionReport.not_found.push('×¨×›×‘×™×');\n                }\n            } else if (searchResults[key]) {\n                executionReport.found.push(`${key}: ${JSON.stringify(searchResults[key]).substring(0, 50)}`);\n            } else {\n                executionReport.not_found.push(key);\n            }\n        });\n\n        // âœ¨ ×—×“×©! ×˜×™×¤×•×œ ×‘×©×’×™××•×ª ×œ×ª×¢×•×“×•×ª ×—×¡×¨×•×ª\n        if (structure.has_doc) {\n            const foundDocsCount = searchResults.documents ? searchResults.documents.length : 0;\n            const ocrUnidentified = ocrFields.UnidentifiedNumbers || [];\n\n            // ×¡×¤×•×¨ ×›××” BOOKNUM × ××¦××• ×‘-OCR\n            const booknumPattern = /^108\\d{6}$/;\n            let expectedDocsCount = 0;\n\n            if (typeof ocrUnidentified[0] === 'object' && ocrUnidentified[0].value) {\n                expectedDocsCount = ocrUnidentified.filter(item =>\n                    booknumPattern.test(item.value)\n                ).length;\n            } else {\n                expectedDocsCount = ocrUnidentified.filter(num =>\n                    booknumPattern.test(num)\n                ).length;\n            }\n\n            // ×˜×™×¤×•×œ ×‘×©×’×™××•×ª\n            if (foundDocsCount === 0) {\n                // ××£ ×ª×¢×•×“×” ×œ× × ××¦××”\n                if (expectedDocsCount > 0) {\n                    executionReport.errors.push(\n                        `×ª×‘× ×™×ª ×“×•×¨×©×ª ×ª×¢×•×“×•×ª. × ××¦××• ${expectedDocsCount} BOOKNUM ×‘-OCR ××š ×œ× × ××¦××” ×”×ª×××” ×‘-docs_list`\n                    );\n                } else {\n                    executionReport.errors.push(\n                        '×ª×‘× ×™×ª ×“×•×¨×©×ª ×ª×¢×•×“×•×ª ××š ×œ× × ××¦××• BOOKNUM ×‘-OCR'\n                    );\n                }\n            } else if (expectedDocsCount > 0 && foundDocsCount < expectedDocsCount) {\n                // × ××¦××• ×ª×¢×•×“×•×ª ×—×œ×§×™×•×ª\n                executionReport.warnings.push(\n                    `× ××¦××• ×¨×§ ${foundDocsCount} ××ª×•×š ${expectedDocsCount} ×ª×¢×•×“×•×ª ××”-OCR. ×—×¡×¨×•×ª ${expectedDocsCount - foundDocsCount} ×ª×¢×•×“×•×ª`\n                );\n            }\n        }\n\n        // ============================================================================\n        // ×©×œ×‘ 4: ×‘× ×™×™×ª JSON\n        // ============================================================================\n\n        executionReport.stage = \"×©×œ×‘ 4: ×‘× ×™×™×ª ×—×©×‘×•× ×™×ª\";\n\n        const invoice = buildInvoiceFromTemplate(\n            template,\n            structure,\n            config,\n            searchResults,\n            input.learned_config,\n            ocrFields,  // âœ¨ ×—×“×©! ××¢×‘×™×¨ ×’× ××ª ocrFields\n            input.docs_list  // âœ¨ ×—×“×©! ××¢×‘×™×¨ ×’× ××ª docs_list\n        );\n\n        // ============================================================================\n        // ×©×œ×‘ 5: ×‘×§×¨×•×ª\n        // ============================================================================\n\n        executionReport.stage = \"×©×œ×‘ 5: ×‘×§×¨×•×ª\";\n\n        const validation = performValidation(\n            invoice,\n            ocrFields,\n            config,\n            input.docs_list,\n            patterns\n        );\n\n        // ============================================================================\n        // ×©×œ×‘ 6: × ×™×ª×•×— ×œ××™×“×”\n        // ============================================================================\n\n        executionReport.stage = \"×©×œ×‘ 6: × ×™×ª×•×— ×œ××™×“×”\";\n\n        const learningAnalysis = analyzeLearning(invoice, config);\n\n        // ============================================================================\n        // ×©×œ×‘ 7: × ×™×§×•×™ ×•×”×—×–×¨×ª ×ª×•×¦××”\n        // ============================================================================\n\n        // × ×™×§×•×™ ×©×“×•×ª ×©×œ× ×¦×¨×™×›×™× (×œ××™×“×” ×‘×œ×‘×“, ×œ× ×œ-Priority)\n        const cleanedInvoice = cleanInvoiceForPriority(invoice);\n\n        // ============================================================================\n        // ×©×œ×‘ 8: ×™×¦×™×¨×ª ×¤×œ×˜×™× × ×•×¡×¤×™× - ×œ×›×œ ×ª×‘× ×™×ª ××¤×©×¨×™×ª!\n        // ============================================================================\n\n        // ×¤×œ×˜ 1: ×—×©×‘×•× ×™×•×ª ×œ×›×œ ×”×ª×‘× ×™×•×ª\n        const allInvoices = [];\n        for (let i = 0; i < config.structure.length; i++) {\n            const templateStructure = config.structure[i];\n            const templateData = input.learned_config.template.PINVOICES[i];\n\n            const tempInvoice = buildInvoiceFromTemplate(\n                templateData,\n                templateStructure,\n                config,\n                searchResults,\n                input.learned_config,\n                ocrFields,\n                input.docs_list\n            );\n\n            const cleanedTempInvoice = cleanInvoiceForPriority(tempInvoice);\n            allInvoices.push(cleanedTempInvoice);\n        }\n\n        // ×¤×œ×˜ 2: ×”× ×—×™×•×ª ×œ-LLM - ×œ×›×œ ×ª×‘× ×™×ª\n        const allLlmPrompts = [];\n        const allTechnicalConfigs = [];\n\n        for (let i = 0; i < config.structure.length; i++) {\n            const templateStructure = config.structure[i];\n\n            allLlmPrompts.push(generateLLMPrompt(\n                config,\n                ocrFields,\n                searchResults,\n                executionReport,\n                i,\n                templateStructure,\n                documentPatterns  // âœ¨ ×—×“×©! ×”×¢×‘×¨×ª ×ª×‘× ×™×•×ª ×ª×¢×•×“×•×ª\n            ));\n\n            allTechnicalConfigs.push(generateTechnicalConfig(\n                config,\n                ocrFields,\n                searchResults,\n                executionReport,\n                i,\n                templateStructure,\n                documentPatterns  // âœ¨ ×—×“×©! ×”×¢×‘×¨×ª ×ª×‘× ×™×•×ª ×ª×¢×•×“×•×ª\n            ));\n        }\n\n        // ×¤×œ×˜ 2: ×”× ×—×™×•×ª ×œ×ª×‘× ×™×ª ×©× ×‘×—×¨×” (×œ× ×•×—×•×ª)\n        const selectedLlmPrompt = allLlmPrompts[templateIndex];\n        const selectedTechnicalConfig = allTechnicalConfigs[templateIndex];\n\n        // ×¤×œ×˜ 3: ×¡×¦× ×¨×™×• ×¢×™×‘×•×“ - ××” MAKE ×¦×¨×™×š ×œ×©×œ×•×£ ××”××¢×¨×›×ª - ×œ×›×œ ×ª×‘× ×™×ª!\n        const hasVehicles = vehicleRules &&\n                           vehicleRules.vehicle_account_mapping &&\n                           Object.keys(vehicleRules.vehicle_account_mapping).length > 0;\n\n        const allProcessingScenarios = [];\n        for (let i = 0; i < config.structure.length; i++) {\n            const templateStructure = config.structure[i];\n\n            // âœ¨ ×§×‘×™×¢×ª document_type ×œ×¤×™ ×”×ª×‘× ×™×ª\n            let documentTypeKey = \"regular_invoice\";\n            if (templateStructure.has_import && templateStructure.has_doc) {\n                documentTypeKey = \"import_with_docs_invoice\";\n            } else if (templateStructure.has_import) {\n                documentTypeKey = \"import_invoice\";\n            } else if (templateStructure.has_doc) {\n                documentTypeKey = \"docs_invoice\";\n            } else if (templateStructure.debit_type === \"C\") {\n                documentTypeKey = \"credit_note\";\n            } else if (hasVehicles) {\n                documentTypeKey = \"vehicle_service_invoice\";\n            }\n\n            allProcessingScenarios.push({\n                document_type: documentTypeKey,  // âœ¨ ×”×•×¡×¤×”!\n                check_docs: templateStructure.has_doc || false,\n                check_import: templateStructure.has_import || false,\n                check_vehicles: hasVehicles || false\n            });\n        }\n\n        const selectedProcessingScenario = allProcessingScenarios[templateIndex];\n\n        // âœ¨ ××‘× ×” ×—×“×©: supplier_code/name ×‘×¨××” ×¢×œ×™×•× ×”, ×”×›×œ ×”××—×¨ ×ª×—×ª all_templates\n        const supplierCode = config.supplier_config.supplier_code;\n        const supplierName = config.supplier_config.supplier_name;\n\n        // ×‘× ×™×™×ª all_templates ×¢×‘×•×¨ llm_prompt - ×¢× invoice_data!\n        const llmTemplates = allLlmPrompts.map((prompt, idx) => {\n            const { supplier_code, supplier_name, ...rest } = prompt;\n            return {\n                ...rest,\n                invoice_data: {\n                    PINVOICES: [allInvoices[idx]]\n                }\n            };\n        });\n\n        // ×‘× ×™×™×ª all_templates ×¢×‘×•×¨ technical_config\n        const technicalTemplates = allTechnicalConfigs.map(cfg => {\n            const { supplier_code, supplier_name, ...rest } = cfg;\n            return rest;\n        });\n\n        return {\n            status: \"success\",\n\n            // 1. ×”× ×—×™×•×ª ×œ-LLM - supplier_code/name ×‘×¨××” ×¢×œ×™×•× ×”, ×”×›×œ ×”××—×¨ ×ª×—×ª all_templates\n            llm_prompt: {\n                supplier_code: supplierCode,\n                supplier_name: supplierName,\n                all_templates: llmTemplates\n            },\n\n            // 2. ×§×•× ×¤×™×’ ×˜×›× ×™ - supplier_code/name ×‘×¨××” ×¢×œ×™×•× ×”, ×”×›×œ ×”××—×¨ ×ª×—×ª all_templates\n            technical_config: {\n                supplier_code: supplierCode,\n                supplier_name: supplierName,\n                all_templates: technicalTemplates\n            },\n\n            // 3. ×¡×¦× ×¨×™×• ×¢×™×‘×•×“ - supplier_code/name ×‘×¨××” ×¢×œ×™×•× ×”, ×”×›×œ ×”××—×¨ ×ª×—×ª all_templates\n            processing_scenario: {\n                supplier_code: supplierCode,\n                supplier_name: supplierName,\n                all_templates: allProcessingScenarios\n            }\n        };\n\n    } catch (error) {\n        return {\n            status: \"error\",\n            error_type: error.name || \"ProcessingError\",\n            message: error.message\n        };\n    }\n}\n\n// ============================================================================\n// ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ - ×©×œ×‘ 1\n// ============================================================================\n\nfunction checkImportExists(importFiles) {\n    if (!importFiles || !importFiles.IMPFILES) return false;\n    if (importFiles.IMPFILES.length === 0) return false;\n\n    try {\n        const parsed = JSON.parse('[' + importFiles.IMPFILES[0] + ']');\n        return parsed.length > 0 && !!parsed[0].IMPFNUM;\n    } catch (e) {\n        return false;\n    }\n}\n\nfunction checkDocsExist(docsList) {\n    if (!docsList || docsList.DOC_YES_NO !== \"Y\") return false;\n    return docsList.list_of_docs && docsList.list_of_docs.length > 0;\n}\n\nfunction checkDocsInOCR(ocrFields, azureText) {\n    const unidentified = ocrFields.UnidentifiedNumbers || [];\n    const docPattern = /^25\\d{6}$/;          // DOCNO pattern\n    const booknumPattern = /^108\\d{6}$/;     // BOOKNUM pattern\n\n    let foundInUnidentified = false;\n\n    if (unidentified.length > 0) {\n        if (typeof unidentified[0] === 'object' && unidentified[0].value) {\n            foundInUnidentified = unidentified.some(item =>\n                docPattern.test(item.value) || booknumPattern.test(item.value)\n            );\n        } else {\n            foundInUnidentified = unidentified.some(num =>\n                docPattern.test(num) || booknumPattern.test(num)\n            );\n        }\n    }\n\n    if (foundInUnidentified) return true;\n\n    if (azureText) {\n        // Search for both DOCNO and BOOKNUM patterns with word boundaries\n        const docMatches = azureText.match(/\\b25\\d{6}\\b/g);\n        const booknumMatches = azureText.match(/\\b108\\d{6}\\b/g);\n        if ((docMatches && docMatches.length > 0) || (booknumMatches && booknumMatches.length > 0)) {\n            return true;\n        }\n    }\n\n    return false;\n}\n\n// âœ¨ ×¤×•× ×§×¦×™×” ×—×“×©×”: ×–×™×”×•×™ ×“×™× ××™ ×©×œ ×ª×‘× ×™×•×ª ×ª×¢×•×“×•×ª\nfunction detectDocumentPatterns(ocrFields, azureText) {\n    const detected = {\n        booknum_found: [],\n        docno_found: [],\n        booknum_pattern: null,\n        docno_pattern: null,\n        guidance: \"\"\n    };\n\n    const unidentified = ocrFields.UnidentifiedNumbers || [];\n\n    // ×—×¤×© BOOKNUM ×‘-UnidentifiedNumbers\n    if (unidentified.length > 0) {\n        const values = typeof unidentified[0] === 'object'\n            ? unidentified.map(item => item.value).filter(v => v)\n            : unidentified;\n\n        // ×ª×‘× ×™×•×ª ××¤×©×¨×™×•×ª ×œ-BOOKNUM (107XXXXXX, 108XXXXXX, ×•×›×•')\n        values.forEach(val => {\n            if (/^10[78]\\d{6}$/.test(val)) {\n                detected.booknum_found.push(val);\n            }\n            if (/^25\\d{6}$/.test(val)) {\n                detected.docno_found.push(val);\n            }\n        });\n    }\n\n    // ×—×¤×© ×’× ×‘-AZURE_TEXT ×× ×œ× × ××¦× ×‘-UnidentifiedNumbers\n    if (detected.booknum_found.length === 0 && azureText) {\n        const booknumMatches = azureText.match(/\\b10[78]\\d{6}\\b/g);\n        if (booknumMatches) {\n            detected.booknum_found = [...new Set(booknumMatches)]; // unique values\n        }\n    }\n\n    if (detected.docno_found.length === 0 && azureText) {\n        const docnoMatches = azureText.match(/\\b25\\d{6}\\b/g);\n        if (docnoMatches) {\n            detected.docno_found = [...new Set(docnoMatches)];\n        }\n    }\n\n    // ×–×”×” ××ª ×”×ª×‘× ×™×ª ×”××“×•×™×§×ª ×¢×œ ×¤×™ ××” ×©× ××¦×\n    if (detected.booknum_found.length > 0) {\n        const firstBooknum = detected.booknum_found[0];\n        const prefix = firstBooknum.substring(0, 3); // 107 ××• 108\n\n        detected.booknum_pattern = `\\\\b(${prefix}\\\\d{6})\\\\b`;\n        detected.guidance = `ğŸ” ×–×•×”×ª×” ×ª×‘× ×™×ª BOOKNUM: ${prefix}XXXXXX (${detected.booknum_found.length} ×“×•×’×××•×ª: ${detected.booknum_found.slice(0, 3).join(', ')})`;\n\n        console.log(`âœ¨ ${detected.guidance}`);\n    }\n\n    if (detected.docno_found.length > 0) {\n        detected.docno_pattern = `\\\\b(25\\\\d{6})\\\\b`;\n        console.log(`âœ¨ ×–×•×”×ª×” ×ª×‘× ×™×ª DOCNO: 25XXXXXX (${detected.docno_found.length} ×“×•×’×××•×ª: ${detected.docno_found.slice(0, 3).join(', ')})`);\n    }\n\n    return detected;\n}\n\nfunction identifyDebitType(ocrFields) {\n    const total = ocrFields.InvoiceTotal || ocrFields.InvoiceTotal_amount || 0;\n    return total >= 0 ? \"D\" : \"C\";\n}\n\nfunction findMatchingTemplate(structures, hasImport, hasDocs, debitType) {\n    return structures.findIndex(s =>\n        s.has_import === hasImport &&\n        s.has_doc === hasDocs &&\n        s.debit_type === debitType\n    );\n}\n\n// ============================================================================\n// ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ - ×©×œ×‘ 2\n// ============================================================================\n\nfunction extractPatterns(recommendedSamples, docsList) {\n    const patterns = {\n        booknum_pattern: null,\n        ivnum_pattern: null,\n        docs_pattern: null,\n        docs_totquant: {}\n    };\n\n    if (recommendedSamples && recommendedSamples.samples && recommendedSamples.samples.length > 0) {\n        const sample = recommendedSamples.samples[0];\n\n        if (sample.sample_booknum) {\n            patterns.booknum_pattern = {\n                length: sample.sample_booknum.length,\n                example: sample.sample_booknum\n            };\n        }\n\n        if (sample.sample_ivnum) {\n            patterns.ivnum_pattern = {\n                length: sample.sample_ivnum.length,\n                example: sample.sample_ivnum\n            };\n        }\n    }\n\n    if (docsList && docsList.list_of_docs && docsList.list_of_docs.length > 0) {\n        try {\n            const docs = docsList.list_of_docs.map(d => JSON.parse(d));\n\n            if (docs.length > 0) {\n                const firstDoc = docs[0];\n                patterns.docs_pattern = {\n                    booknum_example: firstDoc.BOOKNUM,\n                    docno_example: firstDoc.DOCNO\n                };\n\n                docs.forEach(doc => {\n                    if (doc.TOTQUANT) {\n                        patterns.docs_totquant[doc.BOOKNUM] = doc.TOTQUANT;\n                    }\n                });\n            }\n        } catch (e) {\n            // ×©×’×™××” ×‘×¤×¨×¡×•×¨\n        }\n    }\n\n    return patterns;\n}\n\n// ============================================================================\n// ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ - ×©×œ×‘ 3\n// ============================================================================\n\nfunction searchAllData(ocrFields, azureText, patterns, structure, importFiles, docsList, vehicleRules) {\n    return {\n        booknum: searchBooknum(ocrFields, patterns),\n        ivdate: searchIvdate(ocrFields),\n        details: searchDetails(ocrFields, azureText),\n        ordname: structure.has_purchase_orders || structure.has_import ? searchOrdname(ocrFields) : null,\n        impfnum: structure.has_import ? searchImpfnum(ocrFields, importFiles) : null,\n        documents: structure.has_doc ? searchDocuments(ocrFields, azureText, patterns, docsList) : null,\n        vehicles: vehicleRules ? extractVehiclesAdvanced(ocrFields, vehicleRules, azureText) : [],  // âœ¨ ×—×“×©! + fallback ×œ-AZURE_TEXT\n        items: ocrFields.Items || []\n    };\n}\n\nfunction searchBooknum(ocrFields, patterns) {\n    let booknum = ocrFields.InvoiceId || \"\";\n\n    booknum = String(booknum).replace(/^SI/i, '');\n\n    if (patterns.booknum_pattern) {\n        const expectedLength = patterns.booknum_pattern.length;\n        if (booknum.length > expectedLength) {\n            booknum = booknum.slice(-expectedLength);\n        }\n    }\n\n    return booknum;\n}\n\nfunction searchIvdate(ocrFields) {\n    const isoDate = ocrFields.InvoiceDate;\n    if (!isoDate) return \"\";\n\n    const date = new Date(isoDate);\n    const day = String(date.getDate()).padStart(2, '0');\n    const month = String(date.getMonth() + 1).padStart(2, '0');\n    const year = String(date.getFullYear()).slice(-2);\n\n    return `${day}/${month}/${year}`;\n}\n\nfunction searchDetails(ocrFields, azureText) {\n    if (ocrFields.InvoiceDescription) {\n        return ocrFields.InvoiceDescription;\n    }\n\n    if (azureText) {\n        const lines = azureText.split('\\n').filter(l => l.trim());\n        if (lines.length > 2) {\n            return lines[2].substring(0, 100);\n        }\n    }\n\n    return \"\";\n}\n\nfunction searchOrdname(ocrFields) {\n    const unidentified = ocrFields.UnidentifiedNumbers || [];\n    const ordPattern = /^\\d{10}$/;\n    let found = \"\";\n\n    if (unidentified.length > 0) {\n        if (typeof unidentified[0] === 'object' && unidentified[0].value) {\n            const orderItem = unidentified.find(item =>\n                item.label && (\n                    item.label.includes('×”×–×× ×”') ||\n                    item.label.toLowerCase().includes('order') ||\n                    item.label.toLowerCase().includes('po')\n                ) && ordPattern.test(item.value)\n            );\n\n            if (orderItem) {\n                found = orderItem.value;\n            } else {\n                const anyOrder = unidentified.find(item =>\n                    ordPattern.test(item.value)\n                );\n                found = anyOrder ? anyOrder.value : \"\";\n            }\n        } else {\n            const match = unidentified.find(num => ordPattern.test(num));\n            found = match || \"\";\n        }\n    }\n\n    return found;\n}\n\nfunction searchImpfnum(ocrFields, importFiles) {\n    const unidentified = ocrFields.UnidentifiedNumbers || [];\n    const impPattern = /^\\d{2}c\\d{5}$/;\n    let foundInOCR = \"\";\n\n    if (unidentified.length > 0) {\n        if (typeof unidentified[0] === 'object' && unidentified[0].value) {\n            const importItem = unidentified.find(item =>\n                item.label && (\n                    item.label.includes('×™×‘×•×') ||\n                    item.label.toLowerCase().includes('import') ||\n                    item.label.includes('IMPFNUM')\n                ) && impPattern.test(item.value)\n            );\n\n            if (importItem) {\n                foundInOCR = importItem.value;\n            } else {\n                const anyImport = unidentified.find(item =>\n                    impPattern.test(item.value)\n                );\n                foundInOCR = anyImport ? anyImport.value : \"\";\n            }\n        } else {\n            const match = unidentified.find(num => impPattern.test(num));\n            foundInOCR = match || \"\";\n        }\n    }\n\n    if (foundInOCR) return foundInOCR;\n\n    if (importFiles && importFiles.IMPFILES && importFiles.IMPFILES.length > 0) {\n        try {\n            const parsed = JSON.parse('[' + importFiles.IMPFILES[0] + ']');\n            if (parsed.length > 0 && parsed[0].IMPFNUM) {\n                return parsed[0].IMPFNUM;\n            }\n        } catch (e) {\n            // ×××©×™×›×™× ×‘×œ×™\n        }\n    }\n\n    return \"\";\n}\n\nfunction searchDocuments(ocrFields, azureText, patterns, docsList) {\n    const foundDocs = [];\n\n    if (!docsList || !docsList.list_of_docs || docsList.list_of_docs.length === 0) {\n        return foundDocs;\n    }\n\n    let availableDocs = [];\n    try {\n        // ×ª×™×§×•×Ÿ: flatMap ×›×“×™ ×œ×©×˜×— ××¢×¨×›×™× ××§×•× × ×™×\n        availableDocs = docsList.list_of_docs.flatMap(d => JSON.parse(d));\n    } catch (e) {\n        return foundDocs;\n    }\n\n    const unidentified = ocrFields.UnidentifiedNumbers || [];\n\n    if (unidentified.length > 0) {\n        if (typeof unidentified[0] === 'object' && unidentified[0].value) {\n            for (const item of unidentified) {\n                const match = availableDocs.find(doc => doc.BOOKNUM === item.value);\n\n                if (match) {\n                    foundDocs.push({\n                        DOCNO: match.DOCNO,\n                        BOOKNUM: match.BOOKNUM,\n                        TOTQUANT: match.TOTQUANT || null\n                    });\n                }\n            }\n        } else {\n            for (const num of unidentified) {\n                const match = availableDocs.find(doc => doc.BOOKNUM === num);\n\n                if (match) {\n                    foundDocs.push({\n                        DOCNO: match.DOCNO,\n                        BOOKNUM: match.BOOKNUM,\n                        TOTQUANT: match.TOTQUANT || null\n                    });\n                }\n            }\n        }\n    }\n\n    // Fallback: ×× ×œ× × ××¦× ×‘-UnidentifiedNumbers, ×—×¤×© ×‘-AZURE_TEXT\n    if (foundDocs.length === 0 && azureText) {\n        for (const doc of availableDocs) {\n            // ×©×™×¤×•×¨: ×—×™×¤×•×© ×¢× regex ×‘××§×•× includes (××“×•×™×§ ×™×•×ª×¨)\n            // ×ª×‘× ×™×ª: ×’×‘×•×œ ××™×œ×” + BOOKNUM + ×’×‘×•×œ ××™×œ×” (×›×“×™ ×œ×× ×•×¢ ×”×ª×××” ×—×œ×§×™×ª)\n            const pattern = new RegExp('\\\\b' + doc.BOOKNUM + '\\\\b');\n            if (pattern.test(azureText)) {\n                foundDocs.push({\n                    DOCNO: doc.DOCNO,\n                    BOOKNUM: doc.BOOKNUM,\n                    TOTQUANT: doc.TOTQUANT || null\n                });\n            }\n        }\n    }\n\n    // âœ¨ ×—×“×©! Fallback 2: ×”×ª×××” ×œ×¤×™ ×›××•×™×•×ª ×›×©×”OCR ×œ× ××¦× ×ª×¢×•×“×•×ª\n    if (foundDocs.length === 0 && ocrFields.Items && ocrFields.Items.length > 0) {\n        const totalOcrQuantity = ocrFields.Items.reduce((sum, item) => sum + (item.Quantity || 0), 0);\n\n        if (totalOcrQuantity > 0) {\n            // ×¤×•× ×§×¦×™×™×ª ×¢×–×¨ ×œ×”×©×•×•××ª ×›××•×™×•×ª ×¢× ×¡×•×‘×œ× ×•×ª\n            const isQuantityMatch = (qty1, qty2) => {\n                if (qty1 === qty2) return true;\n                const tolerance = Math.min(Math.abs(qty1 * 0.005), 10);\n                return Math.abs(qty1 - qty2) <= tolerance;\n            };\n\n            // × ×¡×” ×œ××¦×•× ×ª×¢×•×“×” ×‘×•×“×“×ª ×©××ª××™××” (×¢× ×¡×•×‘×œ× ×•×ª)\n            const singleMatch = availableDocs.find(doc => isQuantityMatch(doc.TOTQUANT, totalOcrQuantity));\n            if (singleMatch) {\n                foundDocs.push({\n                    DOCNO: singleMatch.DOCNO,\n                    BOOKNUM: singleMatch.BOOKNUM,\n                    TOTQUANT: singleMatch.TOTQUANT || null\n                });\n            }\n            // ×× ×œ× × ××¦× ×ª×¢×•×“×” ×‘×•×“×“×ª, × ×¡×” ×œ×—×¤×© ×§×•××‘×™× ×¦×™×” ×©×œ ××¡×¤×¨ ×ª×¢×•×“×•×ª\n            else {\n                const matchedDocs = findDocCombinationByQuantity(totalOcrQuantity, availableDocs);\n                if (matchedDocs.length > 0) {\n                    foundDocs.push(...matchedDocs);\n                }\n            }\n        }\n    }\n\n    return foundDocs;\n}\n\n// ============================================================================\n// âœ¨ ×—×“×©! ×¤×•× ×§×¦×™×” ×œ××¦×™××ª ×§×•××‘×™× ×¦×™×” ×©×œ ×ª×¢×•×“×•×ª ×œ×¤×™ ×›××•×ª\n// ============================================================================\n\nfunction findDocCombinationByQuantity(targetQuantity, availableDocs) {\n    // ×× ××™×Ÿ ×ª×¢×•×“×•×ª ××• ×›××•×ª ×™×¢×“ ×œ× ×ª×§×™× ×”\n    if (!availableDocs || availableDocs.length === 0 || targetQuantity <= 0) {\n        return [];\n    }\n\n    // ×¤×•× ×§×¦×™×™×ª ×¢×–×¨ ×œ×”×©×•×•××ª ×›××•×™×•×ª ×¢× ×¡×•×‘×œ× ×•×ª ×§×˜× ×”\n    const isQuantityMatch = (qty1, qty2) => {\n        // ×”×ª×××” ××“×•×™×§×ª\n        if (qty1 === qty2) return true;\n\n        // ×¡×•×‘×œ× ×•×ª ×©×œ 0.5% ××• 10 ×™×—×™×“×•×ª (×”×§×˜×Ÿ ××‘×™× ×™×”×)\n        const tolerance = Math.min(Math.abs(qty1 * 0.005), 10);\n        return Math.abs(qty1 - qty2) <= tolerance;\n    };\n\n    // × ×¡×” ×›×œ ×§×•××‘×™× ×¦×™×” ××¤×©×¨×™×ª (×¢×“ 4 ×ª×¢×•×“×•×ª ××§×¡×™××•×)\n    const maxCombinationSize = Math.min(4, availableDocs.length);\n\n    for (let size = 2; size <= maxCombinationSize; size++) {\n        const combinations = getCombinations(availableDocs, size);\n\n        for (const combo of combinations) {\n            const comboTotal = combo.reduce((sum, doc) => sum + (doc.TOTQUANT || 0), 0);\n\n            if (isQuantityMatch(comboTotal, targetQuantity)) {\n                // × ××¦××” ×§×•××‘×™× ×¦×™×” ××ª××™××”!\n                return combo.map(doc => ({\n                    DOCNO: doc.DOCNO,\n                    BOOKNUM: doc.BOOKNUM,\n                    TOTQUANT: doc.TOTQUANT || null\n                }));\n            }\n        }\n    }\n\n    return [];\n}\n\n// ×¤×•× ×§×¦×™×™×ª ×¢×–×¨ ×œ×—×™×©×•×‘ ×§×•××‘×™× ×¦×™×•×ª\nfunction getCombinations(array, size) {\n    if (size === 1) {\n        return array.map(item => [item]);\n    }\n\n    const combinations = [];\n\n    for (let i = 0; i < array.length - size + 1; i++) {\n        const head = array[i];\n        const tailCombos = getCombinations(array.slice(i + 1), size - 1);\n\n        for (const combo of tailCombos) {\n            combinations.push([head, ...combo]);\n        }\n    }\n\n    return combinations;\n}\n\n// ============================================================================\n// âœ¨ ×—×“×©! ×¤×•× ×§×¦×™×•×ª ×—×™×œ×•×¥ ×¨×›×‘×™× ××ª×§×“×\n// ============================================================================\n\nfunction extractVehiclesAdvanced(ocrFields, vehicleRules, azureText) {\n    // ×ª×™×§×•×Ÿ: ×‘×“×•×§ ×× ×™×© vehicle_account_mapping ×‘××§×•× enabled\n    if (!vehicleRules || !vehicleRules.vehicle_account_mapping) return [];\n\n    const foundVehicles = [];\n    // ×ª×™×§×•×Ÿ: ×× ××™×Ÿ search_locations, ×”×©×ª××© ×‘×‘×¨×™×¨×ª ××—×“×œ\n    const searchLocations = vehicleRules.search_locations || [\n        {\n            location: \"fields.UnidentifiedNumbers\",\n            priority: 1,\n            filter_by_label: \"×¨×›×‘\",\n            description: \"×—×™×¤×•×© ×¨×›×‘×™× ×‘-UnidentifiedNumbers ×¢× ×ª×•×•×™×ª ×¨×›×‘\"\n        }\n    ];\n\n    // ×¡×“×¨ ×œ×¤×™ ×¢×“×™×¤×•×ª\n    const sortedLocations = [...searchLocations].sort((a, b) => a.priority - b.priority);\n\n    for (const location of sortedLocations) {\n        if (location.location === \"fields.VehicleNumbers\") {\n            // 1. ×¨×©×™××” ××•×›× ×” ×××–'×•×¨\n            if (ocrFields.VehicleNumbers && Array.isArray(ocrFields.VehicleNumbers)) {\n                ocrFields.VehicleNumbers.forEach(vNum => {\n                    if (!foundVehicles.includes(vNum)) {\n                        foundVehicles.push(vNum);\n                    }\n                });\n            }\n        }\n        else if (location.location === \"fields.Items[].VehicleNumber\") {\n            // 2. ×§×™×©×•×¨ ×™×©×™×¨ ×‘×¤×¨×™×˜\n            if (ocrFields.Items && Array.isArray(ocrFields.Items)) {\n                ocrFields.Items.forEach(item => {\n                    if (item.VehicleNumber && !foundVehicles.includes(item.VehicleNumber)) {\n                        foundVehicles.push(item.VehicleNumber);\n                    }\n                });\n            }\n        }\n        else if (location.location === \"fields.Items[].Description\" && location.pattern) {\n            // 3. ×—×™×¤×•×© ×‘×ª×™××•×¨ ×œ×¤×™ ×“×¤×•×¡\n            if (ocrFields.Items && Array.isArray(ocrFields.Items)) {\n                const pattern = new RegExp(location.pattern);\n                ocrFields.Items.forEach(item => {\n                    if (item.Description) {\n                        const match = item.Description.match(pattern);\n                        if (match && match[0] && !foundVehicles.includes(match[0])) {\n                            foundVehicles.push(match[0]);\n                        }\n                    }\n                });\n            }\n        }\n        else if (location.location === \"fields.UnidentifiedNumbers\") {\n            // 4. ××¡×¤×¨×™× ×œ× ××–×•×”×™×\n            const unidentified = ocrFields.UnidentifiedNumbers || [];\n            const vehiclePattern = /\\d{3}-\\d{2}-\\d{3}/;\n\n            unidentified.forEach(item => {\n                const value = typeof item === 'object' ? item.value : item;\n                const label = typeof item === 'object' ? (item.label || '') : '';\n                const context = typeof item === 'object' ? (item.context || '') : '';\n\n                // ×ª×™×§×•×Ÿ: ×’× ×× ×™×© ×ª×•×•×™×ª \"×¨×›×‘\", ×—×™×™×‘ ×œ×”×ª××™× ×œ×“×¤×•×¡ ××¡×¤×¨ ×¨×›×‘!\n                // ×–×” ××•× ×¢ ×˜×¢×•×™×•×ª ×©×œ Azure OCR ×©××¡××Ÿ ××¡×¤×¨ ×›×¨×˜×™×¡ ×‘×ª×•×¨ \"××¡×¤×¨ ×¨×›×‘\"\n                const isValidVehicleNumber = vehiclePattern.test(value);\n\n                // ×‘×“×™×§×” × ×•×¡×¤×ª: ×× ×‘×”×§×©×¨ ×›×ª×•×‘ \"×›×¨×˜×™×¡\", ×–×” ×œ× ×¨×›×‘\n                const looksLikeCardNumber = context.includes('×›×¨×˜×™×¡') || label.includes('×›×¨×˜×™×¡');\n\n                // ×× ×™×© filter_by_label - ×¨×§ ×¢× ×”×ª×•×•×™×ª ×”×–×• ×•×’× ×“×¤×•×¡ ×ª×§×™×Ÿ\n                if (location.filter_by_label) {\n                    if (label && label.includes(location.filter_by_label)) {\n                        // ×ª×™×§×•×Ÿ: ×’× ×¢× ×ª×•×•×™×ª ×¨×›×‘, ×—×™×™×‘ ×“×¤×•×¡ ×ª×§×™×Ÿ ×•×œ× ×œ×”×™×•×ª ××¡×•××Ÿ ×›×›×¨×˜×™×¡\n                        if (isValidVehicleNumber && !looksLikeCardNumber && !foundVehicles.includes(value)) {\n                            foundVehicles.push(value);\n                        }\n                    }\n                } else {\n                    // ××—×¨×ª - ×œ×¤×™ ×“×¤×•×¡ ×¨×›×‘ ×‘×œ×‘×“\n                    if (isValidVehicleNumber && !looksLikeCardNumber && !foundVehicles.includes(value)) {\n                        foundVehicles.push(value);\n                    }\n                }\n            });\n        }\n    }\n\n    // âœ¨ ×—×“×©! ×× ×œ× × ××¦××• ×¨×›×‘×™×, ×—×¤×© ×’× ×‘-AZURE_TEXT\n    if (foundVehicles.length === 0 && azureText) {\n        console.log(\"âš ï¸  ×œ× × ××¦××• ×¨×›×‘×™× ×‘××§×•××•×ª ×”××•×‘× ×™× - ××—×¤×© ×‘-AZURE_TEXT...\");\n        const vehiclePattern = /\\d{3}-\\d{2}-\\d{3}/g;\n        const matches = azureText.match(vehiclePattern) || [];\n\n        matches.forEach(match => {\n            if (!foundVehicles.includes(match)) {\n                // ×‘×“×•×§ ×©×–×” ×œ× ××•×¤×™×¢ ×œ×™×“ ×”××™×œ×” \"×›×¨×˜×™×¡\"\n                const contextStart = Math.max(0, azureText.indexOf(match) - 20);\n                const contextEnd = Math.min(azureText.length, azureText.indexOf(match) + match.length + 20);\n                const context = azureText.substring(contextStart, contextEnd);\n\n                if (!context.includes('×›×¨×˜×™×¡')) {\n                    foundVehicles.push(match);\n                    console.log(`âœ… × ××¦× ×¨×›×‘ ×‘-AZURE_TEXT: ${match}`);\n                }\n            }\n        });\n    }\n\n    if (foundVehicles.length > 0) {\n        console.log(`ğŸš— ×¡×”\"×› × ××¦××• ${foundVehicles.length} ×¨×›×‘×™×:`, foundVehicles);\n    }\n\n    return [...new Set(foundVehicles)]; // ×™×™×—×•×“×™×™× ×‘×œ×‘×“\n}\n\nfunction createVehicleItems(vehicles, ocrItems, vehicleRules, ocrFields) {\n    if (!vehicles || vehicles.length === 0) return [];\n\n    const vehicleItems = [];\n\n    // ×ª×™×§×•×Ÿ: ××—×™×¨ = ×¡×›×•× ×›×œ ×”×—×©×‘×•× ×™×ª (×œ×¤× ×™ ××¢\"×)\n    // ×—×™×©×•×‘: InvoiceTotal - TotalTax = ×¡×”\"×› ×œ×¤× ×™ ××¢\"× (×¢×‘×•×“×•×ª + ×—×œ×§×™×)\n    const totalPrice = ocrFields.TotalTax_amount\n        ? (ocrFields.InvoiceTotal_amount || 0) - ocrFields.TotalTax_amount\n        : (ocrFields.SubTotal_amount || ocrFields.InvoiceTotal_amount || 0);\n    const pricePerVehicle = vehicles.length > 0 ? totalPrice / vehicles.length : totalPrice;\n\n    vehicles.forEach(vehicleNum => {\n        // ×—×™×¤×•×© ××™×¤×•×™ ×‘×—×•×§×™×\n        const mapping = vehicleRules.vehicle_account_mapping?.[vehicleNum];\n\n        // ×—×™×¤×•×© ×ª×™××•×¨ ××”×¤×¨×™×˜×™× ×©×œ OCR\n        const relatedItem = ocrItems.find(item =>\n            (item.VehicleNumber && item.VehicleNumber === vehicleNum) ||\n            (item.Description && item.Description.includes(vehicleNum))\n        );\n\n        // ×ª×™×§×•×Ÿ: ×ª×™××•×¨ ×§×¦×¨ ×‘×œ×‘×“\n        const shortDesc = extractShortDescription(ocrFields, vehicleNum);\n\n        // âœ¨ ×‘× ×™×™×ª ×¤×¨×™×˜ - ×¨×§ ×©×“×•×ª ×©Priority ××›×™×¨!\n        const item = {\n            PARTNAME: vehicleRules.output_format?.partname || \"car\",\n            PDES: shortDesc,\n            TQUANT: relatedItem?.Quantity || 1,\n            TUNITNAME: relatedItem?.Unit || \"×™×—'\",\n            PRICE: pricePerVehicle,\n            VATFLAG: mapping?.vat_pattern?.VATFLAG || \"Y\",\n            ACCNAME: mapping?.accname || vehicleRules.default_values?.accname || \"\"\n        };\n\n        // âœ¨ BUDCODE - ×‘×™× ×ª×™×™× ×¨×™×§ (×œ×•×’×™×§×” ×œ× ×××•×¤×™×™× ×ª)\n\n        // âœ¨ SPECIALVATFLAG - ×¨×§ ×× ×–×” Y (×œ× ×©×“×•×ª ××—×¨×™×!)\n        if (mapping?.vat_pattern?.SPECIALVATFLAG === \"Y\") {\n            item.SPECIALVATFLAG = \"Y\";\n        }\n\n        // ×©××•×¨ ××™×“×¢ ×œ××™×“×” ×‘× ×¤×¨×“ (×œ× × ×©×œ×— ×œ-Priority!)\n        if (!mapping) {\n            // ×¨×§ ×œ×¦×¨×›×™ ×“×™×•×•×— ×•×œ××™×“×” - ×œ× ×™×©×œ×— ×‘-JSON ×”×¡×•×¤×™\n            item._learningNote = \"×¨×›×‘ ×—×“×© - × ×“×¨×© ××™×¤×•×™\";\n        }\n\n        vehicleItems.push(item);\n    });\n\n    return vehicleItems;\n}\n\n// ============================================================================\n// ×¤×•× ×§×¦×™×™×ª ×¢×–×¨ - ×—×™×œ×•×¥ ×ª×™××•×¨ ×§×¦×¨\n// ============================================================================\n\nfunction extractShortDescription(ocrFields, vehicleNum) {\n    // ×—×™×¤×•×© ×ª×™××•×¨ ×§×¦×¨ ××”×¤×¨×™×˜×™×\n    if (ocrFields.Items && ocrFields.Items.length > 0) {\n        // ×—×¤×© ×¤×¨×™×˜ ×©××›×™×œ ×ª×™××•×¨ ×¨×œ×•×•× ×˜×™\n        const item = ocrFields.Items.find(i =>\n            i.Description && (\n                i.Description.includes(vehicleNum) ||\n                i.Description.includes('×˜×™×¤×•×œ') ||\n                i.Description.includes('×¢×‘×•×“×”')\n            )\n        );\n\n        if (item && item.Description) {\n            const desc = item.Description.trim();\n\n            // ×ª×™×§×•×Ÿ ×—×“×©: ×—×¤×© ×“×¤×•×¡ \"×˜×™×¤×•×œ XXX ×§\\\"×\" ××• \"×˜×™×¤×•×œ XXX,XXX ×§\\\"×\"\n            // ×“×¤×•×¡: \"×˜×™×¤×•×œ\" + ××¡×¤×¨ (×¢× ××• ×‘×œ×™ ×¤×¡×™×§) + \"×§\\\"×\" ××• \"×§×\"\n            const servicePattern = /×˜×™×¤×•×œ\\s+[\\d,]+\\s*×§[×´\"]?×/i;\n            const match = desc.match(servicePattern);\n\n            if (match) {\n                // × ××¦× ×“×¤×•×¡ ×˜×™×¤×•×œ - × ×§×” ××•×ª×• ×•× ×—×–×™×¨\n                let serviceDesc = match[0];\n                // ×”××¨ \"×§×\" ×œ-\"×§\"×\" ×•×”×¡×¨ ×¤×¡×™×§×™× ××”××¡×¤×¨\n                serviceDesc = serviceDesc\n                    .replace(/,/g, '')          // ×”×¡×¨ ×¤×¡×™×§×™×\n                    .replace(/×§×/g, '×§\"×')      // ×ª×§× ×Ÿ ××ª \"×§×\" ×œ-\"×§\"×\"\n                    .replace(/×§×´×/g, '×§\"×');   // ×ª×§× ×Ÿ ××ª ×´ ×œ-\"\n\n                return serviceDesc;\n            }\n\n            // ×× ×œ× × ××¦× ×“×¤×•×¡ ×˜×™×¤×•×œ - ×—×¤×© ×ª×™××•×¨×™× ××—×¨×™× (×”×—×œ×¤×”, ×ª×™×§×•×Ÿ, ×‘×“×™×§×”)\n            const generalPattern = /(×”×—×œ×¤×ª|×ª×™×§×•×Ÿ|×‘×“×™×§×ª|×”×—[''×³])\\s+[\\u0590-\\u05FF\\s]+/;\n            const generalMatch = desc.match(generalPattern);\n\n            if (generalMatch) {\n                // ×§×— ×¢×“ 50 ×ª×•×•×™× ××”×ª×™××•×¨\n                let shortDesc = generalMatch[0].trim();\n                if (shortDesc.length > 50) {\n                    shortDesc = shortDesc.substring(0, 47) + '...';\n                }\n                return shortDesc;\n            }\n\n            // ×× ××™×Ÿ ×“×¤×•×¡ ××™×•×—×“ - ×§×— ××ª 3-4 ×”××™×œ×™× ×”×¨××©×•× ×•×ª\n            const words = desc.split(/\\s+/);\n            let shortDesc = words.slice(0, 4).join(' ');\n\n            if (shortDesc.length > 50) {\n                shortDesc = shortDesc.substring(0, 47) + '...';\n            }\n\n            return shortDesc;\n        }\n    }\n\n    // ×× ×œ× ××¦×× ×• ×ª×™××•×¨ - ×”×—×–×¨ ×‘×¨×™×¨×ª ××—×“×œ\n    return '×˜×™×¤×•×œ';\n}\n\n// ============================================================================\n// ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ - ×©×œ×‘ 4\n// ============================================================================\n\nfunction buildInvoiceFromTemplate(template, structure, config, searchResults, learnedConfig, ocrFields, docsList) {\n    const invoice = {\n        SUPNAME: config.supplier_config.supplier_code,\n        CODE: template.CODE,\n        DEBIT: structure.debit_type,\n        IVDATE: searchResults.ivdate,\n        BOOKNUM: searchResults.booknum\n    };\n\n    if (searchResults.ordname) {\n        invoice.ORDNAME = searchResults.ordname;\n    }\n\n    if (searchResults.impfnum) {\n        invoice.IMPFNUM = searchResults.impfnum;\n    }\n\n    // ×ª×™×§×•×Ÿ: DETAILS - ×™×¦×™×¨×” ×—×›××” ×œ×¤×™ ×¨×›×‘×™×\n    if (searchResults.vehicles && searchResults.vehicles.length > 0) {\n        // ×× ×™×© ×¨×›×‘×™× - ×‘× ×” DETAILS ×¢× ×ª×™××•×¨ ×˜×™×¤×•×œ + ×§\"× × ×•×›×—×™\n        const vehicleNum = searchResults.vehicles[0];\n        const shortDesc = extractShortDescription(ocrFields, vehicleNum);\n\n        // ×—×™×¤×•×© ×§\"× × ×•×›×—×™ ××”-UnidentifiedNumbers ××• CustomerId\n        let currentMileage = '';\n\n        // × ×¡×” ×œ××¦×•× ×§\"× ×‘-UnidentifiedNumbers\n        const unidentified = ocrFields.UnidentifiedNumbers || [];\n        if (unidentified.length > 0) {\n            const mileageItem = unidentified.find(item => {\n                if (typeof item === 'object') {\n                    const label = item.label || '';\n                    const value = item.value || '';\n                    // ×—×¤×© ×ª×•×•×™×ª \"×§\\\"×\" ××• ××¡×¤×¨ ×‘×™×Ÿ 50000-300000 (×˜×•×•×— ×¡×‘×™×¨ ×œ×§\"×)\n                    if (label.includes('×§') || label.includes('×§×') || label.includes('×')) {\n                        return /^\\d{5,6}$/.test(value);\n                    }\n                }\n                return false;\n            });\n\n            if (mileageItem && typeof mileageItem === 'object') {\n                currentMileage = mileageItem.value;\n            }\n        }\n\n        // ×× ×œ× × ××¦×, × ×¡×” CustomerId (×œ×¤×¢××™× Azure ××–×”×” ××ª ×§\"× ×›-CustomerId)\n        if (!currentMileage && ocrFields.CustomerId && /^\\d{5,6}$/.test(ocrFields.CustomerId)) {\n            currentMileage = ocrFields.CustomerId;\n        }\n\n        // ×‘× ×” DETAILS ×œ×¤×™ ×”×¤×•×¨××˜: \"×ª×™××•×¨ ×˜×™×¤×•×œ-XXXXX×§\\\"×\"\n        invoice.DETAILS = currentMileage ? `${shortDesc}-${currentMileage}` : shortDesc;\n    } else if (searchResults.details) {\n        // ××—×¨×ª - ×”×©×ª××© ×‘-DETAILS ×”×¨×’×™×œ\n        invoice.DETAILS = searchResults.details;\n    }\n\n    // ×ª×¢×•×“×•×ª\n    if (structure.has_doc) {\n        // ×× ××¦×× ×• ×ª×¢×•×“×•×ª ×‘-OCR - ×”×©×ª××© ×‘×”×Ÿ\n        if (searchResults.documents && searchResults.documents.length > 0) {\n            if (searchResults.documents.length === 1) {\n                invoice.DOCNO = searchResults.documents[0].DOCNO;\n            } else {\n                invoice.PIVDOC_SUBFORM = searchResults.documents.map(d => ({\n                    DOCNO: d.DOCNO,\n                    BOOKNUM: d.BOOKNUM\n                }));\n            }\n        }\n        // ×× ×œ× ××¦×× ×• ×‘-OCR ××‘×œ ×™×© ×‘-docs_list - ×§×— ×-docs_list\n        else if (docsList && docsList.DOC_YES_NO === \"Y\" && docsList.list_of_docs && docsList.list_of_docs.length > 0) {\n            try {\n                const docs = docsList.list_of_docs.flatMap(d => JSON.parse(d));\n                if (docs.length === 1) {\n                    invoice.DOCNO = docs[0].DOCNO;\n                } else if (docs.length > 1) {\n                    invoice.PIVDOC_SUBFORM = docs.map(d => ({\n                        DOCNO: d.DOCNO,\n                        BOOKNUM: d.BOOKNUM\n                    }));\n                }\n            } catch (e) {\n                // ×× ×™×© ×©×’×™××ª parsing, ×”××©×š ×‘×œ×™ ×ª×¢×•×“×•×ª\n            }\n        }\n    }\n\n    // ×¤×¨×™×˜×™×\n    const needItems = shouldAddItems(structure, searchResults.documents, docsList);\n\n    if (needItems) {\n        const vehicleRules = config.rules?.critical_patterns?.vehicle_rules;\n\n        // âœ¨ ×—×“×©! ×× ×™×© ×¨×›×‘×™× - ×™×•×¦×¨×™× ×¤×¨×™×˜×™ ×¨×›×‘×™×\n        if (searchResults.vehicles && searchResults.vehicles.length > 0 && vehicleRules) {\n            invoice.PINVOICEITEMS_SUBFORM = createVehicleItems(\n                searchResults.vehicles,\n                searchResults.items,\n                vehicleRules,\n                ocrFields  // ×ª×™×§×•×Ÿ: ×”×¢×‘×¨×ª ocrFields\n            );\n        }\n        // ××—×¨×ª - ×¤×¨×™×˜×™× ×¨×’×™×œ×™× ×-OCR\n        else if (searchResults.items && searchResults.items.length > 0) {\n            invoice.PINVOICEITEMS_SUBFORM = buildItems(\n                searchResults.items,\n                config,\n                structure,\n                template,\n                learnedConfig\n            );\n        }\n    }\n\n    if (template.PINVOICESCONT_SUBFORM) {\n        invoice.PINVOICESCONT_SUBFORM = template.PINVOICESCONT_SUBFORM;\n    }\n\n    return invoice;\n}\n\nfunction shouldAddItems(structure, documents, docsList) {\n    // ×× ××™×Ÿ ×ª×¢×•×“×•×ª ×‘×›×œ×œ ×‘×ª×‘× ×™×ª â†’ ×¦×¨×™×š ×¤×¨×™×˜×™×\n    if (!structure.has_doc) return true;\n\n    // ×‘×“×•×§ ×× ×™×© ×ª×¢×•×“×•×ª ×‘×¤×•×¢×œ (×‘-OCR ××• ×‘-docs_list)\n    const hasDocsInOCR = documents && documents.length > 0;\n    const hasDocsInList = docsList && docsList.DOC_YES_NO === \"Y\";\n    const hasDocsActually = hasDocsInOCR || hasDocsInList;\n\n    // ×× ×”×ª×‘× ×™×ª ××•××¨×ª ×©×™×© ×ª×¢×•×“×•×ª ××‘×œ ××™×Ÿ ×‘×¤×•×¢×œ â†’ ×¦×¨×™×š ×¤×¨×™×˜×™×\n    if (structure.has_doc && !hasDocsActually) return true;\n\n    // ×× ×™×© ×ª×¢×•×“×•×ª ×‘×¤×•×¢×œ:\n    if (hasDocsActually) {\n        // ×× ×™×© ×’× ×™×‘×•× â†’ ×œ× ×¦×¨×™×š ×¤×¨×™×˜×™× (×”×›×œ ×‘×ª×¢×•×“×•×ª)\n        if (structure.has_import) return false;\n\n        // ×× ××™×Ÿ ×™×‘×•× ××‘×œ ×™×© ××œ××™ ×œ× ×× ×•×”×œ â†’ ×¦×¨×™×š ×¤×¨×™×˜×™×\n        if (structure.inventory_management === \"not_managed_inventory\") return true;\n    }\n\n    // ××—×¨×ª â†’ ×œ× ×¦×¨×™×š ×¤×¨×™×˜×™×\n    return false;\n}\n\nfunction buildItems(ocrItems, config, structure, template, learnedConfig) {\n    // âœ¨ ×ª×™×§×•×Ÿ: ×§×— ××ª ×”×¤×¨×™×˜ ×”×¨××©×•×Ÿ ××”×ª×‘× ×™×ª ×›×‘×¡×™×¡\n    const templateItem = template.PINVOICEITEMS_SUBFORM?.[0] || {};\n\n    return ocrItems.map(ocrItem => {\n        // âœ¨ ×”×ª×—×œ ×¢× ×”×©×“×•×ª ××”×ª×‘× ×™×ª (×§×‘×•×¢×™× ×œ×œ××™×“×”)\n        const item = {\n            PARTNAME: templateItem.PARTNAME || \"\",          // ××”×ª×‘× ×™×ª âœ…\n            TUNITNAME: templateItem.TUNITNAME || \"×™×—'\",     // ××”×ª×‘× ×™×ª âœ…\n            VATFLAG: templateItem.VATFLAG || \"Y\",           // ××”×ª×‘× ×™×ª âœ…\n            ACCNAME: templateItem.ACCNAME || \"\",            // ××”×ª×‘× ×™×ª âœ…\n\n            // âœ¨ ×“×¨×•×¡ ×¢× × ×ª×•× ×™× ×“×™× ××™×™× ×-OCR\n            PDES: ocrItem.Description || \"\",                // ×-OCR âœ…\n            TQUANT: ocrItem.Quantity || 1,                  // ×-OCR âœ…\n            PRICE: ocrItem.UnitPrice || ocrItem.UnitPrice_amount || 0  // ×-OCR âœ…\n        };\n\n        // âœ¨ ×”×•×¡×£ SPECIALVATFLAG ×¨×§ ×× ×–×” \"Y\" ×‘×ª×‘× ×™×ª\n        if (templateItem.SPECIALVATFLAG === \"Y\") {\n            item.SPECIALVATFLAG = \"Y\";\n        }\n\n        // âœ¨ BUDCODE - ×‘×™× ×ª×™×™× ×¨×™×§ (×œ×•×’×™×§×” ×œ× ×××•×¤×™×™× ×ª)\n\n        return item;\n    });\n}\n\n// âœ¨ ×¤×•× ×§×¦×™×•×ª applyVehicleRules() ×•-applyPartnameRules() ×”×•×¡×¨×•\n// ×”×œ×•×’×™×§×” ×¢×‘×¨×” ×œ-createVehicleItems() ×•×œ-buildItems() ×‘×”×ª×××”\n\n// ============================================================================\n// ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ - ×©×œ×‘ 5 (×‘×§×¨×•×ª)\n// ============================================================================\n\nfunction performValidation(invoice, ocrFields, config, docsList, patterns) {\n    const warnings = [];\n    const checks = {};\n\n    let invoiceTotquant = 0;\n    if (invoice.PINVOICEITEMS_SUBFORM) {\n        invoiceTotquant = invoice.PINVOICEITEMS_SUBFORM.reduce(\n            (sum, item) => sum + (item.TQUANT || 0),\n            0\n        );\n    }\n\n    let docsTotquant = 0;\n    if (docsList && docsList.list_of_docs) {\n        try {\n            const docs = docsList.list_of_docs.map(d => JSON.parse(d));\n            docsTotquant = docs.reduce((sum, d) => sum + (d.TOTQUANT || 0), 0);\n        } catch (e) {\n            // ×××©×™×›×™× ×‘×œ×™\n        }\n    }\n\n    const learnedTotquant = config.rules.validation_data.TOTQUANT || 0;\n\n    checks.totquant = {\n        invoice_items_sum: invoiceTotquant,\n        docs_sum: docsTotquant,\n        learned_reference: learnedTotquant,\n        items_vs_docs_match: invoiceTotquant === docsTotquant || docsTotquant === 0,\n        notes: []\n    };\n\n    if (invoiceTotquant !== docsTotquant && docsTotquant > 0) {\n        warnings.push(`××™ ×”×ª×××ª ×›××•×™×•×ª: ×¤×¨×™×˜×™×=${invoiceTotquant}, ×ª×¢×•×“×•×ª=${docsTotquant}`);\n        checks.totquant.notes.push(\"××™ ×”×ª×××” ×‘×™×Ÿ ×¤×¨×™×˜×™× ×œ×ª×¢×•×“×•×ª\");\n    }\n\n    if (patterns.booknum_pattern) {\n        const expected = patterns.booknum_pattern.length;\n        const actual = invoice.BOOKNUM.length;\n\n        checks.booknum_pattern = {\n            expected_length: expected,\n            actual_length: actual,\n            match: expected === actual,\n            pattern_example: patterns.booknum_pattern.example\n        };\n\n        if (expected !== actual) {\n            warnings.push(`×“×¤×•×¡ BOOKNUM: ×¦×¤×•×™ ${expected} ×¡×¤×¨×•×ª, ×§×™×‘×œ× ×• ${actual}`);\n        }\n    }\n\n    const requiredFields = [\"SUPNAME\", \"CODE\", \"DEBIT\", \"IVDATE\", \"BOOKNUM\"];\n    const missingFields = requiredFields.filter(f => !invoice[f]);\n\n    if (missingFields.length > 0) {\n        warnings.push(`×©×“×•×ª ×—×•×‘×” ×—×¡×¨×™×: ${missingFields.join(', ')}`);\n    }\n\n    if (invoice.PINVOICEITEMS_SUBFORM) {\n        const emptyAccounts = invoice.PINVOICEITEMS_SUBFORM.filter(\n            item => !item.ACCNAME || item.ACCNAME === \"\"\n        );\n\n        if (emptyAccounts.length > 0) {\n            warnings.push(`${emptyAccounts.length} ×¤×¨×™×˜×™× ×œ×œ× ACCNAME`);\n        }\n    }\n\n    return {\n        all_valid: warnings.length === 0,\n        checks: checks,\n        warnings: warnings\n    };\n}\n\n// ============================================================================\n// ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ - ×©×œ×‘ 6 (×œ××™×“×”)\n// ============================================================================\n\nfunction analyzeLearning(invoice, config) {\n    const newPatterns = {\n        new_partnames: [],\n        new_vehicles: [],\n        unknown_accounts: []\n    };\n\n    const instructions = [];\n\n    if (invoice.PINVOICEITEMS_SUBFORM) {\n        invoice.PINVOICEITEMS_SUBFORM.forEach(item => {\n            const partnameKnown = config.rules.critical_patterns.partname_rules &&\n                                config.rules.critical_patterns.partname_rules[item.PARTNAME];\n\n            if (!partnameKnown && item.PARTNAME !== \"car\") {\n                newPatterns.new_partnames.push({\n                    partname: item.PARTNAME,\n                    pdes: item.PDES,\n                    suggested_accname: item.ACCNAME\n                });\n\n                instructions.push({\n                    type: \"add_partname_rule\",\n                    partname: item.PARTNAME,\n                    suggested_accname: item.ACCNAME,\n                    priority: \"medium\"\n                });\n            }\n\n            // âœ¨ ×—×“×©! ×–×™×”×•×™ ×¨×›×‘ ×—×“×©\n            if (item.PARTNAME === \"car\" || item.isNewVehicle) {\n                const vehicleMatch = item.PDES.match(/\\d{3}-\\d{2}-\\d{3}/);\n                if (vehicleMatch) {\n                    const vNum = vehicleMatch[0];\n                    const vehicleKnown = config.rules?.critical_patterns?.vehicle_rules?.vehicle_account_mapping?.[vNum];\n\n                    if (!vehicleKnown || item.isNewVehicle) {\n                        newPatterns.new_vehicles.push({\n                            vehicle_number: vNum,\n                            suggested_accname: item.ACCNAME,\n                            suggested_budcode: item.BUDCODE,\n                            suggested_vatflag: item.VATFLAG\n                        });\n\n                        instructions.push({\n                            type: \"add_vehicle_rule\",\n                            vehicle_number: vNum,\n                            suggested_accname: item.ACCNAME,\n                            suggested_budcode: item.BUDCODE,\n                            priority: \"high\"\n                        });\n                    }\n                }\n            }\n\n            if (!item.ACCNAME || item.ACCNAME === \"\") {\n                newPatterns.unknown_accounts.push({\n                    partname: item.PARTNAME,\n                    pdes: item.PDES\n                });\n\n                instructions.push({\n                    type: \"missing_account\",\n                    partname: item.PARTNAME,\n                    priority: \"critical\"\n                });\n            }\n        });\n    }\n\n    const learningRequired =\n        newPatterns.new_partnames.length > 0 ||\n        newPatterns.new_vehicles.length > 0 ||\n        newPatterns.unknown_accounts.length > 0;\n\n    return {\n        learning_required: learningRequired,\n        new_patterns: newPatterns,\n        learning_instructions: instructions,\n        recommendation: learningRequired ? \"×©×œ×— ×œ×§×•×“ 3 ×œ×œ××™×“×”\" : \"××™×Ÿ ×¦×•×¨×š ×‘×œ××™×“×”\"\n    };\n}\n\n// ============================================================================\n// ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ - ×©×œ×‘ 7 (×™×¦×™×¨×ª ×¤×œ×˜×™× × ×•×¡×¤×™×)\n// ============================================================================\n\nfunction generateLLMPrompt(config, ocrFields, searchResults, executionReport, templateIndex, structure, documentPatterns = null) {\n    const supplierCode = config.supplier_config.supplier_code;\n    const supplierName = config.supplier_config.supplier_name;\n\n    // ×‘× ×™×™×ª ×”×¡×‘×¨ ×¢×œ ×›×œ ×©×“×”\n    const fieldInstructions = {};\n\n    // BOOKNUM\n    fieldInstructions.booknum = {\n        field_name: \"BOOKNUM\",\n        description: \"××¡×¤×¨ ×—×©×‘×•× ×™×ª\",\n        how_to_find: \"×—×¤×© ×‘×©×“×” InvoiceId ×‘-OCR. ×”×¡×¨ ×§×™×“×•××ª SI ×× ×§×™×™××ª. ×§×— ××ª ××¡×¤×¨ ×”×ª×•×•×™× ×”××—×¨×•× ×™× ×œ×¤×™ ×”×“×¤×•×¡ ×”× ×œ××“.\",\n        example: searchResults.booknum || \"1015938\",\n        ocr_source: \"ocrFields.InvoiceId\"\n    };\n\n    // IVDATE\n    fieldInstructions.ivdate = {\n        field_name: \"IVDATE\",\n        description: \"×ª××¨×™×š ×—×©×‘×•× ×™×ª\",\n        how_to_find: \"×§×— ××ª InvoiceDate ××”-OCR ×•×”××¨ ×œ×¤×•×¨××˜ DD/MM/YY\",\n        example: searchResults.ivdate || \"10/09/25\",\n        ocr_source: \"ocrFields.InvoiceDate\"\n    };\n\n    // PRICE - ×—×©×•×‘!\n    fieldInstructions.price = {\n        field_name: \"PRICE\",\n        description: \"××—×™×¨ ×œ×¤× ×™ ××¢\\\"× (×¢×‘×•×“×•×ª + ×—×œ×§×™×)\",\n        how_to_calculate: \"×—×©×‘: InvoiceTotal_amount - TotalTax_amount. ×–×” × ×•×ª×Ÿ ××ª ×¡×”\\\"×› ×”×—×©×‘×•× ×™×ª ×œ×¤× ×™ ××¢\\\"×.\",\n        formula: \"InvoiceTotal_amount - TotalTax_amount\",\n        example: ocrFields.InvoiceTotal_amount && ocrFields.TotalTax_amount\n            ? `${ocrFields.InvoiceTotal_amount} - ${ocrFields.TotalTax_amount} = ${ocrFields.InvoiceTotal_amount - ocrFields.TotalTax_amount}`\n            : \"2524 - 385.02 = 2138.98\",\n        fallback: \"×× ××™×Ÿ TotalTax_amount, ×§×— SubTotal_amount. ×× ×’× ×–×” ×œ× ×§×™×™×, ×§×— InvoiceTotal_amount.\",\n        ocr_source: \"ocrFields.InvoiceTotal_amount, ocrFields.TotalTax_amount\"\n    };\n\n    // VEHICLES\n    const vehicleRules = config.rules?.critical_patterns?.vehicle_rules;\n    if (vehicleRules) {\n        fieldInstructions.vehicles = {\n            field_name: \"VEHICLES\",\n            description: \"××¡×¤×¨×™ ×¨×›×‘×™×\",\n            how_to_find: \"×—×¤×© ×¤×•×¨××˜ XXX-XX-XXX ×‘-UnidentifiedNumbers ×¢× label='×¨×›×‘'. ×‘×“×•×§ ×©×–×” ×œ× ××¡×¤×¨ ×›×¨×˜×™×¡ (context ×œ× ××›×™×œ '×›×¨×˜×™×¡').\",\n            pattern: \"\\\\d{3}-\\\\d{2}-\\\\d{3}\",\n            example: searchResults.vehicles && searchResults.vehicles.length > 0\n                ? searchResults.vehicles.join(', ')\n                : \"459-06-303\",\n            ocr_source: \"ocrFields.UnidentifiedNumbers (with label filter)\"\n        };\n    }\n\n    // DETAILS\n    fieldInstructions.details = {\n        field_name: \"DETAILS\",\n        description: \"×ª×™××•×¨ ×”×—×©×‘×•× ×™×ª\",\n        how_to_find: \"×× ×™×© ×¨×›×‘×™×: ×—×œ×¥ ×ª×™××•×¨ ×§×¦×¨ ×©×œ ×”×©×™×¨×•×ª (3-4 ××™×œ×™×, ××§×¡×™××•× 50 ×ª×•×•×™×) ××”×¤×¨×™×˜ ×”×¨××©×•×Ÿ ×‘-Items. ×× ×™×© ×’× ×§\\\"× × ×•×›×—×™ (CustomerId), ×”×•×¡×£ ××•×ª×• ×‘×¤×•×¨××˜: '×ª×™××•×¨-XXXXX×§\\\"×'\",\n        example: \"×˜×™×¤×•×œ 75000 ×§\\\"×-76256\",\n        ocr_source: \"ocrFields.Items[0].Description, ocrFields.CustomerId\"\n    };\n\n    // ××™×¤×•×™ ×¨×›×‘×™×\n    const vehicleMapping = {};\n    if (vehicleRules && vehicleRules.vehicle_account_mapping) {\n        Object.keys(vehicleRules.vehicle_account_mapping).forEach(vNum => {\n            const mapping = vehicleRules.vehicle_account_mapping[vNum];\n            vehicleMapping[vNum] = {\n                account: mapping.accname,\n                budget_code: mapping.budcode,\n                vat_flag: mapping.vat_pattern?.VATFLAG || \"Y\",\n                description: mapping.accdes || `×¨×›×‘ ${vNum}`\n            };\n        });\n    }\n\n    // ×‘× ×™×™×ª document_type ×“×™× ××™×ª ×œ×¤×™ ××‘× ×” ×”×ª×‘× ×™×ª ×©× ×‘×—×¨×”\n    let documentType = \"\";\n    if (structure.has_import && structure.has_doc) {\n        documentType = \"×—×©×‘×•× ×™×ª ×¢× ×ª×™×§ ×™×‘×•× ×¢× ×ª×¢×•×“×•×ª\";\n    } else if (structure.has_import) {\n        documentType = \"×—×©×‘×•× ×™×ª ×™×‘×•×\";\n    } else if (structure.has_doc) {\n        documentType = \"×—×©×‘×•× ×™×ª ×¢× ×ª×¢×•×“×•×ª\";\n    } else if (structure.debit_type === \"C\") {\n        documentType = \"×–×™×›×•×™ ×¨×’×™×œ ×¢× ×¤×™×¨×•×˜\";\n    } else if (vehicleRules && Object.keys(vehicleRules.vehicle_account_mapping || {}).length > 0) {\n        documentType = \"×—×©×‘×•× ×™×ª ×©×™×¨×•×ª×™ ×¨×›×‘ ×•××•×¡×š\";\n    } else {\n        documentType = \"×—×©×‘×•× ×™×ª ×¨×’×™×œ×” ×¢× ×¤×™×¨×•×˜\";\n    }\n\n    // ×‘× ×™×™×ª overview ×“×™× ××™ ×œ×¤×™ ××‘× ×” ×”×ª×‘× ×™×ª ×©× ×‘×—×¨×”\n    let overview = `×—×©×‘×•× ×™×ª ××¡×¤×§ ${supplierName}.`;\n\n    if (structure.has_import && structure.has_doc) {\n        overview += \" ×ª×‘× ×™×ª: ×™×‘×•× + ×ª×¢×•×“×•×ª. ×”×¡×¤×§ ××¡×¤×§ ××•×¦×¨×™ ××¦××™ ×•×™×‘×•×.\";\n    } else if (structure.has_import) {\n        overview += \" ×ª×‘× ×™×ª: ×™×‘×•×. ×”×¡×¤×§ ××¡×¤×§ ××•×¦×¨×™× ××™×•×‘××™×.\";\n    } else if (structure.has_doc) {\n        overview += \" ×ª×‘× ×™×ª: ×ª×¢×•×“×•×ª. ×”×¡×¤×§ ××¡×¤×§ ××•×¦×¨×™× ×¢×œ ×‘×¡×™×¡ ×ª×¢×•×“×•×ª ××¡×¤×§×”.\";\n    } else if (vehicleRules && Object.keys(vehicleRules.vehicle_account_mapping || {}).length > 0) {\n        overview += \" ×ª×‘× ×™×ª: ×©×™×¨×•×ª×™ ×¨×›×‘ ×•××•×¡×š.\";\n    } else {\n        overview += \" ×ª×‘× ×™×ª: ×—×©×‘×•× ×™×ª ×¨×’×™×œ×” ×¢× ×¤×™×¨×•×˜.\";\n    }\n\n    // ×‘× ×™×™×ª processing_steps ×“×™× ××™ ×œ×¤×™ ××‘× ×” ×”×ª×‘× ×™×ª\n    const processingSteps = [];\n    processingSteps.push(\"1. ×–×”×” ××ª ××¡×¤×¨ ×”×—×©×‘×•× ×™×ª (BOOKNUM) ××ª×•×š InvoiceId\");\n    processingSteps.push(\"2. ×—×œ×¥ ×ª××¨×™×š ×—×©×‘×•× ×™×ª (IVDATE) ××ª×•×š InvoiceDate\");\n\n    if (structure.has_import) {\n        processingSteps.push(\"3. ×–×”×” ××¡×¤×¨ ×™×‘×•× (IMPFNUM) ××ª×•×š import_files\");\n    }\n\n    if (structure.has_doc) {\n        // âœ¨ ×—×“×©! ×”× ×—×™×” ×“×™× ××™×ª ×¢×œ ×¤×™ ×ª×‘× ×™×ª ×©×–×•×”×ª×” ××”-OCR\n        let docsGuidance = \"×–×”×” ×ª×¢×•×“×•×ª (DOCNO/BOOKNUM)\";\n        if (documentPatterns && documentPatterns.booknum_found.length > 0) {\n            const prefix = documentPatterns.booknum_found[0].substring(0, 3);\n            const examples = documentPatterns.booknum_found.slice(0, 3).join(', ');\n            docsGuidance += ` - ×–×•×”×• ${documentPatterns.booknum_found.length} ××¡×¤×¨×™ BOOKNUM ×‘×¤×•×¨××˜ ${prefix}XXXXXX (×“×•×’×××•×ª: ${examples}). ×—×¤×© ××¡×¤×¨×™× ××œ×• ×‘×˜×§×¡×˜ ×•×”×ª×× ×¢× docs_list`;\n        } else {\n            docsGuidance += \" - ×—×¤×© ××¡×¤×¨×™× ×‘×¤×•×¨××˜ 25XXXXXX ××• 107/108XXXXXX\";\n        }\n        processingSteps.push(`${processingSteps.length + 1}. ${docsGuidance}`);\n    }\n\n    if (structure.has_purchase_orders) {\n        processingSteps.push(`${processingSteps.length + 1}. ×–×”×” ×”×–×× ×ª ×¨×›×© (ORDNAME) ×× ×§×™×™××ª`);\n    }\n\n    if (vehicleRules && Object.keys(vehicleRules.vehicle_account_mapping || {}).length > 0) {\n        processingSteps.push(`${processingSteps.length + 1}. ×—×œ×¥ ××¡×¤×¨×™ ×¨×›×‘×™× ×-UnidentifiedNumbers (×¤×•×¨××˜ XXX-XX-XXX)`);\n        processingSteps.push(`${processingSteps.length + 1}. ××¤×” ×›×œ ×¨×›×‘ ×œ×—×©×‘×•×Ÿ ×”× ×›×•×Ÿ ×œ×¤×™ vehicle_mapping`);\n        processingSteps.push(`${processingSteps.length + 1}. ×¦×•×¨ ×ª×™××•×¨ ×§×¦×¨ ×©×œ ×”×©×™×¨×•×ª ××”×¤×¨×™×˜ ×”×¨××©×•×Ÿ`);\n    } else {\n        processingSteps.push(`${processingSteps.length + 1}. ×—×©×‘ ××ª ×”××—×™×¨ ×”×›×•×œ×œ ×œ×¤× ×™ ××¢\"×: InvoiceTotal - TotalTax`);\n    }\n\n    return {\n        supplier_code: supplierCode,\n        supplier_name: supplierName,\n        document_type: documentType,\n        instructions: {\n            overview: overview,\n            processing_steps: processingSteps,\n            fields: fieldInstructions,\n            vehicle_mapping: vehicleMapping\n        }\n    };\n}\n\nfunction generateTechnicalConfig(config, ocrFields, searchResults, executionReport, templateIndex, structure, documentPatterns = null) {\n    const supplierCode = config.supplier_config.supplier_code;\n    const supplierName = config.supplier_config.supplier_name;\n\n    // extraction rules ××¤×•×¨×˜×™×\n    const extractionRules = {};\n\n    // BOOKNUM\n    extractionRules.booknum = {\n        source: \"ocrFields.InvoiceId\",\n        transformations: [\n            {\n                action: \"remove_prefix\",\n                pattern: \"^SI\",\n                case_insensitive: true,\n                description: \"×”×¡×¨ ×§×™×“×•××ª SI ×× ×§×™×™××ª\"\n            },\n            {\n                action: \"take_last_n_chars\",\n                count: 7,\n                description: \"×§×— 7 ×ª×•×•×™× ××—×¨×•× ×™×\"\n            }\n        ],\n        validation: {\n            length: 7,\n            pattern: \"^\\\\d{7}$\",\n            required: true\n        },\n        example: searchResults.booknum || \"1015938\"\n    };\n\n    // IVDATE\n    extractionRules.ivdate = {\n        source: \"ocrFields.InvoiceDate\",\n        format: \"DD/MM/YY\",\n        transformation: {\n            from: \"ISO8601\",\n            to: \"DD/MM/YY\",\n            description: \"×”××¨ ××¤×•×¨××˜ ISO (YYYY-MM-DD) ×œ×¤×•×¨××˜ DD/MM/YY\"\n        },\n        validation: {\n            pattern: \"^\\\\d{2}/\\\\d{2}/\\\\d{2}$\",\n            required: true\n        },\n        example: searchResults.ivdate || \"10/09/25\"\n    };\n\n    // PRICE - ×”×—×™×©×•×‘ ×”×—×©×•×‘!\n    extractionRules.price = {\n        calculation: {\n            method: \"subtract\",\n            primary: {\n                formula: \"ocrFields.InvoiceTotal_amount - ocrFields.TotalTax_amount\",\n                fields_required: [\"InvoiceTotal_amount\", \"TotalTax_amount\"],\n                description: \"×¡×”\\\"×› ×œ×¤× ×™ ××¢\\\"× = ×¡×”\\\"×› ×›×•×œ×œ ××¢\\\"× - ××¢\\\"×\"\n            },\n            fallback: {\n                formula: \"ocrFields.SubTotal_amount || ocrFields.InvoiceTotal_amount\",\n                fields_required: [\"SubTotal_amount\"],\n                description: \"×× ××™×Ÿ TotalTax_amount, ×§×— SubTotal_amount\"\n            },\n            division_by_vehicles: {\n                enabled: true,\n                formula: \"totalPrice / vehicles.length\",\n                description: \"×× ×™×© ××¡×¤×¨ ×¨×›×‘×™×, ×—×œ×§ ××ª ×”××—×™×¨ ×”×›×•×œ×œ ×‘××•×¤×Ÿ ×©×•×•×”\"\n            }\n        },\n        description: \"××—×™×¨ ×œ×¤× ×™ ××¢\\\"× (×¢×‘×•×“×•×ª + ×—×œ×§×™×)\",\n        example_calculation: ocrFields.InvoiceTotal_amount && ocrFields.TotalTax_amount\n            ? {\n                invoice_total: ocrFields.InvoiceTotal_amount,\n                total_tax: ocrFields.TotalTax_amount,\n                calculated_price: ocrFields.InvoiceTotal_amount - ocrFields.TotalTax_amount,\n                formula_used: \"InvoiceTotal_amount - TotalTax_amount\"\n            }\n            : {\n                invoice_total: 2524,\n                total_tax: 385.02,\n                calculated_price: 2138.98,\n                formula_used: \"2524 - 385.02\"\n            }\n    };\n\n    // VEHICLES\n    const vehicleRules = config.rules?.critical_patterns?.vehicle_rules;\n    if (vehicleRules) {\n        extractionRules.vehicles = {\n            search_locations: [\n                {\n                    field: \"ocrFields.UnidentifiedNumbers\",\n                    priority: 1,\n                    filter: {\n                        label: \"×¨×›×‘\",\n                        description: \"×¨×§ ×¤×¨×™×˜×™× ×¢× ×ª×•×•×™×ª '×¨×›×‘'\"\n                    },\n                    pattern: \"\\\\d{3}-\\\\d{2}-\\\\d{3}\",\n                    validation: {\n                        must_match_pattern: true,\n                        exclude_if_context_contains: [\"×›×¨×˜×™×¡\"],\n                        description: \"×‘×“×•×§ ×©×–×” ×œ× ××¡×¤×¨ ×›×¨×˜×™×¡\"\n                    }\n                },\n                {\n                    field: \"ocrFields.VehicleNumbers\",\n                    priority: 2,\n                    pattern: \"\\\\d{3}-\\\\d{2}-\\\\d{3}\"\n                },\n                {\n                    field: \"ocrFields.Items[].Description\",\n                    priority: 3,\n                    pattern: \"\\\\d{3}-\\\\d{2}-\\\\d{3}\",\n                    description: \"×—×¤×© ×‘×ª×™××•×¨ ×”×¤×¨×™×˜×™×\"\n                }\n            ],\n            example: searchResults.vehicles || [\"459-06-303\"]\n        };\n    }\n\n    // DOCUMENTS (DOCNO + BOOKNUM) - ×¨×§ ×× ×”×ª×‘× ×™×ª ×©× ×‘×—×¨×” ×“×•×¨×©×ª ×ª×¢×•×“×•×ª\n    if (structure.has_doc) {\n        // âœ¨ ×—×“×©! ×©×™××•×© ×‘×ª×‘× ×™×ª ×©×–×•×”×ª×” ×“×™× ××™×ª ××”-OCR\n        const detectedPattern = documentPatterns && documentPatterns.booknum_pattern\n            ? documentPatterns.booknum_pattern\n            : \"\\\\b(108\\\\d{6})\\\\b\";  // ×‘×¨×™×¨×ª ××—×“×œ ×× ×œ× ×–×•×”×”\n\n        const detectedDescription = documentPatterns && documentPatterns.booknum_found.length > 0\n            ? `BOOKNUM - ×–×•×”×” ${documentPatterns.booknum_found[0].substring(0, 3)}XXXXXX (${documentPatterns.booknum_found.length} ×“×•×’×××•×ª ××”-OCR)`\n            : \"BOOKNUM - 9 ×¡×¤×¨×•×ª ××ª×—×™×œ ×‘-108\";\n\n        extractionRules.documents = {\n            search_in: [\n                {\n                    location: \"ocrFields.UnidentifiedNumbers\",\n                    priority: 1,\n                    filter: {\n                        label: \"××¡×³ ×”×§×¦××” (BOOKNUM)\",\n                        description: \"×—×¤×© ×‘××¢×¨×š UnidentifiedNumbers ×¢× ×ª×•×•×™×ª BOOKNUM\"\n                    },\n                    pattern: detectedPattern,\n                    description: detectedDescription,\n                    detected_examples: documentPatterns ? documentPatterns.booknum_found.slice(0, 3) : []  // âœ¨ ×”×•×¡×¤×ª ×“×•×’×××•×ª\n                },\n                {\n                    location: \"AZURE_TEXT\",\n                    priority: 2,\n                    fallback: true,\n                    pattern: detectedPattern,\n                    description: \"×—×™×¤×•×© fallback ×‘-AZURE_TEXT ×× ×œ× × ××¦× ×‘-UnidentifiedNumbers\"\n                }\n            ],\n            matching: {\n                match_field: \"BOOKNUM\",\n                lookup_source: \"docs_list.list_of_docs\",\n                output_fields: [\"DOCNO\", \"BOOKNUM\"],\n                description: \"×”×ª×× ××ª BOOKNUM ×©× ××¦× ×‘-OCR ×¢× docs_list ×›×“×™ ×œ×§×‘×œ DOCNO\"\n            },\n            output_format: {\n                field_name: \"PIVDOC_SUBFORM\",\n                structure: [\n                    {\n                        DOCNO: \"string - ××¡×¤×¨ ×ª×¢×•×“×” ×¤× ×™××™ ×‘-Priority (25XXXXXX)\",\n                        BOOKNUM: \"string - ××¡×¤×¨ ×”×§×¦××” ×—×™×¦×•× ×™ (108XXXXXX)\"\n                    }\n                ]\n            },\n            error_handling: {\n                if_none_found: {\n                    action: \"return_partial_json\",\n                    include_empty_array: true,\n                    add_to_report: \"errors\",\n                    message: \"×ª×‘× ×™×ª ×“×•×¨×©×ª ×ª×¢×•×“×•×ª ××š ×œ× × ××¦××• ×‘-OCR\"\n                },\n                if_partial_found: {\n                    action: \"return_partial_json\",\n                    include_found_items: true,\n                    add_to_report: \"warnings\",\n                    message: \"× ××¦××• ×¨×§ {found_count} ××ª×•×š {expected_count} ×ª×¢×•×“×•×ª\"\n                }\n            },\n            example: searchResults.documents || [\n                { DOCNO: \"25026849\", BOOKNUM: \"108379736\" },\n                { DOCNO: \"25026850\", BOOKNUM: \"108379734\" }\n            ]\n        };\n    }\n\n    // DESCRIPTION\n    extractionRules.description = {\n        source: \"ocrFields.Items[0].Description\",\n        extraction: {\n            method: \"pattern_match\",\n            patterns: [\n                {\n                    name: \"service_with_km\",\n                    pattern: \"×˜×™×¤×•×œ\\\\s+[\\\\d,]+\\\\s*×§[×´\\\"]?×\",\n                    priority: 1,\n                    description: \"×˜×™×¤×•×œ XXX ×§\\\"×\"\n                },\n                {\n                    name: \"general_service\",\n                    pattern: \"(×”×—×œ×¤×ª|×ª×™×§×•×Ÿ|×‘×“×™×§×ª)\\\\s+[\\\\u0590-\\\\u05FF\\\\s]+\",\n                    priority: 2,\n                    description: \"×ª×™××•×¨ ×›×œ×œ×™ ×©×œ ×©×™×¨×•×ª\"\n                }\n            ],\n            max_words: 4,\n            max_length: 50,\n            append_mileage: {\n                enabled: true,\n                source: \"ocrFields.CustomerId\",\n                format: \"{description}-{mileage}\",\n                description: \"×× ×™×© ×§\\\"× × ×•×›×—×™, ×”×•×¡×£ ×‘×¤×•×¨××˜: '×ª×™××•×¨-XXXXX×§\\\"×'\"\n            }\n        },\n        fallback: \"×˜×™×¤×•×œ\",\n        example: \"×˜×™×¤×•×œ 75000 ×§\\\"×\"\n    };\n\n    // Vehicle mapping\n    const vehicleMapping = {};\n    if (vehicleRules && vehicleRules.vehicle_account_mapping) {\n        Object.keys(vehicleRules.vehicle_account_mapping).forEach(vNum => {\n            const mapping = vehicleRules.vehicle_account_mapping[vNum];\n            vehicleMapping[vNum] = {\n                accname: mapping.accname,\n                accdes: mapping.accdes,\n                budcode: mapping.budcode,\n                vat_pattern: {\n                    VATFLAG: mapping.vat_pattern?.VATFLAG || \"Y\",\n                    SPECIALVATFLAG: mapping.vat_pattern?.SPECIALVATFLAG\n                },\n                date_range_pattern: mapping.date_range_pattern || \"never\",\n                pdaccname_pattern: mapping.pdaccname_pattern || \"never\"\n            };\n        });\n    }\n\n    // Template structure\n    const template = {\n        SUPNAME: supplierCode,\n        CODE: \"×©\\\"×—\",\n        DEBIT: \"D\",\n        TUNITNAME: \"×™×—'\",\n        TQUANT: 1,\n        PINVOICESCONT_SUBFORM: [\n            { FNCPATNAME: \"2323\" }\n        ]\n    };\n\n    // ×§×‘×™×¢×ª document_type ×“×™× ××™ ×œ×¤×™ ×”×ª×‘× ×™×ª ×©× ×‘×—×¨×”\n    let documentTypeKey = \"regular_invoice\";\n    if (structure.has_import && structure.has_doc) {\n        documentTypeKey = \"import_with_docs_invoice\";\n    } else if (structure.has_import) {\n        documentTypeKey = \"import_invoice\";\n    } else if (structure.has_doc) {\n        documentTypeKey = \"docs_invoice\";\n    } else if (structure.debit_type === \"C\") {\n        documentTypeKey = \"credit_note\";\n    } else if (config.rules?.critical_patterns?.vehicle_rules?.vehicle_account_mapping &&\n               Object.keys(config.rules.critical_patterns.vehicle_rules.vehicle_account_mapping).length > 0) {\n        documentTypeKey = \"vehicle_service_invoice\";\n    }\n\n    return {\n        supplier_code: supplierCode,\n        supplier_name: supplierName,\n        version: \"4.2\",\n        document_type: documentTypeKey,\n        extraction_rules: extractionRules,\n        vehicle_mapping: vehicleMapping,\n        template: template,\n        validation_rules: {\n            required_fields: [\"SUPNAME\", \"CODE\", \"DEBIT\", \"IVDATE\", \"BOOKNUM\"],\n            booknum_length: 7,\n            totquant_check: {\n                enabled: true,\n                compare_with_docs: true,\n                learned_reference: config.rules.validation_data.TOTQUANT || 1\n            }\n        }\n    };\n}\n\n// ============================================================================\n// × ×§×•×“×ª ×›× ×™×¡×” - ×¨×§ ×× input ××•×’×“×¨ (×¡×‘×™×‘×ª Azure Functions)\n// ============================================================================\n\nif (typeof input !== 'undefined') {\n    const processInput = {\n        learned_config: input.learned_config,\n        docs_list: input.docs_list,\n        import_files: input.import_files,\n        AZURE_RESULT: input.AZURE_RESULT,\n        AZURE_TEXT: input.AZURE_TEXT\n    };\n\n    const result = processInvoiceComplete(processInput);\n\n    console.log(JSON.stringify(result));\n    return result;\n}\n\n// ============================================================================\n// ×™×™×¦×•× ×¤×•× ×§×¦×™×•×ª ×œ××•×“×•×œ\n// ============================================================================\nmodule.exports = {\n    processInvoiceComplete\n};\n"
    }
]
