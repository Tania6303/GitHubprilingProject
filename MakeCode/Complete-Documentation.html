<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>דוקומנטציה מלאה - מערכת עיבוד חשבוניות</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .content {
            padding: 40px;
        }

        h2 {
            color: #667eea;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
            margin: 30px 0 20px 0;
            font-size: 2em;
        }

        /* Accordion Styles */
        .accordion {
            margin: 20px 0;
        }

        .accordion-item {
            margin: 15px 0;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .accordion-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            font-size: 1.3em;
            font-weight: bold;
        }

        .accordion-header:hover {
            background: linear-gradient(135deg, #5568d3 0%, #653a8b 100%);
        }

        .accordion-header.active {
            background: linear-gradient(135deg, #4a52ba 0%, #563472 100%);
        }

        .accordion-icon {
            font-size: 1.5em;
            transition: transform 0.3s ease;
        }

        .accordion-header.active .accordion-icon {
            transform: rotate(180deg);
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease;
            background: white;
        }

        .accordion-content.active {
            max-height: 10000px;
        }

        .accordion-body {
            padding: 30px;
            background: #f8f9fa;
        }

        .flow-diagram {
            background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
        }

        .flow-step {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            border-right: 5px solid #667eea;
        }

        .flow-step h3 {
            color: #667eea;
            margin: 0 0 10px 0;
        }

        .flow-arrow {
            text-align: center;
            font-size: 2em;
            color: #764ba2;
            margin: 10px 0;
        }

        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 10px;
            overflow-x: auto;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            direction: ltr;
            text-align: left;
            font-size: 0.9em;
        }

        .info-box {
            background: #e7f3ff;
            border-right: 5px solid #2196F3;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
        }

        .warning-box {
            background: #fff3cd;
            border-right: 5px solid #ffc107;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
        }

        .key-principle {
            background: #d4edda;
            border-right: 5px solid #28a745;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
        }

        .scenarios-table {
            width: 100%;
            border-collapse: collapse;
            margin: 30px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-radius: 10px;
            overflow: hidden;
        }

        .scenarios-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
        }

        .scenarios-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
            text-align: center;
        }

        .scenarios-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .badge-yes {
            background: #d4edda;
            color: #155724;
        }

        .badge-no {
            background: #f8d7da;
            color: #721c24;
        }

        footer {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }

        ul, ol {
            margin: 15px 0;
            padding-right: 30px;
        }

        li {
            margin: 10px 0;
        }

        strong {
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>🔄 דוקומנטציה מלאה - מערכת עיבוד חשבוניות</h1>
            <p>תיעוד מלא של תהליך למידה, עיבוד וייצור חשבוניות ל-ERP</p>
            <p style="margin-top: 10px; font-size: 0.9em;">📅 עודכן: 05 נובמבר 2025 | 🔧 גרסה: v16:02</p>
        </header>

        <div class="content">
            <h2>📋 סקירה כללית</h2>
            <p>מערכת עיבוד החשבוניות מורכבת מ-3 שלבים עיקריים שעובדים יחד כדי להמיר מסמכים סרוקים (OCR) לפורמט JSON מובנה למערכת ה-ERP.</p>

            <div class="flow-diagram">
                <h3 style="text-align: center; color: #667eea; margin-bottom: 30px;">תרשים זרימה - 3 השלבים</h3>

                <div class="flow-step">
                    <h3>שלב 1️⃣: Supplier Data Learning</h3>
                    <p><strong>קלט:</strong> נתונים מ-ERP Priority (חשבוניות קיימות של הספק)</p>
                    <p><strong>פלט:</strong> learned_config (הגדרות ספק מלומדות)</p>
                    <p><strong>תפקיד:</strong> למידת דפוסים, תבניות, חשבונות וחוקי מיפוי ספציפיים לכל ספק</p>
                </div>

                <div class="flow-arrow">⬇</div>

                <div class="flow-step">
                    <h3>שלב 2️⃣: Processing Invoice</h3>
                    <p><strong>קלט:</strong> learned_config + OCR (Azure Document Intelligence) + תעודות/יבוא</p>
                    <p><strong>פלט:</strong> תבנית מאוחדת (invoice_data + llm_prompt + technical_config)</p>
                    <p><strong>תפקיד:</strong> יצירת תבנית מאוחדת שמכילה את כל המידע הדרוש לייצור החשבונית</p>
                </div>

                <div class="flow-arrow">⬇</div>

                <div class="flow-step">
                    <h3>שלב 3️⃣: Production Invoice</h3>
                    <p><strong>קלט:</strong> תבנית מאוחדת (מ-Processing Invoice)</p>
                    <p><strong>פלט:</strong> JSON סופי לשליחה ל-Priority ERP</p>
                    <p><strong>תפקיד:</strong> יצירת חשבונית סופית מוכנה להזנה למערכת ERP</p>
                </div>
            </div>

            <h2>🎯 עקרונות מנחים</h2>
            <div class="key-principle">
                <h4>1. תבנית = בסיס קבוע</h4>
                <p>השדות הקבועים (PARTNAME, VATFLAG, ACCNAME, TUNITNAME, SPECIALVATFLAG) נלקחים מהתבנית המלומדת.</p>
            </div>

            <div class="key-principle">
                <h4>2. OCR = נתונים דינמיים</h4>
                <p>השדות הדינמיים (PDES, TQUANT, PRICE) נלקחים מ-OCR בזמן אמת.</p>
            </div>

            <div class="key-principle">
                <h4>3. רכבים = מיפוי מיוחד</h4>
                <p>עבור רכבים, ACCNAME נלקח מרשימת הרכבים המלומדת (vehicle_account_mapping).</p>
            </div>

            <div class="key-principle">
                <h4>4. BOOKNUM = ניקוי אוטומטי</h4>
                <p>מספר חשבונית ספק עובר ניקוי אוטומטי - הסרת prefix ו-suffix לא מספריים.</p>
            </div>

            <h2>📊 5 תרחישי עיבוד</h2>
            <table class="scenarios-table">
                <thead>
                    <tr>
                        <th>תרחיש</th>
                        <th>יבוא</th>
                        <th>תעודות</th>
                        <th>רכבים</th>
                        <th>IMPFNUM</th>
                        <th>תעודות<br>בפועל</th>
                        <th>פריטים<br>מפורטים</th>
                        <th>מקור נתונים</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>1. רכבים</strong></td>
                        <td><span class="badge badge-no">לא</span></td>
                        <td><span class="badge badge-no">לא</span></td>
                        <td><span class="badge badge-yes">כן</span></td>
                        <td><span class="badge badge-no">לא</span></td>
                        <td><span class="badge badge-no">לא</span></td>
                        <td><span class="badge badge-yes">כן</span></td>
                        <td>רשימת רכבים + OCR</td>
                    </tr>
                    <tr>
                        <td><strong>2. פריטים רגילים</strong></td>
                        <td><span class="badge badge-no">לא</span></td>
                        <td><span class="badge badge-no">לא</span></td>
                        <td><span class="badge badge-no">לא</span></td>
                        <td><span class="badge badge-no">לא</span></td>
                        <td><span class="badge badge-no">לא</span></td>
                        <td><span class="badge badge-yes">כן</span></td>
                        <td>תבנית + OCR</td>
                    </tr>
                    <tr>
                        <td><strong>3. תעודות בלבד</strong></td>
                        <td><span class="badge badge-no">לא</span></td>
                        <td><span class="badge badge-yes">כן</span></td>
                        <td><span class="badge badge-no">לא</span></td>
                        <td><span class="badge badge-no">לא</span></td>
                        <td><span class="badge badge-yes">כן</span></td>
                        <td><span class="badge badge-no">לא</span></td>
                        <td>-</td>
                    </tr>
                    <tr>
                        <td><strong>4. יבוא + תעודות</strong></td>
                        <td><span class="badge badge-yes">כן</span></td>
                        <td><span class="badge badge-yes">כן</span></td>
                        <td><span class="badge badge-no">לא</span></td>
                        <td><span class="badge badge-yes">כן</span></td>
                        <td><span class="badge badge-yes">כן</span></td>
                        <td><span class="badge badge-no">לא</span></td>
                        <td>-</td>
                    </tr>
                    <tr>
                        <td><strong>5. יבוא + הוצאות</strong></td>
                        <td><span class="badge badge-yes">כן</span></td>
                        <td><span class="badge badge-no">לא</span></td>
                        <td><span class="badge badge-no">לא</span></td>
                        <td><span class="badge badge-yes">כן</span></td>
                        <td><span class="badge badge-no">לא</span></td>
                        <td><span class="badge badge-yes">כן</span></td>
                        <td>תבנית + OCR</td>
                    </tr>
                </tbody>
            </table>

            <!-- ACCORDION SECTIONS -->
            <h2>📖 תיעוד מפורט לפי שלבים</h2>

            <div class="accordion">
                <!-- SECTION 1: Supplier Data Learning -->
                <div class="accordion-item">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <span>🎓 שלב 1: Supplier Data Learning - למידת נתוני ספק</span>
                        <span class="accordion-icon">▼</span>
                    </div>
                    <div class="accordion-content">
                        <div class="accordion-body">
                            <h3>📥 קלט</h3>
                            <p>נתוני חשבוניות קיימות של הספק מ-Priority ERP, כולל:</p>
                            <ul>
                                <li>חשבוניות קודמות (PINVOICES)</li>
                                <li>פריטים (PINVOICEITEMS_SUBFORM)</li>
                                <li>קוד ספק (supplier_code)</li>
                                <li>חשבונות חשבונאיים (accounts)</li>
                            </ul>

                            <h3>📤 פלט</h3>
                            <p><strong>learned_config</strong> - קובץ הגדרות מלומד שכולל:</p>
                            <div class="code-block">
{
  "supplier_code": "5014",
  "supplier_name": "טכומטר-מכון ספידומטרים",
  "all_templates": [
    {
      "document_type": "vehicle_service_invoice",
      "extraction_rules": {
        "booknum": {
          "source": "ocrFields.InvoiceId",
          "transformations": [
            {
              "action": "remove_prefix",
              "pattern": "^SI",
              "description": "הסר קידומת SI"
            }
          ]
        }
      },
      "invoice_data": {
        "PINVOICES": [{
          "SUPNAME": "5014",
          "CODE": "ש\"ח",
          "PINVOICEITEMS_SUBFORM": [...]
        }]
      }
    }
  ],
  "vehicle_account_mapping": {...}
}
                            </div>

                            <h3>🎯 תפקידים עיקריים</h3>
                            <ol>
                                <li><strong>זיהוי דפוסים:</strong> מציאת דפוסים במספרי חשבוניות, תאריכים וסכומים</li>
                                <li><strong>יצירת תבניות:</strong> בניית תבנית חשבונית לפי סוג מסמך</li>
                                <li><strong>מיפוי חשבונות:</strong> קישור פריטים לחשבונות חשבונאיים</li>
                                <li><strong>למידת רכבים:</strong> זיהוי רכבים וחיבור לחשבונות מתאימים</li>
                            </ol>

                            <div class="info-box">
                                <h4>💡 טיפ חשוב</h4>
                                <p>ה-learned_config נוצר פעם אחת לספק ומשמש לכל החשבוניות שלו. אם הספק משנה את המבנה שלו (למשל מוסיף סוג חשבונית חדש), יש להריץ למידה מחדש.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECTION 2: Processing Invoice -->
                <div class="accordion-item">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <span>⚙️ שלב 2: Processing Invoice - עיבוד חשבונית</span>
                        <span class="accordion-icon">▼</span>
                    </div>
                    <div class="accordion-content">
                        <div class="accordion-body">
                            <h3>📥 קלט</h3>
                            <ul>
                                <li><strong>learned_config:</strong> מהשלב הקודם</li>
                                <li><strong>OCR (AZURE_RESULT):</strong> תוצאות Azure Document Intelligence</li>
                                <li><strong>docs_list:</strong> רשימת תעודות (אם יש)</li>
                                <li><strong>import_files:</strong> קבצי יבוא (אם יש)</li>
                                <li><strong>vehicles:</strong> רשימת רכבים (אם רלוונטי)</li>
                            </ul>

                            <h3>📤 פלט</h3>
                            <p><strong>תבנית מאוחדת</strong> המכילה:</p>
                            <div class="code-block">
{
  "status": "success",
  "llm_prompt": {
    "supplier_code": "5014",
    "supplier_name": "טכומטר-מכון ספידומטרים",
    "all_templates": [...]
  },
  "technical_config": {
    "supplier_code": "5014",
    "all_templates": [...]
  },
  "invoice_data": {
    "PINVOICES": [{
      "SUPNAME": "5014",
      "BOOKNUM": "288756",
      "IVDATE": "22/10/25",
      "PINVOICEITEMS_SUBFORM": [...]
    }]
  }
}
                            </div>

                            <h3>🔄 תהליך עיבוד</h3>
                            <ol>
                                <li><strong>זיהוי ספק:</strong> קביעת קוד הספק לפי ח.פ או שם</li>
                                <li><strong>בחירת תבנית:</strong> מציאת התבנית המתאימה לפי סוג מסמך</li>
                                <li><strong>חילוץ נתונים מ-OCR:</strong>
                                    <ul>
                                        <li>BOOKNUM - מספר חשבונית ספק (+ ניקוי)</li>
                                        <li>IVDATE - תאריך חשבונית</li>
                                        <li>פריטים/רכבים - מ-OCR או מתבנית</li>
                                    </ul>
                                </li>
                                <li><strong>שילוב עם תבנית:</strong> מיזוג נתונים דינמיים (OCR) עם תבנית קבועה</li>
                                <li><strong>תיקוף:</strong> בדיקת שדות חובה ותקינות מבנה</li>
                            </ol>

                            <div class="warning-box">
                                <h4>⚠️ שינוי מבנה בגרסה 4.2</h4>
                                <p><strong>לפני:</strong> invoice_data ברמה עליונה</p>
                                <p><strong>אחרי:</strong> כל התבניות תחת llm_prompt.all_templates[] ו-technical_config.all_templates[]</p>
                                <p>זה משפיע על האופן שבו Production Invoice קורא את הנתונים!</p>
                            </div>

                            <h3>🚗 טיפול מיוחד ברכבים</h3>
                            <p>כאשר נמצאים רכבים בחשבונית:</p>
                            <ol>
                                <li>חילוץ מספר רכב מ-OCR (license plate)</li>
                                <li>התאמה לרשימת הרכבים המלומדת</li>
                                <li>מיפוי לחשבון חשבונאי נכון (ACCNAME)</li>
                                <li>יצירת פריט לכל רכב עם PARTNAME="car"</li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- SECTION 3: Production Invoice -->
                <div class="accordion-item">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <span>🏭 שלב 3: Production Invoice - ייצור חשבונית סופית</span>
                        <span class="accordion-icon">▼</span>
                    </div>
                    <div class="accordion-content">
                        <div class="accordion-body">
                            <h3>📥 קלט</h3>
                            <p>התבנית המאוחדת מ-Processing Invoice (שלב 2)</p>

                            <h3>📤 פלט</h3>
                            <p><strong>JSON סופי</strong> מוכן לשליחה ל-Priority ERP:</p>
                            <div class="code-block">
{
  "status": "success",
  "supplier_identification": {
    "supplier_code": "5014",
    "supplier_name": "טכומטר-מכון ספידומטרים"
  },
  "invoice_data": {
    "PINVOICES": [{
      "SUPNAME": "5014",
      "CODE": "ש\"ח",
      "DEBIT": "D",
      "IVDATE": "22/10/25",
      "BOOKNUM": "288756",
      "PINVOICEITEMS_SUBFORM": [{
        "PARTNAME": "car",
        "TUNITNAME": "יח'",
        "VATFLAG": "Y",
        "ACCNAME": "66979",
        "PDES": "התקנת מצלמה",
        "TQUANT": 1,
        "PRICE": 300,
        "SPECIALVATFLAG": "Y"
      }],
      "PINVOICESCONT_SUBFORM": []
    }]
  },
  "validation": {
    "all_valid": true,
    "checks": {...}
  },
  "execution_report": {
    "stage": "שלב 7: ניקוי והכנה לפריוריטי",
    "found": [...],
    "not_found": [],
    "warnings": [],
    "errors": []
  }
}
                            </div>

                            <h3>🔄 תהליך ייצור</h3>
                            <ol>
                                <li><strong>קריאת Input:</strong> פענוח המבנה המאוחד</li>
                                <li><strong>חילוץ תבניות:</strong>
                                    <ul>
                                        <li>מ-llm_prompt.all_templates[].invoice_data.PINVOICES[0]</li>
                                        <li>תמיכה גם במבנה הישן לתאימות אחורה</li>
                                    </ul>
                                </li>
                                <li><strong>בחירת תבנית נכונה:</strong> לפי has_import, has_doc, debit_type</li>
                                <li><strong>בניית חשבונית:</strong>
                                    <ul>
                                        <li>העתקת שדות קבועים מהתבנית</li>
                                        <li>הוספת נתונים דינמיים (booknum, ivdate)</li>
                                        <li>יצירת פריטים (מרכבים או מתבנית)</li>
                                    </ul>
                                </li>
                                <li><strong>ניקוי BOOKNUM:</strong>
                                    <ul>
                                        <li>הסרת prefix (כמו "SI")</li>
                                        <li>הסרת suffix לא-מספרי (כמו " Ns")</li>
                                        <li>trim רווחים</li>
                                    </ul>
                                </li>
                                <li><strong>תיקוף סופי:</strong> בדיקת שדות חובה</li>
                                <li><strong>החזרת object:</strong> JavaScript object (לא string!)</li>
                            </ol>

                            <div class="info-box">
                                <h4>✅ תיקונים אחרונים (v16:02)</h4>
                                <ul>
                                    <li><strong>ניקוי BOOKNUM:</strong> "288756 Ns" → "288756"</li>
                                    <li><strong>חילוץ תבניות מ-v4.2:</strong> תמיכה במבנה החדש של all_templates</li>
                                    <li><strong>החזרת object:</strong> במקום JSON string</li>
                                    <li><strong>fallback לפריטים:</strong> העתקה מתבנית כשאין OCR</li>
                                </ul>
                            </div>

                            <h3>🔧 ניקוי BOOKNUM - דוגמה</h3>
                            <div class="code-block">
// דוגמאות ניקוי:
"288756 Ns"  →  "288756"
"SI12345"    →  "12345"
"756 ns"     →  "756"
"108123456"  →  "108123456"  (ללא שינוי)
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECTION 4: Data Flow -->
                <div class="accordion-item">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <span>🔄 זרימת נתונים מלאה - דוגמה מעשית</span>
                        <span class="accordion-icon">▼</span>
                    </div>
                    <div class="accordion-content">
                        <div class="accordion-body">
                            <h3>1️⃣ Supplier Data Learning</h3>
                            <div class="code-block">
קלט: חשבוניות קיימות מ-Priority
↓
למידה: דפוסים, תבניות, חשבונות
↓
פלט: learned_config
{
  "supplier_code": "5014",
  "vehicle_account_mapping": {
    "1234567": "66979"
  },
  "all_templates": [{
    "invoice_data": {
      "PINVOICES": [{
        "PINVOICEITEMS_SUBFORM": [{
          "PARTNAME": "car",
          "ACCNAME": "66979"
        }]
      }]
    }
  }]
}
                            </div>

                            <h3>2️⃣ Processing Invoice</h3>
                            <div class="code-block">
קלט: learned_config + OCR
OCR נתונים:
- InvoiceId: "288756 Ns"
- InvoiceDate: "2025-10-22"
- רכב: "1234567"
↓
עיבוד:
- זיהוי ספק: 5014
- מיפוי רכב → חשבון: 66979
- יצירת פריט לרכב
↓
פלט: תבנית מאוחדת
{
  "llm_prompt": {
    "supplier_code": "5014",
    "all_templates": [...]
  },
  "invoice_data": {
    "PINVOICES": [{
      "BOOKNUM": "288756 Ns",  ← עדיין לא מנוקה
      "IVDATE": "22/10/25"
    }]
  }
}
                            </div>

                            <h3>3️⃣ Production Invoice</h3>
                            <div class="code-block">
קלט: תבנית מאוחדת
↓
עיבוד:
- חילוץ תבנית מ-all_templates
- ניקוי BOOKNUM: "288756 Ns" → "288756"
- העתקת פריטים מתבנית
- בניית חשבונית סופית
↓
פלט: JSON ל-Priority
{
  "invoice_data": {
    "PINVOICES": [{
      "SUPNAME": "5014",
      "BOOKNUM": "288756",  ← מנוקה! ✅
      "IVDATE": "22/10/25",
      "PINVOICEITEMS_SUBFORM": [{
        "PARTNAME": "car",
        "ACCNAME": "66979",
        "PDES": "התקנת מצלמה",
        "PRICE": 300
      }]
    }]
  }
}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECTION 5: Common Issues -->
                <div class="accordion-item">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <span>❗ בעיות נפוצות ופתרונות</span>
                        <span class="accordion-icon">▼</span>
                    </div>
                    <div class="accordion-content">
                        <div class="accordion-body">
                            <h3>🔴 בעיה 1: BOOKNUM לא נקי</h3>
                            <div class="warning-box">
                                <strong>תסמין:</strong> BOOKNUM = "288756 Ns" במקום "288756"
                                <br><strong>סיבה:</strong> Production Invoice לא מנקה suffix
                                <br><strong>פתרון:</strong> הוספת regex ב-searchBooknum: <code>/^[\d\-\/]+/</code>
                                <br><strong>סטטוס:</strong> ✅ תוקן ב-v16:02
                            </div>

                            <h3>🔴 בעיה 2: PINVOICEITEMS_SUBFORM חסר</h3>
                            <div class="warning-box">
                                <strong>תסמין:</strong> החשבונית ללא פריטים
                                <br><strong>סיבה:</strong> חילוץ תבנית לא עובד - מחפש במקום הלא נכון
                                <br><strong>פתרון:</strong> חילוץ מ-llm_prompt.all_templates[].invoice_data.PINVOICES[0]
                                <br><strong>סטטוס:</strong> ✅ תוקן ב-v15:15
                            </div>

                            <h3>🔴 בעיה 3: result = {} (ריק)</h3>
                            <div class="warning-box">
                                <strong>תסמין:</strong> שדה result ריק למרות שהקוד רץ
                                <br><strong>סיבה:</strong> הקוד לא מחזיר את result בסוף
                                <br><strong>פתרון:</strong> הוספת <code>return result;</code>
                                <br><strong>סטטוס:</strong> ✅ תוקן ב-v15:00
                            </div>

                            <h3>🔴 בעיה 4: תוצאה לא קריאה (string)</h3>
                            <div class="warning-box">
                                <strong>תסמין:</strong> התוצאה string גדול במקום object
                                <br><strong>סיבה:</strong> החזרת JSON.stringify(result) במקום result
                                <br><strong>פתרון:</strong> החזרת object: <code>return result;</code>
                                <br><strong>סטטוס:</strong> ✅ תוקן ב-v15:42
                            </div>

                            <h3>🔴 בעיה 5: קישורים לא עובדים</h3>
                            <div class="warning-box">
                                <strong>תסמין:</strong> לחיצה על קישור בדוקומנטציה לא עובדת
                                <br><strong>סיבה:</strong> רווחים בשמות תיקיות (Processing Invoice, Production Invoice)
                                <br><strong>פתרון:</strong> שימוש ב-%20 או מסמך אחד מאוחד (זה!)
                                <br><strong>סטטוס:</strong> ✅ תוקן - נוצר מסמך מאוחד
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECTION 6: File Locations -->
                <div class="accordion-item">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <span>📁 מיקומי קבצים וקוד</span>
                        <span class="accordion-icon">▼</span>
                    </div>
                    <div class="accordion-content">
                        <div class="accordion-body">
                            <h3>📂 מבנה תיקיות</h3>
                            <div class="code-block">
MakeCode/
├── SupplierDataLearning/
│   ├── v1.2-complete.js
│   └── EXEMPTS/  ← קבצי בדיקה
│
├── Processing Invoice/
│   ├── v4.2-COMPLETE.js
│   └── EXEMPTS/  ← קבצי בדיקה
│
├── Production Invoice/
│   ├── v1.0-production.js  (v16:02)
│   └── EXEMPTS/  ← קבצי בדיקה
│
└── Complete-Documentation.html  ← מסמך זה
                            </div>

                            <h3>🔍 איך למצוא קבצי בדיקה</h3>
                            <div class="code-block">
# מציאת קבצי הבדיקה האחרונים:
ls -lt "MakeCode/Production Invoice/EXEMPTS" | head -5

# חיפוש לפי גרסה:
grep "DEBUG-v16:02" "MakeCode/Production Invoice/EXEMPTS"/*.js
                            </div>

                            <h3>📝 גרסאות עדכניות</h3>
                            <ul>
                                <li><strong>Supplier Data Learning:</strong> v1.2</li>
                                <li><strong>Processing Invoice:</strong> v4.2</li>
                                <li><strong>Production Invoice:</strong> v1.0 (v16:02)</li>
                            </ul>

                            <div class="info-box">
                                <h4>⚠️ כלל חשוב</h4>
                                <p>קבצי בדיקה (EXEMPTS) תמיד ממוקמים באותה תיקיה עם הקוד!</p>
                                <p>לא צריך לחפש במקומות אחרים.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <footer>
            <p>📅 עודכן לאחרונה: 05 נובמבר 2025, 16:05</p>
            <p>🔧 גרסאות: Supplier Learning 1.2 | Processing Invoice 4.2 | Production Invoice v16:02</p>
            <p>✅ תיקונים אחרונים: ניקוי BOOKNUM, חילוץ תבניות מ-v4.2, החזרת object, מסמך מאוחד</p>
        </footer>
    </div>

    <script>
        function toggleAccordion(header) {
            const content = header.nextElementSibling;
            const allHeaders = document.querySelectorAll('.accordion-header');
            const allContents = document.querySelectorAll('.accordion-content');

            // Close all others
            allHeaders.forEach(h => {
                if (h !== header) {
                    h.classList.remove('active');
                }
            });
            allContents.forEach(c => {
                if (c !== content) {
                    c.classList.remove('active');
                }
            });

            // Toggle current
            header.classList.toggle('active');
            content.classList.toggle('active');
        }
    </script>
</body>
</html>
