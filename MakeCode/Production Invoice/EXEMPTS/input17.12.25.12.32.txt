[
    {
        "input": [
            {
                "name": "learned_config",
                "value": {
                    "status": "success",
                    "llm_prompt": {
                        "supplier_code": "3710",
                        "supplier_name": "×“×¨×™×Ÿ ×˜×¨×’×œ ×•×©×•×ª`",
                        "all_templates": [
                            {
                                "template_index": 0,
                                "document_type": "×—×©×‘×•× ×™×ª ×¨×’×™×œ×” ×¢× ×¤×™×¨×•×˜",
                                "document_type_info": {
                                    "type": "×—×©×‘×•× ×™×ª ×¨×’×™×œ×” ×¢× ×¤×™×¨×•×˜",
                                    "type_key": "regular_invoice",
                                    "structure_flags": {
                                        "has_import": false,
                                        "has_doc": false,
                                        "has_purchase_orders": false,
                                        "has_date_range": false,
                                        "has_budcode": false,
                                        "has_pdaccname": false,
                                        "inventory_management": "not_managed_inventory",
                                        "debit_type": "D"
                                    }
                                },
                                "instructions": {
                                    "overview": "×—×©×‘×•× ×™×ª ×ž×¡×¤×§ ×“×¨×™×Ÿ ×˜×¨×’×œ ×•×©×•×ª`",
                                    "processing_steps": [
                                        "1. ×–×”×” ××ª ×ž×¡×¤×¨ ×”×—×©×‘×•× ×™×ª (BOOKNUM) ×ž×ª×•×š InvoiceId",
                                        "2. ×—×œ×¥ ×ª××¨×™×š ×—×©×‘×•× ×™×ª (IVDATE) ×ž×ª×•×š InvoiceDate - ×”×ž×¨ ×œ×¤×•×¨×ž×˜ DD/MM/YY",
                                        "3. ×—×œ×¥ ×ª×™××•×¨ ×›×œ×œ×™ (DETAILS) - ×ª×™××•×¨ ×”×©×™×¨×•×ª ×”×¢×™×§×¨×™ (×œ× ×˜×œ×¤×•×Ÿ/×›×ª×•×‘×ª!)",
                                        "4. ×œ×›×œ ×¤×¨×™×˜: ×—×œ×¥ PDES (×ª×™××•×¨), TQUANT (×›×ž×•×ª), PRICE (×ž×—×™×¨ ×œ×¤× ×™ ×ž×¢\"×ž)",
                                        "5. ×œ×›×œ ×¤×¨×™×˜: ×‘×—×¨ ACCNAME ×ž×ª×•×š ×”×—×©×‘×•× ×•×ª ×”×–×ž×™× ×™× ×œ×¤×™ ×¡×•×’ ×”×”×•×¦××”",
                                        "6. ×‘×“×•×§ ×× ×™×© ×ž×¡×¤×¨ ×”×§×¦××” (×¨×§ ×× ×ž×•×¤×™×¢×” ×”×ž×™×œ×” '×”×§×¦××”'!) - ×× ×›×Ÿ, ×¨×©×•× ×‘-SDINUMIT",
                                        "7. ×—×©×‘ ×ž×—×™×¨: SubTotal_amount ××• (InvoiceTotal - TotalTax)"
                                    ],
                                    "fields": {
                                        "booknum": {
                                            "field_name": "BOOKNUM",
                                            "description": "×ž×¡×¤×¨ ×—×©×‘×•× ×™×ª ×¡×¤×§",
                                            "how_to_find": "×—×¤×© ×‘×©×“×” InvoiceId ×‘-OCR",
                                            "example": "052785"
                                        },
                                        "ivdate": {
                                            "field_name": "IVDATE",
                                            "description": "×ª××¨×™×š ×—×©×‘×•× ×™×ª",
                                            "how_to_find": "×§×— ××ª InvoiceDate ×•×”×ž×¨ ×œ-DD/MM/YY",
                                            "example": "11/09/25"
                                        },
                                        "details": {
                                            "field_name": "DETAILS",
                                            "description": "×ª×™××•×¨ ×›×œ×œ×™ ×©×œ ×”×—×©×‘×•× ×™×ª ×‘×›×•×ª×¨×ª",
                                            "importance": "×’×‘×•×”×” - ×ž×¡×›× ××ª ×ž×”×•×ª ×”×—×©×‘×•× ×™×ª",
                                            "how_to_find": "×—×¤×© ×ª×™××•×¨ ×”×©×™×¨×•×ª ×”×¢×™×§×¨×™ ×‘×˜×§×¡×˜",
                                            "do_NOT_use": [
                                                "×˜×œ×¤×•×Ÿ",
                                                "×¤×§×¡",
                                                "×›×ª×•×‘×ª",
                                                "×ž×¡×¤×¨ ×¢×•×¡×§ ×ž×•×¨×©×”"
                                            ],
                                            "example": "×“×•×— ×œ×©× ×ª 2024 ×—×œ×§ 2"
                                        },
                                        "price": {
                                            "field_name": "PRICE",
                                            "location": "PINVOICEITEMS_SUBFORM",
                                            "description": "×ž×—×™×¨ ×œ×¤× ×™ ×ž×¢\"×ž",
                                            "how_to_calculate": "SubTotal_amount ××• (InvoiceTotal_amount - TotalTax_amount)",
                                            "example": 7500
                                        },
                                        "pdes": {
                                            "field_name": "PDES",
                                            "location": "PINVOICEITEMS_SUBFORM",
                                            "description": "×ª×™××•×¨ ×”×¤×¨×™×˜/×©×™×¨×•×ª ×‘×©×•×¨×ª ×”×¤×™×¨×•×˜",
                                            "importance": "×§×¨×™×˜×™! ×–×” ×ž×–×”×” ××ª ×¡×•×’ ×”×”×•×¦××”",
                                            "max_length": 48,
                                            "how_to_find": "×—×¤×© ×‘×˜×§×¡×˜ ×©×•×¨×•×ª ×”×ž×ª××¨×•×ª ×©×™×¨×•×ª×™×",
                                            "example": "×“×•×— ×œ×©× ×ª 2024 ×—×œ×§ 2"
                                        },
                                        "accname": {
                                            "field_name": "ACCNAME",
                                            "location": "PINVOICEITEMS_SUBFORM",
                                            "description": "×—×©×‘×•×Ÿ ×”× ×”×œ×ª ×—×©×‘×•× ×•×ª ×œ×¡×™×•×•×’ ×”×”×•×¦××”",
                                            "importance": "×§×¨×™×˜×™! ×§×•×‘×¢ ××™×š ×”×”×•×¦××” ×ž×¡×•×•×’×ª",
                                            "available_accounts": [
                                                "49998",
                                                "49902"
                                            ],
                                            "examples_from_history": [
                                                {
                                                    "partname": "zzz02",
                                                    "description": "×“×•×— ×œ×©× ×ª 2024 ×—×œ×§ 2",
                                                    "accname": "49998"
                                                },
                                                {
                                                    "partname": "zzz02",
                                                    "description": "×“×•×— ×œ×©× ×ª 2024 ×—×œ×§ 2",
                                                    "accname": "49902"
                                                }
                                            ],
                                            "selection_guide": "×‘×—×¨ ×—×©×‘×•×Ÿ ×œ×¤×™ ×¡×•×’ ×”×”×•×¦××”/×©×™×¨×•×ª ×‘×”×ª×× ×œ×“×•×’×ž××•×ª ×”×”×™×¡×˜×•×¨×™×•×ª",
                                            "note": "×™×© 2 ×—×©×‘×•× ×•×ª ××¤×©×¨×™×™× - ×‘×—×¨ ×œ×¤×™ ×¡×•×’ ×”×”×•×¦××”"
                                        },
                                        "sdinumit": {
                                            "field_name": "SDINUMIT",
                                            "location": "PINVOICESCONT_SUBFORM",
                                            "description": "×ž×¡×¤×¨ ×”×§×¦××” ×ž×¨×©×•×ª ×”×ž×™×¡×™×",
                                            "importance": "×§×¨×™×˜×™ ×œ×—×©×‘×•× ×™×•×ª ×ž×¢×œ ×¡×£! ×œ×œ× ×ž×¡×¤×¨ ×–×” ×œ× × ×™×ª×Ÿ ×œ× ×›×•×ª ×ž×¢\"×ž",
                                            "format": "9 ×¡×¤×¨×•×ª",
                                            "rule": "×¨×§ ×× ×ž×•×¤×™×¢×” ×”×ž×™×œ×” '×”×§×¦××”' ×‘×ž×¤×•×¨×©!",
                                            "search_keywords": [
                                                "×ž×¡×¤×¨ ×”×§×¦××”",
                                                "×”×§×¦××” ×ž×¡'"
                                            ],
                                            "NOT_valid": [
                                                "×ª×¢×•×“×ª ×¨×™×©×•×",
                                                "×ž×¡×¤×¨ ××¡×ž×›×ª×"
                                            ],
                                            "example": null
                                        }
                                    }
                                },
                                "sample_from_history": {
                                    "IV": 1348583,
                                    "VAT": 1350,
                                    "CODE": "×©\"×—",
                                    "DIFF": 7500,
                                    "DEBIT": "D",
                                    "FINAL": "Y",
                                    "IVNUM": "25067090",
                                    "FNCNUM": "25102571",
                                    "IVDATE": "2025-09-11T00:00:00+03:00",
                                    "IVTYPE": "P",
                                    "QPRICE": 7500,
                                    "SUPDES": "×“×¨×™×Ÿ ×˜×¨×’×œ ×•×©×•×ª`",
                                    "BOOKNUM": "052785",
                                    "DETAILS": "×“×¨×™×Ÿ 8/25",
                                    "PAYDATE": "2025-09-11T00:00:00+03:00",
                                    "STATDES": "×¡×•×¤×™×ª",
                                    "SUPNAME": "3710",
                                    "DISPRICE": 7500,
                                    "TOTPRICE": 8850,
                                    "TOTQUANT": 1,
                                    "TYPEDDATE": "2025-09-17T00:00:00+03:00",
                                    "OWNERLOGIN": "××•×¨× ×”",
                                    "EXTFILEFLAG": "Y",
                                    "TYPEDBYLOGIN": "××•×¨× ×”",
                                    "PINVOICEITEMS_SUBFORM": [
                                        {
                                            "PARTNAME": "zzz02",
                                            "PDES": "×ª×œ×•×©×™ ×©×›×¨",
                                            "TQUANT": 1,
                                            "TUNITNAME": "×™×—'",
                                            "QUANT": 1,
                                            "UNITNAME": "×™×—'",
                                            "PRICE": 7500,
                                            "ICODE": "×©\"×—",
                                            "PRSOURCENAME": "×™×“× ×™",
                                            "QPRICE": 7500,
                                            "TOTPRICE": 8850,
                                            "CODE": "×©\"×—",
                                            "VATFLAG": "Y",
                                            "BARCODE": "zzz02",
                                            "ACCNAME": "49902",
                                            "ACCDES": "×”×•×¦××•×ª ×œ×©×œ×",
                                            "EXCH": 1,
                                            "USERLOGIN": "××•×¨× ×”",
                                            "UDATE": "2025-09-17T14:59:00+03:00",
                                            "KLINE": 1
                                        }
                                    ],
                                    "PINVOICESCONT_SUBFORM": [
                                        {
                                            "ADRS": "×”×ž×œ××›×” 8 ××™×–×•×¨ ×ª×¢×©×™×” ×—×“×©",
                                            "STATE": "× ×ª× ×™×”",
                                            "COUNTRYNAME": "Israel",
                                            "ZIP": "42296",
                                            "PHONE": "073-2400700",
                                            "FAX": "8628554",
                                            "PAYCODE": "00",
                                            "PAYDES": "×ž×–×•×ž×Ÿ",
                                            "FNCPATNAME": "×—×¡×ž",
                                            "FNCPATDES2": "×—×©×‘×•× ×™×ª ×¡×¤×§ ×ž×¨×›×–×ª",
                                            "TAXCODE": "002",
                                            "IVREF": "557149143",
                                            "USERLOGIN": "×—×Ÿ",
                                            "UDATE": "2025-09-30T09:50:00+03:00",
                                            "DEBIT": "D",
                                            "IVNUM": "25067090"
                                        }
                                    ]
                                },
                                "ocr_extracted": {
                                    "subtotal": 7500,
                                    "total_tax": 1350,
                                    "invoice_total": 8850
                                },
                                "invoice_data": {
                                    "PINVOICES": [
                                        {
                                            "SUPNAME": "3710",
                                            "CODE": "×©\"×—",
                                            "DEBIT": "D",
                                            "IVDATE": "11/09/25",
                                            "BOOKNUM": "052785",
                                            "DETAILS": "×“×•×— ×œ×©× ×ª 2024 ×—×œ×§ 2",
                                            "PINVOICEITEMS_SUBFORM": [
                                                {
                                                    "PARTNAME": "zzz02",
                                                    "TUNITNAME": "×™×—'",
                                                    "VATFLAG": "Y",
                                                    "ACCNAME": "49998",
                                                    "PDES": "2025 ×¨×™×˜×™×™× ×¨ ××•×’×•×¡×˜",
                                                    "TQUANT": 1,
                                                    "PRICE": 0
                                                }
                                            ]
                                        }
                                    ]
                                }
                            }
                        ]
                    },
                    "technical_config": {
                        "supplier_code": "3710",
                        "supplier_name": "×“×¨×™×Ÿ ×˜×¨×’×œ ×•×©×•×ª`",
                        "all_templates": [
                            {
                                "template_index": 0,
                                "version": "5.5",
                                "document_type": "regular_invoice",
                                "extraction_rules": {
                                    "booknum": {
                                        "source": "ocrFields.InvoiceId",
                                        "transformations": [
                                            {
                                                "action": "remove_prefix",
                                                "pattern": "^SI"
                                            },
                                            {
                                                "action": "take_last_n_chars",
                                                "count": 7
                                            }
                                        ],
                                        "example": "052785"
                                    },
                                    "ivdate": {
                                        "source": "ocrFields.InvoiceDate",
                                        "format": "DD/MM/YY",
                                        "example": "11/09/25"
                                    },
                                    "details": {
                                        "source": "azureText",
                                        "method": "find_service_description",
                                        "exclude": [
                                            "×˜×œ×¤×•×Ÿ",
                                            "×¤×§×¡",
                                            "×›×ª×•×‘×ª",
                                            "×¢×•×¡×§ ×ž×•×¨×©×”"
                                        ],
                                        "example": "×“×•×— ×œ×©× ×ª 2024 ×—×œ×§ 2"
                                    },
                                    "price": {
                                        "primary": "ocrFields.SubTotal_amount",
                                        "fallback": "ocrFields.InvoiceTotal_amount - ocrFields.TotalTax_amount",
                                        "example": 7500
                                    },
                                    "sdinumit": {
                                        "source": "azureText",
                                        "required_keyword": "×”×§×¦××”",
                                        "pattern": "×”×§×¦××”[:s]*(d{9})",
                                        "example": null
                                    },
                                    "accname": {
                                        "available_accounts": [],
                                        "selection_method": "single_account",
                                        "partname_rules": null
                                    },
                                    "fncpatname": {
                                        "source": "template.sample",
                                        "value": null,
                                        "note": "×§×‘×•×¢ ×ž×”×ª×‘× ×™×ª ×”× ×œ×ž×“×ª"
                                    },
                                    "pdes": {
                                        "source": "azureText or ocrFields.Items",
                                        "max_length": 48,
                                        "importance": "critical",
                                        "note": "×ª×™××•×¨ ×”×¤×¨×™×˜/×©×™×¨×•×ª - ×§×¨×™×˜×™ ×œ×–×™×”×•×™ ×¡×•×’ ×”×”×•×¦××”"
                                    }
                                },
                                "structure_flags": {
                                    "has_import": false,
                                    "has_doc": false,
                                    "has_purchase_orders": false,
                                    "has_date_range": false,
                                    "has_budcode": false,
                                    "has_pdaccname": false,
                                    "inventory_management": "not_managed_inventory",
                                    "debit_type": "D"
                                },
                                "validation_rules": {
                                    "required_fields": [
                                        "SUPNAME",
                                        "CODE",
                                        "DEBIT",
                                        "IVDATE",
                                        "BOOKNUM"
                                    ]
                                },
                                "sample_from_history": {
                                    "IV": 1348583,
                                    "VAT": 1350,
                                    "CODE": "×©\"×—",
                                    "DIFF": 7500,
                                    "DEBIT": "D",
                                    "FINAL": "Y",
                                    "IVNUM": "25067090",
                                    "FNCNUM": "25102571",
                                    "IVDATE": "2025-09-11T00:00:00+03:00",
                                    "IVTYPE": "P",
                                    "QPRICE": 7500,
                                    "SUPDES": "×“×¨×™×Ÿ ×˜×¨×’×œ ×•×©×•×ª`",
                                    "BOOKNUM": "052785",
                                    "DETAILS": "×“×¨×™×Ÿ 8/25",
                                    "PAYDATE": "2025-09-11T00:00:00+03:00",
                                    "STATDES": "×¡×•×¤×™×ª",
                                    "SUPNAME": "3710",
                                    "DISPRICE": 7500,
                                    "TOTPRICE": 8850,
                                    "TOTQUANT": 1,
                                    "TYPEDDATE": "2025-09-17T00:00:00+03:00",
                                    "OWNERLOGIN": "××•×¨× ×”",
                                    "EXTFILEFLAG": "Y",
                                    "TYPEDBYLOGIN": "××•×¨× ×”",
                                    "PINVOICEITEMS_SUBFORM": [
                                        {
                                            "PARTNAME": "zzz02",
                                            "PDES": "×ª×œ×•×©×™ ×©×›×¨",
                                            "TQUANT": 1,
                                            "TUNITNAME": "×™×—'",
                                            "QUANT": 1,
                                            "UNITNAME": "×™×—'",
                                            "PRICE": 7500,
                                            "ICODE": "×©\"×—",
                                            "PRSOURCENAME": "×™×“× ×™",
                                            "QPRICE": 7500,
                                            "TOTPRICE": 8850,
                                            "CODE": "×©\"×—",
                                            "VATFLAG": "Y",
                                            "BARCODE": "zzz02",
                                            "ACCNAME": "49902",
                                            "ACCDES": "×”×•×¦××•×ª ×œ×©×œ×",
                                            "EXCH": 1,
                                            "USERLOGIN": "××•×¨× ×”",
                                            "UDATE": "2025-09-17T14:59:00+03:00",
                                            "KLINE": 1
                                        }
                                    ],
                                    "PINVOICESCONT_SUBFORM": [
                                        {
                                            "ADRS": "×”×ž×œ××›×” 8 ××™×–×•×¨ ×ª×¢×©×™×” ×—×“×©",
                                            "STATE": "× ×ª× ×™×”",
                                            "COUNTRYNAME": "Israel",
                                            "ZIP": "42296",
                                            "PHONE": "073-2400700",
                                            "FAX": "8628554",
                                            "PAYCODE": "00",
                                            "PAYDES": "×ž×–×•×ž×Ÿ",
                                            "FNCPATNAME": "×—×¡×ž",
                                            "FNCPATDES2": "×—×©×‘×•× ×™×ª ×¡×¤×§ ×ž×¨×›×–×ª",
                                            "TAXCODE": "002",
                                            "IVREF": "557149143",
                                            "USERLOGIN": "×—×Ÿ",
                                            "UDATE": "2025-09-30T09:50:00+03:00",
                                            "DEBIT": "D",
                                            "IVNUM": "25067090"
                                        }
                                    ]
                                }
                            }
                        ]
                    },
                    "processing_scenario": {
                        "supplier_code": "3710",
                        "supplier_name": "×“×¨×™×Ÿ ×˜×¨×’×œ ×•×©×•×ª`",
                        "all_templates": [
                            {
                                "document_type": "regular_invoice",
                                "check_docs": false,
                                "check_import": false,
                                "check_vehicles": false,
                                "check_sdinumit": true,
                                "extract_line_items": true,
                                "account_selection_required": false,
                                "debit_type": "D",
                                "inventory_management": "not_managed_inventory"
                            }
                        ]
                    },
                    "execution_report": {
                        "stage": "×©×œ×‘ 3: ×‘× ×™×™×ª ×¤×œ×˜",
                        "found": [
                            "×¡×”\"×› ×ª×‘× ×™×•×ª: 1",
                            "×ª×‘× ×™×•×ª × ×¡×¨×§×•: 1",
                            "×ª×‘× ×™×ª 0: ×™×‘×•×=false, ×ª×¢×•×“×•×ª=false, ×—×™×•×‘/×–×™×›×•×™=D"
                        ],
                        "not_found": [],
                        "warnings": [],
                        "errors": [],
                        "templates_processed": [
                            {
                                "template_index": 0,
                                "document_type": "×—×©×‘×•× ×™×ª ×¨×’×™×œ×” ×¢× ×¤×™×¨×•×˜",
                                "status": "success"
                            }
                        ]
                    }
                }
            },
            {
                "name": "docs_list",
                "value": "[]"
            },
            {
                "name": "import_files",
                "value": "[]"
            },
            {
                "name": "vehicles",
                "value": "[]"
            },
            {
                "name": "AZURE_RESULT",
                "value": {
                    "structure": {
                        "docType": "string",
                        "fields": {
                            "AmountDue_amount": "number",
                            "AmountDue_currency": "string",
                            "CustomerAddress": "string",
                            "CustomerAddress_houseNumber": "string",
                            "CustomerAddress_road": "string",
                            "CustomerAddress_streetAddress": "string",
                            "CustomerAddress_house": "string",
                            "CustomerAddressRecipient": "string",
                            "CustomerName": "string",
                            "CustomerTaxId": "string",
                            "InvoiceDate": "YYYY-MM-DD",
                            "InvoiceId": "string",
                            "InvoiceTotal_amount": "number",
                            "InvoiceTotal_currency": "string",
                            "SubTotal_amount": "number",
                            "SubTotal_currency": "string",
                            "TotalDiscount_amount": "number",
                            "TotalDiscount_currency": "string",
                            "TotalTax_amount": "number",
                            "TotalTax_currency": "string",
                            "VendorAddress": "string",
                            "VendorAddress_houseNumber": "string",
                            "VendorAddress_road": "string",
                            "VendorAddress_poBox": "string",
                            "VendorAddress_city": "string",
                            "VendorAddress_streetAddress": "string",
                            "VendorAddress_house": "string",
                            "VendorAddressRecipient": "string",
                            "VendorName": "string",
                            "VendorTaxId": "string",
                            "VendorTel": "string",
                            "VendorFax": "string",
                            "InvoiceTime": "HH:MM:SS",
                            "DueDate": "YYYY-MM-DD",
                            "CustomerEmail": "string",
                            "UnidentifiedNumbers": [
                                "object"
                            ]
                        },
                        "Items": [
                            {
                                "LineNumber": {
                                    "type": "number",
                                    "originalHeader": "×¡×”×´×› ×‘×©×´×—"
                                },
                                "UnitPrice": {
                                    "type": "number",
                                    "originalHeader": "×ž×—×™×¨ ×‘ $"
                                },
                                "Quantity": {
                                    "type": "number",
                                    "originalHeader": "×›×ž×•×ª"
                                },
                                "Description": {
                                    "type": "string",
                                    "originalHeader": "×ª××•×¨"
                                }
                            }
                        ]
                    },
                    "data": {
                        "docType": "invoice",
                        "fields": {
                            "AmountDue_amount": 8850,
                            "AmountDue_currency": "ILS",
                            "CustomerAddress": "×”×§×˜×™×£ 11 ×¤××¨×§ ×ª×¢×©×™×•×ª",
                            "CustomerAddress_houseNumber": "11",
                            "CustomerAddress_road": "×”×§×˜×™×£",
                            "CustomerAddress_streetAddress": "11 ×”×§×˜×™×£",
                            "CustomerAddress_house": "×¤××¨×§ ×ª×¢×©×™×•×ª",
                            "CustomerAddressRecipient": "×˜.×¤.×™ ×¤×œ ×™× ×‘×¢×´×ž",
                            "CustomerName": "×˜.×¤.×™ ×¤×œ ×™× ×‘×¢×´×ž",
                            "CustomerTaxId": "513327064",
                            "InvoiceDate": "2025-08-25",
                            "InvoiceId": "052569",
                            "InvoiceTotal_amount": 8850,
                            "InvoiceTotal_currency": "ILS",
                            "Items": [
                                {
                                    "LineNumber": 7500,
                                    "UnitPrice": 0,
                                    "Quantity": 1,
                                    "Description": "2025 ×¨×™×˜×™×™× ×¨ ×™×•×œ×™"
                                }
                            ],
                            "SubTotal_amount": 7500,
                            "SubTotal_currency": "ILS",
                            "TotalDiscount_amount": 0,
                            "TotalDiscount_currency": "ILS",
                            "TotalTax_amount": 1350,
                            "TotalTax_currency": "ILS",
                            "VendorAddress": "×¨×—×³ ×”×ž×œ××›×” 8 ×ª.×“. 8642 ×.×ª. ×¤×•×œ×’ × ×ª× ×™×”",
                            "VendorAddress_houseNumber": "8",
                            "VendorAddress_road": "×¨×—×³ ×”×ž×œ××›×”",
                            "VendorAddress_poBox": "×ª.×“. 8642",
                            "VendorAddress_city": "× ×ª× ×™×”",
                            "VendorAddress_streetAddress": "8 ×¨×—×³ ×”×ž×œ××›×” ×ª.×“. 8642",
                            "VendorAddress_house": "×.×ª. ×¤×•×œ×’",
                            "VendorAddressRecipient": "×“×¨×™×Ÿ, ×˜×¨×’×œ ×•×©×•×ª' - ×¨×•××™ ×—×©×‘×•×Ÿ",
                            "VendorName": "×“×¨×™×Ÿ, ×˜×¨×’×œ ×•×©×•×ª' - ×¨×•××™ ×—×©×‘×•×Ÿ",
                            "VendorTaxId": "557149143",
                            "VendorTel": "073-2400700",
                            "VendorFax": "09-8628554",
                            "InvoiceTime": "10:41:23",
                            "DueDate": "2025-08-24",
                            "CustomerEmail": "account@t-p-y.co.il",
                            "UnidentifiedNumbers": [
                                {
                                    "label": "×˜×œ×¤×•×Ÿ",
                                    "value": "073-2400700 ×¤×§×¡: 09-8628554"
                                },
                                {
                                    "label": "×¢×ž×§ ×—×¤×¨",
                                    "value": 3877701
                                },
                                {
                                    "label": "×ž×¡×¤×¨ ×œ×§×•×—",
                                    "value": 260
                                },
                                {
                                    "label": "×ž×¡×¤×¨",
                                    "value": "2230018"
                                }
                            ]
                        }
                    },
                    "metadata": {
                        "modelId": "",
                        "totalFields": 37,
                        "uniqueDataFound": 4,
                        "pageCount": 1
                    },
                    "status": "success"
                }
            },
            {
                "name": "AZURE_TEXT_CLEAN",
                "value": "×“×¨×™×Ÿ, ×˜×¨×’×œ ×•×©×•×ª' - ×¨×•××™ ×—×©×‘×•×Ÿ\n×¨×—×³ ×”×ž×œ××›×” 8 ×ª.×“. 8642 ×.×ª. ×¤×•×œ×’ × ×ª× ×™×”\n×˜×œ×¤×•×Ÿ: 073-2400700 ×¤×§×¡: 09-8628554\n×¢×•×¡×§ ×ž×•×¨×©×” 557149143\n×ž×¡×ž×š ×ž×ž×•×—×©×‘\n×—×©×‘×•× ×™×ª ×ž×¡ / ×§×‘×œ×” ×ž×¡×¤×¨ 052569\n×œ×›×‘×•×“:\n×ž×§×•×¨\n×˜.×¤.×™ ×¤×œ ×™× ×‘×¢×´×ž\n×”×§×˜×™×£ 11 ×¤××¨×§ ×ª×¢×©×™×•×ª\n×ª××¨×™×š ×ž×¡×ž×š: 25/08/2025\n×¢×ž×§ ×—×¤×¨ 3877701\n×ž×¡×¤×¨ ×œ×§×•×—: 260\naccount@t-p-y.co.il\n×ž. ×¢×•×¡×§ ×œ×§×•×—: 513327064\n×¤×¨×˜×™ ×”×—×©×‘×•× ×™×ª\n×ª××•×¨\n×›×ž×•×ª\n×ž×—×™×¨ ×‘ $\n×ž×—×™×¨ ×‘×©×´×— ××—×•×– ×”× ×—×”\n×¡×”×´×› ×‘×©×´×—\n2025 ×¨×™×˜×™×™× ×¨ ×™×•×œ×™\n1\n0.00\n7,500.00\n7,500.00\n×”× ×—×”/×ª×•×¡×¤×ª ×¢×™×’×•×œ\n0.00\n×¡×”×´×› ×œ×¤× ×™ ×ž×¢×´×ž\n7,500.00\n% 18 ×ž×¢×´×ž\n1,350.00\n×¡×”×´×› ×›×•×œ×œ ×ž×¢×´×ž\n8,850.00\n×¤×¨×˜×™ ×”×ª×§×‘×•×œ×™×\n××•×¤×Ÿ ×ª×©×œ×•×\n×ž×¡×¤×¨\n×‘× ×§\n×¡× ×™×£ ×—×©×‘×•×Ÿ\n×ª××¨×™×š ×¤×¨×¢×•×Ÿ\n×¡×›×•×\n×”×¢×‘×¨×”\n10\n744\n2230018\n24/08/2025\n8,850.00\n× ×™×›×•×™ ×ž×¡ ×‘×ž×§×•×¨\n×¡×”×´×› ×©×©×•×œ×\n8,850.00\n×”×•×¤×§ ×¢×´×™ ××©×¤×™×ª ×©×œ ×˜.×ž.×œ ×‘×ª××¨×™×š 25/08/2025 ×‘×©×¢×” 10:41:23 ×¢×¤×´×™ ×ª×¢×•×“×ª ×¨×™×©×•× (×ž×´×”) ×ž×¡×¤×¨ 97509\n×ž×¡×ž×š ×–×” × ×—×ª× ×‘×—×ª×™×ž×” ×“×™×’×™×˜×œ×™×ª ×ž××•×‘×˜×—×ª"
            },
            {
                "name": "template_index",
                "value": 0
            }
        ],
        "language": "javascript",
        "inputFormat": "string",
        "dependencies": [],
        "codeStringJavascript": "// ============================================================================\n// ×§×•×“ 3 - ×™×™×¦×•×¨ ×—×©×‘×•× ×™×•×ª (×’×¨×¡×” 1.8.5 - 16.12.25)\n// ×¢×“×›×•×Ÿ ××—×¨×•×Ÿ: 16.12.25 17:45\n//\n// ×ž×§×‘×œ: learned_config, docs_list, import_files, vehicles, AZURE_RESULT, AZURE_TEXT_CLEAN\n//        + template_index (××•×¤×¦×™×•× ×œ×™)\n// ×ž×—×–×™×¨: JSON ×œ×¤×¨×™×•×¨×™×˜×™ (PINVOICES + ×ª×¢×•×“×•×ª/×¤×¨×™×˜×™×/×¨×›×‘×™×) + ×“×•×— ×‘×™×¦×•×¢ + validation + field_mapping\n//\n// ðŸ“ ×§×‘×¦×™ ×‘×“×™×§×”: MakeCode/Production Invoice/EXEMPTS/\n// ×œ×§×™×—×ª ×”×§×•×‘×¥ ×”×¢×“×›× ×™: ls -lt \"MakeCode/Production Invoice/EXEMPTS\" | head -5\n//\n// âš ï¸ ×§×©×•×¨ ×œ: MakeCode/Processing Invoice/v5.1\n// ×× ×ž×ª×§× ×™× ×‘×¢×™×” ×›××Ÿ (×›×ž×• ×ª×‘× ×™×ª BOOKNUM, docs_list) - ×œ×‘×“×•×§ ×’× ×©×!\n//\n// ×ª×™×§×•× ×™×:\n// v1.8.5: DETAILS fallback ×ž-template.DETAILS (×›×©××™×Ÿ searchResults ×•××™×Ÿ PDES)\n// v1.8.4: ×—×™×œ×•×¥ PDES ×ž-AZURE_TEXT_CLEAN (×›×©××™×Ÿ Description ×‘-Items)\n// v1.8.3: ×ª×™×§×•×Ÿ DETAILS - ×”×¡×¨×ª ×‘×“×™×§×ª vehicles (×ž×¢×¨×š ×¨×™×§ ×”×•× truthy!)\n// v1.8.2: ×ª×™×§×•×Ÿ AZURE_RESULT quote ×‘×”×ª×—×œ×”, PRICE ×ž-SubTotal ×œ×¤×¨×™×˜ ×™×—×™×“\n// v1.8.1: ×œ×¢×•×œ× ×œ× ×ž×—×–×™×¨ ×©×’×™××”! ×× ××™×Ÿ ×”×ª××ž×” - ×œ×•×§×— ×ª×‘× ×™×ª 0 + ×ž×“×•×•×— ×‘×¤×™×¨×•×˜\n// ============================================================================\n\n// âš ï¸ CRITICAL: result ×—×™×™×‘ ×œ×”×™×•×ª global ×›×“×™ ×©-Make.com ×™×§×¨× ××•×ª×•!\n// ×ž×©×ª×ž×©×™× ×‘-var (×œ× let) ×›×“×™ ×œ×™×¦×•×¨ ×ž×©×ª× ×” ×’×œ×•×‘×œ×™ ××ž×™×ª×™\nvar result;\n\n(function() {\n\nfunction removeUndefinedValues(obj) {\n    if (Array.isArray(obj)) {\n        return obj.map(item => removeUndefinedValues(item));\n    } else if (obj !== null && typeof obj === 'object') {\n        const cleaned = {};\n        for (const [key, value] of Object.entries(obj)) {\n            if (value !== undefined) {\n                cleaned[key] = removeUndefinedValues(value);\n            }\n        }\n        return cleaned;\n    }\n    return obj;\n}\n\nfunction cleanInvoiceForPriority(invoice) {\n    const cleaned = JSON.parse(JSON.stringify(invoice));\n    if (!cleaned.PINVOICESCONT_SUBFORM) {\n        cleaned.PINVOICESCONT_SUBFORM = [];\n    }\n    if (cleaned.PINVOICEITEMS_SUBFORM) {\n        cleaned.PINVOICEITEMS_SUBFORM = cleaned.PINVOICEITEMS_SUBFORM.map(item => {\n            delete item.isNewVehicle;\n            delete item._learningNote;\n            if (item.SPECIALVATFLAG && item.SPECIALVATFLAG !== \"Y\") {\n                delete item.SPECIALVATFLAG;\n            }\n            if (item.BUDCODE === undefined) delete item.BUDCODE;\n            if (item.SPECIALVATFLAG === undefined) delete item.SPECIALVATFLAG;\n            if (item.TUNITNAME === undefined) delete item.TUNITNAME;\n            return item;\n        });\n    }\n    return cleaned;\n}\n\nfunction normalizeAzureFields(rawFields) {\n    if (!rawFields || typeof rawFields !== 'object') {\n        return {};\n    }\n    const normalized = {};\n    for (const [key, field] of Object.entries(rawFields)) {\n        if (!field || typeof field !== 'object') {\n            normalized[key] = field;\n            continue;\n        }\n        if (field.valueString !== undefined) {\n            normalized[key] = field.valueString;\n        } else if (field.valueDate !== undefined) {\n            normalized[key] = field.valueDate;\n        } else if (field.valueNumber !== undefined) {\n            normalized[key] = field.valueNumber;\n        } else if (field.valueCurrency !== undefined && field.valueCurrency !== null) {\n            normalized[key] = (field.valueCurrency && field.valueCurrency.amount) || 0;\n            if (key.includes('Total') || key.includes('Amount')) {\n                normalized[key + '_amount'] = (field.valueCurrency && field.valueCurrency.amount) || 0;\n                normalized[key + '_currency'] = (field.valueCurrency && field.valueCurrency.currencyCode) || '';\n            }\n        } else if (field.valueArray !== undefined && Array.isArray(field.valueArray)) {\n            normalized[key] = field.valueArray.map(item => {\n                if (!item) return item;\n                if (item.valueObject && item.valueObject !== null) {\n                    return normalizeAzureFields(item.valueObject);\n                } else if (item.valueString !== undefined) {\n                    return item.valueString;\n                } else if (item.content !== undefined) {\n                    return item.content;\n                } else {\n                    return item;\n                }\n            });\n        } else if (field.valueObject !== undefined && field.valueObject !== null) {\n            normalized[key] = normalizeAzureFields(field.valueObject);\n        } else if (field.content !== undefined) {\n            normalized[key] = field.content;\n        } else {\n            normalized[key] = field;\n        }\n    }\n    return normalized;\n}\n\nfunction convertProductionInputToProcessingInput(productionInput) {\n    // ×× ×™×© input array, ×× ×™ ×¦×¨×™×š ×œ×—×œ×¥ vehicles ×•×œ×‘× ×•×ª learned_config!\n    let carsData = productionInput.CARS;\n    let supTemp = productionInput.SUP_TEMP;\n    let supname = productionInput.SUPNAME;\n    let azureTextClean = productionInput.AZURE_TEXT_CLEAN || \"\";\n    let existingLearnedConfig = null;\n\n    if (productionInput.input && Array.isArray(productionInput.input)) {\n        // ×—×™×œ×•×¥ ×ž×”-input array\n        for (const item of productionInput.input) {\n            if (item.name === 'vehicles') {\n                carsData = item.value;\n                console.log('ðŸ” Found vehicles in input:', typeof carsData, carsData ? carsData.substring(0, 100) : 'empty');\n            }\n            if (item.name === 'supplier_template') supTemp = item.value;\n            if (item.name === 'supplier_code') supname = item.value;\n            if (item.name === 'AZURE_TEXT_CLEAN') azureTextClean = item.value;\n            if (item.name === 'learned_config') existingLearnedConfig = item.value;\n        }\n\n        // ×× ×™×© learned_config ×§×™×™× ×•×™×© ×‘×• config ×¢× vehicleRules ×˜×•×‘ - × ×©×ª×ž×© ×‘×•\n        const hasVehicleRules = existingLearnedConfig &&\n                               existingLearnedConfig.config &&\n                               existingLearnedConfig.config.rules &&\n                               existingLearnedConfig.config.rules.critical_patterns &&\n                               existingLearnedConfig.config.rules.critical_patterns.vehicle_rules &&\n                               existingLearnedConfig.config.rules.critical_patterns.vehicle_rules.vehicle_account_mapping &&\n                               Object.keys(existingLearnedConfig.config.rules.critical_patterns.vehicle_rules.vehicle_account_mapping).length > 0;\n\n        if (hasVehicleRules) {\n            console.log('âœ… Using existing learned_config with vehicleRules');\n            return productionInput;\n        }\n\n        // ××™×Ÿ learned_config ×˜×•×‘ - × ×‘× ×” ×—×“×© ×ž-vehicles\n        console.log('ðŸ”§ Building new learned_config from vehicles, carsData=' + (carsData ? 'exists' : 'null'));\n    }\n\n    let azureData;\n    if (!productionInput.AZURE) {\n        azureData = {};\n    } else if (typeof productionInput.AZURE === 'string') {\n        try {\n            azureData = JSON.parse(productionInput.AZURE);\n        } catch (e) {\n            azureData = {};\n        }\n    } else {\n        azureData = productionInput.AZURE || {};\n    }\n\n    // ×‘× ×™×™×ª learned_config ×ž-vehicles/CARS\n    console.log('ðŸ”§ Building learned_config: supname=' + supname + ', carsData type=' + typeof carsData);\n    const learnedConfig = buildLearnedConfigFromProduction(\n        supname,\n        carsData,\n        supTemp\n    );\n    let documents = [];\n    let fields = {};\n    let content = \"\";\n    if (azureData.analyzeResult) {\n        content = azureData.analyzeResult.content || \"\";\n        if (azureData.analyzeResult.documents && azureData.analyzeResult.documents.length > 0) {\n            documents = azureData.analyzeResult.documents;\n            const rawFields = documents[0].fields || {};\n            fields = normalizeAzureFields(rawFields);\n            fields._rawContent = content;\n        }\n    } else if (azureData.fields) {\n        fields = azureData.fields;\n        content = azureData.content || \"\";\n        fields._rawContent = content;\n    }\n    return {\n        input: [\n            { name: \"learned_config\", value: learnedConfig },\n            { name: \"docs_list\", value: { DOC_YES_NO: \"N\", list_of_docs: [] } },\n            { name: \"import_files\", value: { IMPFILES: [] } },\n            { name: \"AZURE_RESULT\", value: { data: { fields: fields, documents: documents } } },\n            { name: \"AZURE_TEXT_CLEAN\", value: azureTextClean },\n            { name: \"AZURE_TEXT\", value: content }\n        ]\n    };\n}\n\nfunction buildLearnedConfigFromProduction(supname, cars, supTemp) {\n    const vehicleMapping = {};\n    let carsArray = [];\n    if (typeof cars === 'string') {\n        try {\n            carsArray = JSON.parse(cars);\n        } catch (e) {\n            carsArray = [];\n        }\n    } else if (Array.isArray(cars)) {\n        carsArray = cars;\n    }\n    if (carsArray && Array.isArray(carsArray)) {\n        carsArray.forEach(car => {\n            if (car.CAR_NUMBER && car.ACCNAME) {\n                vehicleMapping[car.CAR_NUMBER] = {\n                    accname: car.ACCNAME,\n                    accdes: car.ASSDES || \"\",\n                    budcode: car.BUDCODE || \"\",\n                    vat_pattern: { VATFLAG: \"Y\", SPECIALVATFLAG: \"varies\" },\n                    date_range_pattern: \"never\",\n                    pdaccname_pattern: \"never\"\n                };\n            }\n        });\n    }\n    console.log('ðŸš— vehicleMapping:', Object.keys(vehicleMapping).length, '×¨×›×‘×™×');\n    let supplierTemplate = null;\n    let parsedTemplate = null;\n    if (supTemp && typeof supTemp === 'string') {\n        try {\n            supplierTemplate = JSON.parse(supTemp);\n        } catch (e) {\n            supplierTemplate = null;\n        }\n    } else if (supTemp && typeof supTemp === 'object') {\n        supplierTemplate = supTemp;\n    }\n    let parsedConfig = null;\n    let templateData = null;\n    if (supplierTemplate && supplierTemplate.TEMPLETE) {\n        try {\n            const templateStr = typeof supplierTemplate.TEMPLETE === 'string'\n                ? supplierTemplate.TEMPLETE\n                : JSON.stringify(supplierTemplate.TEMPLETE);\n            templateData = JSON.parse(templateStr);\n            if (templateData.llm_prompt && templateData.llm_prompt.all_templates) {\n                const allPinvoices = templateData.llm_prompt.all_templates.map(template => {\n                    return template.invoice_data?.PINVOICES?.[0] || {};\n                });\n                parsedTemplate = {\n                    PINVOICES: allPinvoices,\n                    document_types_count: allPinvoices.length\n                };\n            }\n            if (templateData.technical_config && templateData.technical_config.all_templates) {\n                parsedConfig = {\n                    ...templateData.technical_config.all_templates[0],\n                    supplier_config: {\n                        supplier_code: templateData.technical_config.supplier_code,\n                        supplier_name: templateData.technical_config.supplier_name\n                    }\n                };\n            }\n        } catch (e) {\n            parsedTemplate = null;\n            parsedConfig = null;\n            templateData = null;\n        }\n    }\n    const templatesCount = parsedTemplate?.PINVOICES?.length || 1;\n    const config = {\n        status: \"success\",\n        supplier_id: supname || \"\",\n        supplier_name: supplierTemplate?.SDES || parsedConfig?.supplier_config?.supplier_name || \"\",\n        vendor_tax_id_reference: supplierTemplate?.VATNUM || parsedConfig?.supplier_config?.vendor_tax_id_reference || \"\",\n        supplier_phone: supplierTemplate?.supplier_phone || \"\",\n        supplier_email: supplierTemplate?.supplier_email || \"\",\n        json_files_analyzed: 1,\n        templates_detected: templatesCount,\n        llm_prompt: templateData?.llm_prompt || null,\n        technical_config: templateData?.technical_config || null,\n        config: parsedConfig || {\n            supplier_config: {\n                supplier_code: supname || \"\",\n                supplier_name: supplierTemplate?.SDES || \"\",\n                vendor_tax_id_reference: supplierTemplate?.VATNUM || \"\"\n            },\n            structure: [{\n                has_import: false,\n                has_purchase_orders: false,\n                has_doc: false,\n                has_date_range: false,\n                has_budcode: true,\n                has_pdaccname: false,\n                inventory_management: \"not_managed_inventory\",\n                debit_type: \"D\"\n            }],\n            rules: {\n                invoice_date_format: \"DD/MM/YY\",\n                doc_variation: \"\",\n                validation_data: { TOTQUANT: 1 },\n                critical_patterns: {\n                    vehicle_rules: {\n                        partname: \"car\",\n                        vehicle_account_mapping: vehicleMapping,\n                        search_locations: [\n                            { location: \"fields.VehicleNumbers\", priority: 1 },\n                            { location: \"fields.UnidentifiedNumbers\", priority: 2, filter_by_label: \"×¨×›×‘\" }\n                        ],\n                        default_values: {\n                            accname: Object.values(vehicleMapping)[0]?.accname || \"\",\n                            budcode: Object.values(vehicleMapping)[0]?.budcode || \"\"\n                        },\n                        output_format: { partname: \"car\" }\n                    },\n                    partname_rules: {}\n                }\n            },\n            document_types: [{\n                type: \"×—×©×‘×•× ×™×ª ×¨×’×™×œ×” ×¢× ×¤×™×¨×•×˜\",\n                accnames: Object.values(vehicleMapping).map(v => v.accname).filter((v, i, a) => a.indexOf(v) === i)\n            }]\n        },\n        template: parsedTemplate || supplierTemplate?.template || {\n            PINVOICES: [{\n                SUPNAME: supname || \"\",\n                CODE: \"×©\\\"×—\",\n                DEBIT: \"D\",\n                IVDATE: \"\",\n                BOOKNUM: \"\",\n                DETAILS: \"\",\n                PINVOICEITEMS_SUBFORM: [],\n                PINVOICESCONT_SUBFORM: []\n            }],\n            document_types_count: 1\n        },\n        recommended_samples: { samples: [] }\n    };\n    return config;\n}\n\nfunction processProductionInvoice(productionInput) {\n    console.log('ðŸš€ PRODUCTION INVOICE v1.6.6 IIFE (21:40 05.11.25) - ' + new Date().toISOString());\n    console.log('ðŸ“¦ ×§×•×“: 49KB | ðŸ”§ IIFE wrap: âœ… | ðŸŽ¯ return ×‘×ž×§×•× expression!');\n    console.log('==========================================');\n    const executionReport = {\n        stage: \"\",\n        found: [],\n        not_found: [],\n        warnings: [],\n        errors: []\n    };\n    try {\n        executionReport.stage = \"×”×ž×¨×ª ×ž×‘× ×” Production ×œ-Processing\";\n        const processingInput = convertProductionInputToProcessingInput(productionInput);\n        executionReport.stage = \"×§×¨×™××” ×œ×¤×•× ×§×¦×™×™×ª ×¢×™×‘×•×“\";\n        const result = processInvoiceComplete(processingInput);\n        if (result.status === \"success\") {\n            result.metadata = result.metadata || {};\n            result.metadata.input_type = \"production\";\n            result.metadata.filename = productionInput.FILENAME || \"\";\n            result.metadata.cars_count = (productionInput.CARS || []).length;\n        }\n        return removeUndefinedValues(result);\n    } catch (error) {\n        executionReport.errors.push(error.message);\n        const errorResult = {\n            status: \"error\",\n            error_type: error.name || \"ProductionProcessingError\",\n            message: error.message,\n            execution_report: executionReport\n        };\n        return removeUndefinedValues(errorResult);\n    }\n}\n\nfunction processInvoiceComplete(input) {\n    const executionReport = {\n        stage: \"\",\n        found: [],\n        not_found: [],\n        warnings: [],\n        errors: []\n    };\n    try {\n        let inputData = {};\n        if (input.input && Array.isArray(input.input)) {\n            // ×¤×•×¨×ž×˜ Make.com: { input: [{name, value}, ...] }\n            input.input.forEach(item => {\n                inputData[item.name] = item.value;\n            });\n        } else if (input.learned_config || input.AZURE_RESULT || input.vehicles) {\n            // ×¤×•×¨×ž×˜ ×™×©×™×¨: { learned_config, AZURE_RESULT, vehicles, ... }\n            inputData = input;\n        }\n        let learnedConfig = inputData.learned_config || {};\n        if (typeof learnedConfig === 'string') {\n            try {\n                learnedConfig = JSON.parse(learnedConfig);\n            } catch (e) {\n                learnedConfig = {};\n            }\n        }\n        if (learnedConfig.TEMPLETE && learnedConfig.SUPNAME) {\n            try {\n                const templateStr = typeof learnedConfig.TEMPLETE === 'string'\n                    ? learnedConfig.TEMPLETE\n                    : JSON.stringify(learnedConfig.TEMPLETE);\n                const templateData = JSON.parse(templateStr);\n                let parsedConfig = {};\n                let parsedTemplate = { PINVOICES: [{}] };\n                if (templateData.technical_config && templateData.technical_config.all_templates) {\n                    parsedConfig = {\n                        ...templateData.technical_config.all_templates[0],\n                        supplier_config: {\n                            supplier_code: templateData.technical_config.supplier_code,\n                            supplier_name: templateData.technical_config.supplier_name\n                        }\n                    };\n                }\n                if (templateData.llm_prompt && templateData.llm_prompt.all_templates) {\n                    const allPinvoices = templateData.llm_prompt.all_templates.map(template => {\n                        return template.invoice_data?.PINVOICES?.[0] || {};\n                    });\n                    parsedTemplate = {\n                        PINVOICES: allPinvoices,\n                        document_types_count: allPinvoices.length\n                    };\n                }\n                learnedConfig = {\n                    status: \"success\",\n                    supplier_id: learnedConfig.SUPNAME,\n                    supplier_name: learnedConfig.SDES || \"\",\n                    vendor_tax_id_reference: learnedConfig.VATNUM || \"\",\n                    config: parsedConfig,\n                    template: parsedTemplate\n                };\n            } catch (e) {\n                // ignore\n            }\n        }\n        let docsList = inputData.docs_list || { DOC_YES_NO: \"N\", list_of_docs: [] };\n        if (typeof docsList === 'string') {\n            try {\n                // ×˜×™×¤×•×œ ×‘×¤×•×¨×ž×˜ \"{[...]}\" - ×”×¡×¨ ××ª ×”×¡×•×’×¨×™×™× ×”×—×™×¦×•× ×™×™×\n                let cleaned = docsList.trim();\n                if (cleaned.startsWith('{') && cleaned.endsWith('}')) {\n                    cleaned = cleaned.slice(1, -1); // ×”×¡×¨ { ×•-}\n                }\n                const parsedArray = JSON.parse(cleaned);\n                docsList = {\n                    DOC_YES_NO: \"Y\",\n                    list_of_docs: Array.isArray(parsedArray) ? parsedArray.map(d => JSON.stringify(d)) : []\n                };\n                console.log(`âœ… docs_list parsed: ${docsList.list_of_docs.length} ×ª×¢×•×“×•×ª`);\n            } catch (e) {\n                console.log('âŒ ×©×’×™××” ×‘×¤×¨×¡×•×¨ docs_list:', e.message);\n                docsList = { DOC_YES_NO: \"N\", list_of_docs: [] };\n            }\n        }\n        let importFiles = inputData.import_files || { IMPFILES: [] };\n        if (typeof importFiles === 'string') {\n            try {\n                importFiles = JSON.parse(importFiles);\n            } catch (e) {\n                importFiles = { IMPFILES: [] };\n            }\n        }\n\n        // Parse vehicles input and build vehicle_account_mapping\n        let vehicleMapping = {};\n        if (inputData.vehicles) {\n            try {\n                let vehiclesData = inputData.vehicles;\n                if (typeof vehiclesData === 'string') {\n                    // ×˜×™×¤×•×œ ×‘×¤×•×¨×ž×˜ \"{[...]}\" - ×”×¡×¨ ××ª ×”×¡×•×’×¨×™×™× ×”×—×™×¦×•× ×™×™×\n                    let cleaned = vehiclesData.trim();\n                    if (cleaned.startsWith('{') && cleaned.endsWith('}')) {\n                        cleaned = cleaned.slice(1, -1); // ×”×¡×¨ { ×•-}\n                    }\n                    vehiclesData = JSON.parse(cleaned);\n                }\n                // ×”×ž×¨×” ×œ×ž×‘× ×” vehicle_account_mapping: { \"CAR_NUMBER\": { accname, assdes, ... } }\n                // ×× ×™×© duplicate - ×œ×•×§×— ××ª ×–×” ×¢× ACCNAME ×”×’×‘×•×” ×‘×™×•×ª×¨\n                if (Array.isArray(vehiclesData)) {\n                    vehiclesData.forEach(v => {\n                        if (v.CAR_NUMBER) {\n                            const existing = vehicleMapping[v.CAR_NUMBER];\n                            // ×× ××™×Ÿ existing ××• ACCNAME ×”× ×•×›×—×™ ×’×‘×•×” ×™×•×ª×¨ - ×¢×“×›×Ÿ\n                            if (!existing || (v.ACCNAME && (!existing.accname || v.ACCNAME > existing.accname))) {\n                                vehicleMapping[v.CAR_NUMBER] = {\n                                    accname: v.ACCNAME,\n                                    assdes: v.ASSDES,\n                                    group: v.GROUP,\n                                    vat_pattern: { VATFLAG: \"Y\" } // default VAT\n                                };\n                            }\n                        }\n                    });\n                    console.log(`âœ… vehicles parsed: ${Object.keys(vehicleMapping).length} ×¨×›×‘×™×`);\n                }\n            } catch (e) {\n                console.log('âŒ ×©×’×™××” ×‘×¤×¨×¡×•×¨ vehicles:', e.message);\n                vehicleMapping = {};\n            }\n        }\n\n        let azureResult = inputData.AZURE_RESULT || { data: { fields: {} } };\n        // ×ª×™×§×•×Ÿ v1.8.2: ×˜×™×¤×•×œ ×‘×¤×•×¨×ž×˜×™× ×©×•× ×™× ×©×œ AZURE_RESULT\n        // ×¤×•×¨×ž×˜ 1: ×ž×—×¨×•×–×ª JSON ×¨×’×™×œ×” - {\"data\":...}\n        // ×¤×•×¨×ž×˜ 2: ×ž×—×¨×•×–×ª ×¢× quotes ×—×™×¦×•× ×™×™× - \"{\"data\":...}\" (×ž-Make.com)\n        // ×¤×•×¨×ž×˜ 3: double-escaped - \"\\\"{\\\"data\\\":...}\\\"\"\n        if (typeof azureResult === 'string') {\n            try {\n                let jsonStr = azureResult.trim();\n\n                // ×¤×•×¨×ž×˜ 2: ×× ×ž×ª×—×™×œ ×‘-\"{ - ×”×¡×¨ quote ×ž×™×•×ª×¨ ×‘×”×ª×—×œ×”\n                // (Make.com ×©×•×œ×—: \"{\"structure\":...,\"status\":\"success\"})\n                if (jsonStr.startsWith('\"{')) {\n                    jsonStr = jsonStr.slice(1);  // ×”×¡×¨ ×¨×§ ××ª ×”-\" ×‘×”×ª×—×œ×”\n                    console.log('âš ï¸ AZURE_RESULT: ×”×•×¡×¨ quote ×‘×”×ª×—×œ×”');\n                }\n\n                azureResult = JSON.parse(jsonStr);\n\n                // ×¤×•×¨×ž×˜ 3: ×‘×“×™×§×” ×× ×¢×“×™×™×Ÿ ×ž×—×¨×•×–×ª (double-escaped)\n                if (typeof azureResult === 'string') {\n                    console.log('âš ï¸ AZURE_RESULT: double-escaped, ×ž×¤×¨×¡×¨ ×©×•×‘');\n                    azureResult = JSON.parse(azureResult);\n                }\n\n                console.log('âœ… AZURE_RESULT × ×¤×¨×¡×¨ ×‘×”×¦×œ×—×”, ×™×© data:', !!azureResult.data);\n            } catch (e) {\n                console.log('âŒ ×©×’×™××” ×‘×¤×¨×¡×•×¨ AZURE_RESULT:', e.message);\n                console.log('   10 ×ª×•×•×™× ×¨××©×•× ×™×:', JSON.stringify(String(inputData.AZURE_RESULT).substring(0, 10)));\n                azureResult = { data: { fields: {} } };\n            }\n        }\n        const azureTextClean = inputData.AZURE_TEXT_CLEAN || \"\";\n        const azureTextRaw = inputData.AZURE_TEXT || \"\";\n        const azureText = azureTextClean || azureTextRaw;\n        if (!azureResult.data) {\n            if (azureResult.analyzeResult) {\n                const analyzeResult = azureResult.analyzeResult;\n                const documents = analyzeResult.documents || [];\n                if (documents.length > 0) {\n                    const rawFields = documents[0].fields || {};\n                    const normalizedFields = normalizeAzureFields(rawFields);\n                    azureResult.data = {\n                        fields: normalizedFields,\n                        documents: documents\n                    };\n                } else {\n                    azureResult.data = { fields: {}, documents: [] };\n                }\n            } else if (azureResult.apiVersion && azureResult.documents) {\n                const documents = azureResult.documents || [];\n                if (documents.length > 0) {\n                    const rawFields = documents[0].fields || {};\n                    const normalizedFields = normalizeAzureFields(rawFields);\n                    azureResult.data = {\n                        fields: normalizedFields,\n                        documents: documents\n                    };\n                } else {\n                    azureResult.data = { fields: {}, documents: [] };\n                }\n            } else {\n                azureResult.data = { fields: {}, documents: [] };\n            }\n        }\n        if (!azureResult.data.fields) {\n            azureResult.data.fields = {};\n        }\n        executionReport.stage = \"×©×œ×‘ 1: ×–×™×”×•×™ ×¡×•×’ ×•×ª×‘× ×™×ª\";\n        const hasImport = checkImportExists(importFiles);\n        const hasDocs = checkDocsInOCR(azureResult.data.fields, azureText);\n        const debitType = identifyDebitType(azureResult.data.fields);\n        executionReport.found.push(`×¡×•×’: ×™×‘×•×=${hasImport}, ×ª×¢×•×“×•×ª=${hasDocs}, ×—×™×•×‘/×–×™×›×•×™=${debitType}`);\n        const config = learnedConfig.config || learnedConfig.technical_config || {};\n\n        // Inject vehicle_account_mapping into config if we have vehicles\n        if (Object.keys(vehicleMapping).length > 0) {\n            if (!config.rules) config.rules = {};\n            if (!config.rules.critical_patterns) config.rules.critical_patterns = {};\n            if (!config.rules.critical_patterns.vehicle_rules) {\n                config.rules.critical_patterns.vehicle_rules = {\n                    partname: \"car\",\n                    vehicle_account_mapping: {},\n                    search_locations: [\n                        { location: \"fields.VehicleNumbers\", priority: 1 },\n                        { location: \"fields.UnidentifiedNumbers\", priority: 2, filter_by_label: \"×¨×›×‘\" }\n                    ],\n                    output_format: { partname: \"car\" },\n                    default_values: { budcode: null }\n                };\n            }\n            // Inject the mapping\n            config.rules.critical_patterns.vehicle_rules.vehicle_account_mapping = vehicleMapping;\n            console.log(`âœ… Injected ${Object.keys(vehicleMapping).length} vehicles into config`);\n        }\n\n        // ×‘× ×™×™×ª allStructures - ×ª×ž×™×›×” ×‘×¤×•×¨×ž×˜×™× ×©×•× ×™×\n        let allStructures = config.structure;\n\n        // ×× ××™×Ÿ structure, × ×¡×” ×œ×‘× ×•×ª ×ž-processing_scenario.all_templates\n        if (!allStructures && learnedConfig.processing_scenario?.all_templates) {\n            console.log('ðŸ”§ ×‘×•× ×” structure ×ž×ª×•×š processing_scenario.all_templates');\n            allStructures = learnedConfig.processing_scenario.all_templates.map(t => ({\n                has_import: t.check_import || false,\n                has_doc: t.check_docs || false,\n                has_vehicles: t.check_vehicles || false,\n                debit_type: t.debit_type || \"D\",\n                has_budcode: true,\n                inventory_management: \"not_managed_inventory\"\n            }));\n            console.log(`âœ… × ×‘× ×• ${allStructures.length} structures:`, JSON.stringify(allStructures));\n        }\n\n        // fallback ×œ×•×’×™×§×” ×™×©× ×” - technical_config.all_templates\n        if (!allStructures && config.all_templates) {\n            console.log('ðŸ”§ ×‘×•× ×” structure ×ž×ª×•×š technical_config.all_templates');\n            allStructures = config.all_templates.map(t => ({\n                has_import: t.check_import || false,\n                has_doc: t.check_docs || false,\n                has_vehicles: t.check_vehicles || false,\n                debit_type: t.debit_type || \"D\",\n                has_budcode: true,\n                inventory_management: \"not_managed_inventory\"\n            }));\n            console.log(`âœ… × ×‘× ×• ${allStructures.length} structures:`, JSON.stringify(allStructures));\n        }\n\n        // fallback ××—×¨×•×Ÿ - ×× ×’× ×–×” ×œ× ×§×™×™×\n        if (!allStructures) {\n            console.log('âš ï¸ ×ž×©×ª×ž×© ×‘-fallback structure');\n            allStructures = [{\n                has_import: false,\n                has_doc: false,\n                has_vehicles: false,\n                debit_type: \"D\",\n                has_budcode: true,\n                inventory_management: \"not_managed_inventory\"\n            }];\n        }\n        let allTemplates;\n        if (learnedConfig.template?.PINVOICES) {\n            allTemplates = learnedConfig.template.PINVOICES;\n        } else if (learnedConfig.llm_prompt?.all_templates) {\n            allTemplates = learnedConfig.llm_prompt.all_templates.map(t =>\n                t.invoice_data?.PINVOICES?.[0] || {}\n            );\n        } else if (learnedConfig.invoice_data?.PINVOICES) {\n            allTemplates = learnedConfig.invoice_data.PINVOICES;\n        } else {\n            allTemplates = [{\n                SUPNAME: config.supplier_config?.supplier_code || \"\",\n                CODE: \"×©\\\"×—\",\n                DEBIT: \"D\"\n            }];\n        }\n        // âœ… ×—×“×©! ×× ×§×™×‘×œ× ×• template_index ×‘×§×œ×˜ - ×œ×”×©×ª×ž×© ×‘×• ×™×©×™×¨×•×ª\n        // ×ª×ž×™×›×” ×’× ×‘×ž×¡×¤×¨ ×•×’× ×‘×ž×—×¨×•×–×ª (Make ×©×•×œ×— ×ž×—×¨×•×–×ª)\n        let templateIndex;\n        let templateMatchStatus = \"matched\"; // matched / fallback / forced\n        let templateMatchReason = \"\";\n\n        const rawTemplateIndex = inputData.template_index;\n        if (rawTemplateIndex !== undefined && rawTemplateIndex !== null && rawTemplateIndex !== '') {\n            templateIndex = parseInt(rawTemplateIndex, 10);\n            if (!isNaN(templateIndex) && templateIndex >= 0 && templateIndex < allStructures.length) {\n                templateMatchStatus = \"forced\";\n                templateMatchReason = \"template_index ×¡×•×¤×§ ×‘×§×œ×˜\";\n                executionReport.found.push(`×ª×‘× ×™×ª: index=${templateIndex} (×ž×§×œ×˜ - template_index)`);\n            } else {\n                // template_index ×œ× ×ª×§×™×Ÿ - fallback ×œ×–×™×”×•×™ ××•×˜×•×ž×˜×™\n                templateIndex = findMatchingTemplate(allStructures, hasImport, hasDocs, debitType);\n                if (templateIndex === -1) {\n                    // âœ… v1.8.1: ×œ× ×–×•×¨×§×™× ×©×’×™××”! ×ž×©×ª×ž×©×™× ×‘×ª×‘× ×™×ª 0 ×›×‘×¨×™×¨×ª ×ž×—×“×œ\n                    templateIndex = 0;\n                    templateMatchStatus = \"fallback\";\n                    templateMatchReason = `×œ× × ×ž×¦××” ×”×ª××ž×” (×—×™×¤×©× ×•: has_import=${hasImport}, has_doc=${hasDocs}, debit_type=${debitType}). × ×œ×§×—×” ×ª×‘× ×™×ª 0 ×›×‘×¨×™×¨×ª ×ž×—×“×œ`;\n                    executionReport.warnings.push(`âš ï¸ ×œ× × ×ž×¦××” ×ª×‘× ×™×ª ×ž×ª××™×ž×”! ×ž×©×ª×ž×©×™× ×‘×ª×‘× ×™×ª 0`);\n                    executionReport.warnings.push(`   ×—×™×¤×©× ×•: ×™×‘×•×=${hasImport}, ×ª×¢×•×“×•×ª=${hasDocs}, ×¡×•×’=${debitType}`);\n                    executionReport.warnings.push(`   ×ª×‘× ×™×•×ª ×–×ž×™× ×•×ª: ${allStructures.map((s, i) => `${i}: ×™×‘×•×=${s.has_import}, ×ª×¢×•×“×•×ª=${s.has_doc}, ×¡×•×’=${s.debit_type}`).join(' | ')}`);\n                } else {\n                    templateMatchStatus = \"matched\";\n                    templateMatchReason = \"×–×™×”×•×™ ××•×˜×•×ž×˜×™ (template_index ×‘×§×œ×˜ ×œ× ×ª×§×™×Ÿ)\";\n                    executionReport.found.push(`×ª×‘× ×™×ª: × ×ž×¦××” ×”×ª××ž×” (index=${templateIndex}) (×–×™×”×•×™ ××•×˜×•×ž×˜×™ - template_index ×œ× ×ª×§×™×Ÿ)`);\n                }\n            }\n        } else {\n            // fallback - ×–×™×”×•×™ ××•×˜×•×ž×˜×™ ×œ×¤×™ ×ž××¤×™×™× ×™ ×”×ž×¡×ž×š\n            templateIndex = findMatchingTemplate(allStructures, hasImport, hasDocs, debitType);\n            if (templateIndex === -1) {\n                // âœ… v1.8.1: ×œ× ×–×•×¨×§×™× ×©×’×™××”! ×ž×©×ª×ž×©×™× ×‘×ª×‘× ×™×ª 0 ×›×‘×¨×™×¨×ª ×ž×—×“×œ\n                templateIndex = 0;\n                templateMatchStatus = \"fallback\";\n                templateMatchReason = `×œ× × ×ž×¦××” ×”×ª××ž×” (×—×™×¤×©× ×•: has_import=${hasImport}, has_doc=${hasDocs}, debit_type=${debitType}). × ×œ×§×—×” ×ª×‘× ×™×ª 0 ×›×‘×¨×™×¨×ª ×ž×—×“×œ`;\n                executionReport.warnings.push(`âš ï¸ ×œ× × ×ž×¦××” ×ª×‘× ×™×ª ×ž×ª××™×ž×”! ×ž×©×ª×ž×©×™× ×‘×ª×‘× ×™×ª 0`);\n                executionReport.warnings.push(`   ×—×™×¤×©× ×•: ×™×‘×•×=${hasImport}, ×ª×¢×•×“×•×ª=${hasDocs}, ×¡×•×’=${debitType}`);\n                executionReport.warnings.push(`   ×ª×‘× ×™×•×ª ×–×ž×™× ×•×ª: ${allStructures.map((s, i) => `${i}: ×™×‘×•×=${s.has_import}, ×ª×¢×•×“×•×ª=${s.has_doc}, ×¡×•×’=${s.debit_type}`).join(' | ')}`);\n            } else {\n                templateMatchStatus = \"matched\";\n                templateMatchReason = \"×–×™×”×•×™ ××•×˜×•×ž×˜×™ ×œ×¤×™ ×ž××¤×™×™× ×™ ×”×ž×¡×ž×š\";\n                executionReport.found.push(`×ª×‘× ×™×ª: × ×ž×¦××” ×”×ª××ž×” (index=${templateIndex}) (×–×™×”×•×™ ××•×˜×•×ž×˜×™)`);\n            }\n        }\n\n        // ×©×ž×™×¨×ª ×ž×™×“×¢ ×¢×œ ×”×”×ª××ž×” ×œ×“×•×—\n        executionReport.template_match = {\n            status: templateMatchStatus,\n            template_index: templateIndex,\n            reason: templateMatchReason,\n            document_characteristics: {\n                has_import: hasImport,\n                has_doc: hasDocs,\n                debit_type: debitType\n            },\n            available_templates: allStructures.length\n        };\n        const structure = allStructures[templateIndex];\n        const template = allTemplates[templateIndex] || allTemplates[0];\n        executionReport.stage = \"×©×œ×‘ 2: ×”×‘× ×ª ×“×¤×•×¡×™×\";\n        const patterns = extractPatterns(learnedConfig.recommended_samples, docsList);\n        executionReport.found.push(`×“×¤×•×¡×™×: × ×ž×¦××•`);\n        const vehicleRules = config.rules?.critical_patterns?.vehicle_rules || null;\n        console.log('ðŸš— vehicleRules:', !!vehicleRules, 'mapping:', Object.keys(vehicleRules?.vehicle_account_mapping || {}).length);\n        if (vehicleRules && vehicleRules.vehicle_account_mapping) {\n            executionReport.found.push(`×—×•×§×™ ×¨×›×‘×™×: ×¤×¢×™×œ×™× (${Object.keys(vehicleRules.vehicle_account_mapping).length} ×¨×›×‘×™×)`);\n        }\n        executionReport.stage = \"×©×œ×‘ 3: ×—×™×¤×•×© × ×ª×•× ×™×\";\n        const ocrFields = azureResult.data.fields || {};\n        ocrFields.AZURE_TEXT_CLEAN = azureTextClean;\n        const searchResults = searchAllData(\n            ocrFields,\n            azureText,\n            patterns,\n            structure,\n            importFiles,\n            docsList,\n            vehicleRules\n        );\n        Object.keys(searchResults).forEach(key => {\n            if (key === 'vehicles' && searchResults.vehicles) {\n                if (searchResults.vehicles.length > 0) {\n                    executionReport.found.push(`×¨×›×‘×™×: ${searchResults.vehicles.length} ×¨×›×‘×™× - ${searchResults.vehicles.join(', ')}`);\n                }\n            } else if (searchResults[key]) {\n                const value = searchResults[key];\n                if (Array.isArray(value)) {\n                    executionReport.found.push(`${key}: ${value.length} ×¤×¨×™×˜×™×`);\n                } else if (typeof value === 'string' && value.length > 0) {\n                    const displayValue = value.length > 50 ? value.substring(0, 50) + '...' : value;\n                    executionReport.found.push(`${key}: \"${displayValue}\"`);\n                } else if (value !== null) {\n                    executionReport.found.push(`${key}: ${JSON.stringify(value)}`);\n                }\n            }\n        });\n        executionReport.stage = \"×©×œ×‘ 4: ×‘× ×™×™×ª ×—×©×‘×•× ×™×ª\";\n        const invoice = buildInvoiceFromTemplate(\n            template,\n            structure,\n            config,\n            searchResults,\n            learnedConfig,\n            ocrFields\n        );\n        executionReport.stage = \"×©×œ×‘ 5: ×‘×§×¨×•×ª\";\n        const validation = performValidation(invoice, ocrFields, config, docsList, patterns, structure, searchResults, template);\n        executionReport.stage = \"×©×œ×‘ 6: × ×™×ª×•×— ×œ×ž×™×“×”\";\n        const learningAnalysis = analyzeLearning(invoice, config);\n        executionReport.stage = \"×©×œ×‘ 7: × ×™×§×•×™ ×•×”×›× ×” ×œ×¤×¨×™×•×¨×™×˜×™\";\n        const cleanedInvoice = cleanInvoiceForPriority(invoice);\n        const result = {\n            status: \"success\",\n            supplier_identification: {\n                supplier_code: learnedConfig.supplier_id ||\n                              learnedConfig.llm_prompt?.supplier_code ||\n                              learnedConfig.technical_config?.supplier_code ||\n                              config.supplier_config?.supplier_code || \"\",\n                supplier_name: learnedConfig.supplier_name ||\n                              learnedConfig.llm_prompt?.supplier_name ||\n                              learnedConfig.technical_config?.supplier_name ||\n                              config.supplier_config?.supplier_name || \"\",\n                identification_method: \"vendor_tax_id\",\n                confidence: \"high\"\n            },\n            invoice_data: {\n                PINVOICES: [cleanedInvoice]\n            },\n            validation: validation,\n            learning_analysis: learningAnalysis,\n            execution_report: executionReport,\n            metadata: {\n                ocr_invoice_id: ocrFields.InvoiceId || \"\",\n                ocr_invoice_date: ocrFields.InvoiceDate || \"\",\n                ocr_total_amount: ocrFields.InvoiceTotal || ocrFields.InvoiceTotal_amount || 0,\n                ocr_subtotal: ocrFields.SubTotal || ocrFields.SubTotal_amount ||\n                             (ocrFields.InvoiceTotal_amount && ocrFields.TotalTax_amount ?\n                              ocrFields.InvoiceTotal_amount - ocrFields.TotalTax_amount : null),\n                ocr_tax: ocrFields.TotalTax || ocrFields.TotalTax_amount || 0,\n                processing_timestamp: new Date().toISOString(),\n                version: \"1.0-production\",\n                template_index: templateIndex,\n                template_type: structure.has_import && structure.has_doc ? \"import_with_docs\" :\n                              structure.has_import ? \"import_only\" :\n                              structure.has_doc ? \"docs_only\" :\n                              structure.has_vehicles ? \"vehicles\" :\n                              structure.debit_type === \"C\" ? \"credit_note\" : \"regular\",\n                has_vehicles: structure.has_vehicles || false,\n                vehicle_numbers: searchResults.vehicles || [],\n                vehicle_count: searchResults.vehicles ? searchResults.vehicles.length : 0,\n                has_documents: structure.has_doc || false,\n                document_count: searchResults.documents ? searchResults.documents.length : 0,\n                has_import: structure.has_import || false\n            }\n        };\n        return removeUndefinedValues(result);\n    } catch (error) {\n        executionReport.errors.push(error.message);\n        const errorResult = {\n            status: \"error\",\n            error_type: error.name || \"ProcessingError\",\n            message: error.message,\n            execution_report: executionReport\n        };\n        return removeUndefinedValues(errorResult);\n    }\n}\n\nfunction checkImportExists(importFiles) {\n    if (!importFiles || !importFiles.IMPFILES) return false;\n    if (importFiles.IMPFILES.length === 0) return false;\n    return true;\n}\n\nfunction checkDocsInOCR(ocrFields, azureText) {\n    const unidentified = ocrFields.UnidentifiedNumbers || [];\n    const docPattern = /^25\\d{6}$/;\n    const booknumPattern = /^10\\d{7}$/;  // BOOKNUM pattern (10XXXXXXX - 9 digits)\n    if (unidentified.length > 0) {\n        if (typeof unidentified[0] === 'object' && unidentified[0].value) {\n            if (unidentified.some(item => docPattern.test(item.value) || booknumPattern.test(item.value))) {\n                return true;\n            }\n        } else {\n            if (unidentified.some(num => docPattern.test(num) || booknumPattern.test(num))) {\n                return true;\n            }\n        }\n    }\n    if (azureText) {\n        if (azureText.match(/\\b25\\d{6}\\b/g) || azureText.match(/\\b10\\d{7}\\b/g)) {\n            return true;\n        }\n    }\n    return false;\n}\n\nfunction identifyDebitType(ocrFields) {\n    const total = ocrFields.InvoiceTotal || ocrFields.InvoiceTotal_amount || 0;\n    return total >= 0 ? \"D\" : \"C\";\n}\n\nfunction findMatchingTemplate(structures, hasImport, hasDocs, debitType) {\n    return structures.findIndex(s =>\n        s.has_import === hasImport &&\n        s.has_doc === hasDocs &&\n        s.debit_type === debitType\n    );\n}\n\nfunction extractPatterns(recommendedSamples, docsList) {\n    const patterns = {\n        booknum_pattern: null,\n        ivnum_pattern: null,\n        docs_pattern: null,\n        docs_totquant: {}\n    };\n    if (recommendedSamples && recommendedSamples.samples && recommendedSamples.samples.length > 0) {\n        const sample = recommendedSamples.samples[0];\n        if (sample.sample_booknum) {\n            patterns.booknum_pattern = {\n                length: sample.sample_booknum.length,\n                example: sample.sample_booknum\n            };\n        }\n    }\n    return patterns;\n}\n\nfunction searchAllData(ocrFields, azureText, patterns, structure, importFiles, docsList, vehicleRules) {\n    // ×—×™×¤×•×© ×ª×¢×•×“×•×ª ×× × ×“×¨×©\n    let documents = null;\n    if (structure.has_doc) {\n        documents = searchDocuments(ocrFields, azureText, docsList);\n        console.log(`ðŸ” ×ž×—×¤×© ×ª×¢×•×“×•×ª: × ×ž×¦××• ${documents?.length || 0}`);\n    }\n\n    return {\n        booknum: searchBooknum(ocrFields, patterns),\n        ivdate: searchIvdate(ocrFields),\n        details: searchDetails(ocrFields, azureText),\n        ordname: null,\n        impfnum: null,\n        documents: documents,\n        vehicles: vehicleRules ? extractVehiclesAdvanced(ocrFields, vehicleRules) : [],\n        items: ocrFields.Items || []\n    };\n}\n\nfunction searchBooknum(ocrFields, patterns) {\n    const original = ocrFields.InvoiceId || \"\";\n    let booknum = String(original);\n    booknum = booknum.replace(/^SI/i, '');\n    const match = booknum.match(/^[\\d\\-\\/]+/);\n    if (match) {\n        booknum = match[0];\n    }\n    booknum = booknum.trim();\n    if (patterns.booknum_pattern) {\n        const expectedLength = patterns.booknum_pattern.length;\n        if (booknum.length > expectedLength) {\n            booknum = booknum.slice(-expectedLength);\n        }\n    }\n    console.log(`BOOKNUM: \"${original}\" â†’ \"${booknum}\"`);\n    return booknum;\n}\n\nfunction searchIvdate(ocrFields) {\n    const isoDate = ocrFields.InvoiceDate;\n    if (!isoDate) return \"\";\n    const date = new Date(isoDate);\n    const day = String(date.getDate()).padStart(2, '0');\n    const month = String(date.getMonth() + 1).padStart(2, '0');\n    const year = String(date.getFullYear()).slice(-2);\n    return `${day}/${month}/${year}`;\n}\n\nfunction searchDetails(ocrFields, azureText) {\n    if (ocrFields.InvoiceDescription) {\n        return ocrFields.InvoiceDescription;\n    }\n    if (azureText) {\n        const lines = azureText.split('\\n').filter(l => l.trim());\n        if (lines.length > 2) {\n            return lines[2].substring(0, 100);\n        }\n    }\n    return \"\";\n}\n\nfunction searchDocuments(ocrFields, azureText, docsList) {\n    const foundDocs = [];\n\n    if (!docsList || !docsList.list_of_docs || docsList.list_of_docs.length === 0) {\n        console.log('âš ï¸ docs_list ×¨×™×§ ××• ×œ× ×§×™×™×');\n        return foundDocs;\n    }\n\n    let availableDocs = [];\n    try {\n        availableDocs = docsList.list_of_docs.flatMap(d => JSON.parse(d));\n        console.log(`ðŸ“‹ ×™×© ${availableDocs.length} ×ª×¢×•×“×•×ª ×–×ž×™× ×•×ª`);\n    } catch (e) {\n        console.log('âŒ ×©×’×™××” ×‘×¤×¨×¡×•×¨ docs_list:', e.message);\n        return foundDocs;\n    }\n\n    const unidentified = ocrFields.UnidentifiedNumbers || [];\n    console.log(`ðŸ” ×ž×—×¤×© ×‘-${unidentified.length} UnidentifiedNumbers`);\n\n    // ×—×™×¤×•×© ×‘-UnidentifiedNumbers\n    if (unidentified.length > 0) {\n        if (typeof unidentified[0] === 'object' && unidentified[0].value) {\n            for (const item of unidentified) {\n                const match = availableDocs.find(doc => doc.BOOKNUM === item.value);\n                if (match) {\n                    // ×‘×“×™×§×”: ×”×× ×›×‘×¨ ×”×•×¡×¤× ×• ×ª×¢×•×“×” ×¢× ××•×ª×• BOOKNUM?\n                    const alreadyExists = foundDocs.some(d => d.BOOKNUM === match.BOOKNUM);\n                    if (!alreadyExists) {\n                        console.log(`âœ… ×ž×¦××ª×™ ×ª×¢×•×“×”: ${match.BOOKNUM} â†’ ${match.DOCNO}`);\n                        foundDocs.push({\n                            DOCNO: match.DOCNO,\n                            BOOKNUM: match.BOOKNUM,\n                            TOTQUANT: match.TOTQUANT || null\n                        });\n                    } else {\n                        console.log(`â­ï¸ ×“×™×œ×•×’: ${match.BOOKNUM} ×›×‘×¨ ×§×™×™×`);\n                    }\n                }\n            }\n        } else {\n            for (const num of unidentified) {\n                const match = availableDocs.find(doc => doc.BOOKNUM === num);\n                if (match) {\n                    // ×‘×“×™×§×”: ×”×× ×›×‘×¨ ×”×•×¡×¤× ×• ×ª×¢×•×“×” ×¢× ××•×ª×• BOOKNUM?\n                    const alreadyExists = foundDocs.some(d => d.BOOKNUM === match.BOOKNUM);\n                    if (!alreadyExists) {\n                        console.log(`âœ… ×ž×¦××ª×™ ×ª×¢×•×“×”: ${match.BOOKNUM} â†’ ${match.DOCNO}`);\n                        foundDocs.push({\n                            DOCNO: match.DOCNO,\n                            BOOKNUM: match.BOOKNUM,\n                            TOTQUANT: match.TOTQUANT || null\n                        });\n                    } else {\n                        console.log(`â­ï¸ ×“×™×œ×•×’: ${match.BOOKNUM} ×›×‘×¨ ×§×™×™×`);\n                    }\n                }\n            }\n        }\n    }\n\n    // Fallback: ×—×™×¤×•×© ×‘-AZURE_TEXT\n    if (foundDocs.length === 0 && azureText) {\n        console.log('ðŸ” ×ž×—×¤×© fallback ×‘-AZURE_TEXT');\n        for (const doc of availableDocs) {\n            // âš ï¸ ×“×œ×’ ×¢×œ BOOKNUM ×œ× ×ª×§×™×Ÿ (×§×¦×¨ ×ž×“×™ ××• ×¨×™×§)\n            // BOOKNUM ×ª×§×™×Ÿ: 107XXXXXX, 108XXXXXX, 258XXXXXX (×ž×™× ×™×ž×•× 7 ×ª×•×•×™×)\n            if (!doc.BOOKNUM || doc.BOOKNUM.length < 7) {\n                console.log(`âš ï¸ ×“×™×œ×•×’ ×¢×œ ×ª×¢×•×“×” ×¢× BOOKNUM ×œ× ×ª×§×™×Ÿ: DOCNO=${doc.DOCNO}, BOOKNUM=\"${doc.BOOKNUM || 'null'}\"`);\n                continue;\n            }\n\n            const pattern = new RegExp('\\\\b' + doc.BOOKNUM + '\\\\b');\n            if (pattern.test(azureText)) {\n                // ×‘×“×™×§×”: ×”×× ×›×‘×¨ ×”×•×¡×¤× ×• ×ª×¢×•×“×” ×¢× ××•×ª×• BOOKNUM?\n                const alreadyExists = foundDocs.some(d => d.BOOKNUM === doc.BOOKNUM);\n                if (!alreadyExists) {\n                    console.log(`âœ… ×ž×¦××ª×™ ×ª×¢×•×“×” ×‘×˜×§×¡×˜: ${doc.BOOKNUM} â†’ ${doc.DOCNO}`);\n                    foundDocs.push({\n                        DOCNO: doc.DOCNO,\n                        BOOKNUM: doc.BOOKNUM,\n                        TOTQUANT: doc.TOTQUANT || null\n                    });\n                } else {\n                    console.log(`â­ï¸ ×“×™×œ×•×’: ${doc.BOOKNUM} ×›×‘×¨ ×§×™×™×`);\n                }\n            }\n        }\n    }\n\n    console.log(`ðŸ“Š ×¡×”\"×› ×ª×¢×•×“×•×ª ×©× ×ž×¦××•: ${foundDocs.length}`);\n    return foundDocs;\n}\n\nfunction extractVehiclesAdvanced(ocrFields, vehicleRules) {\n    console.log('ðŸ” extractVehiclesAdvanced: vehicleRules=' + !!vehicleRules + ', mapping=' + Object.keys(vehicleRules?.vehicle_account_mapping || {}).length);\n    if (!vehicleRules || !vehicleRules.vehicle_account_mapping) {\n        return [];\n    }\n    const foundVehicles = [];\n    const vehiclePattern = /\\d{3}-\\d{2}-\\d{3}/g;\n    const searchLocations = vehicleRules.search_locations || [\n        { location: \"fields.UnidentifiedNumbers\", priority: 1, filter_by_label: \"×¨×›×‘\" }\n    ];\n    const sortedLocations = [...searchLocations].sort((a, b) => a.priority - b.priority);\n    for (const location of sortedLocations) {\n        if (location.location === \"fields.VehicleNumbers\") {\n            if (ocrFields.VehicleNumbers && Array.isArray(ocrFields.VehicleNumbers)) {\n                ocrFields.VehicleNumbers.forEach(vNum => {\n                    if (!foundVehicles.includes(vNum)) {\n                        foundVehicles.push(vNum);\n                    }\n                });\n            }\n        }\n        else if (location.location === \"fields.UnidentifiedNumbers\") {\n            const unidentified = ocrFields.UnidentifiedNumbers || [];\n            unidentified.forEach(item => {\n                const value = typeof item === 'object' ? item.value : item;\n                const label = typeof item === 'object' ? (item.label || '') : '';\n                const context = typeof item === 'object' ? (item.context || '') : '';\n                const isValidVehicleNumber = /\\d{3}-\\d{2}-\\d{3}/.test(value);\n                const looksLikeCardNumber = context.includes('×›×¨×˜×™×¡') || label.includes('×›×¨×˜×™×¡');\n                if (location.filter_by_label) {\n                    if (label && label.includes(location.filter_by_label)) {\n                        if (isValidVehicleNumber && !looksLikeCardNumber && !foundVehicles.includes(value)) {\n                            foundVehicles.push(value);\n                        }\n                    }\n                } else {\n                    if (isValidVehicleNumber && !looksLikeCardNumber && !foundVehicles.includes(value)) {\n                        foundVehicles.push(value);\n                    }\n                }\n            });\n        }\n    }\n    console.log(`ðŸš— foundVehicles from OCR: ${foundVehicles.length}`);\n    if (foundVehicles.length === 0) {\n        let textToSearch = ocrFields.AZURE_TEXT_CLEAN || ocrFields._rawContent || '';\n        console.log(`ðŸ“ Searching in text: ${textToSearch.length} chars, has 419-29-702: ${textToSearch.includes('419-29-702')}`);\n        if (textToSearch) {\n            console.log(`ðŸ” ×—×™×¤×•×© ×¨×›×‘×™× ×‘×˜×§×¡×˜ (${ocrFields.AZURE_TEXT_CLEAN ? 'CLEAN' : 'RAW'})`);\n            const contentMatches = textToSearch.match(vehiclePattern);\n            if (contentMatches) {\n                console.log(`ðŸš— × ×ž×¦××• ${contentMatches.length} ×ž×¡×¤×¨×™ ×¨×›×‘: ${[...new Set(contentMatches)].join(', ')}`);\n                contentMatches.forEach(match => {\n                    const matchIndex = textToSearch.indexOf(match);\n                    const contextStart = Math.max(0, matchIndex - 50);\n                    const contextEnd = Math.min(textToSearch.length, matchIndex + match.length + 50);\n                    const context = textToSearch.substring(contextStart, contextEnd).toLowerCase();\n                    const isCard = context.includes('×›×¨×˜×™×¡') || context.includes('××©×¨××™');\n                    const isTaxId = context.includes('×—.×¤') || context.includes('×¢×•×¡×§ ×ž×•×¨×©×”');\n                    const isVehicle = context.includes('×¨×›×‘') || context.includes('×¨×™×©×•×™') ||\n                                     context.includes('×ž×©××™×ª') || context.includes('vehicle');\n                    if (!isCard && !isTaxId && (isVehicle || vehicleRules.vehicle_account_mapping[match])) {\n                        if (!foundVehicles.includes(match)) {\n                            console.log(`âœ… ×¨×›×‘ ×ž××•×©×¨: ${match}`);\n                            foundVehicles.push(match);\n                        }\n                    } else {\n                        console.log(`âŒ × ×“×—×” ${match} (card:${isCard}, tax:${isTaxId}, vehicle:${isVehicle})`);\n                    }\n                });\n            }\n        }\n    }\n    return [...new Set(foundVehicles)];\n}\n\nfunction buildInvoiceFromTemplate(template, structure, config, searchResults, learnedConfig, ocrFields) {\n    const supplierCode = template.SUPNAME ||\n                        config.supplier_config?.supplier_code ||\n                        learnedConfig.supplier_id ||\n                        learnedConfig.llm_prompt?.supplier_code ||\n                        learnedConfig.technical_config?.supplier_code ||\n                        \"\";\n    const invoice = {\n        SUPNAME: supplierCode,\n        CODE: template.CODE || \"×©\\\"×—\",\n        DEBIT: structure.debit_type || \"D\",\n        IVDATE: searchResults.ivdate,\n        BOOKNUM: searchResults.booknum\n    };\n    // DETAILS - ×ž-searchResults.details (×× ×œ× ×¨×™×§ ×•×œ× ×’× ×¨×™)\n    // ×œ× ×ª×œ×•×™ ×‘×¨×›×‘×™× - ×ª×ž×™×“ ×œ×§×—×ª details ×× ×§×™×™×\n    if (searchResults.details && searchResults.details.trim()) {\n        const isGeneric = ['×¢×‘×•×“×”', 'work', 'labor'].some(term => searchResults.details.trim() === term);\n        if (!isGeneric) {\n            invoice.DETAILS = searchResults.details;\n            console.log(`âœ… DETAILS ×ž-searchResults: ${invoice.DETAILS}`);\n        }\n    }\n\n    // ×ª×¢×•×“×•×ª (×× × ×ž×¦××•)\n    if (searchResults.documents && searchResults.documents.length > 0) {\n        console.log(`ðŸ“„ ×ž×•×¡×™×£ ${searchResults.documents.length} ×ª×¢×•×“×•×ª`);\n        if (searchResults.documents.length === 1) {\n            // ×ª×¢×•×“×” ×™×—×™×“×” - ×©×“×•×ª ×¨×’×™×œ×™×\n            const doc = searchResults.documents[0];\n            invoice.DOCNO = doc.DOCNO;\n            // BOOKNUM × ×©××¨ ×©×œ ×”×—×©×‘×•× ×™×ª, ×œ× ×ž×©× ×™×!\n            console.log(`âœ… ×ª×¢×•×“×” ×™×—×™×“×”: DOCNO=${doc.DOCNO}, doc BOOKNUM=${doc.BOOKNUM}`);\n        } else {\n            // ×ž×¡×¤×¨ ×ª×¢×•×“×•×ª - ×ª×ª-×˜×•×¤×¡\n            invoice.PIVDOC_SUBFORM = searchResults.documents.map(d => ({\n                DOCNO: d.DOCNO,\n                BOOKNUM: d.BOOKNUM\n            }));\n            console.log(`âœ… ${searchResults.documents.length} ×ª×¢×•×“×•×ª ×‘-PIVDOC_SUBFORM`);\n        }\n    }\n\n    // ×¤×¨×™×˜×™× - ×¨×§ ×× ×–×• ×œ× ×ª×‘× ×™×ª ×ª×¢×•×“×•×ª!\n    // ×× has_doc=true â†’ ×œ×¢×•×œ× ×œ× ×¦×¨×™×š ×¤×¨×™×˜×™× (×’× ×× ×œ× × ×ž×¦××• ×ª×¢×•×“×•×ª)\n    const needItems = !structure.has_doc;\n    console.log(`ðŸ”§ needItems=${needItems} (has_doc=${structure.has_doc}, found docs=${searchResults.documents?.length || 0})`);\n\n    if (needItems) {\n        const vehicleRules = config.rules?.critical_patterns?.vehicle_rules;\n        if (searchResults.vehicles && searchResults.vehicles.length > 0 && vehicleRules) {\n            invoice.PINVOICEITEMS_SUBFORM = createVehicleItems(\n                searchResults.vehicles,\n                searchResults.items,\n                vehicleRules,\n                ocrFields\n            );\n        } else if (searchResults.items && searchResults.items.length > 0) {\n            invoice.PINVOICEITEMS_SUBFORM = createItemsFromOCR(\n                searchResults.items,\n                template,\n                ocrFields\n            );\n        } else if (template.PINVOICEITEMS_SUBFORM) {\n            invoice.PINVOICEITEMS_SUBFORM = JSON.parse(JSON.stringify(template.PINVOICEITEMS_SUBFORM));\n        }\n    }\n\n    // DETAILS - ×œ×¤×™ PDES ×©×œ ×©×•×¨×” 1, ××• ×ž×”×ª×‘× ×™×ª\n    if (invoice.PINVOICEITEMS_SUBFORM && invoice.PINVOICEITEMS_SUBFORM.length > 0) {\n        if (!invoice.DETAILS) {\n            // ×× ××™×Ÿ DETAILS - × ×¡×” PDES ×©×œ ×”×¤×¨×™×˜ ×”×¨××©×•×Ÿ\n            const pdesValue = invoice.PINVOICEITEMS_SUBFORM[0].PDES;\n            if (pdesValue && pdesValue.trim()) {\n                invoice.DETAILS = pdesValue;\n                console.log(`âœ… DETAILS set from first item PDES: ${invoice.DETAILS}`);\n            }\n            // ×× ×¢×“×™×™×Ÿ ××™×Ÿ - ×§×— ×ž×”×ª×‘× ×™×ª\n            else if (template.DETAILS) {\n                invoice.DETAILS = template.DETAILS;\n                console.log(`âœ… DETAILS set from template: ${invoice.DETAILS}`);\n            }\n            else {\n                invoice.DETAILS = null;\n                console.log(`âš ï¸ DETAILS: ×œ× × ×ž×¦× ×ž×§×•×¨`);\n            }\n        } else {\n            console.log(`âœ… DETAILS kept from searchResults: ${invoice.DETAILS}`);\n        }\n    }\n\n    if (template.PINVOICESCONT_SUBFORM) {\n        invoice.PINVOICESCONT_SUBFORM = template.PINVOICESCONT_SUBFORM;\n    }\n    return invoice;\n}\n\nfunction extractShortDescription(ocrFields, vehicleNum) {\n    if (ocrFields.Items && ocrFields.Items.length > 0) {\n        const item = ocrFields.Items.find(i =>\n            i.Description && (\n                i.Description.includes(vehicleNum) ||\n                i.Description.includes('×˜×™×¤×•×œ') ||\n                i.Description.includes('×¢×‘×•×“×”')\n            )\n        );\n        if (item && item.Description) {\n            const desc = item.Description.trim();\n            const servicePattern = /×˜×™×¤×•×œ\\s+[\\d,]+\\s*×§[×´\"]?×ž/i;\n            const match = desc.match(servicePattern);\n            if (match) {\n                let serviceDesc = match[0];\n                serviceDesc = serviceDesc\n                    .replace(/,/g, '')\n                    .replace(/×§×ž/g, '×§\"×ž')\n                    .replace(/×§×´×ž/g, '×§\"×ž');\n                return serviceDesc;\n            }\n            const words = desc.split(/\\s+/);\n            let shortDesc = words.slice(0, 4).join(' ');\n            if (shortDesc.length > 50) {\n                shortDesc = shortDesc.substring(0, 47) + '...';\n            }\n            return shortDesc;\n        }\n    }\n    return '×˜×™×¤×•×œ';\n}\n\nfunction createItemsFromOCR(ocrItems, template, ocrFields) {\n    if (!ocrItems || ocrItems.length === 0) return [];\n    const items = [];\n    const templateItem = template.PINVOICEITEMS_SUBFORM?.[0] || {};\n\n    // ×—×™×©×•×‘ SubTotal ×œ×¤× ×™ ×ž×¢\"×ž\n    let subtotal = ocrFields.SubTotal || ocrFields.SubTotal_amount || 0;\n    if (!subtotal && ocrFields.InvoiceTotal_amount && ocrFields.TotalTax_amount) {\n        subtotal = ocrFields.InvoiceTotal_amount - ocrFields.TotalTax_amount;\n    }\n\n    // ×—×™×œ×•×¥ ×ª×™××•×¨ ×ž-AZURE_TEXT_CLEAN ×× ××™×Ÿ Description ×‘-Items\n    let extractedDescription = \"\";\n    const azureText = ocrFields.AZURE_TEXT_CLEAN || \"\";\n    if (azureText) {\n        const lines = azureText.split('\\n').map(l => l.trim()).filter(l => l);\n\n        // ×—×™×¤×•×© ×ª×™××•×¨ ×©×™×¨×•×ª - ×©× ×” + ×˜×§×¡×˜ (×œ×ž×©×œ \"2025 ×¨×™×˜×™×™× ×¨ ×™×•×œ×™\")\n        for (const line of lines) {\n            // ×“×¤×•×¡: ×©× ×” (2020-2030) + ×˜×§×¡×˜\n            if (/^20[2-3]\\d\\s+\\S/.test(line)) {\n                extractedDescription = line;\n                break;\n            }\n            // ×“×¤×•×¡: ×ž×™×œ×•×ª ×ž×¤×ª×— ×©×œ ×ª×™××•×¨ ×©×™×¨×•×ª\n            if ((line.includes('×¨×™×˜×™×™× ×¨') || line.includes('×©×™×¨×•×ª') ||\n                 line.includes('×™×™×¢×•×¥') || line.includes('×”× ×”×œ×ª ×—×©×‘×•× ×•×ª')) &&\n                line.length > 5 && line.length < 100) {\n                extractedDescription = line;\n                break;\n            }\n        }\n\n        if (extractedDescription) {\n            console.log(`ðŸ“ PDES ×—×•×œ×¥ ×ž-AZURE_TEXT: \"${extractedDescription}\"`);\n        }\n    }\n\n    ocrItems.forEach((ocrItem, index) => {\n        let price = 0;\n\n        // ×× ×™×© ×¨×§ ×¤×¨×™×˜ ××—×“ - ×¢×“×™×£ ×œ×§×—×ª SubTotal (×œ×¤× ×™ ×ž×¢\"×ž)\n        if (ocrItems.length === 1 && subtotal > 0) {\n            price = subtotal;\n            console.log(`ðŸ“Š PRICE ×ž-SubTotal (×¤×¨×™×˜ ×™×—×™×“): ${price}`);\n        }\n        // ××—×¨×ª - ×‘×“×™×§×ª ×ž×§×•×¨×•×ª ×©×•× ×™× ×œ×ž×—×™×¨\n        else if (ocrItem.UnitPrice) {\n            price = ocrItem.UnitPrice;\n        } else if (ocrItem.Amount) {\n            price = ocrItem.Amount / (ocrItem.Quantity || 1);\n        } else if (ocrItem.Amount_amount) {\n            price = ocrItem.Amount_amount / (ocrItem.Quantity || 1);\n        } else if (ocrItem.TotalPrice) {\n            // TotalPrice - ×ž×—×™×¨ ×›×•×œ×œ ×ž×¢\"×ž (×¤×—×•×ª ×ž×“×•×™×§)\n            price = ocrItem.TotalPrice;\n            console.log(`âš ï¸ PRICE ×ž-TotalPrice (×›×•×œ×œ ×ž×¢\"×ž): ${price}`);\n        }\n\n        // PDES - ×ª×™××•×¨ ×”×¤×¨×™×˜ (×ž×¡×¤×¨ ×ž×§×•×¨×•×ª ××¤×©×¨×™×™×)\n        let pdes = ocrItem.Description || extractedDescription || templateItem.PDES || \"\";\n\n        const item = {\n            PARTNAME: templateItem.PARTNAME || \"item\",\n            TUNITNAME: ocrItem.Unit || templateItem.TUNITNAME || \"×™×—'\",\n            VATFLAG: templateItem.VATFLAG || \"Y\",\n            ACCNAME: templateItem.ACCNAME || \"\",\n            SPECIALVATFLAG: templateItem.SPECIALVATFLAG || \"Y\",\n            PDES: pdes,\n            TQUANT: ocrItem.Quantity || 1,\n            PRICE: price\n        };\n        if (templateItem.BUDCODE) {\n            item.BUDCODE = templateItem.BUDCODE;\n        }\n        items.push(item);\n    });\n    const calculatedTotal = items.reduce((sum, item) => sum + (item.TQUANT * item.PRICE), 0);\n    let ocrSubtotal = ocrFields.SubTotal || ocrFields.SubTotal_amount || 0;\n    if (!ocrSubtotal &&\n        (ocrFields.InvoiceTotal || ocrFields.InvoiceTotal_amount) &&\n        (ocrFields.TotalTax || ocrFields.TotalTax_amount)) {\n        const invoiceTotal = ocrFields.InvoiceTotal || ocrFields.InvoiceTotal_amount;\n        const totalTax = ocrFields.TotalTax || ocrFields.TotalTax_amount;\n        ocrSubtotal = invoiceTotal - totalTax;\n    }\n    if (calculatedTotal > 0 && ocrSubtotal > 0) {\n        const difference = Math.abs(calculatedTotal - ocrSubtotal);\n        const percentDiff = (difference / ocrSubtotal) * 100;\n        if (percentDiff > 5) {\n            console.log(`âš ï¸ ×”×¤×¨×© ×¡×›×•×ž×™×: ${difference.toFixed(2)} (${percentDiff.toFixed(1)}%)`);\n        } else {\n            console.log(`âœ… ×¡×›×•× ×ª×•××: OCR=${ocrSubtotal}, ×—×™×©×•×‘=${calculatedTotal.toFixed(2)}`);\n        }\n    }\n    console.log(`× ×•×¦×¨×• ${items.length} ×¤×¨×™×˜×™× ×ž-OCR`);\n    return items;\n}\n\nfunction createVehicleItems(vehicles, ocrItems, vehicleRules, ocrFields) {\n    if (!vehicles || vehicles.length === 0) return [];\n    const vehicleItems = [];\n\n    // Calculate SubTotal (before VAT)\n    let subtotal = ocrFields.SubTotal_amount || ocrFields.SubTotal || 0;\n    if (!subtotal && ocrFields.InvoiceTotal_amount && ocrFields.TotalTax_amount) {\n        subtotal = ocrFields.InvoiceTotal_amount - ocrFields.TotalTax_amount;\n        console.log(`ðŸ“Š Calculated SubTotal: ${ocrFields.InvoiceTotal_amount} - ${ocrFields.TotalTax_amount} = ${subtotal}`);\n    }\n\n    const pricePerVehicle = vehicles.length > 0 ? subtotal / vehicles.length : subtotal;\n\n    vehicles.forEach(vehicleNum => {\n        const mapping = vehicleRules.vehicle_account_mapping?.[vehicleNum];\n\n        // Build PDES from real product descriptions (not \"×¢×‘×•×“×”\")\n        let pdesWithVehicle = vehicleNum;\n\n        // Get product descriptions from Items, excluding generic work descriptions\n        if (ocrItems && ocrItems.length > 0) {\n            const productDescriptions = [];\n            const excludeTerms = ['×¢×‘×•×“×”', 'work', 'labor'];\n\n            // Sort by amount (highest first) and take meaningful descriptions\n            const sortedItems = [...ocrItems].sort((a, b) => {\n                const amountA = parseFloat(a.Amount_amount || a.Amount || 0);\n                const amountB = parseFloat(b.Amount_amount || b.Amount || 0);\n                return amountB - amountA;\n            });\n\n            for (const item of sortedItems) {\n                const desc = item.Description_content || item.Description || '';\n                const isGeneric = excludeTerms.some(term => desc.trim() === term);\n\n                if (desc && !isGeneric && productDescriptions.length < 3) {\n                    productDescriptions.push(desc.trim());\n                }\n            }\n\n            if (productDescriptions.length > 0) {\n                pdesWithVehicle = productDescriptions.join('+ ');\n                console.log(`ðŸš— ×¨×›×‘ ${vehicleNum}: PDES = \"${pdesWithVehicle}\"`);\n            }\n        }\n\n        let actualMapping = mapping;\n        if (Array.isArray(mapping) && mapping.length > 0) {\n            console.log(`ðŸš— ×¨×›×‘ ${vehicleNum}: ${mapping.length} bundles, ×œ×•×§×— ×¨××©×•×Ÿ`);\n            actualMapping = mapping[0];\n        }\n\n        const item = {\n            PARTNAME: vehicleRules.output_format?.partname || \"car\",\n            PDES: pdesWithVehicle,\n            TQUANT: 1,\n            TUNITNAME: \"×™×—'\",\n            PRICE: pricePerVehicle,\n            VATFLAG: actualMapping?.vat_pattern?.VATFLAG || \"Y\",\n            ACCNAME: actualMapping?.accname || \"\"\n        };\n\n        if (actualMapping?.budcode) {\n            item.BUDCODE = actualMapping.budcode;\n        } else if (vehicleRules.default_values?.budcode) {\n            item.BUDCODE = vehicleRules.default_values.budcode;\n        }\n        if (actualMapping?.vat_pattern?.SPECIALVATFLAG === \"Y\") {\n            item.SPECIALVATFLAG = \"Y\";\n        }\n        if (!actualMapping) {\n            item._learningNote = \"×¨×›×‘ ×—×“×© - × ×“×¨×© ×ž×™×¤×•×™\";\n            console.log(`âš ï¸ ×¨×›×‘ ${vehicleNum} ×œ× ×‘×ž×™×¤×•×™ - ACCNAME ×¨×™×§`);\n        }\n        vehicleItems.push(item);\n    });\n    console.log(`× ×•×¦×¨×• ${vehicleItems.length} ×¤×¨×™×˜×™ ×¨×›×‘`);\n    return vehicleItems;\n}\n\nfunction performValidation(invoice, ocrFields, config, docsList, patterns, structure, searchResults, template) {\n    const warnings = [];\n    const checks = {\n        required_fields_check: \"passed\",\n        invoice_structure_check: \"passed\",\n        amount_validation: \"not_checked\"\n    };\n\n    // Build field mapping - shows source and value for each field\n    const fieldMapping = {\n        SUPNAME: { source: \"Template\", field: \"supplier_code\", value: invoice.SUPNAME },\n        CODE: { source: \"Template\", value: invoice.CODE },\n        DEBIT: { source: structure.debit_type === \"C\" ? \"Calculated (Credit)\" : \"Template\", value: invoice.DEBIT },\n        IVDATE: { source: \"OCR\", field: \"InvoiceDate\", value: invoice.IVDATE, ocr_value: ocrFields.InvoiceDate },\n        BOOKNUM: { source: \"OCR\", field: \"InvoiceId\", value: invoice.BOOKNUM, ocr_value: ocrFields.InvoiceId },\n        DETAILS: {\n            source: invoice.PINVOICEITEMS_SUBFORM && invoice.PINVOICEITEMS_SUBFORM.length > 0\n                ? \"First Item PDES\"\n                : (searchResults.details ? \"OCR\" : \"Template\"),\n            value: invoice.DETAILS\n        }\n    };\n\n    if (structure.has_doc && searchResults.documents && searchResults.documents.length > 0) {\n        fieldMapping.DOCNO = { source: \"Documents Search\", value: invoice.DOCNO, count: searchResults.documents.length };\n    }\n\n    if (structure.has_vehicles && searchResults.vehicles && searchResults.vehicles.length > 0) {\n        fieldMapping.PINVOICEITEMS_SUBFORM = {\n            source: \"Vehicle Items\",\n            vehicle_numbers: searchResults.vehicles,\n            count: searchResults.vehicles.length,\n            items: invoice.PINVOICEITEMS_SUBFORM?.map(item => ({\n                PDES: item.PDES,\n                ACCNAME: item.ACCNAME,\n                PRICE: item.PRICE\n            }))\n        };\n    } else if (invoice.PINVOICEITEMS_SUBFORM && invoice.PINVOICEITEMS_SUBFORM.length > 0) {\n        fieldMapping.PINVOICEITEMS_SUBFORM = {\n            source: \"OCR Items\",\n            count: invoice.PINVOICEITEMS_SUBFORM.length\n        };\n    }\n\n    checks.field_mapping = fieldMapping;\n    const requiredFields = [\"SUPNAME\", \"CODE\", \"DEBIT\", \"IVDATE\", \"BOOKNUM\"];\n    const missingFields = requiredFields.filter(f => !invoice[f]);\n    if (missingFields.length > 0) {\n        warnings.push(`×©×“×•×ª ×—×•×‘×” ×—×¡×¨×™×: ${missingFields.join(', ')}`);\n        checks.required_fields_check = \"failed\";\n    }\n    if (invoice.PINVOICEITEMS_SUBFORM && invoice.PINVOICEITEMS_SUBFORM.length > 0) {\n        const calculatedTotal = invoice.PINVOICEITEMS_SUBFORM.reduce((sum, item) => {\n            return sum + (item.TQUANT || 0) * (item.PRICE || 0);\n        }, 0);\n        let ocrSubtotal = ocrFields.SubTotal || ocrFields.SubTotal_amount || 0;\n        if (!ocrSubtotal &&\n            (ocrFields.InvoiceTotal || ocrFields.InvoiceTotal_amount) &&\n            (ocrFields.TotalTax || ocrFields.TotalTax_amount)) {\n            const invoiceTotal = ocrFields.InvoiceTotal || ocrFields.InvoiceTotal_amount;\n            const totalTax = ocrFields.TotalTax || ocrFields.TotalTax_amount;\n            ocrSubtotal = invoiceTotal - totalTax;\n        }\n        if (calculatedTotal > 0 && ocrSubtotal > 0) {\n            const difference = Math.abs(calculatedTotal - ocrSubtotal);\n            const percentDiff = (difference / ocrSubtotal) * 100;\n            if (percentDiff > 5) {\n                warnings.push(`âš ï¸ ×”×¤×¨×© ×¡×›×•×ž×™×: ${calculatedTotal.toFixed(2)} vs ${ocrSubtotal.toFixed(2)} (${percentDiff.toFixed(1)}%)`);\n                checks.amount_validation = \"warning\";\n            } else {\n                warnings.push(`âœ… ×¡×›×•× ×ª×§×™×Ÿ: ${calculatedTotal.toFixed(2)} ×©\"×— (${percentDiff.toFixed(1)}% ×”×¤×¨×©)`);\n                checks.amount_validation = \"passed\";\n            }\n        } else {\n            warnings.push(`â„¹ï¸ ×œ× × ×™×ª×Ÿ ×œ×‘×“×•×§ ×¡×›×•×ž×™×`);\n            checks.amount_validation = \"not_applicable\";\n        }\n    } else {\n        const itemsInOCR = ocrFields.Items ? ocrFields.Items.length : 0;\n        if (itemsInOCR > 0) {\n            warnings.push(`â„¹ï¸ OCR ×–×™×”×” ${itemsInOCR} ×¤×¨×™×˜×™× ××‘×œ ×œ× × ×•×¦×¨×•`);\n            checks.amount_validation = \"no_items\";\n        }\n    }\n    return {\n        all_valid: warnings.length === 0 || warnings.every(w => w.startsWith('âœ…') || w.startsWith('â„¹ï¸')),\n        checks: checks,\n        warnings: warnings\n    };\n}\n\nfunction analyzeLearning(invoice, config) {\n    const newPatterns = {\n        new_partnames: [],\n        new_vehicles: [],\n        unknown_accounts: []\n    };\n    const instructions = [];\n    if (invoice.PINVOICEITEMS_SUBFORM) {\n        invoice.PINVOICEITEMS_SUBFORM.forEach(item => {\n            if (item._learningNote) {\n                const vehicleMatch = item.PDES.match(/\\d{3}-\\d{2}-\\d{3}/);\n                if (vehicleMatch) {\n                    const vehiclePattern = {\n                        vehicle_number: vehicleMatch[0],\n                        suggested_accname: item.ACCNAME || \"\",\n                        suggested_vatflag: item.VATFLAG || \"Y\"\n                    };\n                    if (item.BUDCODE !== undefined) {\n                        vehiclePattern.suggested_budcode = item.BUDCODE;\n                    }\n                    newPatterns.new_vehicles.push(vehiclePattern);\n                }\n            }\n        });\n    }\n    const learningRequired = newPatterns.new_vehicles.length > 0;\n    return {\n        learning_required: learningRequired,\n        new_patterns: newPatterns,\n        learning_instructions: instructions,\n        recommendation: learningRequired ? \"×©×œ×— ×œ×§×•×“ 3 ×œ×œ×ž×™×“×”\" : \"××™×Ÿ ×¦×•×¨×š ×‘×œ×ž×™×“×”\"\n    };\n}\n\n// Main execution - Make.com runs this automatically\nresult = { status: \"error\", message: \"No input provided\" };\n\nif (typeof input !== 'undefined') {\n    console.log(\"v1.7.1: input type =\", typeof input, \"isArray =\", Array.isArray(input));\n    // ×× input ×”×•× array, × ×™×§×— ××ª ×”×¤×¨×™×˜ ×”×¨××©×•×Ÿ\n    let inputData = Array.isArray(input) ? input[0] : input;\n    // ×× inputData ×”×•× array, × ×™×§×— ××ª ×”×¤×¨×™×˜ ×”×¨××©×•×Ÿ ×©×œ×•\n    if (Array.isArray(inputData)) {\n        console.log(\"ðŸ” inputData is array, taking inputData[0]\");\n        inputData = inputData[0];\n    }\n    // ×× inputData ×¨×™×§ ××• ××™×Ÿ ×œ×• keys, × × ×¡×” input ×™×©×™×¨×•×ª\n    if (!inputData || (typeof inputData === 'object' && Object.keys(inputData).length === 0)) {\n        console.log(\"ðŸ” inputData empty, using input directly\");\n        inputData = input;\n    }\n    console.log(\"ðŸ” inputData keys:\", typeof inputData === 'object' ? Object.keys(inputData).slice(0, 10).join(', ') : 'not object');\n    console.log(\"ðŸ” inputData.input exists?\", !!inputData.input);\n    console.log(\"ðŸ” inputData.AZURE exists?\", !!inputData.AZURE);\n    console.log(\"ðŸ” inputData.SUPNAME exists?\", !!inputData.SUPNAME);\n    // **×ª×ž×™×“** × ×§×¨× ×œ-processProductionInvoice - ×–×” ×™×¢×‘×™×¨ ×œ-processInvoiceComplete ×× ×¦×¨×™×š\n    if (inputData.AZURE || inputData.SUPNAME || (inputData.input && Array.isArray(inputData.input))) {\n        console.log(\"âœ… Calling processProductionInvoice\");\n        result = processProductionInvoice(inputData);\n    } else {\n        const processInput = {\n            learned_config: input.learned_config || {},\n            docs_list: input.docs_list || { DOC_YES_NO: \"N\", list_of_docs: [] },\n            import_files: input.import_files || { IMPFILES: [] },\n            vehicles: input.vehicles || \"{}\",\n            AZURE_RESULT: input.AZURE_RESULT || { data: { fields: {} } },\n            AZURE_TEXT_CLEAN: input.AZURE_TEXT_CLEAN || \"\",\n            AZURE_TEXT: input.AZURE_TEXT || \"\",\n            template_index: input.template_index  // âœ… ×—×“×©! ×”×¢×‘×¨×ª template_index\n        };\n        result = processInvoiceComplete({ input: [\n            { name: \"learned_config\", value: processInput.learned_config },\n            { name: \"docs_list\", value: processInput.docs_list },\n            { name: \"import_files\", value: processInput.import_files },\n            { name: \"vehicles\", value: processInput.vehicles },\n            { name: \"AZURE_RESULT\", value: processInput.AZURE_RESULT },\n            { name: \"AZURE_TEXT_CLEAN\", value: processInput.AZURE_TEXT_CLEAN },\n            { name: \"AZURE_TEXT\", value: processInput.AZURE_TEXT },\n            { name: \"template_index\", value: processInput.template_index }  // âœ… ×—×“×©!\n        ]});\n    }\n    console.log(JSON.stringify(result, null, 2));\n    console.log(\"v1.7.1: items =\", result.invoice_data?.PINVOICES?.[0]?.PINVOICEITEMS_SUBFORM?.length || 0);\n    console.log(\"v1.7.1: BOOKNUM =\", result.invoice_data?.PINVOICES?.[0]?.BOOKNUM);\n    console.log(\"v1.7.1: DOCNO =\", result.invoice_data?.PINVOICES?.[0]?.DOCNO);\n    console.log(\"==========================================\");\n}\n\n})();  // End of IIFE\n\n// âš ï¸ CRITICAL: return ×ž×—×•×¥ ×œ-IIFE - Make.com ×¢×•×˜×£ ××ª ×”×›×œ ×‘×¤×•× ×§×¦×™×”!\nreturn result;\n"
    }
]
