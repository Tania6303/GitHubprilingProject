<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production Invoice - ×™×™×¦×•×¨ ×—×©×‘×•× ×™×•×ª</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .breadcrumb {
            background: #f8f9fa;
            padding: 15px 40px;
            border-bottom: 1px solid #e9ecef;
        }

        .breadcrumb a {
            color: #00f2fe;
            text-decoration: none;
            font-weight: bold;
        }

        .content {
            padding: 40px;
        }

        h2 {
            color: #00f2fe;
            border-bottom: 3px solid #00f2fe;
            padding-bottom: 10px;
            margin: 30px 0 20px 0;
            font-size: 2em;
        }

        h3 {
            color: #4facfe;
            margin: 25px 0 15px 0;
            font-size: 1.5em;
        }

        .flow-step {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            border-right: 5px solid #4facfe;
        }

        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 10px;
            overflow-x: auto;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            direction: ltr;
            text-align: left;
            font-size: 0.9em;
        }

        .info-box {
            background: #e7f3ff;
            border-right: 5px solid #2196F3;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
        }

        .warning-box {
            background: #fff3cd;
            border-right: 5px solid #ffc107;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
        }

        ul, ol {
            margin: 15px 0 15px 30px;
        }

        li {
            margin: 8px 0;
        }

        footer {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .highlight {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ­ Production Invoice</h1>
            <p>×©×œ×‘ 3: ×™×¦×™×¨×ª JSON ×¡×•×¤×™ ×œ××¢×¨×›×ª ERP</p>
        </header>

        <div class="breadcrumb">
            <a href="../Documentation-Mapping-Rules.html">â¬… ×—×–×¨×” ×œ×“×£ ×”×¨××©×™</a>
        </div>

        <div class="content">
            <h2>ğŸ“‹ ×¡×§×™×¨×”</h2>
            <p>××•×“×•×œ Production Invoice ×”×•× ×”×©×œ×‘ ×”××—×¨×•×Ÿ ×‘×ª×”×œ×™×š. ×”×•× ×œ×•×§×— ××ª ×”×ª×‘× ×™×ª ×”×××•×—×“×ª ×-Processing Invoice ×•××™×™×¦×¨ JSON ×¡×•×¤×™ ××•×›×Ÿ ×œ×©×œ×™×—×” ×œ-Priority ERP.</p>

            <div class="info-box">
                <h3>ğŸ¯ ×ª×¤×§×™×“ ×¢×™×§×¨×™</h3>
                <p>×”××¨×ª ×”××‘× ×” ×”×—×“×© (×¢× all_templates) ×œ××‘× ×” ×©××¢×¨×›×ª ×”-ERP ××‘×™× ×”.</p>
            </div>

            <h2>ğŸ“¥ ×§×œ×˜</h2>
            <p>×”×§×œ×˜ ××’×™×¢ ×××¢×¨×›×ª Make.com ×•××›×™×œ:</p>
            <ul>
                <li><strong>AZURE:</strong> × ×ª×•× ×™ OCR (JSON string ××• ××•×‘×™×™×§×˜)</li>
                <li><strong>SUPNAME:</strong> ×§×•×“ ×¡×¤×§</li>
                <li><strong>CARS:</strong> ×¨×©×™××ª ×¨×›×‘×™× (JSON array)</li>
                <li><strong>SUP_TEMP:</strong> ×ª×‘× ×™×ª ×××•×—×“×ª ×-Processing Invoice</li>
            </ul>

            <h2>âš™ï¸ ×ª×”×œ×™×š ×”×¢×™×‘×•×“</h2>

            <div class="flow-step">
                <h3>×©×œ×‘ 1: ×”××¨×ª ××‘× ×”</h3>
                <p>×”××¨×ª ×”××‘× ×” ×”×—×“×© (SUP_TEMP) ×œ××‘× ×” learned_config:</p>
                <ul>
                    <li>×—×™×œ×•×¥ <span class="highlight">invoice_data</span> ××›×œ ×ª×‘× ×™×ª ×‘-all_templates</li>
                    <li>×—×™×œ×•×¥ <span class="highlight">technical_config</span> ×œ×‘× ×™×™×ª config</li>
                    <li>×‘× ×™×™×ª vehicle_account_mapping ××¨×©×™××ª CARS</li>
                </ul>
            </div>

            <div class="flow-step">
                <h3>×©×œ×‘ 2: ×§×¨×™××” ×œ-Processing Invoice</h3>
                <p>×”×¢×‘×¨×ª ×”× ×ª×•× ×™× ×”××•××¨×™× ×œ×¤×•× ×§×¦×™×” processInvoiceComplete().</p>
            </div>

            <div class="flow-step">
                <h3>×©×œ×‘ 3: × ×™×§×•×™ ×•×”×›× ×”</h3>
                <p>× ×™×§×•×™ ×”×—×©×‘×•× ×™×ª ×”×¡×•×¤×™×ª:</p>
                <ul>
                    <li>×”×¡×¨×ª ×©×“×•×ª ×œ××™×“×” (_learningNote, isNewVehicle)</li>
                    <li>×”×¡×¨×ª SPECIALVATFLAG ×× ×œ× "Y"</li>
                    <li>×”×¡×¨×ª undefined values (Make.com ×œ× ××§×‘×œ)</li>
                </ul>
            </div>

            <div class="flow-step">
                <h3>×©×œ×‘ 4: ×”×—×–×¨×ª JSON</h3>
                <p>×”×—×–×¨×ª JSON ××•×‘× ×” ××•×›×Ÿ ×œ×©×œ×™×—×” ×œ-Priority.</p>
            </div>

            <h2>âœ¨ ×˜×™×¤×•×œ ×‘××‘× ×” ×”×—×“×©</h2>

            <div class="warning-box">
                <h3>âš ï¸ ×©×™× ×•×™ ×§×¨×™×˜×™ ×‘×’×¨×¡×” 4.2</h3>
                <p>×”××‘× ×” ×©×œ Processing Invoice ×”×©×ª× ×”:</p>
                <ul>
                    <li><strong>×œ×¤× ×™:</strong> invoice_data ×•-technical_config ×‘×¨××” ×¢×œ×™×•× ×”</li>
                    <li><strong>××—×¨×™:</strong> supplier_code/name ×‘×¨××” ×¢×œ×™×•× ×”, ×”×›×œ ×”××—×¨ ×ª×—×ª all_templates</li>
                </ul>
            </div>

            <h3>×§×•×“ ×—×™×œ×•×¥ ××”××‘× ×” ×”×—×“×©:</h3>
            <div class="code-block">
// ×—×™×œ×•×¥ invoice_data ××›×œ ×”×ª×‘× ×™×•×ª
if (templateData.llm_prompt && templateData.llm_prompt.all_templates) {
    const allPinvoices = templateData.llm_prompt.all_templates.map(template => {
        return template.invoice_data?.PINVOICES?.[0] || {};
    });

    parsedTemplate = {
        PINVOICES: allPinvoices,
        document_types_count: allPinvoices.length
    };
}

// ×—×™×œ×•×¥ technical_config
if (templateData.technical_config && templateData.technical_config.all_templates) {
    parsedConfig = {
        ...templateData.technical_config.all_templates[0],
        supplier_config: {
            supplier_code: templateData.technical_config.supplier_code,
            supplier_name: templateData.technical_config.supplier_name
        }
    };
}
            </div>

            <h2>ğŸ“¤ ×¤×œ×˜</h2>
            <p>JSON ×¡×•×¤×™ ×”×›×•×œ×œ:</p>
            <ul>
                <li><strong>status:</strong> "success" ××• "error"</li>
                <li><strong>invoice:</strong> ×—×©×‘×•× ×™×ª ××•×‘× ×™×ª ×œ×¤×™ ×¤×•×¨××˜ Priority</li>
                <li><strong>execution_report:</strong> ×“×•×— ×‘×™×¦×•×¢ (found, not_found, warnings, errors)</li>
            </ul>

            <h3>×“×•×’××” ×œ×¤×œ×˜ ×¡×•×¤×™:</h3>
            <div class="code-block">
{
  "status": "success",
  "invoice": {
    "SUPNAME": "5014",
    "CODE": "×©\"×—",
    "DEBIT": "D",
    "IVDATE": "05/11/25",
    "BOOKNUM": "1234567",
    "PINVOICEITEMS_SUBFORM": [
      {
        "PARTNAME": "car",
        "PDES": "×˜×™×¤×•×œ 75000 ×§\"×",
        "TQUANT": 1,
        "TUNITNAME": "×™×—'",
        "PRICE": 300,
        "VATFLAG": "Y",
        "ACCNAME": "66979",
        "SPECIALVATFLAG": "Y"
      }
    ],
    "PINVOICESCONT_SUBFORM": [
      {
        "FNCPATNAME": "2323"
      }
    ]
  },
  "execution_report": {
    "stage": "×©×œ×‘ 7: × ×™×§×•×™ ×•×”×—×–×¨×ª ×ª×•×¦××”",
    "found": [
      "×¡×•×’: ×™×‘×•×=false, ×ª×¢×•×“×•×ª=false, ×—×™×•×‘/×–×™×›×•×™=D",
      "×¨×›×‘×™×: 1 - 741-69-103"
    ],
    "not_found": [],
    "warnings": [],
    "errors": []
  }
}
            </div>

            <h2>ğŸ”— ×©×¨×©×¨×ª ×”××¢×¨×›×ª ×”××œ××”</h2>
            <div class="info-box">
                <h3>1ï¸âƒ£ Supplier Data Learning</h3>
                <p>ERP Priority â†’ learned_config</p>

                <h3>2ï¸âƒ£ Processing Invoice</h3>
                <p>learned_config + OCR â†’ ×ª×‘× ×™×ª ×××•×—×“×ª (all_templates)</p>

                <h3>3ï¸âƒ£ Production Invoice</h3>
                <p>×ª×‘× ×™×ª ×××•×—×“×ª â†’ JSON ×¡×•×¤×™ â†’ ERP Priority</p>
            </div>

            <h2>âš ï¸ × ×§×•×“×•×ª ×—×©×•×‘×•×ª</h2>
            <ul>
                <li>Production Invoice <strong>×—×™×™×‘</strong> ×œ×”×›×™×¨ ××ª ×”××‘× ×” ×”×—×“×© ×©×œ Processing Invoice</li>
                <li>×›×œ ×©×™× ×•×™ ×‘-Processing Invoice ×“×•×¨×© ×‘×“×™×§×” ×‘-Production Invoice</li>
                <li>× ×™×§×•×™ ×©×“×•×ª undefined <strong>×§×¨×™×˜×™</strong> - Make.com ×“×•×—×” JSON ×¢× undefined</li>
                <li>PINVOICESCONT_SUBFORM ×—×™×™×‘ ×œ×”×™×•×ª ××•×’×“×¨ (××¤×™×œ×• ×›××¢×¨×š ×¨×™×§)</li>
            </ul>

            <h2>ğŸ”„ ×¢×“×›×•× ×™× ×¢×ª×™×“×™×™×</h2>
            <p>×›××©×¨ ××•×¡×™×¤×™× ×©×“×•×ª ×—×“×©×™× ×‘-Processing Invoice:</p>
            <ol>
                <li>×œ×•×•×“× ×©×”× ××•×¢×‘×¨×™× ×“×¨×š all_templates</li>
                <li>×œ×¢×“×›×Ÿ ××ª Production Invoice ×œ×§×¨×•× ××•×ª× × ×›×•×Ÿ</li>
                <li>×œ×‘×“×•×§ ×©×”× ×™×§×•×™ cleanInvoiceForPriority() ××˜×¤×œ ×‘×”×</li>
                <li>×œ×¢×“×›×Ÿ ×“×•×§×•×× ×˜×¦×™×”</li>
            </ol>
        </div>

        <footer>
            <p>ğŸ“… ×¢×•×“×›×Ÿ ×œ××—×¨×•× ×”: × ×•×‘××‘×¨ 2025</p>
            <p>ğŸ”§ ×’×¨×¡×”: 1.0 (×ª×•××š ×‘-Processing Invoice 4.2)</p>
        </footer>
    </div>
</body>
</html>
