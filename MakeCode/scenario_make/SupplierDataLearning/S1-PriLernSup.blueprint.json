{
    "name": "S1-PriLernSup",
    "flow": [
        {
            "id": 1,
            "module": "app#leonai-priority:getItemsForms",
            "version": 1,
            "parameters": {
                "__IMTCONN__": 12563223
            },
            "mapper": {
                "form": "PINVOICES",
                "sort": "desc",
                "limit": "{{var.input.LIMIT}}",
                "column": [
                    [
                        {
                            "a": "SUPNAME::text",
                            "b": "{{var.input.SUPNAME}}",
                            "o": "eq"
                        }
                    ]
                ],
                "orderby": "IVDATE",
                "subforms": [
                    {
                        "table": "PINVOICESCONT_SUBFORM"
                    },
                    {
                        "table": "PIVDOC_SUBFORM"
                    },
                    {
                        "table": "PINVOICEITEMS_SUBFORM"
                    },
                    {
                        "table": "EXTFILES_SUBFORM",
                        "filters": [
                            [
                                {
                                    "a": "EXTFILEDES::text",
                                    "o": "exist"
                                },
                                {
                                    "a": "SUFFIX::text",
                                    "b": "pdf",
                                    "o": "eq"
                                }
                            ],
                            [
                                {
                                    "a": "SUFFIX::text",
                                    "b": "PDF",
                                    "o": "eq"
                                }
                            ]
                        ]
                    },
                    {
                        "table": "INTERNALDIALOGTEXT_SUBFORM"
                    }
                ]
            },
            "metadata": {
                "designer": {
                    "x": 0,
                    "y": 0
                },
                "restore": {
                    "expect": {
                        "form": {
                            "mode": "chose",
                            "label": "חשבוניות ספק מרכזות"
                        },
                        "sort": {
                            "mode": "chose",
                            "label": "Descending"
                        },
                        "orderby": {
                            "mode": "chose",
                            "label": "תאריך"
                        },
                        "subforms": {
                            "items": [
                                {
                                    "table": {
                                        "mode": "chose",
                                        "label": "חשבונית - פרטים נוספים"
                                    },
                                    "orderby2": {
                                        "mode": "chose"
                                    },
                                    "selection2": {
                                        "mode": "chose"
                                    }
                                },
                                {
                                    "table": {
                                        "mode": "chose",
                                        "label": "תעודות קבלה לחשבונית"
                                    },
                                    "orderby2": {
                                        "mode": "chose"
                                    },
                                    "selection2": {
                                        "mode": "chose"
                                    }
                                },
                                {
                                    "table": {
                                        "mode": "chose",
                                        "label": "חשבוניות ספק מרכזות - פירוט"
                                    },
                                    "orderby2": {
                                        "mode": "chose"
                                    },
                                    "selection2": {
                                        "mode": "chose"
                                    }
                                },
                                {
                                    "table": {
                                        "mode": "chose",
                                        "label": "נספחים"
                                    },
                                    "orderby2": {
                                        "mode": "chose"
                                    },
                                    "selection2": {
                                        "mode": "chose"
                                    }
                                },
                                {
                                    "table": {
                                        "mode": "chose",
                                        "label": "דו שיח פנימי"
                                    },
                                    "orderby2": {
                                        "mode": "chose"
                                    },
                                    "selection2": {
                                        "mode": "chose"
                                    }
                                }
                            ]
                        },
                        "selection": {
                            "mode": "chose"
                        }
                    },
                    "parameters": {
                        "__IMTCONN__": {
                            "data": {
                                "scoped": "true",
                                "connection": "app#leonai-priority3"
                            },
                            "label": "palyam (a011204, tabula.ini)"
                        }
                    }
                },
                "parameters": [
                    {
                        "name": "__IMTCONN__",
                        "type": "account:app#leonai-priority3",
                        "label": "Connection",
                        "required": true
                    }
                ],
                "expect": [
                    {
                        "name": "limit",
                        "type": "number",
                        "label": "Limit",
                        "required": true
                    },
                    {
                        "name": "skip",
                        "type": "number",
                        "label": "Skip"
                    },
                    {
                        "name": "form",
                        "type": "select",
                        "label": "Form",
                        "required": true
                    },
                    {
                        "name": "hevra",
                        "type": "text",
                        "label": "Company \\ Environment"
                    },
                    {
                        "name": "column",
                        "type": "filter",
                        "label": "Filters",
                        "options": {
                            "store": [
                                {
                                    "label": "מס' ספק",
                                    "value": "SUPNAME::text"
                                },
                                {
                                    "label": "שם ספק",
                                    "value": "SUPDES::text"
                                },
                                {
                                    "label": "תאריך",
                                    "value": "IVDATE::date"
                                },
                                {
                                    "label": "מס. פנימי",
                                    "value": "IVNUM::text"
                                },
                                {
                                    "label": "סופית",
                                    "value": "FINAL::text"
                                },
                                {
                                    "label": "מספר חשבונית",
                                    "value": "BOOKNUM::text"
                                },
                                {
                                    "label": "לשערך מחירים?",
                                    "value": "ADJPRICEFLAG::text"
                                },
                                {
                                    "label": "חיוב/זכוי",
                                    "value": "DEBIT::text"
                                },
                                {
                                    "label": "סטטוס",
                                    "value": "STATDES::text"
                                },
                                {
                                    "label": "לטיפול",
                                    "value": "OWNERLOGIN::text"
                                },
                                {
                                    "label": "תעודה",
                                    "value": "DOCNO::text"
                                },
                                {
                                    "label": "הזמנה",
                                    "value": "ORDNAME::text"
                                },
                                {
                                    "label": "הזמנת מסגרת",
                                    "value": "DEALNAME::text"
                                },
                                {
                                    "label": "פרויקט",
                                    "value": "PROJDOCNO::text"
                                },
                                {
                                    "label": "תאור פרויקט",
                                    "value": "PROJDES::text"
                                },
                                {
                                    "label": "ת. פרעון",
                                    "value": "PAYDATE::date"
                                },
                                {
                                    "label": "ת. למאזן",
                                    "value": "BALDATE::date"
                                },
                                {
                                    "label": "מקדמה?",
                                    "value": "ADVFLAG::text"
                                },
                                {
                                    "label": "סכום לפני הנחה",
                                    "value": "QPRICE::number"
                                },
                                {
                                    "label": "הנחה כללית",
                                    "value": "DISCOUNT::number"
                                },
                                {
                                    "label": "מחיר אחרי הנחה",
                                    "value": "DISPRICE::number"
                                },
                                {
                                    "label": "סכום מחושב",
                                    "value": "CALPRICE::number"
                                },
                                {
                                    "label": "הפרש במחיר",
                                    "value": "DIFF::number"
                                },
                                {
                                    "label": "מע\"מ",
                                    "value": "VAT::number"
                                },
                                {
                                    "label": "מס נוסף",
                                    "value": "TAXSUM::number"
                                },
                                {
                                    "label": "סה\"כ לתשלום",
                                    "value": "TOTPRICE::number"
                                },
                                {
                                    "label": "ניכוי מס במקור",
                                    "value": "WTAX::number"
                                },
                                {
                                    "label": "סכום אחרי ניכוי",
                                    "value": "AFTERWTAX::number"
                                },
                                {
                                    "label": "מטבע",
                                    "value": "CODE::text"
                                },
                                {
                                    "label": "סוג תיק יבוא/יצוא",
                                    "value": "OTYPE::text"
                                },
                                {
                                    "label": "תיק יבוא/יצוא",
                                    "value": "IMPFNUM::text"
                                },
                                {
                                    "label": "פרטים",
                                    "value": "DETAILS::text"
                                },
                                {
                                    "label": "כמות פריטים",
                                    "value": "TOTQUANT::number"
                                },
                                {
                                    "label": "מס. תנועת היומן",
                                    "value": "FNCNUM::text"
                                },
                                {
                                    "label": "מבוטל ?",
                                    "value": "STORNOFLAG::text"
                                },
                                {
                                    "label": "סניף",
                                    "value": "BRANCHNAME::text"
                                },
                                {
                                    "label": "נספחים?",
                                    "value": "EXTFILEFLAG::text"
                                },
                                {
                                    "label": "חשבונית פנימית ?",
                                    "value": "INTERNAL::text"
                                },
                                {
                                    "label": "הוקלד ע\"י",
                                    "value": "TYPEDBYLOGIN::text"
                                },
                                {
                                    "label": "תאריך הקלדה",
                                    "value": "TYPEDDATE::date"
                                },
                                {
                                    "label": "Black List ?",
                                    "value": "BLACKLISTFLAG::text"
                                },
                                {
                                    "label": "קוד רשימת מאשרים",
                                    "value": "CODENAME::text"
                                },
                                {
                                    "label": "תאור רשימה",
                                    "value": "CODEDES::text"
                                },
                                {
                                    "label": "החותם הבא",
                                    "value": "NEXTSIGNUSERLOGIN::text"
                                },
                                {
                                    "label": "מאושרת?",
                                    "value": "UFLAG::text"
                                },
                                {
                                    "label": "סכום החשבונית",
                                    "value": "TOTPRICE2::number"
                                },
                                {
                                    "label": "סכום התשלומים",
                                    "value": "CASHPAYMENT::number"
                                },
                                {
                                    "label": "הפרש תשלומים",
                                    "value": "DIFF2::number"
                                },
                                {
                                    "label": "שם קובץ לסריקה",
                                    "value": "SCAN_ATTACHFN::text"
                                },
                                {
                                    "label": "אישור חריגה?",
                                    "value": "SOXFLAG::text"
                                },
                                {
                                    "label": "משתמש מאשר חריגה",
                                    "value": "SOXUSERLOGIN::text"
                                },
                                {
                                    "label": "תאריך אישור חריגה",
                                    "value": "SOXUDATE::date"
                                },
                                {
                                    "label": "מזהה מובנה",
                                    "value": "UNIQUEID::text"
                                },
                                {
                                    "label": "מזהה רשויות המס",
                                    "value": "SDINUMIT::text"
                                },
                                {
                                    "label": "קוד רשימת מאשרים",
                                    "value": "ESHK_APPLISTCODE::text"
                                },
                                {
                                    "label": "תאור רשימה",
                                    "value": "ESHK_APPLISTCODEDES::text"
                                },
                                {
                                    "label": "מאשר הבא",
                                    "value": "ESHK_NEXTAPPROVE::text"
                                },
                                {
                                    "label": "מאושרת?",
                                    "value": "ESHK_UFLAG::text"
                                },
                                {
                                    "label": "נטו באתר",
                                    "value": "PRIT_SITENET::number"
                                },
                                {
                                    "label": "מע\"מ באתר",
                                    "value": "PRIT_SITEVAT::number"
                                },
                                {
                                    "label": "ברוטו באתר",
                                    "value": "PRIT_SITEGROSS::number"
                                },
                                {
                                    "label": "שם קובץ",
                                    "value": "PRIT_FILENAME::text"
                                },
                                {
                                    "label": "חשבונית (ID)",
                                    "value": "IV::number"
                                },
                                {
                                    "label": "סוג",
                                    "value": "IVTYPE::text"
                                }
                            ],
                            "operators": [
                                {
                                    "label": "Basic operators",
                                    "options": [
                                        {
                                            "label": "Exists",
                                            "value": "exist"
                                        },
                                        {
                                            "label": "Does not exist",
                                            "value": "notexist"
                                        }
                                    ]
                                },
                                {
                                    "label": "Text operators",
                                    "options": [
                                        {
                                            "label": "Equal to",
                                            "value": "eq"
                                        },
                                        {
                                            "label": "Not equal to",
                                            "value": "ne"
                                        },
                                        {
                                            "label": "Contains",
                                            "value": "contains"
                                        },
                                        {
                                            "label": "Does not Contain",
                                            "value": "notcontains"
                                        },
                                        {
                                            "label": "Start with",
                                            "value": "startwith"
                                        },
                                        {
                                            "label": "Does not start with",
                                            "value": "notstartwith"
                                        }
                                    ]
                                },
                                {
                                    "label": "Numbers operators",
                                    "options": [
                                        {
                                            "label": "Equal to",
                                            "value": "eq"
                                        },
                                        {
                                            "label": "Not equal to",
                                            "value": "ne"
                                        },
                                        {
                                            "label": "Greater than",
                                            "value": "gt"
                                        },
                                        {
                                            "label": "Less than",
                                            "value": "lt"
                                        },
                                        {
                                            "label": "Greater than or equal to",
                                            "value": "ge"
                                        },
                                        {
                                            "label": "Less than or equal to",
                                            "value": "le"
                                        }
                                    ]
                                },
                                {
                                    "label": "Datetime operators",
                                    "options": [
                                        {
                                            "label": "Equal to",
                                            "value": "eq"
                                        },
                                        {
                                            "label": "Not equal to",
                                            "value": "ne"
                                        },
                                        {
                                            "label": "Greater than",
                                            "value": "gt"
                                        },
                                        {
                                            "label": "Less than",
                                            "value": "lt"
                                        },
                                        {
                                            "label": "Greater than or equal to",
                                            "value": "ge"
                                        },
                                        {
                                            "label": "Less than or equal to",
                                            "value": "le"
                                        }
                                    ]
                                }
                            ]
                        }
                    },
                    {
                        "name": "orderby",
                        "type": "select",
                        "label": "Order by"
                    },
                    {
                        "name": "since",
                        "type": "text",
                        "label": "Modified Since"
                    },
                    {
                        "name": "selection",
                        "type": "select",
                        "label": "Get specified field\\s",
                        "multiple": true
                    },
                    {
                        "name": "subforms",
                        "spec": [
                            {
                                "name": "table",
                                "type": "select",
                                "label": "Sub-Form",
                                "dynamic": true,
                                "options": {
                                    "store": []
                                },
                                "required": true
                            }
                        ],
                        "type": "array",
                        "label": "Sub-Forms Expend"
                    },
                    {
                        "name": "sort",
                        "type": "select",
                        "label": "Sort order",
                        "required": true,
                        "validate": {
                            "enum": [
                                "asc",
                                "desc"
                            ]
                        }
                    }
                ],
                "interface": [
                    {
                        "name": "__IMTLENGTH__",
                        "type": "uinteger",
                        "label": "Total number of bundles"
                    },
                    {
                        "name": "__IMTINDEX__",
                        "type": "uinteger",
                        "label": "Bundle order position"
                    },
                    {
                        "name": "SUPNAME",
                        "type": "text",
                        "label": "‫מס' ספק‬"
                    },
                    {
                        "name": "SUPDES",
                        "type": "text",
                        "label": "‫שם ספק‬"
                    },
                    {
                        "name": "IVDATE",
                        "type": "date",
                        "label": "‫תאריך‬"
                    },
                    {
                        "name": "IVNUM",
                        "type": "text",
                        "label": "‫מס. פנימי‬"
                    },
                    {
                        "name": "FINAL",
                        "type": "text",
                        "label": "‫סופית‬"
                    },
                    {
                        "name": "BOOKNUM",
                        "type": "text",
                        "label": "‫מספר חשבונית‬"
                    },
                    {
                        "name": "ADJPRICEFLAG",
                        "type": "text",
                        "label": "‫לשערך מחירים?‬"
                    },
                    {
                        "name": "DEBIT",
                        "type": "text",
                        "label": "‫חיוב/זכוי‬"
                    },
                    {
                        "name": "STATDES",
                        "type": "text",
                        "label": "‫סטטוס‬"
                    },
                    {
                        "name": "OWNERLOGIN",
                        "type": "text",
                        "label": "‫לטיפול‬"
                    },
                    {
                        "name": "DOCNO",
                        "type": "text",
                        "label": "‫תעודה‬"
                    },
                    {
                        "name": "ORDNAME",
                        "type": "text",
                        "label": "‫הזמנה‬"
                    },
                    {
                        "name": "DEALNAME",
                        "type": "text",
                        "label": "‫הזמנת מסגרת‬"
                    },
                    {
                        "name": "PROJDOCNO",
                        "type": "text",
                        "label": "‫פרויקט‬"
                    },
                    {
                        "name": "PROJDES",
                        "type": "text",
                        "label": "‫תאור פרויקט‬"
                    },
                    {
                        "name": "PAYDATE",
                        "type": "date",
                        "label": "‫ת. פרעון‬"
                    },
                    {
                        "name": "BALDATE",
                        "type": "date",
                        "label": "‫ת. למאזן‬"
                    },
                    {
                        "name": "ADVFLAG",
                        "type": "text",
                        "label": "‫מקדמה?‬"
                    },
                    {
                        "name": "QPRICE",
                        "type": "number",
                        "label": "‫סכום לפני הנחה‬"
                    },
                    {
                        "name": "DISCOUNT",
                        "type": "number",
                        "label": "‫הנחה כללית‬"
                    },
                    {
                        "name": "DISPRICE",
                        "type": "number",
                        "label": "‫מחיר אחרי הנחה‬"
                    },
                    {
                        "name": "CALPRICE",
                        "type": "number",
                        "label": "‫סכום מחושב‬"
                    },
                    {
                        "name": "DIFF",
                        "type": "number",
                        "label": "‫הפרש במחיר‬"
                    },
                    {
                        "name": "VAT",
                        "type": "number",
                        "label": "‫מע\"מ‬"
                    },
                    {
                        "name": "TAXSUM",
                        "type": "number",
                        "label": "‫מס נוסף‬"
                    },
                    {
                        "name": "TOTPRICE",
                        "type": "number",
                        "label": "‫סה\"כ לתשלום‬"
                    },
                    {
                        "name": "WTAX",
                        "type": "number",
                        "label": "‫ניכוי מס במקור‬"
                    },
                    {
                        "name": "AFTERWTAX",
                        "type": "number",
                        "label": "‫סכום אחרי ניכוי‬"
                    },
                    {
                        "name": "CODE",
                        "type": "text",
                        "label": "‫מטבע‬"
                    },
                    {
                        "name": "OTYPE",
                        "type": "text",
                        "label": "‫סוג תיק יבוא/יצוא‬"
                    },
                    {
                        "name": "IMPFNUM",
                        "type": "text",
                        "label": "‫תיק יבוא/יצוא‬"
                    },
                    {
                        "name": "DETAILS",
                        "type": "text",
                        "label": "‫פרטים‬"
                    },
                    {
                        "name": "TOTQUANT",
                        "type": "number",
                        "label": "‫כמות פריטים‬"
                    },
                    {
                        "name": "FNCNUM",
                        "type": "text",
                        "label": "‫מס. תנועת היומן‬"
                    },
                    {
                        "name": "STORNOFLAG",
                        "type": "text",
                        "label": "‫מבוטל ?‬"
                    },
                    {
                        "name": "BRANCHNAME",
                        "type": "text",
                        "label": "‫סניף‬"
                    },
                    {
                        "name": "EXTFILEFLAG",
                        "type": "text",
                        "label": "‫נספחים?‬"
                    },
                    {
                        "name": "INTERNAL",
                        "type": "text",
                        "label": "‫חשבונית פנימית ?‬"
                    },
                    {
                        "name": "TYPEDBYLOGIN",
                        "type": "text",
                        "label": "‫הוקלד ע\"י‬"
                    },
                    {
                        "name": "TYPEDDATE",
                        "type": "date",
                        "label": "‫תאריך הקלדה‬"
                    },
                    {
                        "name": "BLACKLISTFLAG",
                        "type": "text",
                        "label": "Black List ?"
                    },
                    {
                        "name": "CODENAME",
                        "type": "text",
                        "label": "‫קוד רשימת מאשרים‬"
                    },
                    {
                        "name": "CODEDES",
                        "type": "text",
                        "label": "‫תאור רשימה‬"
                    },
                    {
                        "name": "NEXTSIGNUSERLOGIN",
                        "type": "text",
                        "label": "‫החותם הבא‬"
                    },
                    {
                        "name": "UFLAG",
                        "type": "text",
                        "label": "‫מאושרת?‬"
                    },
                    {
                        "name": "TOTPRICE2",
                        "type": "number",
                        "label": "‫סכום החשבונית‬"
                    },
                    {
                        "name": "CASHPAYMENT",
                        "type": "number",
                        "label": "‫סכום התשלומים‬"
                    },
                    {
                        "name": "DIFF2",
                        "type": "number",
                        "label": "‫הפרש תשלומים‬"
                    },
                    {
                        "name": "SCAN_ATTACHFN",
                        "type": "text",
                        "label": "‫שם קובץ לסריקה‬"
                    },
                    {
                        "name": "SOXFLAG",
                        "type": "text",
                        "label": "‫אישור חריגה?‬"
                    },
                    {
                        "name": "SOXUSERLOGIN",
                        "type": "text",
                        "label": "‫משתמש מאשר חריגה‬"
                    },
                    {
                        "name": "SOXUDATE",
                        "type": "date",
                        "label": "‫תאריך אישור חריגה‬"
                    },
                    {
                        "name": "UNIQUEID",
                        "type": "text",
                        "label": "‫מזהה מובנה‬"
                    },
                    {
                        "name": "SDINUMIT",
                        "type": "text",
                        "label": "‫מזהה רשויות המס‬"
                    },
                    {
                        "name": "ESHK_APPLISTCODE",
                        "type": "text",
                        "label": "‫קוד רשימת מאשרים‬"
                    },
                    {
                        "name": "ESHK_APPLISTCODEDES",
                        "type": "text",
                        "label": "‫תאור רשימה‬"
                    },
                    {
                        "name": "ESHK_NEXTAPPROVE",
                        "type": "text",
                        "label": "‫מאשר הבא‬"
                    },
                    {
                        "name": "ESHK_UFLAG",
                        "type": "text",
                        "label": "‫מאושרת?‬"
                    },
                    {
                        "name": "PRIT_SITENET",
                        "type": "number",
                        "label": "‫נטו באתר‬"
                    },
                    {
                        "name": "PRIT_SITEVAT",
                        "type": "number",
                        "label": "‫מע\"מ באתר‬"
                    },
                    {
                        "name": "PRIT_SITEGROSS",
                        "type": "number",
                        "label": "‫ברוטו באתר‬"
                    },
                    {
                        "name": "PRIT_FILENAME",
                        "type": "text",
                        "label": "‫שם קובץ‬"
                    },
                    {
                        "name": "IV",
                        "type": "number",
                        "label": "‫חשבונית (ID)‬"
                    },
                    {
                        "name": "IVTYPE",
                        "type": "text",
                        "label": "‫סוג‬"
                    },
                    {
                        "name": "PINVOICESCONT_SUBFORM",
                        "spec": {
                            "spec": [
                                {
                                    "name": "ADRS",
                                    "type": "text",
                                    "label": "‫כתובת‬"
                                },
                                {
                                    "name": "ADRS2",
                                    "type": "text",
                                    "label": "‫כתובת - שורה 2‬"
                                },
                                {
                                    "name": "ADRS3",
                                    "type": "text",
                                    "label": "‫כתובת - שורה 3‬"
                                },
                                {
                                    "name": "STATEA",
                                    "type": "text",
                                    "label": "‫עיר‬"
                                },
                                {
                                    "name": "STATENAME",
                                    "type": "text",
                                    "label": "‫מדינה‬"
                                },
                                {
                                    "name": "STATE",
                                    "type": "text",
                                    "label": "‫עיר ומדינה‬"
                                },
                                {
                                    "name": "COUNTRYNAME",
                                    "type": "text",
                                    "label": "‫ארץ‬"
                                },
                                {
                                    "name": "ZIP",
                                    "type": "text",
                                    "label": "‫מיקוד‬"
                                },
                                {
                                    "name": "PHONE",
                                    "type": "text",
                                    "label": "‫טלפון‬"
                                },
                                {
                                    "name": "FAX",
                                    "type": "text",
                                    "label": "‫פקס‬"
                                },
                                {
                                    "name": "EMAIL",
                                    "type": "text",
                                    "label": "‫דואר אלקטרוני‬"
                                },
                                {
                                    "name": "PAYCODE",
                                    "type": "text",
                                    "label": "‫קוד תנאי תשלום‬"
                                },
                                {
                                    "name": "PAYDES",
                                    "type": "text",
                                    "label": "‫תנאי תשלום‬"
                                },
                                {
                                    "name": "FNCPATNAME",
                                    "type": "text",
                                    "label": "‫סוג תנועה‬"
                                },
                                {
                                    "name": "FNCPATDES2",
                                    "type": "text",
                                    "label": "‫סוג תנועה-תאור מלא‬"
                                },
                                {
                                    "name": "TAXCODE",
                                    "type": "text",
                                    "label": "‫קוד מע\"מ‬"
                                },
                                {
                                    "name": "LCODE",
                                    "type": "text",
                                    "label": "‫מטבע הצמדה/המרה‬"
                                },
                                {
                                    "name": "LEXCH",
                                    "type": "number",
                                    "label": "‫שער הצמדה/המרה‬"
                                },
                                {
                                    "name": "ACC_CODE",
                                    "type": "text",
                                    "label": "‫מטבע הספק‬"
                                },
                                {
                                    "name": "ACC_EXCH",
                                    "type": "number",
                                    "label": "‫שער המרה - מטבע ספק‬"
                                },
                                {
                                    "name": "PIVCODE",
                                    "type": "text",
                                    "label": "‫קוד חשבונית קודמת‬"
                                },
                                {
                                    "name": "PIVNUM",
                                    "type": "text",
                                    "label": "‫חשבונית קודמת‬"
                                },
                                {
                                    "name": "LIVCODE",
                                    "type": "text",
                                    "label": "‫קוד חשבונית מועמסת‬"
                                },
                                {
                                    "name": "LIVNUM",
                                    "type": "text",
                                    "label": "‫חשבונית מועמסת‬"
                                },
                                {
                                    "name": "STCODE",
                                    "type": "text",
                                    "label": "‫קוד משלוח‬"
                                },
                                {
                                    "name": "IMPTERMNAME",
                                    "type": "text",
                                    "label": "‫תנאי שילוח‬"
                                },
                                {
                                    "name": "ORIGCOUNTRYNAME",
                                    "type": "text",
                                    "label": "‫ארץ מוצא‬"
                                },
                                {
                                    "name": "SENDCOUNTRYNAME",
                                    "type": "text",
                                    "label": "‫ארץ משלוח‬"
                                },
                                {
                                    "name": "TRANSTYPE1",
                                    "type": "text",
                                    "label": "‫סוג משלוח INTRASTAT‬"
                                },
                                {
                                    "name": "TRANSTYPE2",
                                    "type": "text",
                                    "label": "‫ס. משלוח 2-INTRASTAT‬"
                                },
                                {
                                    "name": "INTRASTATDATE",
                                    "type": "date",
                                    "label": "‫תאריך הצהרה‬"
                                },
                                {
                                    "name": "IVREF",
                                    "type": "text",
                                    "label": "‫תיק במע\"מ/הצהרת יבוא‬"
                                },
                                {
                                    "name": "ACCNAME",
                                    "type": "text",
                                    "label": "‫חשבון ספק לזיכוי‬"
                                },
                                {
                                    "name": "IVCOUNT",
                                    "type": "number",
                                    "label": "‫מונה חשבוניות‬"
                                },
                                {
                                    "name": "VATTYPE",
                                    "type": "text",
                                    "label": "‫סוג רשומה למע\"מ‬"
                                },
                                {
                                    "name": "USERLOGIN",
                                    "type": "text",
                                    "label": "‫חתימה‬"
                                },
                                {
                                    "name": "UDATE",
                                    "type": "date",
                                    "label": "‫ת. חתימה‬"
                                },
                                {
                                    "name": "ACTDATE",
                                    "type": "date",
                                    "label": "‫ת. פעילות‬"
                                },
                                {
                                    "name": "CASHNAME",
                                    "type": "text",
                                    "label": "‫שולם בכרטיס אשראי‬"
                                },
                                {
                                    "name": "CASHDES",
                                    "type": "text",
                                    "label": "‫שם כרטיס אשראי‬"
                                },
                                {
                                    "name": "FIRSTPAY",
                                    "type": "number",
                                    "label": "‫סכום תשלום ראשון‬"
                                },
                                {
                                    "name": "OTHERPAYMENTS",
                                    "type": "number",
                                    "label": "‫סכום כל תשלום נוסף‬"
                                },
                                {
                                    "name": "TRANSMEANCODE",
                                    "type": "text",
                                    "label": "‫קוד אמצעי שינוע‬"
                                },
                                {
                                    "name": "TRANSMEANDES",
                                    "type": "text",
                                    "label": "‫תאור אמצעי שינוע‬"
                                },
                                {
                                    "name": "FEPROTOCOL",
                                    "type": "text",
                                    "label": "‫פרוטוקול יצואן תדיר‬"
                                },
                                {
                                    "name": "FEPROTOCOLDATE",
                                    "type": "date",
                                    "label": "‫תאריך פרוטוקול‬"
                                },
                                {
                                    "name": "PROTOCOLNUM",
                                    "type": "text",
                                    "label": "‫מספר פרוטוקול‬"
                                },
                                {
                                    "name": "SDINUMIT",
                                    "type": "text",
                                    "label": "‫מזהה רשויות המס‬"
                                },
                                {
                                    "name": "DEBIT",
                                    "type": "text",
                                    "label": "‫חיוב/זכוי‬"
                                },
                                {
                                    "name": "IVNUM",
                                    "type": "text",
                                    "label": "‫חשבונית‬"
                                }
                            ],
                            "type": "collection"
                        },
                        "type": "array",
                        "label": "‫חשבונית - פרטים נוספים‬"
                    },
                    {
                        "name": "PIVDOC_SUBFORM",
                        "spec": {
                            "spec": [
                                {
                                    "name": "DOCNO",
                                    "type": "text",
                                    "label": "‫תעודה‬"
                                },
                                {
                                    "name": "BOOKNUM",
                                    "type": "text",
                                    "label": "‫תעודת משלוח - ספק‬"
                                },
                                {
                                    "name": "CURDATE",
                                    "type": "date",
                                    "label": "‫תאריך‬"
                                },
                                {
                                    "name": "SUPNAME",
                                    "type": "text",
                                    "label": "‫מס' ספק‬"
                                },
                                {
                                    "name": "DOC",
                                    "type": "number",
                                    "label": "‫תעודה (ID)‬"
                                }
                            ],
                            "type": "collection"
                        },
                        "type": "array",
                        "label": "‫תעודות קבלה לחשבונית‬"
                    },
                    {
                        "name": "PINVOICEITEMS_SUBFORM",
                        "spec": {
                            "spec": [
                                {
                                    "name": "PARTNAME",
                                    "type": "text",
                                    "label": "‫מק\"ט‬"
                                },
                                {
                                    "name": "PDES",
                                    "type": "text",
                                    "label": "‫תאור מוצר‬"
                                },
                                {
                                    "name": "TQUANT",
                                    "type": "number",
                                    "label": "‫כמות בחשבונית‬"
                                },
                                {
                                    "name": "CALTQUANT",
                                    "type": "number",
                                    "label": "‫כמות שהתקבלה‬"
                                },
                                {
                                    "name": "TUNITNAME",
                                    "type": "text",
                                    "label": "‫יח'‬"
                                },
                                {
                                    "name": "QUANT",
                                    "type": "number",
                                    "label": "‫כמות מפעל‬"
                                },
                                {
                                    "name": "UNITNAME",
                                    "type": "text",
                                    "label": "‫יח' מפעל‬"
                                },
                                {
                                    "name": "PRICE",
                                    "type": "number",
                                    "label": "‫מחיר ליחידה‬"
                                },
                                {
                                    "name": "ICODE",
                                    "type": "text",
                                    "label": "‫מטבע שורה‬"
                                },
                                {
                                    "name": "PRSOURCENAME",
                                    "type": "text",
                                    "label": "‫מקור מחיר‬"
                                },
                                {
                                    "name": "CALPRICE",
                                    "type": "number",
                                    "label": "‫מחיר בהזמנה‬"
                                },
                                {
                                    "name": "PERCENT",
                                    "type": "number",
                                    "label": "‫הנחה לשורה(%)‬"
                                },
                                {
                                    "name": "ORDIPERCENT",
                                    "type": "number",
                                    "label": "‫הנחה בהזמנה (%)‬"
                                },
                                {
                                    "name": "QPRICE",
                                    "type": "number",
                                    "label": "‫סה\"כ מחיר‬"
                                },
                                {
                                    "name": "CALQPRICE",
                                    "type": "number",
                                    "label": "‫סה\"כ מחיר מחושב‬"
                                },
                                {
                                    "name": "TOTPRICE",
                                    "type": "number",
                                    "label": "‫סה\"כ כולל מע\"מ‬"
                                },
                                {
                                    "name": "CODE",
                                    "type": "text",
                                    "label": "‫מטבע חשבונית‬"
                                },
                                {
                                    "name": "TOTPERCENT",
                                    "type": "number",
                                    "label": "‫הנחה כללית (%)‬"
                                },
                                {
                                    "name": "CALTOTPERCENT",
                                    "type": "number",
                                    "label": "‫הנחה כללית בהזמנה(%)‬"
                                },
                                {
                                    "name": "ORDNAME",
                                    "type": "text",
                                    "label": "‫הזמנה‬"
                                },
                                {
                                    "name": "DOCNO",
                                    "type": "text",
                                    "label": "‫תעודה‬"
                                },
                                {
                                    "name": "VATFLAG",
                                    "type": "text",
                                    "label": "‫מע\"מ?‬"
                                },
                                {
                                    "name": "SPECIALVATFLAG",
                                    "type": "text",
                                    "label": "‫מע\"מ חריג?‬"
                                },
                                {
                                    "name": "SUPPARTNAME",
                                    "type": "text",
                                    "label": "‫מק\"ט ספק/יצרן‬"
                                },
                                {
                                    "name": "REVNAME",
                                    "type": "text",
                                    "label": "‫מהדורת מוצר‬"
                                },
                                {
                                    "name": "BARCODE",
                                    "type": "text",
                                    "label": "‫ברקוד‬"
                                },
                                {
                                    "name": "BUDCODE",
                                    "type": "text",
                                    "label": "‫סעיף תקציבי‬"
                                },
                                {
                                    "name": "BUDGETDATE",
                                    "type": "date",
                                    "label": "‫תאריך ניצול תקציב‬"
                                },
                                {
                                    "name": "COSTCNAME",
                                    "type": "text",
                                    "label": "‫מרכז רווח/עלות‬"
                                },
                                {
                                    "name": "COSTCNAME2",
                                    "type": "text",
                                    "label": "‫מרכז רווח/עלות 2‬"
                                },
                                {
                                    "name": "COSTCNAME3",
                                    "type": "text",
                                    "label": "‫מרכז רווח/עלות 3‬"
                                },
                                {
                                    "name": "COSTCNAME4",
                                    "type": "text",
                                    "label": "‫מרכז רווח/עלות 4‬"
                                },
                                {
                                    "name": "COSTCNAME5",
                                    "type": "text",
                                    "label": "‫מרכז רווח/עלות 5‬"
                                },
                                {
                                    "name": "ACCNAME",
                                    "type": "text",
                                    "label": "‫חשבון הוצאות‬"
                                },
                                {
                                    "name": "ACCDES",
                                    "type": "text",
                                    "label": "‫תאור חשבון‬"
                                },
                                {
                                    "name": "EXCH",
                                    "type": "number",
                                    "label": "‫שער חליפין‬"
                                },
                                {
                                    "name": "CREDITFLAG",
                                    "type": "text",
                                    "label": "‫זיכוי כספי בלבד?‬"
                                },
                                {
                                    "name": "FROMDATE",
                                    "type": "date",
                                    "label": "‫מתאריך הוצאה‬"
                                },
                                {
                                    "name": "TODATE",
                                    "type": "date",
                                    "label": "‫עד תאריך הוצאה‬"
                                },
                                {
                                    "name": "PDACCNAME",
                                    "type": "text",
                                    "label": "‫חשבון יעד להוצאות‬"
                                },
                                {
                                    "name": "FNCICODE",
                                    "type": "text",
                                    "label": "‫קוד מיון שורת פ\"י‬"
                                },
                                {
                                    "name": "FNCIDES",
                                    "type": "text",
                                    "label": "‫תאור מיון שורת פ\"י‬"
                                },
                                {
                                    "name": "RCTAXCODE",
                                    "type": "text",
                                    "label": "Reverse Charge VAT"
                                },
                                {
                                    "name": "TAXCODE",
                                    "type": "text",
                                    "label": "‫קוד ניכוי מס‬"
                                },
                                {
                                    "name": "TAXCODE3",
                                    "type": "text",
                                    "label": "‫קוד ניכוי מס 3‬"
                                },
                                {
                                    "name": "CUSTOMSNUM",
                                    "type": "text",
                                    "label": "‫הצהרת יבוא‬"
                                },
                                {
                                    "name": "CUSTOMSDATE",
                                    "type": "date",
                                    "label": "‫תאריך הצהרה‬"
                                },
                                {
                                    "name": "USERLOGIN",
                                    "type": "text",
                                    "label": "‫חתימה‬"
                                },
                                {
                                    "name": "UDATE",
                                    "type": "date",
                                    "label": "‫ת. חתימה‬"
                                },
                                {
                                    "name": "PRIT_SITEQUANTLINE",
                                    "type": "number",
                                    "label": "‫כמות לשורה באתר‬"
                                },
                                {
                                    "name": "PRIT_SITETOTPRICLINE",
                                    "type": "number",
                                    "label": "‫סה\"כ מחיר לשורה באתר‬"
                                },
                                {
                                    "name": "KLINE",
                                    "type": "number",
                                    "label": "‫שורה (מפתח)‬"
                                }
                            ],
                            "type": "collection"
                        },
                        "type": "array",
                        "label": "‫חשבוניות ספק מרכזות - פירוט‬"
                    },
                    {
                        "name": "EXTFILES_SUBFORM",
                        "spec": {
                            "spec": [
                                {
                                    "name": "EXTFILEDES",
                                    "type": "text",
                                    "label": "‫שם קובץ‬"
                                },
                                {
                                    "name": "EXTFILENUM",
                                    "type": "number",
                                    "label": "‫מספר מסמך‬"
                                },
                                {
                                    "name": "EXTFILENAME",
                                    "type": "text",
                                    "label": "‫נתיב הקובץ‬"
                                },
                                {
                                    "name": "SUFFIX",
                                    "type": "text",
                                    "label": "‫סיומת‬"
                                },
                                {
                                    "name": "CURDATE",
                                    "type": "date",
                                    "label": "‫תאריך יצירת המסמך‬"
                                },
                                {
                                    "name": "NOSEND",
                                    "type": "text",
                                    "label": "‫לא לשלוח‬"
                                },
                                {
                                    "name": "STATUS",
                                    "type": "text",
                                    "label": "‫סטטוס‬"
                                },
                                {
                                    "name": "FILESIZE",
                                    "type": "number",
                                    "label": "‫גודל קובץ בבתים‬"
                                },
                                {
                                    "name": "EI_COND",
                                    "type": "text",
                                    "label": "‫משלוח בממשק אלקטרוני‬"
                                },
                                {
                                    "name": "USERLOGIN",
                                    "type": "text",
                                    "label": "‫עודכן ע\"י‬"
                                },
                                {
                                    "name": "UDATE",
                                    "type": "date",
                                    "label": "‫ת. עדכון אחרון‬"
                                },
                                {
                                    "name": "LUSERLOGIN",
                                    "type": "text",
                                    "label": "‫נעול ע\"י‬"
                                },
                                {
                                    "name": "SCAN_PRIORISCAN",
                                    "type": "text",
                                    "label": "‫פריורי סקאן‬"
                                },
                                {
                                    "name": "NGV_SIGNATURE2",
                                    "type": "text",
                                    "label": "‫חתימה?‬"
                                },
                                {
                                    "name": "NGV_ADDRESS",
                                    "type": "text",
                                    "label": "‫כתובת (נייד)‬"
                                },
                                {
                                    "name": "NGV_LATITUDE",
                                    "type": "number",
                                    "label": "‫קו רוחב (נייד)‬"
                                },
                                {
                                    "name": "NGV_LONGITUDE",
                                    "type": "number",
                                    "label": "‫קו אורך (נייד)‬"
                                },
                                {
                                    "name": "SCAN_APIUSERLOGIN",
                                    "type": "text",
                                    "label": "‫שם מייבא הנספח‬"
                                },
                                {
                                    "name": "SCAN_UDATEAPI",
                                    "type": "date",
                                    "label": "‫ת. יבוא הנספח‬"
                                }
                            ],
                            "type": "collection"
                        },
                        "type": "array",
                        "label": "‫נספחים‬"
                    },
                    {
                        "name": "INTERNALDIALOGTEXT_SUBFORM",
                        "spec": {
                            "spec": [
                                {
                                    "name": "TEXT",
                                    "type": "text",
                                    "label": ""
                                },
                                {
                                    "name": "APPEND",
                                    "type": "boolean",
                                    "label": ""
                                },
                                {
                                    "name": "SIGNATURE",
                                    "type": "boolean",
                                    "label": ""
                                }
                            ],
                            "type": "collection"
                        },
                        "type": "array",
                        "label": "‫דו שיח פנימי‬"
                    }
                ]
            }
        },
        {
            "id": 56,
            "module": "json:AggregateToJSON",
            "version": 1,
            "parameters": {
                "type": 471896,
                "space": "",
                "feeder": 1
            },
            "mapper": {
                "IV": "{{1.IV}}",
                "VAT": "{{1.VAT}}",
                "CODE": "{{1.CODE}}",
                "DIFF": "{{1.DIFF}}",
                "WTAX": "",
                "DEBIT": "{{1.DEBIT}}",
                "DIFF2": "",
                "DOCNO": "{{1.DOCNO}}",
                "FINAL": "{{1.FINAL}}",
                "IVNUM": "{{1.IVNUM}}",
                "OTYPE": "",
                "UFLAG": "{{1.UFLAG}}",
                "FNCNUM": "{{1.FNCNUM}}",
                "IVDATE": "{{1.IVDATE}}",
                "IVTYPE": "{{1.IVTYPE}}",
                "QPRICE": "{{1.QPRICE}}",
                "SUPDES": "{{1.SUPDES}}",
                "TAXSUM": "",
                "ADVFLAG": "{{1.ADVFLAG}}",
                "BALDATE": "{{1.BALDATE}}",
                "BOOKNUM": "{{1.BOOKNUM}}",
                "CODEDES": "",
                "DETAILS": "{{1.DETAILS}}",
                "IMPFNUM": "{{1.IMPFNUM}}",
                "ORDNAME": "{{1.ORDNAME}}",
                "PAYDATE": "{{1.PAYDATE}}",
                "PROJDES": "{{1.PROJDES}}",
                "SOXFLAG": "",
                "STATDES": "{{1.STATDES}}",
                "SUPNAME": "{{1.SUPNAME}}",
                "CALPRICE": "{{1.CALPRICE}}",
                "CODENAME": "",
                "DEALNAME": "{{1.DEALNAME}}",
                "DISCOUNT": "{{1.DISCOUNT}}",
                "DISPRICE": "{{1.DISPRICE}}",
                "INTERNAL": "",
                "SDINUMIT": "",
                "SOXUDATE": "",
                "TOTPRICE": "{{1.TOTPRICE}}",
                "TOTQUANT": "{{1.TOTQUANT}}",
                "UNIQUEID": "",
                "AFTERWTAX": "",
                "PROJDOCNO": "{{1.PROJDOCNO}}",
                "TOTPRICE2": "",
                "TYPEDDATE": "{{1.TYPEDDATE}}",
                "BRANCHNAME": "{{1.BRANCHNAME}}",
                "ESHK_UFLAG": "",
                "OWNERLOGIN": "{{1.OWNERLOGIN}}",
                "STORNOFLAG": "{{1.STORNOFLAG}}",
                "CASHPAYMENT": "",
                "EXTFILEFLAG": "{{1.EXTFILEFLAG}}",
                "ADJPRICEFLAG": "",
                "PRIT_SITENET": "",
                "PRIT_SITEVAT": "",
                "SOXUSERLOGIN": "",
                "TYPEDBYLOGIN": "{{1.TYPEDBYLOGIN}}",
                "__IMTINDEX__": "",
                "BLACKLISTFLAG": "",
                "PRIT_FILENAME": "",
                "SCAN_ATTACHFN": "",
                "__IMTLENGTH__": "",
                "PIVDOC_SUBFORM": "{{1.PIVDOC_SUBFORM}}",
                "PRIT_SITEGROSS": "",
                "ESHK_APPLISTCODE": "",
                "ESHK_NEXTAPPROVE": "",
                "NEXTSIGNUSERLOGIN": "",
                "ESHK_APPLISTCODEDES": "",
                "PINVOICEITEMS_SUBFORM": "{{1.PINVOICEITEMS_SUBFORM}}",
                "PINVOICESCONT_SUBFORM": "{{1.PINVOICESCONT_SUBFORM}}",
                "INTERNALDIALOGTEXT_SUBFORM": "{{1.INTERNALDIALOGTEXT_SUBFORM[].TEXT}}"
            },
            "metadata": {
                "designer": {
                    "x": 300,
                    "y": 0
                },
                "restore": {
                    "extra": {
                        "feeder": {
                            "label": "LeonAI Priority ERP - Get Items Of Selected Form (advanced) [1]"
                        }
                    },
                    "expect": {
                        "PIVDOC_SUBFORM": {
                            "mode": "edit"
                        },
                        "PINVOICEITEMS_SUBFORM": {
                            "mode": "edit"
                        },
                        "PINVOICESCONT_SUBFORM": {
                            "mode": "edit"
                        }
                    },
                    "parameters": {
                        "type": {
                            "label": "PINVOICES_SHEMA_ALL"
                        },
                        "space": {
                            "label": "Empty"
                        }
                    }
                },
                "parameters": [
                    {
                        "name": "type",
                        "type": "udt",
                        "label": "Data structure",
                        "required": true
                    },
                    {
                        "name": "space",
                        "type": "select",
                        "label": "Indentation",
                        "validate": {
                            "enum": [
                                "tab",
                                "2",
                                "4"
                            ]
                        }
                    }
                ],
                "expect": [
                    {
                        "name": "SUPNAME",
                        "type": "text",
                        "label": "Supname"
                    },
                    {
                        "name": "SUPDES",
                        "type": "text",
                        "label": "Supdes"
                    },
                    {
                        "name": "IVDATE",
                        "type": "text",
                        "label": "Ivdate"
                    },
                    {
                        "name": "IVNUM",
                        "type": "text",
                        "label": "Ivnum"
                    },
                    {
                        "name": "FINAL",
                        "type": "text",
                        "label": "Final"
                    },
                    {
                        "name": "BOOKNUM",
                        "type": "text",
                        "label": "Booknum"
                    },
                    {
                        "name": "ADJPRICEFLAG",
                        "type": "text",
                        "label": "Adjpriceflag"
                    },
                    {
                        "name": "DEBIT",
                        "type": "text",
                        "label": "Debit"
                    },
                    {
                        "name": "STATDES",
                        "type": "text",
                        "label": "Statdes"
                    },
                    {
                        "name": "OWNERLOGIN",
                        "type": "text",
                        "label": "Ownerlogin"
                    },
                    {
                        "name": "DOCNO",
                        "type": "text",
                        "label": "Docno"
                    },
                    {
                        "name": "ORDNAME",
                        "type": "text",
                        "label": "Ordname"
                    },
                    {
                        "name": "DEALNAME",
                        "type": "text",
                        "label": "Dealname"
                    },
                    {
                        "name": "PROJDOCNO",
                        "type": "text",
                        "label": "Projdocno"
                    },
                    {
                        "name": "PROJDES",
                        "type": "text",
                        "label": "Projdes"
                    },
                    {
                        "name": "PAYDATE",
                        "type": "text",
                        "label": "Paydate"
                    },
                    {
                        "name": "BALDATE",
                        "type": "text",
                        "label": "Baldate"
                    },
                    {
                        "name": "ADVFLAG",
                        "type": "text",
                        "label": "Advflag"
                    },
                    {
                        "name": "QPRICE",
                        "type": "number",
                        "label": "Qprice"
                    },
                    {
                        "name": "DISCOUNT",
                        "type": "number",
                        "label": "Discount"
                    },
                    {
                        "name": "DISPRICE",
                        "type": "number",
                        "label": "Disprice"
                    },
                    {
                        "name": "CALPRICE",
                        "type": "number",
                        "label": "Calprice"
                    },
                    {
                        "name": "DIFF",
                        "type": "number",
                        "label": "Diff"
                    },
                    {
                        "name": "VAT",
                        "type": "number",
                        "label": "Vat"
                    },
                    {
                        "name": "TAXSUM",
                        "type": "number",
                        "label": "Taxsum"
                    },
                    {
                        "name": "TOTPRICE",
                        "type": "number",
                        "label": "Totprice"
                    },
                    {
                        "name": "WTAX",
                        "type": "number",
                        "label": "Wtax"
                    },
                    {
                        "name": "AFTERWTAX",
                        "type": "number",
                        "label": "Afterwtax"
                    },
                    {
                        "name": "CODE",
                        "type": "text",
                        "label": "Code"
                    },
                    {
                        "name": "OTYPE",
                        "type": "text",
                        "label": "Otype"
                    },
                    {
                        "name": "IMPFNUM",
                        "type": "text",
                        "label": "Impfnum"
                    },
                    {
                        "name": "DETAILS",
                        "type": "text",
                        "label": "Details"
                    },
                    {
                        "name": "TOTQUANT",
                        "type": "number",
                        "label": "Totquant"
                    },
                    {
                        "name": "FNCNUM",
                        "type": "text",
                        "label": "Fncnum"
                    },
                    {
                        "name": "STORNOFLAG",
                        "type": "text",
                        "label": "Stornoflag"
                    },
                    {
                        "name": "BRANCHNAME",
                        "type": "text",
                        "label": "Branchname"
                    },
                    {
                        "name": "EXTFILEFLAG",
                        "type": "text",
                        "label": "Extfileflag"
                    },
                    {
                        "name": "INTERNAL",
                        "type": "text",
                        "label": "Internal"
                    },
                    {
                        "name": "TYPEDBYLOGIN",
                        "type": "text",
                        "label": "Typedbylogin"
                    },
                    {
                        "name": "TYPEDDATE",
                        "type": "text",
                        "label": "Typeddate"
                    },
                    {
                        "name": "BLACKLISTFLAG",
                        "type": "text",
                        "label": "Blacklistflag"
                    },
                    {
                        "name": "CODENAME",
                        "type": "text",
                        "label": "Codename"
                    },
                    {
                        "name": "CODEDES",
                        "type": "text",
                        "label": "Codedes"
                    },
                    {
                        "name": "NEXTSIGNUSERLOGIN",
                        "type": "text",
                        "label": "Nextsignuserlogin"
                    },
                    {
                        "name": "UFLAG",
                        "type": "text",
                        "label": "Uflag"
                    },
                    {
                        "name": "TOTPRICE2",
                        "type": "number",
                        "label": "Totprice2"
                    },
                    {
                        "name": "CASHPAYMENT",
                        "type": "number",
                        "label": "Cashpayment"
                    },
                    {
                        "name": "DIFF2",
                        "type": "number",
                        "label": "Diff2"
                    },
                    {
                        "name": "SCAN_ATTACHFN",
                        "type": "text",
                        "label": "Scan attachfn"
                    },
                    {
                        "name": "SOXFLAG",
                        "type": "text",
                        "label": "Soxflag"
                    },
                    {
                        "name": "SOXUSERLOGIN",
                        "type": "text",
                        "label": "Soxuserlogin"
                    },
                    {
                        "name": "SOXUDATE",
                        "type": "text",
                        "label": "Soxudate"
                    },
                    {
                        "name": "UNIQUEID",
                        "type": "text",
                        "label": "Uniqueid"
                    },
                    {
                        "name": "SDINUMIT",
                        "type": "text",
                        "label": "Sdinumit"
                    },
                    {
                        "name": "ESHK_APPLISTCODE",
                        "type": "text",
                        "label": "Eshk applistcode"
                    },
                    {
                        "name": "ESHK_APPLISTCODEDES",
                        "type": "text",
                        "label": "Eshk applistcodedes"
                    },
                    {
                        "name": "ESHK_NEXTAPPROVE",
                        "type": "text",
                        "label": "Eshk nextapprove"
                    },
                    {
                        "name": "ESHK_UFLAG",
                        "type": "text",
                        "label": "Eshk uflag"
                    },
                    {
                        "name": "PRIT_SITENET",
                        "type": "number",
                        "label": "Prit sitenet"
                    },
                    {
                        "name": "PRIT_SITEVAT",
                        "type": "number",
                        "label": "Prit sitevat"
                    },
                    {
                        "name": "PRIT_SITEGROSS",
                        "type": "number",
                        "label": "Prit sitegross"
                    },
                    {
                        "name": "PRIT_FILENAME",
                        "type": "text",
                        "label": "Prit filename"
                    },
                    {
                        "name": "IV",
                        "type": "number",
                        "label": "Iv"
                    },
                    {
                        "name": "IVTYPE",
                        "type": "text",
                        "label": "Ivtype"
                    },
                    {
                        "name": "PIVDOC_SUBFORM",
                        "spec": {
                            "name": "value",
                            "type": "text"
                        },
                        "type": "array",
                        "label": "Pivdoc subform"
                    },
                    {
                        "name": "PINVOICESCONT_SUBFORM",
                        "spec": {
                            "name": "value",
                            "spec": [
                                {
                                    "name": "ADRS",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "ADRS2",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "ADRS3",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "STATEA",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "STATENAME",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "STATE",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "COUNTRYNAME",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "ZIP",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "PHONE",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "FAX",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "EMAIL",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "PAYCODE",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "PAYDES",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "FNCPATNAME",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "FNCPATDES2",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "TAXCODE",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "LCODE",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "LEXCH",
                                    "type": "number",
                                    "label": null
                                },
                                {
                                    "name": "ACC_CODE",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "ACC_EXCH",
                                    "type": "number",
                                    "label": null
                                },
                                {
                                    "name": "PIVCODE",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "PIVNUM",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "LIVCODE",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "LIVNUM",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "STCODE",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "IMPTERMNAME",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "ORIGCOUNTRYNAME",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "SENDCOUNTRYNAME",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "TRANSTYPE1",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "TRANSTYPE2",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "INTRASTATDATE",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "IVREF",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "ACCNAME",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "IVCOUNT",
                                    "type": "number",
                                    "label": null
                                },
                                {
                                    "name": "VATTYPE",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "USERLOGIN",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "UDATE",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "ACTDATE",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "CASHNAME",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "CASHDES",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "FIRSTPAY",
                                    "type": "number",
                                    "label": null
                                },
                                {
                                    "name": "OTHERPAYMENTS",
                                    "type": "number",
                                    "label": null
                                },
                                {
                                    "name": "TRANSMEANCODE",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "TRANSMEANDES",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "FEPROTOCOL",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "FEPROTOCOLDATE",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "PROTOCOLNUM",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "SDINUMIT",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "DEBIT",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "IVNUM",
                                    "type": "text",
                                    "label": null
                                }
                            ],
                            "type": "collection"
                        },
                        "type": "array",
                        "label": "Pinvoicescont subform"
                    },
                    {
                        "name": "PINVOICEITEMS_SUBFORM",
                        "spec": {
                            "name": "value",
                            "spec": [
                                {
                                    "name": "PARTNAME",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "PDES",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "TQUANT",
                                    "type": "number",
                                    "label": null
                                },
                                {
                                    "name": "CALTQUANT",
                                    "type": "number",
                                    "label": null
                                },
                                {
                                    "name": "TUNITNAME",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "QUANT",
                                    "type": "number",
                                    "label": null
                                },
                                {
                                    "name": "UNITNAME",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "PRICE",
                                    "type": "number",
                                    "label": null
                                },
                                {
                                    "name": "ICODE",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "PRSOURCENAME",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "CALPRICE",
                                    "type": "number",
                                    "label": null
                                },
                                {
                                    "name": "PERCENT",
                                    "type": "number",
                                    "label": null
                                },
                                {
                                    "name": "ORDIPERCENT",
                                    "type": "number",
                                    "label": null
                                },
                                {
                                    "name": "QPRICE",
                                    "type": "number",
                                    "label": null
                                },
                                {
                                    "name": "CALQPRICE",
                                    "type": "number",
                                    "label": null
                                },
                                {
                                    "name": "TOTPRICE",
                                    "type": "number",
                                    "label": null
                                },
                                {
                                    "name": "CODE",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "TOTPERCENT",
                                    "type": "number",
                                    "label": null
                                },
                                {
                                    "name": "CALTOTPERCENT",
                                    "type": "number",
                                    "label": null
                                },
                                {
                                    "name": "ORDNAME",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "DOCNO",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "VATFLAG",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "SPECIALVATFLAG",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "SUPPARTNAME",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "REVNAME",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "BARCODE",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "BUDCODE",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "BUDGETDATE",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "COSTCNAME",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "COSTCNAME2",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "COSTCNAME3",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "COSTCNAME4",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "COSTCNAME5",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "ACCNAME",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "ACCDES",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "EXCH",
                                    "type": "number",
                                    "label": null
                                },
                                {
                                    "name": "CREDITFLAG",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "FROMDATE",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "TODATE",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "PDACCNAME",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "FNCICODE",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "FNCIDES",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "RCTAXCODE",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "TAXCODE",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "TAXCODE3",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "CUSTOMSNUM",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "CUSTOMSDATE",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "USERLOGIN",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "UDATE",
                                    "type": "text",
                                    "label": null
                                },
                                {
                                    "name": "PRIT_SITEQUANTLINE",
                                    "type": "number",
                                    "label": null
                                },
                                {
                                    "name": "PRIT_SITETOTPRICLINE",
                                    "type": "number",
                                    "label": null
                                },
                                {
                                    "name": "KLINE",
                                    "type": "number",
                                    "label": null
                                }
                            ],
                            "type": "collection"
                        },
                        "type": "array",
                        "label": "Pinvoiceitems subform"
                    },
                    {
                        "name": "INTERNALDIALOGTEXT_SUBFORM",
                        "type": "text",
                        "label": "Internaldialogtext subform"
                    },
                    {
                        "name": "__IMTLENGTH__",
                        "type": "number",
                        "label": "  imtlength  "
                    },
                    {
                        "name": "__IMTINDEX__",
                        "type": "number",
                        "label": "  imtindex  "
                    }
                ]
            }
        },
        {
            "id": 153,
            "module": "http:ActionSendDataAPIKeyAuth",
            "version": 3,
            "parameters": {
                "auth": 146147,
                "handleErrors": false,
                "useNewZLibDeCompress": true
            },
            "mapper": {
                "ca": "",
                "qs": [],
                "url": "https://raw.githubusercontent.com/Tania6303/GitHubprilingProject/refs/heads/{{var.input.branch}}/MakeCode/cleanJson/v1",
                "data": "",
                "gzip": true,
                "method": "get",
                "headers": [
                    {
                        "name": "Accept",
                        "value": "application/vnd.github.v3.raw"
                    }
                ],
                "timeout": "",
                "useMtls": false,
                "bodyType": "raw",
                "contentType": "application/json",
                "serializeUrl": false,
                "shareCookies": false,
                "parseResponse": false,
                "followRedirect": true,
                "useQuerystring": false,
                "followAllRedirects": false,
                "rejectUnauthorized": true
            },
            "metadata": {
                "designer": {
                    "x": 527,
                    "y": -246
                },
                "restore": {
                    "expect": {
                        "qs": {
                            "mode": "chose"
                        },
                        "method": {
                            "mode": "chose",
                            "label": "GET"
                        },
                        "headers": {
                            "mode": "chose",
                            "items": [
                                null
                            ]
                        },
                        "bodyType": {
                            "label": "Raw"
                        },
                        "contentType": {
                            "label": "JSON (application/json)"
                        }
                    },
                    "parameters": {
                        "auth": {
                            "label": "prilinq_GitHub"
                        }
                    }
                },
                "parameters": [
                    {
                        "name": "auth",
                        "type": "keychain:apikeyauth",
                        "label": "Credentials",
                        "required": true
                    },
                    {
                        "name": "handleErrors",
                        "type": "boolean",
                        "label": "Evaluate all states as errors (except for 2xx and 3xx )",
                        "required": true
                    },
                    {
                        "name": "useNewZLibDeCompress",
                        "type": "hidden"
                    }
                ],
                "expect": [
                    {
                        "name": "url",
                        "type": "url",
                        "label": "URL",
                        "required": true
                    },
                    {
                        "name": "serializeUrl",
                        "type": "boolean",
                        "label": "Serialize URL",
                        "required": true
                    },
                    {
                        "name": "method",
                        "type": "select",
                        "label": "Method",
                        "required": true,
                        "validate": {
                            "enum": [
                                "get",
                                "head",
                                "post",
                                "put",
                                "patch",
                                "delete",
                                "options"
                            ]
                        }
                    },
                    {
                        "name": "headers",
                        "spec": [
                            {
                                "name": "name",
                                "type": "text",
                                "label": "Name",
                                "required": true
                            },
                            {
                                "name": "value",
                                "type": "text",
                                "label": "Value"
                            }
                        ],
                        "type": "array",
                        "label": "Headers"
                    },
                    {
                        "name": "qs",
                        "spec": [
                            {
                                "name": "name",
                                "type": "text",
                                "label": "Name",
                                "required": true
                            },
                            {
                                "name": "value",
                                "type": "text",
                                "label": "Value"
                            }
                        ],
                        "type": "array",
                        "label": "Query String"
                    },
                    {
                        "name": "bodyType",
                        "type": "select",
                        "label": "Body type",
                        "validate": {
                            "enum": [
                                "raw",
                                "x_www_form_urlencoded",
                                "multipart_form_data"
                            ]
                        }
                    },
                    {
                        "name": "parseResponse",
                        "type": "boolean",
                        "label": "Parse response",
                        "required": true
                    },
                    {
                        "name": "timeout",
                        "type": "uinteger",
                        "label": "Timeout",
                        "validate": {
                            "max": 300,
                            "min": 1
                        }
                    },
                    {
                        "name": "shareCookies",
                        "type": "boolean",
                        "label": "Share cookies with other HTTP modules",
                        "required": true
                    },
                    {
                        "name": "ca",
                        "type": "cert",
                        "label": "Self-signed certificate"
                    },
                    {
                        "name": "rejectUnauthorized",
                        "type": "boolean",
                        "label": "Reject connections that are using unverified (self-signed) certificates",
                        "required": true
                    },
                    {
                        "name": "followRedirect",
                        "type": "boolean",
                        "label": "Follow redirect",
                        "required": true
                    },
                    {
                        "name": "useQuerystring",
                        "type": "boolean",
                        "label": "Disable serialization of multiple same query string keys as arrays",
                        "required": true
                    },
                    {
                        "name": "gzip",
                        "type": "boolean",
                        "label": "Request compressed content",
                        "required": true
                    },
                    {
                        "name": "useMtls",
                        "type": "boolean",
                        "label": "Use Mutual TLS",
                        "required": true
                    },
                    {
                        "name": "contentType",
                        "type": "select",
                        "label": "Content type",
                        "validate": {
                            "enum": [
                                "text/plain",
                                "application/json",
                                "application/xml",
                                "text/xml",
                                "text/html",
                                "custom"
                            ]
                        }
                    },
                    {
                        "name": "data",
                        "type": "buffer",
                        "label": "Request content"
                    },
                    {
                        "name": "followAllRedirects",
                        "type": "boolean",
                        "label": "Follow all redirect",
                        "required": true
                    }
                ]
            }
        },
        {
            "id": 65,
            "module": "code:ExecuteCode",
            "version": 0,
            "parameters": {},
            "mapper": {
                "input": [
                    {
                        "name": "invoices_json",
                        "value": "{{56.json}}"
                    }
                ],
                "language": "javascript",
                "inputFormat": "string",
                "dependencies": [],
                "codeStringJavascript": "{{153.data}}"
            },
            "metadata": {
                "designer": {
                    "x": 672,
                    "y": 47,
                    "name": "מנקה JSON"
                },
                "restore": {
                    "expect": {
                        "input": {
                            "items": [
                                null
                            ]
                        },
                        "language": {
                            "mode": "chose",
                            "label": "JavaScript"
                        },
                        "inputFormat": {
                            "label": "Mapped code (useful for AI)"
                        }
                    }
                },
                "expect": [
                    {
                        "name": "language",
                        "type": "select",
                        "label": "Language",
                        "required": true,
                        "validate": {
                            "enum": [
                                "javascript",
                                "python"
                            ]
                        }
                    },
                    {
                        "name": "input",
                        "spec": {
                            "name": "value",
                            "spec": [
                                {
                                    "name": "name",
                                    "type": "text",
                                    "label": "Name",
                                    "required": true,
                                    "validate": {
                                        "max": 32,
                                        "min": 1,
                                        "pattern": "^[a-zA-Z0-9_]{1,32}$"
                                    }
                                },
                                {
                                    "name": "value",
                                    "type": "any",
                                    "label": "Value",
                                    "required": true
                                }
                            ],
                            "type": "collection",
                            "label": "Variable"
                        },
                        "type": "array",
                        "label": "Input"
                    },
                    {
                        "name": "dependencies",
                        "spec": {
                            "name": "value",
                            "type": "text",
                            "label": "Dependency",
                            "required": true,
                            "validate": {
                                "max": 214,
                                "min": 1,
                                "pattern": "^[A-Za-z0-9_@\\./<>\\=\\!~\\^+\\-]{1,214}$"
                            }
                        },
                        "type": "array",
                        "label": "Additional dependencies (Enterprise plans only)"
                    },
                    {
                        "name": "inputFormat",
                        "type": "select",
                        "label": "Input format",
                        "required": true,
                        "validate": {
                            "enum": [
                                "editor",
                                "string"
                            ]
                        }
                    },
                    {
                        "name": "codeStringJavascript",
                        "type": "text",
                        "label": "Code",
                        "required": true
                    }
                ]
            }
        },
        {
            "id": 149,
            "module": "http:ActionSendDataAPIKeyAuth",
            "version": 3,
            "parameters": {
                "auth": 146147,
                "handleErrors": false,
                "useNewZLibDeCompress": true
            },
            "mapper": {
                "ca": "",
                "qs": [],
                "url": "https://raw.githubusercontent.com/Tania6303/GitHubprilingProject/refs/heads/main/MakeCode/SupplierDataLearning/v1.2(28.10.25)",
                "data": "",
                "gzip": true,
                "method": "get",
                "headers": [
                    {
                        "name": "Accept",
                        "value": "application/vnd.github.v3.raw"
                    }
                ],
                "timeout": "",
                "useMtls": false,
                "bodyType": "raw",
                "contentType": "application/json",
                "serializeUrl": false,
                "shareCookies": false,
                "parseResponse": false,
                "followRedirect": true,
                "useQuerystring": false,
                "followAllRedirects": false,
                "rejectUnauthorized": true
            },
            "metadata": {
                "designer": {
                    "x": 900,
                    "y": 0
                },
                "restore": {
                    "expect": {
                        "qs": {
                            "mode": "chose"
                        },
                        "method": {
                            "mode": "chose",
                            "label": "GET"
                        },
                        "headers": {
                            "mode": "chose",
                            "items": [
                                null
                            ]
                        },
                        "bodyType": {
                            "label": "Raw"
                        },
                        "contentType": {
                            "label": "JSON (application/json)"
                        }
                    },
                    "parameters": {
                        "auth": {
                            "label": "prilinq_GitHub"
                        }
                    }
                },
                "parameters": [
                    {
                        "name": "auth",
                        "type": "keychain:apikeyauth",
                        "label": "Credentials",
                        "required": true
                    },
                    {
                        "name": "handleErrors",
                        "type": "boolean",
                        "label": "Evaluate all states as errors (except for 2xx and 3xx )",
                        "required": true
                    },
                    {
                        "name": "useNewZLibDeCompress",
                        "type": "hidden"
                    }
                ],
                "expect": [
                    {
                        "name": "url",
                        "type": "url",
                        "label": "URL",
                        "required": true
                    },
                    {
                        "name": "serializeUrl",
                        "type": "boolean",
                        "label": "Serialize URL",
                        "required": true
                    },
                    {
                        "name": "method",
                        "type": "select",
                        "label": "Method",
                        "required": true,
                        "validate": {
                            "enum": [
                                "get",
                                "head",
                                "post",
                                "put",
                                "patch",
                                "delete",
                                "options"
                            ]
                        }
                    },
                    {
                        "name": "headers",
                        "spec": [
                            {
                                "name": "name",
                                "type": "text",
                                "label": "Name",
                                "required": true
                            },
                            {
                                "name": "value",
                                "type": "text",
                                "label": "Value"
                            }
                        ],
                        "type": "array",
                        "label": "Headers"
                    },
                    {
                        "name": "qs",
                        "spec": [
                            {
                                "name": "name",
                                "type": "text",
                                "label": "Name",
                                "required": true
                            },
                            {
                                "name": "value",
                                "type": "text",
                                "label": "Value"
                            }
                        ],
                        "type": "array",
                        "label": "Query String"
                    },
                    {
                        "name": "bodyType",
                        "type": "select",
                        "label": "Body type",
                        "validate": {
                            "enum": [
                                "raw",
                                "x_www_form_urlencoded",
                                "multipart_form_data"
                            ]
                        }
                    },
                    {
                        "name": "parseResponse",
                        "type": "boolean",
                        "label": "Parse response",
                        "required": true
                    },
                    {
                        "name": "timeout",
                        "type": "uinteger",
                        "label": "Timeout",
                        "validate": {
                            "max": 300,
                            "min": 1
                        }
                    },
                    {
                        "name": "shareCookies",
                        "type": "boolean",
                        "label": "Share cookies with other HTTP modules",
                        "required": true
                    },
                    {
                        "name": "ca",
                        "type": "cert",
                        "label": "Self-signed certificate"
                    },
                    {
                        "name": "rejectUnauthorized",
                        "type": "boolean",
                        "label": "Reject connections that are using unverified (self-signed) certificates",
                        "required": true
                    },
                    {
                        "name": "followRedirect",
                        "type": "boolean",
                        "label": "Follow redirect",
                        "required": true
                    },
                    {
                        "name": "useQuerystring",
                        "type": "boolean",
                        "label": "Disable serialization of multiple same query string keys as arrays",
                        "required": true
                    },
                    {
                        "name": "gzip",
                        "type": "boolean",
                        "label": "Request compressed content",
                        "required": true
                    },
                    {
                        "name": "useMtls",
                        "type": "boolean",
                        "label": "Use Mutual TLS",
                        "required": true
                    },
                    {
                        "name": "contentType",
                        "type": "select",
                        "label": "Content type",
                        "validate": {
                            "enum": [
                                "text/plain",
                                "application/json",
                                "application/xml",
                                "text/xml",
                                "text/html",
                                "custom"
                            ]
                        }
                    },
                    {
                        "name": "data",
                        "type": "buffer",
                        "label": "Request content"
                    },
                    {
                        "name": "followAllRedirects",
                        "type": "boolean",
                        "label": "Follow all redirect",
                        "required": true
                    }
                ]
            }
        },
        {
            "id": 79,
            "module": "code:ExecuteCode",
            "version": 0,
            "parameters": {},
            "mapper": {
                "input": [
                    {
                        "name": "supplier_id",
                        "value": "{{65.result.invoices_summary[].SUPNAME}}"
                    },
                    {
                        "name": "invoices_json",
                        "value": "{{65.result.cleaned_json}}"
                    }
                ],
                "language": "javascript",
                "inputFormat": "string",
                "dependencies": [],
                "codeStringJavascript": "{{149.data}}"
            },
            "metadata": {
                "designer": {
                    "x": 1200,
                    "y": 0,
                    "name": "ניתוח חשבוניות ספק"
                },
                "restore": {
                    "expect": {
                        "input": {
                            "items": [
                                null,
                                null
                            ]
                        },
                        "language": {
                            "mode": "chose",
                            "label": "JavaScript"
                        },
                        "inputFormat": {
                            "label": "Mapped code (useful for AI)"
                        }
                    }
                },
                "expect": [
                    {
                        "name": "language",
                        "type": "select",
                        "label": "Language",
                        "required": true,
                        "validate": {
                            "enum": [
                                "javascript",
                                "python"
                            ]
                        }
                    },
                    {
                        "name": "input",
                        "spec": {
                            "name": "value",
                            "spec": [
                                {
                                    "name": "name",
                                    "type": "text",
                                    "label": "Name",
                                    "required": true,
                                    "validate": {
                                        "max": 32,
                                        "min": 1,
                                        "pattern": "^[a-zA-Z0-9_]{1,32}$"
                                    }
                                },
                                {
                                    "name": "value",
                                    "type": "any",
                                    "label": "Value",
                                    "required": true
                                }
                            ],
                            "type": "collection",
                            "label": "Variable"
                        },
                        "type": "array",
                        "label": "Input"
                    },
                    {
                        "name": "dependencies",
                        "spec": {
                            "name": "value",
                            "type": "text",
                            "label": "Dependency",
                            "required": true,
                            "validate": {
                                "max": 214,
                                "min": 1,
                                "pattern": "^[A-Za-z0-9_@\\./<>\\=\\!~\\^+\\-]{1,214}$"
                            }
                        },
                        "type": "array",
                        "label": "Additional dependencies (Enterprise plans only)"
                    },
                    {
                        "name": "inputFormat",
                        "type": "select",
                        "label": "Input format",
                        "required": true,
                        "validate": {
                            "enum": [
                                "editor",
                                "string"
                            ]
                        }
                    },
                    {
                        "name": "codeStringJavascript",
                        "type": "text",
                        "label": "Code",
                        "required": true
                    }
                ]
            }
        },
        {
            "id": 74,
            "module": "builtin:BasicFeeder",
            "version": 1,
            "parameters": {},
            "mapper": {
                "array": "{{79.result.recommended_samples.samples}}"
            },
            "metadata": {
                "designer": {
                    "x": 1500,
                    "y": 0,
                    "name": "מפצל לקבצים "
                },
                "restore": {
                    "expect": {
                        "array": {
                            "mode": "edit"
                        }
                    }
                },
                "expect": [
                    {
                        "mode": "edit",
                        "name": "array",
                        "spec": [],
                        "type": "array",
                        "label": "Array"
                    }
                ]
            }
        },
        {
            "id": 128,
            "module": "scenario-service:CallSubscenario",
            "version": 2,
            "parameters": {
                "scenario": "SCN_7803653",
                "shouldWaitForExecutionEnd": true
            },
            "mapper": {
                "data": {
                    "LIST_IVNUM": "{{74.sample_ivnum}}"
                }
            },
            "metadata": {
                "designer": {
                    "x": 1800,
                    "y": 0,
                    "name": "DOCUMENTS FROM PRIORITY BY IVNUM"
                },
                "restore": {
                    "parameters": {
                        "scenario": {
                            "label": "DOCUMENTS FROM PRIORITY BY IVNUM"
                        }
                    }
                },
                "parameters": [
                    {
                        "name": "scenario",
                        "type": "scenario",
                        "label": "Scenario",
                        "required": true
                    },
                    {
                        "name": "shouldWaitForExecutionEnd",
                        "type": "boolean",
                        "label": "Wait for subscenario output",
                        "required": true
                    }
                ],
                "expect": [
                    {
                        "name": "data",
                        "spec": [
                            {
                                "name": "LIST_IVNUM",
                                "type": "text",
                                "label": ""
                            }
                        ],
                        "type": "collection",
                        "label": "Scenario Inputs"
                    }
                ],
                "interface": [
                    {
                        "help": "",
                        "name": "list_of_docs",
                        "spec": {
                            "type": "text",
                            "default": "",
                            "required": false,
                            "multiline": true
                        },
                        "type": "array",
                        "label": "",
                        "required": false
                    },
                    {
                        "help": "",
                        "name": "DOC_YES_NO",
                        "type": "text",
                        "label": "",
                        "default": "",
                        "required": false,
                        "multiline": false
                    }
                ]
            }
        },
        {
            "id": 90,
            "module": "scenario-service:CallSubscenario",
            "version": 2,
            "parameters": {
                "scenario": "SCN_7775130",
                "shouldWaitForExecutionEnd": true
            },
            "mapper": {
                "data": {
                    "LIST_IMPFNUM": [
                        "{{`74`}}"
                    ]
                }
            },
            "metadata": {
                "designer": {
                    "x": 2100,
                    "y": 0,
                    "name": "IMPFILES(PALYAM)"
                },
                "restore": {
                    "expect": {
                        "data": {
                            "nested": {
                                "LIST_IMPFNUM": {
                                    "mode": "chose",
                                    "items": [
                                        null
                                    ]
                                }
                            }
                        }
                    },
                    "parameters": {
                        "scenario": {
                            "label": "IMPFILES(PALYAM)"
                        }
                    }
                },
                "parameters": [
                    {
                        "name": "scenario",
                        "type": "scenario",
                        "label": "Scenario",
                        "required": true
                    },
                    {
                        "name": "shouldWaitForExecutionEnd",
                        "type": "boolean",
                        "label": "Wait for subscenario output",
                        "required": true
                    }
                ],
                "expect": [
                    {
                        "name": "data",
                        "spec": [
                            {
                                "name": "LIST_IMPFNUM",
                                "spec": {
                                    "name": "value",
                                    "type": "text"
                                },
                                "type": "array",
                                "label": ""
                            }
                        ],
                        "type": "collection",
                        "label": "Scenario Inputs"
                    }
                ],
                "interface": [
                    {
                        "help": "",
                        "name": "IMPFILES",
                        "spec": {
                            "type": "text",
                            "default": "",
                            "required": false,
                            "multiline": false
                        },
                        "type": "array",
                        "label": "",
                        "required": false
                    }
                ]
            }
        },
        {
            "id": 45,
            "module": "app#leonai-priority:getSubformAdv",
            "version": 1,
            "parameters": {
                "__IMTCONN__": 12563223
            },
            "mapper": {
                "form": "PINVOICES",
                "sort": "desc",
                "limit": "1",
                "table": "EXTFILES_SUBFORM",
                "column": [
                    [
                        {
                            "a": "SUFFIX::text",
                            "b": "PDF",
                            "o": "eq"
                        }
                    ],
                    [
                        {
                            "a": "SUFFIX::text",
                            "b": "pdf",
                            "o": "eq"
                        }
                    ]
                ],
                "search": {
                    "DEBIT": "D",
                    "IVNUM": "{{74.sample_ivnum}}",
                    "PIVTYPE": "P"
                },
                "orderby": "EXTFILENUM"
            },
            "metadata": {
                "designer": {
                    "x": 2400,
                    "y": 0
                },
                "restore": {
                    "expect": {
                        "form": {
                            "mode": "chose",
                            "label": "חשבוניות ספק מרכזות"
                        },
                        "sort": {
                            "mode": "chose",
                            "label": "Descending"
                        },
                        "table": {
                            "mode": "chose",
                            "label": "נספחים"
                        },
                        "orderby": {
                            "mode": "chose",
                            "label": "מספר מסמך"
                        },
                        "selection": {
                            "mode": "chose"
                        }
                    },
                    "parameters": {
                        "__IMTCONN__": {
                            "data": {
                                "scoped": "true",
                                "connection": "app#leonai-priority3"
                            },
                            "label": "palyam (a011204, tabula.ini)"
                        }
                    }
                },
                "parameters": [
                    {
                        "name": "__IMTCONN__",
                        "type": "account:app#leonai-priority3",
                        "label": "Connection",
                        "required": true
                    }
                ],
                "expect": [
                    {
                        "name": "limit",
                        "type": "number",
                        "label": "Limit",
                        "required": true
                    },
                    {
                        "name": "skip",
                        "type": "number",
                        "label": "Skip"
                    },
                    {
                        "name": "form",
                        "type": "select",
                        "label": "Forms",
                        "required": true
                    },
                    {
                        "name": "hevra",
                        "type": "text",
                        "label": "Company \\ Environment"
                    },
                    {
                        "name": "search",
                        "spec": [
                            {
                                "name": "IVNUM",
                                "type": "text",
                                "label": "מס. פנימי",
                                "required": true
                            },
                            {
                                "name": "DEBIT",
                                "type": "text",
                                "label": "חיוב/זכוי",
                                "required": true
                            },
                            {
                                "name": "PIVTYPE",
                                "type": "hidden",
                                "label": "סוג",
                                "required": true
                            }
                        ],
                        "type": "collection",
                        "label": "Types"
                    },
                    {
                        "name": "table",
                        "type": "select",
                        "label": "Sub-Form",
                        "required": true
                    },
                    {
                        "name": "column",
                        "type": "filter",
                        "label": "Filters",
                        "options": {
                            "store": [
                                {
                                    "label": "שם קובץ",
                                    "value": "EXTFILEDES::text"
                                },
                                {
                                    "label": "מספר מסמך",
                                    "value": "EXTFILENUM::number"
                                },
                                {
                                    "label": "נתיב הקובץ",
                                    "value": "EXTFILENAME::text"
                                },
                                {
                                    "label": "סיומת",
                                    "value": "SUFFIX::text"
                                },
                                {
                                    "label": "תאריך יצירת המסמך",
                                    "value": "CURDATE::date"
                                },
                                {
                                    "label": "לא לשלוח",
                                    "value": "NOSEND::text"
                                },
                                {
                                    "label": "סטטוס",
                                    "value": "STATUS::text"
                                },
                                {
                                    "label": "גודל קובץ בבתים",
                                    "value": "FILESIZE::number"
                                },
                                {
                                    "label": "משלוח בממשק אלקטרוני",
                                    "value": "EI_COND::text"
                                },
                                {
                                    "label": "עודכן ע\"י",
                                    "value": "USERLOGIN::text"
                                },
                                {
                                    "label": "ת. עדכון אחרון",
                                    "value": "UDATE::date"
                                },
                                {
                                    "label": "נעול ע\"י",
                                    "value": "LUSERLOGIN::text"
                                },
                                {
                                    "label": "פריורי סקאן",
                                    "value": "SCAN_PRIORISCAN::text"
                                },
                                {
                                    "label": "חתימה?",
                                    "value": "NGV_SIGNATURE2::text"
                                },
                                {
                                    "label": "כתובת (נייד)",
                                    "value": "NGV_ADDRESS::text"
                                },
                                {
                                    "label": "קו רוחב (נייד)",
                                    "value": "NGV_LATITUDE::number"
                                },
                                {
                                    "label": "קו אורך (נייד)",
                                    "value": "NGV_LONGITUDE::number"
                                },
                                {
                                    "label": "שם מייבא הנספח",
                                    "value": "SCAN_APIUSERLOGIN::text"
                                },
                                {
                                    "label": "ת. יבוא הנספח",
                                    "value": "SCAN_UDATEAPI::date"
                                }
                            ],
                            "operators": [
                                {
                                    "label": "Basic operators",
                                    "options": [
                                        {
                                            "label": "Exists",
                                            "value": "exist"
                                        },
                                        {
                                            "label": "Does not exists",
                                            "value": "notexist"
                                        }
                                    ]
                                },
                                {
                                    "label": "Text operators",
                                    "options": [
                                        {
                                            "label": "Equal to",
                                            "value": "eq"
                                        },
                                        {
                                            "label": "Not equal to",
                                            "value": "ne"
                                        },
                                        {
                                            "label": "Contains",
                                            "value": "contains"
                                        },
                                        {
                                            "label": "Does not Contain",
                                            "value": "notcontains"
                                        },
                                        {
                                            "label": "Start with",
                                            "value": "startwith"
                                        },
                                        {
                                            "label": "Does not start with",
                                            "value": "notstartwith"
                                        }
                                    ]
                                },
                                {
                                    "label": "Numbers operators",
                                    "options": [
                                        {
                                            "label": "Equal to",
                                            "value": "eq"
                                        },
                                        {
                                            "label": "Not equal to",
                                            "value": "ne"
                                        },
                                        {
                                            "label": "Greater than",
                                            "value": "gt"
                                        },
                                        {
                                            "label": "Less than",
                                            "value": "lt"
                                        },
                                        {
                                            "label": "Greater than or equal to",
                                            "value": "ge"
                                        },
                                        {
                                            "label": "Less than or equal to",
                                            "value": "le"
                                        }
                                    ]
                                },
                                {
                                    "label": "Datetime operators",
                                    "options": [
                                        {
                                            "label": "Equal to",
                                            "value": "eq"
                                        },
                                        {
                                            "label": "Not equal to",
                                            "value": "ne"
                                        },
                                        {
                                            "label": "Greater than",
                                            "value": "gt"
                                        },
                                        {
                                            "label": "Less than",
                                            "value": "lt"
                                        },
                                        {
                                            "label": "Greater than or equal to",
                                            "value": "ge"
                                        },
                                        {
                                            "label": "Less than or equal to",
                                            "value": "le"
                                        }
                                    ]
                                }
                            ]
                        }
                    },
                    {
                        "name": "orderby",
                        "type": "select",
                        "label": "Order by"
                    },
                    {
                        "name": "since",
                        "type": "text",
                        "label": "Modified Since"
                    },
                    {
                        "name": "selection",
                        "type": "select",
                        "label": "Get specified field\\s",
                        "multiple": true
                    },
                    {
                        "name": "sort",
                        "type": "select",
                        "label": "Sort order",
                        "required": true,
                        "validate": {
                            "enum": [
                                "asc",
                                "desc"
                            ]
                        }
                    }
                ],
                "interface": [
                    {
                        "name": "__IMTLENGTH__",
                        "type": "uinteger",
                        "label": "Total number of bundles"
                    },
                    {
                        "name": "__IMTINDEX__",
                        "type": "uinteger",
                        "label": "Bundle order position"
                    },
                    {
                        "name": "make",
                        "spec": [
                            {
                                "name": "sufFix",
                                "type": "text",
                                "label": "File Suffix"
                            },
                            {
                                "name": "fileData",
                                "type": "buffer",
                                "label": "File Data",
                                "semantic": "file:data"
                            },
                            {
                                "name": "fileName",
                                "type": "text",
                                "label": "File Name"
                            },
                            {
                                "name": "fullname",
                                "type": "filename",
                                "label": "Full Filename",
                                "semantic": "file:name"
                            }
                        ],
                        "type": "collection",
                        "label": "Make"
                    },
                    {
                        "name": "priority",
                        "spec": [
                            {
                                "name": "EXTFILEDES",
                                "type": "text",
                                "label": "שם קובץ"
                            },
                            {
                                "name": "EXTFILENUM",
                                "type": "number",
                                "label": "מספר מסמך"
                            },
                            {
                                "name": "EXTFILENAME",
                                "type": "text",
                                "label": "נתיב הקובץ"
                            },
                            {
                                "name": "SUFFIX",
                                "type": "text",
                                "label": "סיומת"
                            },
                            {
                                "name": "CURDATE",
                                "type": "date",
                                "label": "תאריך יצירת המסמך"
                            },
                            {
                                "name": "NOSEND",
                                "type": "text",
                                "label": "לא לשלוח"
                            },
                            {
                                "name": "STATUS",
                                "type": "text",
                                "label": "סטטוס"
                            },
                            {
                                "name": "FILESIZE",
                                "type": "number",
                                "label": "גודל קובץ בבתים"
                            },
                            {
                                "name": "EI_COND",
                                "type": "text",
                                "label": "משלוח בממשק אלקטרוני"
                            },
                            {
                                "name": "USERLOGIN",
                                "type": "text",
                                "label": "עודכן ע\"י"
                            },
                            {
                                "name": "UDATE",
                                "type": "date",
                                "label": "ת. עדכון אחרון"
                            },
                            {
                                "name": "LUSERLOGIN",
                                "type": "text",
                                "label": "נעול ע\"י"
                            },
                            {
                                "name": "SCAN_PRIORISCAN",
                                "type": "text",
                                "label": "פריורי סקאן"
                            },
                            {
                                "name": "NGV_SIGNATURE2",
                                "type": "text",
                                "label": "חתימה?"
                            },
                            {
                                "name": "NGV_ADDRESS",
                                "type": "text",
                                "label": "כתובת (נייד)"
                            },
                            {
                                "name": "NGV_LATITUDE",
                                "type": "number",
                                "label": "קו רוחב (נייד)"
                            },
                            {
                                "name": "NGV_LONGITUDE",
                                "type": "number",
                                "label": "קו אורך (נייד)"
                            },
                            {
                                "name": "SCAN_APIUSERLOGIN",
                                "type": "text",
                                "label": "שם מייבא הנספח"
                            },
                            {
                                "name": "SCAN_UDATEAPI",
                                "type": "date",
                                "label": "ת. יבוא הנספח"
                            }
                        ],
                        "type": "collection",
                        "label": "Priority"
                    }
                ]
            }
        },
        {
            "id": 49,
            "module": "app#leonai-priority:filedownload",
            "version": 1,
            "parameters": {},
            "filter": {
                "name": "",
                "conditions": [
                    [
                        {
                            "a": "{{45.`__IMTLENGTH__`}}",
                            "b": "0",
                            "o": "number:greater"
                        }
                    ]
                ]
            },
            "mapper": {
                "data": "{{45.EXTFILENAME}}",
                "fileName": "{{79.result.supplier_id}}_{{74.sample_booknum}}.pdf"
            },
            "metadata": {
                "designer": {
                    "x": 2700,
                    "y": 0
                },
                "restore": {},
                "expect": [
                    {
                        "name": "fileName",
                        "type": "filename",
                        "label": "File name"
                    },
                    {
                        "name": "data",
                        "type": "text",
                        "label": "Data"
                    }
                ]
            }
        },
        {
            "id": 99,
            "module": "http:ActionSendData",
            "version": 3,
            "parameters": {
                "handleErrors": true,
                "useNewZLibDeCompress": true
            },
            "mapper": {
                "ca": "",
                "qs": [],
                "url": "https://prilinqdocai.cognitiveservices.azure.com/formrecognizer/documentModels/prebuilt-invoice:analyze?api-version=2023-07-31",
                "data": "{{49.data}}",
                "gzip": true,
                "method": "post",
                "headers": [
                    {
                        "name": "Ocp-Apim-Subscription-Key",
                        "value": "CdSbyB8oJePTa6bRLuzJmkZE7IGd31GQaZZQtlIF9VjBwwsuVSbOJQQJ99BJAC5RqLJXJ3w3AAALACOGSDuM"
                    },
                    {
                        "name": "Content-Type",
                        "value": "application/pdf"
                    }
                ],
                "timeout": "",
                "useMtls": false,
                "authPass": "",
                "authUser": "",
                "bodyType": "raw",
                "contentType": "application/json",
                "serializeUrl": false,
                "shareCookies": false,
                "parseResponse": true,
                "followRedirect": true,
                "useQuerystring": false,
                "followAllRedirects": false,
                "rejectUnauthorized": true
            },
            "metadata": {
                "designer": {
                    "x": 3000,
                    "y": 0
                },
                "restore": {
                    "expect": {
                        "qs": {
                            "mode": "chose"
                        },
                        "method": {
                            "mode": "chose",
                            "label": "POST"
                        },
                        "headers": {
                            "mode": "chose",
                            "items": [
                                null,
                                null
                            ]
                        },
                        "bodyType": {
                            "label": "Raw"
                        },
                        "contentType": {
                            "label": "JSON (application/json)"
                        }
                    }
                },
                "parameters": [
                    {
                        "name": "handleErrors",
                        "type": "boolean",
                        "label": "Evaluate all states as errors (except for 2xx and 3xx )",
                        "required": true
                    },
                    {
                        "name": "useNewZLibDeCompress",
                        "type": "hidden"
                    }
                ],
                "expect": [
                    {
                        "name": "url",
                        "type": "url",
                        "label": "URL",
                        "required": true
                    },
                    {
                        "name": "serializeUrl",
                        "type": "boolean",
                        "label": "Serialize URL",
                        "required": true
                    },
                    {
                        "name": "method",
                        "type": "select",
                        "label": "Method",
                        "required": true,
                        "validate": {
                            "enum": [
                                "get",
                                "head",
                                "post",
                                "put",
                                "patch",
                                "delete",
                                "options"
                            ]
                        }
                    },
                    {
                        "name": "headers",
                        "spec": [
                            {
                                "name": "name",
                                "type": "text",
                                "label": "Name",
                                "required": true
                            },
                            {
                                "name": "value",
                                "type": "text",
                                "label": "Value"
                            }
                        ],
                        "type": "array",
                        "label": "Headers"
                    },
                    {
                        "name": "qs",
                        "spec": [
                            {
                                "name": "name",
                                "type": "text",
                                "label": "Name",
                                "required": true
                            },
                            {
                                "name": "value",
                                "type": "text",
                                "label": "Value"
                            }
                        ],
                        "type": "array",
                        "label": "Query String"
                    },
                    {
                        "name": "bodyType",
                        "type": "select",
                        "label": "Body type",
                        "validate": {
                            "enum": [
                                "raw",
                                "x_www_form_urlencoded",
                                "multipart_form_data"
                            ]
                        }
                    },
                    {
                        "name": "parseResponse",
                        "type": "boolean",
                        "label": "Parse response",
                        "required": true
                    },
                    {
                        "name": "authUser",
                        "type": "text",
                        "label": "User name"
                    },
                    {
                        "name": "authPass",
                        "type": "password",
                        "label": "Password"
                    },
                    {
                        "name": "timeout",
                        "type": "uinteger",
                        "label": "Timeout",
                        "validate": {
                            "max": 300,
                            "min": 1
                        }
                    },
                    {
                        "name": "shareCookies",
                        "type": "boolean",
                        "label": "Share cookies with other HTTP modules",
                        "required": true
                    },
                    {
                        "name": "ca",
                        "type": "cert",
                        "label": "Self-signed certificate"
                    },
                    {
                        "name": "rejectUnauthorized",
                        "type": "boolean",
                        "label": "Reject connections that are using unverified (self-signed) certificates",
                        "required": true
                    },
                    {
                        "name": "followRedirect",
                        "type": "boolean",
                        "label": "Follow redirect",
                        "required": true
                    },
                    {
                        "name": "useQuerystring",
                        "type": "boolean",
                        "label": "Disable serialization of multiple same query string keys as arrays",
                        "required": true
                    },
                    {
                        "name": "gzip",
                        "type": "boolean",
                        "label": "Request compressed content",
                        "required": true
                    },
                    {
                        "name": "useMtls",
                        "type": "boolean",
                        "label": "Use Mutual TLS",
                        "required": true
                    },
                    {
                        "name": "contentType",
                        "type": "select",
                        "label": "Content type",
                        "validate": {
                            "enum": [
                                "text/plain",
                                "application/json",
                                "application/xml",
                                "text/xml",
                                "text/html",
                                "custom"
                            ]
                        }
                    },
                    {
                        "name": "data",
                        "type": "buffer",
                        "label": "Request content"
                    },
                    {
                        "name": "followAllRedirects",
                        "type": "boolean",
                        "label": "Follow all redirect",
                        "required": true
                    }
                ]
            }
        },
        {
            "id": 103,
            "module": "google-drive:uploadAFile",
            "version": 4,
            "parameters": {
                "__IMTCONN__": 11952466
            },
            "mapper": {
                "data": "{{49.data}}",
                "select": "value",
                "convert": false,
                "filename": "{{49.filename}}",
                "folderId": "/15IK2GudZYSVKqR3Ixj9ofcP970NHczWj/1GZt5b12tXLqB4ykQeHoq9uwgUatdoy_P/1cia0QJzSpI3xgUHTRfe5hP8cekXXIrdR",
                "destination": "drive"
            },
            "metadata": {
                "designer": {
                    "x": 3300,
                    "y": 0
                },
                "restore": {
                    "expect": {
                        "select": {
                            "label": "Select from the list"
                        },
                        "folderId": {
                            "mode": "chose",
                            "path": [
                                "A_MY_PROJECT",
                                "FILES_BASE44",
                                "UPLOADS"
                            ]
                        },
                        "destination": {
                            "label": "My Drive"
                        }
                    },
                    "parameters": {
                        "__IMTCONN__": {
                            "data": {
                                "scoped": "true",
                                "connection": "google-restricted"
                            },
                            "label": "My Google Restricted connection (tani@procom-co-il.org)"
                        }
                    }
                },
                "parameters": [
                    {
                        "name": "__IMTCONN__",
                        "type": "account:google-restricted",
                        "label": "Connection",
                        "required": true
                    }
                ],
                "expect": [
                    {
                        "type": "hidden"
                    },
                    {
                        "name": "select",
                        "type": "select",
                        "label": "Enter a Folder ID",
                        "required": true,
                        "validate": {
                            "enum": [
                                "map",
                                "value"
                            ]
                        }
                    },
                    {
                        "name": "title",
                        "type": "text",
                        "label": "New File Name"
                    },
                    {
                        "name": "filename",
                        "type": "text",
                        "label": "File Name",
                        "required": true
                    },
                    {
                        "name": "data",
                        "type": "buffer",
                        "label": "Data",
                        "required": true
                    },
                    {
                        "name": "convert",
                        "type": "boolean",
                        "label": "Convert a File",
                        "required": true
                    },
                    {
                        "name": "destination",
                        "type": "select",
                        "label": "New Drive Location",
                        "required": true,
                        "validate": {
                            "enum": [
                                "drive",
                                "share",
                                "team"
                            ]
                        }
                    },
                    {
                        "name": "folderId",
                        "type": "folder",
                        "label": "New Folder Location",
                        "required": true
                    }
                ]
            }
        },
        {
            "id": 112,
            "module": "scenario-service:CallSubscenario",
            "version": 2,
            "parameters": {
                "scenario": "SCN_7831155",
                "shouldWaitForExecutionEnd": true
            },
            "mapper": {
                "data": {
                    "PAL_PINV_FUL_azure": [
                        "{{`99`}}"
                    ]
                }
            },
            "metadata": {
                "designer": {
                    "x": 3600,
                    "y": 0,
                    "name": "2- AZURE_PRI(ATTAH)"
                },
                "restore": {
                    "expect": {
                        "data": {
                            "nested": {
                                "PAL_PINV_FUL_azure": {
                                    "mode": "chose",
                                    "items": [
                                        null
                                    ]
                                }
                            }
                        }
                    },
                    "parameters": {
                        "scenario": {
                            "label": "2- AZURE_PRI(ATTAH)"
                        }
                    }
                },
                "parameters": [
                    {
                        "name": "scenario",
                        "type": "scenario",
                        "label": "Scenario",
                        "required": true
                    },
                    {
                        "name": "shouldWaitForExecutionEnd",
                        "type": "boolean",
                        "label": "Wait for subscenario output",
                        "required": true
                    }
                ],
                "expect": [
                    {
                        "name": "data",
                        "spec": [
                            {
                                "name": "PAL_PINV_FUL_azure",
                                "spec": {
                                    "name": "value",
                                    "type": "text"
                                },
                                "type": "array",
                                "label": ""
                            }
                        ],
                        "type": "collection",
                        "label": "Scenario Inputs"
                    }
                ],
                "interface": [
                    {
                        "help": "",
                        "name": "AZURE_AI_TEXT",
                        "type": "text",
                        "label": "",
                        "default": "",
                        "required": false,
                        "multiline": false
                    }
                ]
            }
        },
        {
            "id": 113,
            "module": "json:ParseJSON",
            "version": 1,
            "parameters": {
                "type": 474710
            },
            "mapper": {
                "json": "{{112.AZURE_AI_TEXT}}"
            },
            "metadata": {
                "designer": {
                    "x": 3900,
                    "y": 0
                },
                "restore": {
                    "parameters": {
                        "type": {
                            "label": "My data structure"
                        }
                    }
                },
                "parameters": [
                    {
                        "name": "type",
                        "type": "udt",
                        "label": "Data structure"
                    }
                ],
                "expect": [
                    {
                        "name": "json",
                        "type": "text",
                        "label": "JSON string",
                        "required": true
                    }
                ],
                "interface": [
                    {
                        "help": "",
                        "name": "executionTimeMs",
                        "type": "number",
                        "label": "Execution time ms",
                        "default": null,
                        "required": false
                    }
                ]
            }
        },
        {
            "id": 146,
            "module": "http:ActionSendDataAPIKeyAuth",
            "version": 3,
            "parameters": {
                "auth": 146147,
                "handleErrors": false,
                "useNewZLibDeCompress": true
            },
            "mapper": {
                "ca": "",
                "qs": [],
                "url": "https://raw.githubusercontent.com/Tania6303/GitHubprilingProject/refs/heads/{{var.input.branch}}/MakeCode/AzureInvoiceProcessor/v2.0(30.10.25)",
                "data": "",
                "gzip": true,
                "method": "get",
                "headers": [
                    {
                        "name": "Accept",
                        "value": "application/vnd.github.v3.raw"
                    }
                ],
                "timeout": "",
                "useMtls": false,
                "bodyType": "raw",
                "contentType": "application/json",
                "serializeUrl": false,
                "shareCookies": false,
                "parseResponse": false,
                "followRedirect": true,
                "useQuerystring": false,
                "followAllRedirects": false,
                "rejectUnauthorized": true
            },
            "metadata": {
                "designer": {
                    "x": 4200,
                    "y": 0
                },
                "restore": {
                    "expect": {
                        "qs": {
                            "mode": "chose"
                        },
                        "method": {
                            "mode": "chose",
                            "label": "GET"
                        },
                        "headers": {
                            "mode": "chose",
                            "items": [
                                null
                            ]
                        },
                        "bodyType": {
                            "label": "Raw"
                        },
                        "contentType": {
                            "label": "JSON (application/json)"
                        }
                    },
                    "parameters": {
                        "auth": {
                            "label": "prilinq_GitHub"
                        }
                    }
                },
                "parameters": [
                    {
                        "name": "auth",
                        "type": "keychain:apikeyauth",
                        "label": "Credentials",
                        "required": true
                    },
                    {
                        "name": "handleErrors",
                        "type": "boolean",
                        "label": "Evaluate all states as errors (except for 2xx and 3xx )",
                        "required": true
                    },
                    {
                        "name": "useNewZLibDeCompress",
                        "type": "hidden"
                    }
                ],
                "expect": [
                    {
                        "name": "url",
                        "type": "url",
                        "label": "URL",
                        "required": true
                    },
                    {
                        "name": "serializeUrl",
                        "type": "boolean",
                        "label": "Serialize URL",
                        "required": true
                    },
                    {
                        "name": "method",
                        "type": "select",
                        "label": "Method",
                        "required": true,
                        "validate": {
                            "enum": [
                                "get",
                                "head",
                                "post",
                                "put",
                                "patch",
                                "delete",
                                "options"
                            ]
                        }
                    },
                    {
                        "name": "headers",
                        "spec": [
                            {
                                "name": "name",
                                "type": "text",
                                "label": "Name",
                                "required": true
                            },
                            {
                                "name": "value",
                                "type": "text",
                                "label": "Value"
                            }
                        ],
                        "type": "array",
                        "label": "Headers"
                    },
                    {
                        "name": "qs",
                        "spec": [
                            {
                                "name": "name",
                                "type": "text",
                                "label": "Name",
                                "required": true
                            },
                            {
                                "name": "value",
                                "type": "text",
                                "label": "Value"
                            }
                        ],
                        "type": "array",
                        "label": "Query String"
                    },
                    {
                        "name": "bodyType",
                        "type": "select",
                        "label": "Body type",
                        "validate": {
                            "enum": [
                                "raw",
                                "x_www_form_urlencoded",
                                "multipart_form_data"
                            ]
                        }
                    },
                    {
                        "name": "parseResponse",
                        "type": "boolean",
                        "label": "Parse response",
                        "required": true
                    },
                    {
                        "name": "timeout",
                        "type": "uinteger",
                        "label": "Timeout",
                        "validate": {
                            "max": 300,
                            "min": 1
                        }
                    },
                    {
                        "name": "shareCookies",
                        "type": "boolean",
                        "label": "Share cookies with other HTTP modules",
                        "required": true
                    },
                    {
                        "name": "ca",
                        "type": "cert",
                        "label": "Self-signed certificate"
                    },
                    {
                        "name": "rejectUnauthorized",
                        "type": "boolean",
                        "label": "Reject connections that are using unverified (self-signed) certificates",
                        "required": true
                    },
                    {
                        "name": "followRedirect",
                        "type": "boolean",
                        "label": "Follow redirect",
                        "required": true
                    },
                    {
                        "name": "useQuerystring",
                        "type": "boolean",
                        "label": "Disable serialization of multiple same query string keys as arrays",
                        "required": true
                    },
                    {
                        "name": "gzip",
                        "type": "boolean",
                        "label": "Request compressed content",
                        "required": true
                    },
                    {
                        "name": "useMtls",
                        "type": "boolean",
                        "label": "Use Mutual TLS",
                        "required": true
                    },
                    {
                        "name": "contentType",
                        "type": "select",
                        "label": "Content type",
                        "validate": {
                            "enum": [
                                "text/plain",
                                "application/json",
                                "application/xml",
                                "text/xml",
                                "text/html",
                                "custom"
                            ]
                        }
                    },
                    {
                        "name": "data",
                        "type": "buffer",
                        "label": "Request content"
                    },
                    {
                        "name": "followAllRedirects",
                        "type": "boolean",
                        "label": "Follow all redirect",
                        "required": true
                    }
                ]
            }
        },
        {
            "id": 114,
            "module": "code:ExecuteCode",
            "version": 0,
            "parameters": {},
            "mapper": {
                "input": [
                    {
                        "name": "azureJsonInput",
                        "value": "{{`113`}}"
                    }
                ],
                "language": "javascript",
                "inputFormat": "string",
                "dependencies": [],
                "codeStringJavascript": "{{146.data}}"
            },
            "metadata": {
                "designer": {
                    "x": 4500,
                    "y": 0,
                    "name": "Azure Invoice Processor"
                },
                "restore": {
                    "expect": {
                        "input": {
                            "items": [
                                null
                            ]
                        },
                        "language": {
                            "mode": "chose",
                            "label": "JavaScript"
                        },
                        "inputFormat": {
                            "label": "Mapped code (useful for AI)"
                        }
                    }
                },
                "expect": [
                    {
                        "name": "language",
                        "type": "select",
                        "label": "Language",
                        "required": true,
                        "validate": {
                            "enum": [
                                "javascript",
                                "python"
                            ]
                        }
                    },
                    {
                        "name": "input",
                        "spec": {
                            "name": "value",
                            "spec": [
                                {
                                    "name": "name",
                                    "type": "text",
                                    "label": "Name",
                                    "required": true,
                                    "validate": {
                                        "max": 32,
                                        "min": 1,
                                        "pattern": "^[a-zA-Z0-9_]{1,32}$"
                                    }
                                },
                                {
                                    "name": "value",
                                    "type": "any",
                                    "label": "Value",
                                    "required": true
                                }
                            ],
                            "type": "collection",
                            "label": "Variable"
                        },
                        "type": "array",
                        "label": "Input"
                    },
                    {
                        "name": "dependencies",
                        "spec": {
                            "name": "value",
                            "type": "text",
                            "label": "Dependency",
                            "required": true,
                            "validate": {
                                "max": 214,
                                "min": 1,
                                "pattern": "^[A-Za-z0-9_@\\./<>\\=\\!~\\^+\\-]{1,214}$"
                            }
                        },
                        "type": "array",
                        "label": "Additional dependencies (Enterprise plans only)"
                    },
                    {
                        "name": "inputFormat",
                        "type": "select",
                        "label": "Input format",
                        "required": true,
                        "validate": {
                            "enum": [
                                "editor",
                                "string"
                            ]
                        }
                    },
                    {
                        "name": "codeStringJavascript",
                        "type": "text",
                        "label": "Code",
                        "required": true
                    }
                ]
            }
        },
        {
            "id": 118,
            "module": "util:SetVariables",
            "version": 1,
            "parameters": {},
            "mapper": {
                "scope": "roundtrip",
                "variables": [
                    {
                        "name": "AZURE_RESULT",
                        "value": "{{114.result}}"
                    },
                    {
                        "name": "azuretext",
                        "value": "{{112.AZURE_AI_TEXT}}"
                    },
                    {
                        "name": "docs",
                        "value": "{{`128`}}"
                    },
                    {
                        "name": "imfp",
                        "value": "{{`90`}}"
                    },
                    {
                        "name": "conf",
                        "value": "{{79.result}}"
                    }
                ]
            },
            "metadata": {
                "designer": {
                    "x": 4800,
                    "y": 0
                },
                "restore": {
                    "expect": {
                        "scope": {
                            "label": "One cycle"
                        },
                        "variables": {
                            "items": [
                                null,
                                null,
                                null,
                                null,
                                null
                            ]
                        }
                    }
                },
                "expect": [
                    {
                        "name": "variables",
                        "spec": [
                            {
                                "name": "name",
                                "type": "text",
                                "label": "Variable name",
                                "required": true
                            },
                            {
                                "name": "value",
                                "type": "any",
                                "label": "Variable value"
                            }
                        ],
                        "type": "array",
                        "label": "Variables"
                    },
                    {
                        "name": "scope",
                        "type": "select",
                        "label": "Variable lifetime",
                        "required": true,
                        "validate": {
                            "enum": [
                                "roundtrip",
                                "execution"
                            ]
                        }
                    }
                ],
                "interface": [
                    {
                        "name": "AZURE_RESULT",
                        "type": "any",
                        "label": "AZURE_RESULT"
                    },
                    {
                        "name": "azuretext",
                        "type": "any",
                        "label": "azuretext"
                    },
                    {
                        "name": "docs",
                        "type": "any",
                        "label": "docs"
                    },
                    {
                        "name": "imfp",
                        "type": "any",
                        "label": "imfp"
                    },
                    {
                        "name": "conf",
                        "type": "any",
                        "label": "conf"
                    }
                ]
            }
        },
        {
            "id": 136,
            "module": "scenario-service:CallSubscenario",
            "version": 2,
            "parameters": {
                "scenario": "SCN_7860051",
                "shouldWaitForExecutionEnd": true
            },
            "mapper": {
                "data": {
                    "ALL": [
                        "{{`118`}}"
                    ]
                }
            },
            "metadata": {
                "designer": {
                    "x": 5100,
                    "y": 0,
                    "name": "S2- SUP_LERN_CODE"
                },
                "restore": {
                    "expect": {
                        "data": {
                            "nested": {
                                "ALL": {
                                    "mode": "chose",
                                    "items": [
                                        null
                                    ]
                                }
                            }
                        }
                    },
                    "parameters": {
                        "scenario": {
                            "label": "2- SUP_LERN_CODE"
                        }
                    }
                },
                "parameters": [
                    {
                        "name": "scenario",
                        "type": "scenario",
                        "label": "Scenario",
                        "required": true
                    },
                    {
                        "name": "shouldWaitForExecutionEnd",
                        "type": "boolean",
                        "label": "Wait for subscenario output",
                        "required": true
                    }
                ],
                "expect": [
                    {
                        "name": "data",
                        "spec": [
                            {
                                "name": "ALL",
                                "spec": {
                                    "name": "value",
                                    "type": "text"
                                },
                                "type": "array",
                                "label": ""
                            }
                        ],
                        "type": "collection",
                        "label": "Scenario Inputs"
                    }
                ],
                "interface": [
                    {
                        "help": "",
                        "name": "LEARN_RESULTS",
                        "type": "dynamicCollection",
                        "label": "",
                        "default": "",
                        "required": false
                    },
                    {
                        "help": "",
                        "name": "SUPNAME",
                        "type": "text",
                        "label": "",
                        "default": "",
                        "required": false,
                        "multiline": false
                    },
                    {
                        "help": "",
                        "name": "SUPPLIER_ID",
                        "type": "text",
                        "label": "",
                        "default": "",
                        "required": false,
                        "multiline": false
                    }
                ]
            }
        },
        {
            "id": 150,
            "module": "builtin:BasicRouter",
            "version": 1,
            "filter": {
                "name": "",
                "conditions": [
                    [
                        {
                            "a": "1",
                            "b": "2",
                            "o": "text:equal"
                        }
                    ]
                ]
            },
            "mapper": null,
            "metadata": {
                "designer": {
                    "x": 5400,
                    "y": 0
                }
            },
            "routes": [
                {
                    "flow": [
                        {
                            "id": 145,
                            "module": "scenario-service:CallSubscenario",
                            "version": 2,
                            "parameters": {
                                "scenario": "SCN_7779086",
                                "shouldWaitForExecutionEnd": true
                            },
                            "mapper": {
                                "data": {
                                    "JSON": "{{118.conf.template.PINVOICES}}"
                                }
                            },
                            "metadata": {
                                "designer": {
                                    "x": 5700,
                                    "y": 0,
                                    "name": "OPEN_PIV_PRIORITY"
                                },
                                "restore": {
                                    "parameters": {
                                        "scenario": {
                                            "label": "OPEN_PIV_PRIORITY (PALYAM)"
                                        }
                                    }
                                },
                                "parameters": [
                                    {
                                        "name": "scenario",
                                        "type": "scenario",
                                        "label": "Scenario",
                                        "required": true
                                    },
                                    {
                                        "name": "shouldWaitForExecutionEnd",
                                        "type": "boolean",
                                        "label": "Wait for subscenario output",
                                        "required": true
                                    }
                                ],
                                "expect": [
                                    {
                                        "name": "data",
                                        "spec": [
                                            {
                                                "name": "JSON",
                                                "type": "text",
                                                "label": ""
                                            },
                                            {
                                                "name": "ACTION",
                                                "type": "text",
                                                "label": ""
                                            }
                                        ],
                                        "type": "collection",
                                        "label": "Scenario Inputs"
                                    }
                                ],
                                "interface": [
                                    {
                                        "help": "",
                                        "name": "IVNUM",
                                        "type": "text",
                                        "label": "",
                                        "default": "",
                                        "required": false,
                                        "multiline": false
                                    },
                                    {
                                        "help": "",
                                        "name": "ERR",
                                        "type": "text",
                                        "label": "",
                                        "default": "",
                                        "required": false,
                                        "multiline": false
                                    },
                                    {
                                        "help": "",
                                        "name": "ACTION",
                                        "type": "text",
                                        "label": "",
                                        "default": "",
                                        "required": false,
                                        "multiline": false
                                    },
                                    {
                                        "help": "",
                                        "name": "ANSWERS",
                                        "type": "text",
                                        "label": "",
                                        "default": "",
                                        "required": false,
                                        "multiline": false
                                    },
                                    {
                                        "help": "",
                                        "name": "PRI_LINK",
                                        "type": "text",
                                        "label": "",
                                        "default": "",
                                        "required": false,
                                        "multiline": false
                                    },
                                    {
                                        "help": "",
                                        "name": "TYPE",
                                        "type": "text",
                                        "label": "",
                                        "default": "",
                                        "required": false,
                                        "multiline": false
                                    },
                                    {
                                        "help": "",
                                        "name": "IV",
                                        "type": "number",
                                        "label": "",
                                        "default": null,
                                        "required": false
                                    }
                                ]
                            }
                        },
                        {
                            "id": 140,
                            "module": "app#leonai-priority:CreateDoc",
                            "version": 1,
                            "parameters": {
                                "__IMTCONN__": 12563223
                            },
                            "mapper": {
                                "form": "PINVOICES",
                                "search": {
                                    "DEBIT": "{{145.TYPE}}",
                                    "IVNUM": "{{145.IVNUM}}",
                                    "PIVTYPE": "P"
                                },
                                "EXTFILEDES": "{{103.name}}",
                                "EXTFILENAME": "{{49.data}}"
                            },
                            "metadata": {
                                "designer": {
                                    "x": 6000,
                                    "y": 0
                                },
                                "restore": {
                                    "expect": {
                                        "form": {
                                            "mode": "chose",
                                            "label": "חשבוניות ספק מרכזות"
                                        }
                                    },
                                    "parameters": {
                                        "__IMTCONN__": {
                                            "data": {
                                                "scoped": "true",
                                                "connection": "app#leonai-priority3"
                                            },
                                            "label": "palyam (a011204, tabula.ini)"
                                        }
                                    }
                                },
                                "parameters": [
                                    {
                                        "name": "__IMTCONN__",
                                        "type": "account:app#leonai-priority3",
                                        "label": "Connection",
                                        "required": true
                                    }
                                ],
                                "expect": [
                                    {
                                        "name": "form",
                                        "type": "select",
                                        "label": "Forms",
                                        "required": true
                                    },
                                    {
                                        "name": "hevra",
                                        "type": "text",
                                        "label": "Company \\ Environment"
                                    },
                                    {
                                        "name": "search",
                                        "spec": [
                                            {
                                                "name": "IVNUM",
                                                "type": "text",
                                                "label": "מס. פנימי",
                                                "required": true
                                            },
                                            {
                                                "name": "DEBIT",
                                                "type": "text",
                                                "label": "חיוב/זכוי",
                                                "required": true
                                            },
                                            {
                                                "name": "PIVTYPE",
                                                "type": "hidden",
                                                "label": "סוג",
                                                "required": true
                                            }
                                        ],
                                        "type": "collection",
                                        "label": "Types"
                                    },
                                    {
                                        "name": "EXTFILEDES",
                                        "type": "text",
                                        "label": "File name",
                                        "required": true
                                    },
                                    {
                                        "name": "EXTFILENAME",
                                        "type": "buffer",
                                        "label": "File path / file data",
                                        "required": true
                                    },
                                    {
                                        "name": "NOSEND",
                                        "type": "text",
                                        "label": "Don't send?"
                                    },
                                    {
                                        "name": "STATUS",
                                        "type": "text",
                                        "label": "Status"
                                    },
                                    {
                                        "name": "EI_COND",
                                        "type": "text",
                                        "label": "Electronic interface delivery"
                                    },
                                    {
                                        "name": "suffix",
                                        "type": "text",
                                        "label": "File Suffix",
                                        "validate": {
                                            "max": 4,
                                            "min": 3
                                        }
                                    }
                                ],
                                "interface": [
                                    {
                                        "name": "make",
                                        "spec": [
                                            {
                                                "name": "sufFix",
                                                "type": "text",
                                                "label": "File Suffix"
                                            },
                                            {
                                                "name": "fileData",
                                                "type": "buffer",
                                                "label": "File Data",
                                                "semantic": "file:data"
                                            },
                                            {
                                                "name": "fileName",
                                                "type": "text",
                                                "label": "File Name"
                                            },
                                            {
                                                "name": "fullname",
                                                "type": "filename",
                                                "label": "Full Filename",
                                                "semantic": "file:name"
                                            }
                                        ],
                                        "type": "collection",
                                        "label": "Make"
                                    },
                                    {
                                        "name": "priority",
                                        "spec": [
                                            {
                                                "name": "EXTFILEDES",
                                                "type": "text",
                                                "label": "שם קובץ"
                                            },
                                            {
                                                "name": "EXTFILENUM",
                                                "type": "number",
                                                "label": "מספר מסמך"
                                            },
                                            {
                                                "name": "EXTFILENAME",
                                                "type": "text",
                                                "label": "נתיב הקובץ"
                                            },
                                            {
                                                "name": "SUFFIX",
                                                "type": "text",
                                                "label": "סיומת"
                                            },
                                            {
                                                "name": "CURDATE",
                                                "type": "date",
                                                "label": "תאריך יצירת המסמך"
                                            },
                                            {
                                                "name": "NOSEND",
                                                "type": "text",
                                                "label": "לא לשלוח"
                                            },
                                            {
                                                "name": "STATUS",
                                                "type": "text",
                                                "label": "סטטוס"
                                            },
                                            {
                                                "name": "FILESIZE",
                                                "type": "number",
                                                "label": "גודל קובץ בבתים"
                                            },
                                            {
                                                "name": "EI_COND",
                                                "type": "text",
                                                "label": "משלוח בממשק אלקטרוני"
                                            },
                                            {
                                                "name": "USERLOGIN",
                                                "type": "text",
                                                "label": "עודכן ע\"י"
                                            },
                                            {
                                                "name": "UDATE",
                                                "type": "date",
                                                "label": "ת. עדכון אחרון"
                                            },
                                            {
                                                "name": "LUSERLOGIN",
                                                "type": "text",
                                                "label": "נעול ע\"י"
                                            },
                                            {
                                                "name": "SCAN_PRIORISCAN",
                                                "type": "text",
                                                "label": "פריורי סקאן"
                                            },
                                            {
                                                "name": "NGV_SIGNATURE2",
                                                "type": "text",
                                                "label": "חתימה?"
                                            },
                                            {
                                                "name": "NGV_ADDRESS",
                                                "type": "text",
                                                "label": "כתובת (נייד)"
                                            },
                                            {
                                                "name": "NGV_LATITUDE",
                                                "type": "number",
                                                "label": "קו רוחב (נייד)"
                                            },
                                            {
                                                "name": "NGV_LONGITUDE",
                                                "type": "number",
                                                "label": "קו אורך (נייד)"
                                            },
                                            {
                                                "name": "SCAN_APIUSERLOGIN",
                                                "type": "text",
                                                "label": "שם מייבא הנספח"
                                            },
                                            {
                                                "name": "SCAN_UDATEAPI",
                                                "type": "date",
                                                "label": "ת. יבוא הנספח"
                                            }
                                        ],
                                        "type": "collection",
                                        "label": "Priority"
                                    }
                                ]
                            }
                        },
                        {
                            "id": 143,
                            "module": "scenario-service:CallSubscenario",
                            "version": 2,
                            "parameters": {
                                "scenario": "SCN_7877436",
                                "shouldWaitForExecutionEnd": true
                            },
                            "mapper": {
                                "data": {
                                    "TEXT": "{{113.analyzeResult.content}}",
                                    "IVNUM": "{{145.IV}}",
                                    "SUMMARY": "{{145.ANSWERS}}",
                                    "SUPNAME": "{{118.conf.supplier_id}}",
                                    "FILENAME": "{{103.name}}",
                                    "PRI_LINK": "{{145.PRI_LINK}}",
                                    "App_Number": "68c83949002c2fad7a70e180",
                                    "FILELINKURL": "{{103.webContentLink}}"
                                }
                            },
                            "metadata": {
                                "designer": {
                                    "x": 6300,
                                    "y": 0,
                                    "name": "BASE44"
                                },
                                "restore": {
                                    "parameters": {
                                        "scenario": {
                                            "label": "4-TO_BASE44"
                                        }
                                    }
                                },
                                "parameters": [
                                    {
                                        "name": "scenario",
                                        "type": "scenario",
                                        "label": "Scenario",
                                        "required": true
                                    },
                                    {
                                        "name": "shouldWaitForExecutionEnd",
                                        "type": "boolean",
                                        "label": "Wait for subscenario output",
                                        "required": true
                                    }
                                ],
                                "expect": [
                                    {
                                        "name": "data",
                                        "spec": [
                                            {
                                                "name": "TEXT",
                                                "type": "text",
                                                "label": ""
                                            },
                                            {
                                                "name": "FILENAME",
                                                "type": "text",
                                                "label": ""
                                            },
                                            {
                                                "name": "SUPNAME",
                                                "type": "text",
                                                "label": ""
                                            },
                                            {
                                                "name": "FILELINKURL",
                                                "type": "text",
                                                "label": ""
                                            },
                                            {
                                                "name": "App_Number",
                                                "type": "text",
                                                "label": ""
                                            },
                                            {
                                                "name": "IVNUM",
                                                "type": "text",
                                                "label": ""
                                            },
                                            {
                                                "name": "SUMMARY",
                                                "type": "text",
                                                "label": ""
                                            },
                                            {
                                                "name": "PRI_LINK",
                                                "type": "text",
                                                "label": ""
                                            }
                                        ],
                                        "type": "collection",
                                        "label": "Scenario Inputs"
                                    }
                                ]
                            }
                        }
                    ]
                }
            ]
        }
    ],
    "metadata": {
        "instant": false,
        "version": 1,
        "scenario": {
            "roundtrips": 1,
            "maxErrors": 3,
            "autoCommit": true,
            "autoCommitTriggerLast": true,
            "sequential": false,
            "slots": null,
            "confidential": false,
            "dataloss": false,
            "dlq": false,
            "freshVariables": false
        },
        "designer": {
            "orphans": [
                [
                    {
                        "id": 122,
                        "module": "code:ExecuteCode",
                        "version": 0,
                        "parameters": {},
                        "mapper": {
                            "input": [
                                {
                                    "name": "learned_config",
                                    "value": "{{79.result}}"
                                },
                                {
                                    "name": "docs_list",
                                    "value": "{{`88`}}"
                                },
                                {
                                    "name": "import_files",
                                    "value": "{{`90`}}"
                                },
                                {
                                    "name": "AZURE_RESULT",
                                    "value": "{{114.result}}"
                                },
                                {
                                    "name": "AZURE_TEXT",
                                    "value": "{{112.AZURE_AI_TEXT}}"
                                }
                            ],
                            "language": "javascript",
                            "inputFormat": "editor",
                            "dependencies": [],
                            "codeEditorJavascript": "// ============================================================================\n// קוד עיבוד חשבוניות - קוד 2\n// מקבל: OCR + קובץ הגדרות + תעודות + יבוא\n// מייצר: JSON לפריוריטי\n// ============================================================================\n\nfunction processInvoice(input) {\n    try {\n        // שלב 1: אימות קלט\n        validateInput(input);\n        \n        // שלב 2: זיהוי תבנית\n        const templateIndex = identifyTemplate(\n            input.AZURE_RESULT.data.fields,\n            input.learned_config.config\n        );\n        \n        // שלב 3: עיבוד תעודות\n        const documents = processDocs(input.docs_list);\n        \n        // שלב 4: עיבוד יבוא\n        const importFiles = processImportFiles(input.import_files);\n        \n        // שלב 5: בניית חשבונית\n        const invoice = buildInvoice(\n            input.AZURE_RESULT.data.fields,\n            input.learned_config,\n            templateIndex,\n            documents,\n            importFiles\n        );\n        \n        // שלב 6: בדיקות תקינות\n        const validation = validateInvoice(\n            invoice,\n            input.AZURE_RESULT.data.fields,\n            input.learned_config.config\n        );\n        \n        // שלב 7: החזרת תוצאה\n        return {\n            status: \"success\",\n            supplier_identification: {\n                supplier_code: input.learned_config.supplier_id,\n                supplier_name: input.learned_config.supplier_name,\n                identification_method: \"vendor_tax_id\",\n                confidence: \"high\"\n            },\n            invoice_data: {\n                PINVOICES: [invoice]\n            },\n            validation: validation,\n            metadata: createMetadata(input.AZURE_RESULT.data.fields),\n            learning_analysis: analyzeLearningNeeds(\n                invoice,\n                input.learned_config,\n                input.AZURE_RESULT.data.fields\n            )\n        };\n        \n    } catch (error) {\n        return {\n            status: \"error\",\n            error_type: error.name || \"processing_error\",\n            message: error.message,\n            stack: error.stack\n        };\n    }\n}\n\n// ============================================================================\n// שלב 1: אימות קלט\n// ============================================================================\n\nfunction validateInput(input) {\n    if (!input.AZURE_RESULT || !input.AZURE_RESULT.data) {\n        throw new Error(\"חסר AZURE_RESULT\");\n    }\n    \n    if (!input.learned_config || !input.learned_config.config) {\n        throw new Error(\"חסר learned_config\");\n    }\n    \n    if (input.AZURE_RESULT.status !== \"success\") {\n        throw new Error(\"AZURE_RESULT לא תקין\");\n    }\n    \n    const vendorTaxId = input.AZURE_RESULT.data.fields.VendorTaxId;\n    const configTaxId = input.learned_config.vendor_tax_id_reference;\n    \n    if (vendorTaxId && configTaxId && vendorTaxId !== configTaxId) {\n        throw new Error(\n            `אי התאמה ספק: OCR=${vendorTaxId}, Config=${configTaxId}`\n        );\n    }\n}\n\n// ============================================================================\n// שלב 2: זיהוי תבנית\n// ============================================================================\n\nfunction identifyTemplate(ocrFields, config) {\n    const structures = config.structure;\n    \n    // זיהוי DEBIT\n    const debitType = determineDebitType(ocrFields);\n    \n    // זיהוי תעודות\n    const hasDoc = detectDocuments(ocrFields);\n    \n    // זיהוי יבוא\n    const hasImport = detectImport(ocrFields);\n    \n    // חיפוש תבנית מתאימה\n    for (let i = 0; i < structures.length; i++) {\n        const struct = structures[i];\n        \n        if (struct.debit_type === debitType &&\n            struct.has_doc === hasDoc &&\n            struct.has_import === hasImport) {\n            return i;\n        }\n    }\n    \n    // אם לא נמצא - תבנית ראשונה\n    return 0;\n}\n\nfunction determineDebitType(ocrFields) {\n    const total = ocrFields.InvoiceTotal_amount || 0;\n    return total >= 0 ? \"D\" : \"C\";\n}\n\nfunction detectDocuments(ocrFields) {\n    const unidentified = ocrFields.UnidentifiedNumbers || [];\n    \n    // חיפוש מספרים שמתחילים ב-25 ו-8 ספרות\n    const docPattern = /^25\\d{6}$/;\n    return unidentified.some(num => docPattern.test(num));\n}\n\nfunction detectImport(ocrFields) {\n    // חיפוש IMPFNUM ב-UnidentifiedNumbers\n    const unidentified = ocrFields.UnidentifiedNumbers || [];\n    \n    // דפוס תיק יבוא: XXcXXXXX\n    const impPattern = /^\\d{2}c\\d{5}$/;\n    return unidentified.some(num => impPattern.test(num));\n}\n\n// ============================================================================\n// שלב 3: עיבוד תעודות\n// ============================================================================\n\nfunction processDocs(docsList) {\n    if (!docsList || docsList.DOC_YES_NO !== \"Y\") {\n        return [];\n    }\n    \n    const docs = docsList.list_of_docs || [];\n    \n    return docs.map(docString => {\n        try {\n            return JSON.parse(docString);\n        } catch (e) {\n            return null;\n        }\n    }).filter(doc => doc !== null);\n}\n\n// ============================================================================\n// שלב 4: עיבוד יבוא\n// ============================================================================\n\nfunction processImportFiles(importFiles) {\n    if (!importFiles || !importFiles.IMPFILES || importFiles.IMPFILES.length === 0) {\n        return [];\n    }\n    \n    const rawString = importFiles.IMPFILES[0];\n    \n    if (!rawString) {\n        return [];\n    }\n    \n    try {\n        // תיקון: הוספת [] מסביב\n        const fixedString = '[' + rawString + ']';\n        return JSON.parse(fixedString);\n    } catch (e) {\n        return [];\n    }\n}\n\n// ============================================================================\n// שלב 5: בניית חשבונית\n// ============================================================================\n\nfunction buildInvoice(ocrFields, learnedConfig, templateIndex, documents, importFiles) {\n    const config = learnedConfig.config;\n    const template = learnedConfig.template.PINVOICES[templateIndex];\n    const structure = config.structure[templateIndex];\n    \n    // בניית חשבונית בסיסית\n    const invoice = {\n        SUPNAME: config.supplier_config.supplier_code,\n        CODE: template.CODE,\n        DEBIT: structure.debit_type,\n        IVDATE: convertDate(ocrFields.InvoiceDate),\n        BOOKNUM: extractBooknum(ocrFields.InvoiceId)\n    };\n    \n    // ORDNAME\n    if (structure.has_purchase_orders || (!structure.has_doc && !structure.has_import)) {\n        const ordname = extractOrdname(ocrFields.UnidentifiedNumbers);\n        if (ordname) {\n            invoice.ORDNAME = ordname;\n        }\n    }\n    \n    // IMPFNUM\n    if (structure.has_import) {\n        const impfnum = extractImpfnum(ocrFields.UnidentifiedNumbers, importFiles);\n        if (impfnum) {\n            invoice.IMPFNUM = impfnum;\n        }\n    }\n    \n    // DETAILS\n    if (ocrFields.InvoiceDescription) {\n        invoice.DETAILS = ocrFields.InvoiceDescription;\n    }\n    \n    // תעודות\n    if (structure.has_doc) {\n        addDocuments(invoice, ocrFields.UnidentifiedNumbers, documents);\n    }\n    \n    // פריטים - תמיד להוסיף אם יש Items ב-OCR\n    if (ocrFields.Items && ocrFields.Items.length > 0) {\n        addItems(invoice, ocrFields.Items, config, structure, template);\n    }\n    \n    // PINVOICESCONT_SUBFORM\n    if (template.PINVOICESCONT_SUBFORM) {\n        invoice.PINVOICESCONT_SUBFORM = template.PINVOICESCONT_SUBFORM;\n    }\n    \n    return invoice;\n}\n\n// ============================================================================\n// המרות ועזרים\n// ============================================================================\n\nfunction convertDate(isoDate) {\n    if (!isoDate) return \"\";\n    \n    // \"2025-09-18\" → \"18/09/25\"\n    const date = new Date(isoDate);\n    const day = String(date.getDate()).padStart(2, '0');\n    const month = String(date.getMonth() + 1).padStart(2, '0');\n    const year = String(date.getFullYear()).slice(-2);\n    \n    return `${day}/${month}/${year}`;\n}\n\nfunction extractBooknum(invoiceId) {\n    if (!invoiceId) return \"\";\n    \n    // הסרת קידומת SI אם יש\n    let booknum = String(invoiceId).replace(/^SI/i, '');\n    \n    // לקיחת 6 ספרות אחרונות אם יותר\n    if (booknum.length > 6) {\n        booknum = booknum.slice(-6);\n    }\n    \n    return booknum;\n}\n\nfunction extractOrdname(unidentifiedNumbers) {\n    if (!unidentifiedNumbers) return null;\n    \n    // חיפוש מספר 10 ספרות\n    const ordPattern = /^\\d{10}$/;\n    const found = unidentifiedNumbers.find(num => ordPattern.test(num));\n    \n    return found || null;\n}\n\nfunction extractImpfnum(unidentifiedNumbers, importFiles) {\n    // נסיון 1: מ-UnidentifiedNumbers\n    if (unidentifiedNumbers) {\n        const impPattern = /^\\d{2}c\\d{5}$/;\n        const found = unidentifiedNumbers.find(num => impPattern.test(num));\n        if (found) return found;\n    }\n    \n    // נסיון 2: מרשימת יבוא\n    if (importFiles && importFiles.length > 0) {\n        return importFiles[0].IMPFNUM;\n    }\n    \n    return null;\n}\n\nfunction addDocuments(invoice, unidentifiedNumbers, documentsFromPriority) {\n    const docPattern = /^25\\d{6}$/;\n    const docsFromOCR = (unidentifiedNumbers || [])\n        .filter(num => docPattern.test(num))\n        .map(num => 'SH' + num);\n    \n    // רק אם יש תעודות אמיתיות\n    if (docsFromOCR.length === 0) {\n        return; // אין תעודות - לא להוסיף כלום\n    }\n    \n    if (docsFromOCR.length === 1) {\n        // תעודה אחת\n        invoice.DOCNO = docsFromOCR[0];\n    } else {\n        // תעודות מרובות\n        invoice.PIVDOC_SUBFORM = docsFromOCR.map(booknum => {\n            // חיפוש DOCNO מהרשימה\n            const found = documentsFromPriority.find(d => d.BOOKNUM === booknum);\n            \n            return {\n                DOCNO: found ? found.DOCNO : \"\",\n                BOOKNUM: booknum\n            };\n        });\n    }\n}\n\nfunction addItems(invoice, ocrItems, config, structure, template) {\n    if (!ocrItems || ocrItems.length === 0) {\n        return;\n    }\n    \n    // קבלת ערכי ברירת מחדל מהתבנית\n    const templateItems = template && template.PINVOICEITEMS_SUBFORM \n        ? template.PINVOICEITEMS_SUBFORM \n        : [];\n    \n    const defaultBudcode = templateItems.length > 0 && templateItems[0].BUDCODE \n        ? templateItems[0].BUDCODE \n        : \"\";\n    \n    // אם אין ACCNAME בתבנית, לקחת מ-document_types\n    let defaultAccname = templateItems.length > 0 && templateItems[0].ACCNAME \n        ? templateItems[0].ACCNAME \n        : \"\";\n    \n    if (!defaultAccname && config.document_types && config.document_types.length > 0) {\n        const docType = config.document_types[0];\n        if (docType.accnames && docType.accnames.length > 0) {\n            defaultAccname = docType.accnames[0];\n        }\n    }\n    \n    const items = ocrItems.map(ocrItem => {\n        const item = {\n            PARTNAME: extractPartname(ocrItem.ProductCode),\n            PDES: ocrItem.Description || \"\",\n            TQUANT: ocrItem.Quantity || 1,\n            TUNITNAME: ocrItem.Unit || \"יח'\",\n            PRICE: ocrItem.UnitPrice_amount || 0,\n            VATFLAG: \"Y\",\n            ACCNAME: defaultAccname // ברירת מחדל\n        };\n        \n        // חוקי רכבים - דורסים את ברירת המחדל\n        if (item.PARTNAME === \"car\") {\n            applyVehicleRules(item, ocrItem.Description, config.rules.critical_patterns.vehicle_rules);\n        }\n        \n        // חוקי מקטים - דורסים את ברירת המחדל\n        applyPartnameRules(item, config.rules.critical_patterns.partname_rules);\n        \n        // BUDCODE\n        if (structure.has_budcode && defaultBudcode) {\n            item.BUDCODE = defaultBudcode;\n        }\n        \n        return item;\n    });\n    \n    invoice.PINVOICEITEMS_SUBFORM = items;\n}\n\nfunction extractPartname(productCode) {\n    if (!productCode) return \"\";\n    \n    // אם יש \\n - לקחת את החלק הראשון\n    const codes = String(productCode).split('\\n');\n    \n    // לקחת את הקוד שמתחיל באות גדולה או המספרי\n    const priorityCode = codes.find(c => /^[A-Z]/.test(c) || /^\\d+$/.test(c));\n    \n    return priorityCode || codes[0] || \"\";\n}\n\nfunction applyVehicleRules(item, description, vehicleRules) {\n    if (!vehicleRules || !vehicleRules.vehicle_account_mapping) {\n        return;\n    }\n    \n    // חילוץ מספר רכב מתיאור\n    const vehicleMatch = description.match(/\\d{3}-\\d{2}-\\d{3}/);\n    \n    if (!vehicleMatch) {\n        return;\n    }\n    \n    const vehicleNum = vehicleMatch[0];\n    const mapping = vehicleRules.vehicle_account_mapping[vehicleNum];\n    \n    if (mapping) {\n        item.ACCNAME = mapping.accname;\n        item.VATFLAG = mapping.vat_pattern.VATFLAG;\n        \n        if (mapping.vat_pattern.SPECIALVATFLAG && \n            mapping.vat_pattern.SPECIALVATFLAG !== \"varies\") {\n            item.SPECIALVATFLAG = mapping.vat_pattern.SPECIALVATFLAG;\n        }\n    }\n}\n\nfunction applyPartnameRules(item, partnameRules) {\n    if (!partnameRules || Object.keys(partnameRules).length === 0) {\n        return;\n    }\n    \n    const rule = partnameRules[item.PARTNAME];\n    \n    if (rule) {\n        if (rule.accname) {\n            item.ACCNAME = rule.accname;\n        }\n        if (rule.vatflag) {\n            item.VATFLAG = rule.vatflag;\n        }\n        if (rule.specialvatflag) {\n            item.SPECIALVATFLAG = rule.specialvatflag;\n        }\n    }\n}\n\n// ============================================================================\n// שלב 6: בדיקות תקינות\n// ============================================================================\n\nfunction validateInvoice(invoice, ocrFields, config) {\n    const warnings = [];\n    \n    // בדיקת TOTQUANT - רק שיש פריטים\n    let totquant = 0;\n    if (invoice.PINVOICEITEMS_SUBFORM) {\n        totquant = invoice.PINVOICEITEMS_SUBFORM.reduce(\n            (sum, item) => sum + (item.TQUANT || 0), \n            0\n        );\n    }\n    \n    const hasTotquant = totquant > 0;\n    \n    if (!hasTotquant && config.structure[0].inventory_management === \"managed_inventory\") {\n        warnings.push(\"חסרים פריטים - TOTQUANT=0\");\n    }\n    \n    // בדיקת שדות חובה\n    const missingFields = [];\n    \n    if (!invoice.SUPNAME) missingFields.push(\"SUPNAME\");\n    if (!invoice.CODE) missingFields.push(\"CODE\");\n    if (!invoice.DEBIT) missingFields.push(\"DEBIT\");\n    if (!invoice.IVDATE) missingFields.push(\"IVDATE\");\n    if (!invoice.BOOKNUM) missingFields.push(\"BOOKNUM\");\n    \n    if (missingFields.length > 0) {\n        warnings.push(`שדות חובה חסרים: ${missingFields.join(', ')}`);\n    }\n    \n    // בדיקת חשבונות ריקים\n    if (invoice.PINVOICEITEMS_SUBFORM) {\n        const emptyAccounts = invoice.PINVOICEITEMS_SUBFORM.filter(\n            item => !item.ACCNAME || item.ACCNAME === \"\"\n        );\n        \n        if (emptyAccounts.length > 0) {\n            warnings.push(`${emptyAccounts.length} פריטים ללא חשבון (ACCNAME)`);\n        }\n    }\n    \n    return {\n        all_valid: warnings.length === 0,\n        totquant: totquant,\n        has_items: hasTotquant,\n        template_matched: true,\n        warnings: warnings\n    };\n}\n\n// ============================================================================\n// שלב 7: ניתוח צרכי למידה\n// ============================================================================\n\nfunction analyzeLearningNeeds(invoice, learnedConfig, ocrFields) {\n    const config = learnedConfig.config;\n    const newPatterns = {\n        new_partnames: [],\n        new_vehicles: [],\n        unknown_accounts: [],\n        new_budcodes: []\n    };\n    \n    const learningInstructions = [];\n    \n    // ניתוח פריטים\n    if (invoice.PINVOICEITEMS_SUBFORM) {\n        invoice.PINVOICEITEMS_SUBFORM.forEach(item => {\n            // מקט חדש?\n            const partnameExists = checkIfPartnameKnown(item.PARTNAME, config);\n            if (!partnameExists) {\n                newPatterns.new_partnames.push({\n                    partname: item.PARTNAME,\n                    pdes: item.PDES,\n                    suggested_accname: item.ACCNAME,\n                    occurrences: 1\n                });\n                \n                learningInstructions.push({\n                    type: \"add_partname_rule\",\n                    partname: item.PARTNAME,\n                    pdes: item.PDES,\n                    suggested_accname: item.ACCNAME,\n                    vatflag: item.VATFLAG,\n                    specialvatflag: item.SPECIALVATFLAG || null,\n                    priority: \"medium\"\n                });\n            }\n            \n            // רכב חדש?\n            if (item.PARTNAME === \"car\") {\n                const vehicleNum = extractVehicleNumber(item.PDES);\n                if (vehicleNum) {\n                    const vehicleExists = checkIfVehicleKnown(vehicleNum, config);\n                    if (!vehicleExists) {\n                        newPatterns.new_vehicles.push({\n                            vehicle_number: vehicleNum,\n                            description: item.PDES,\n                            suggested_accname: item.ACCNAME,\n                            occurrences: 1\n                        });\n                        \n                        learningInstructions.push({\n                            type: \"add_vehicle_rule\",\n                            vehicle_number: vehicleNum,\n                            suggested_accname: item.ACCNAME,\n                            vat_pattern: {\n                                VATFLAG: item.VATFLAG,\n                                SPECIALVATFLAG: item.SPECIALVATFLAG || \"\"\n                            },\n                            priority: \"high\"\n                        });\n                    }\n                }\n            }\n            \n            // חשבון לא ידוע?\n            if (!item.ACCNAME || item.ACCNAME === \"\") {\n                newPatterns.unknown_accounts.push({\n                    partname: item.PARTNAME,\n                    pdes: item.PDES,\n                    needs_mapping: true\n                });\n                \n                learningInstructions.push({\n                    type: \"missing_account\",\n                    partname: item.PARTNAME,\n                    pdes: item.PDES,\n                    priority: \"critical\"\n                });\n            }\n            \n            // BUDCODE חדש?\n            if (item.BUDCODE) {\n                const budcodeExists = checkIfBudcodeKnown(item.BUDCODE, config, learnedConfig);\n                if (!budcodeExists) {\n                    newPatterns.new_budcodes.push(item.BUDCODE);\n                }\n            }\n        });\n    }\n    \n    // סיכום\n    const learningRequired = \n        newPatterns.new_partnames.length > 0 ||\n        newPatterns.new_vehicles.length > 0 ||\n        newPatterns.unknown_accounts.length > 0 ||\n        newPatterns.new_budcodes.length > 0;\n    \n    return {\n        learning_required: learningRequired,\n        new_patterns: newPatterns,\n        learning_instructions: learningInstructions,\n        confidence_score: calculateConfidenceScore(newPatterns, invoice),\n        recommendation: learningRequired \n            ? \"שלח לקוד 3 ללמידה מתקדמת\" \n            : \"אין צורך בלמידה נוספת\"\n    };\n}\n\nfunction checkIfPartnameKnown(partname, config) {\n    // בדיקה אם המקט קיים בחוקים\n    if (!config.rules.critical_patterns.partname_rules) {\n        return false;\n    }\n    \n    return config.rules.critical_patterns.partname_rules.hasOwnProperty(partname);\n}\n\nfunction checkIfVehicleKnown(vehicleNum, config) {\n    // בדיקה אם הרכב קיים במיפוי\n    if (!config.rules.critical_patterns.vehicle_rules || \n        !config.rules.critical_patterns.vehicle_rules.vehicle_account_mapping) {\n        return false;\n    }\n    \n    return config.rules.critical_patterns.vehicle_rules.vehicle_account_mapping\n        .hasOwnProperty(vehicleNum);\n}\n\nfunction checkIfBudcodeKnown(budcode, config, learnedConfig) {\n    // בדיקה פשוטה - אם יש BUDCODE בתבנית\n    const template = learnedConfig.template;\n    if (template && template.PINVOICES && template.PINVOICES.length > 0) {\n        const firstInvoice = template.PINVOICES[0];\n        if (firstInvoice.PINVOICEITEMS_SUBFORM) {\n            return firstInvoice.PINVOICEITEMS_SUBFORM.some(\n                item => item.BUDCODE === budcode\n            );\n        }\n    }\n    return false;\n}\n\nfunction extractVehicleNumber(description) {\n    if (!description) return null;\n    \n    const match = description.match(/\\d{3}-\\d{2}-\\d{3}/);\n    return match ? match[0] : null;\n}\n\nfunction calculateConfidenceScore(newPatterns, invoice) {\n    let score = 100;\n    \n    // הורדת ציון על כל חוסר\n    score -= newPatterns.unknown_accounts.length * 20;\n    score -= newPatterns.new_partnames.length * 5;\n    score -= newPatterns.new_vehicles.length * 10;\n    \n    // לא לרדת מתחת ל-0\n    return Math.max(0, score);\n}\n\n// ============================================================================\n// שלב 8: מטא-דאטה\n// ============================================================================\n\nfunction createMetadata(ocrFields) {\n    return {\n        ocr_invoice_id: ocrFields.InvoiceId || \"\",\n        ocr_invoice_date: ocrFields.InvoiceDate || \"\",\n        ocr_total_amount: ocrFields.InvoiceTotal_amount || 0,\n        ocr_vendor_tax_id: ocrFields.VendorTaxId || \"\",\n        processing_timestamp: new Date().toISOString()\n    };\n}\n\n// ============================================================================\n// פרסור INPUT מ-Make\n// ============================================================================\n\nfunction parseInputFromMake(makeInput) {\n    console.error(\"DEBUG - Raw input type:\", typeof makeInput);\n    console.error(\"DEBUG - Is array:\", Array.isArray(makeInput));\n    \n    // אם זה לא מערך, להחזיר כמו שזה\n    if (!Array.isArray(makeInput)) {\n        return makeInput;\n    }\n    \n    // אם המערך ריק\n    if (makeInput.length === 0) {\n        return {};\n    }\n    \n    const firstItem = makeInput[0];\n    console.error(\"DEBUG - First item keys:\", Object.keys(firstItem));\n    \n    // אם יש InputArray\n    if (firstItem.InputArray && Array.isArray(firstItem.InputArray)) {\n        const result = {};\n        \n        console.error(\"DEBUG - InputArray length:\", firstItem.InputArray.length);\n        \n        firstItem.InputArray.forEach((item, index) => {\n            console.error(`DEBUG - Item ${index}:`, {\n                name: item.name,\n                hasValue: item.value !== undefined,\n                hasValueCollection: item.valueCollection !== undefined\n            });\n            \n            // בחירת הערך הנכון\n            let value = null;\n            \n            if (item.valueCollection !== undefined) {\n                value = item.valueCollection;\n            } else if (item.value !== undefined) {\n                value = item.value;\n            }\n            \n            if (item.name && value !== null) {\n                result[item.name] = value;\n                console.error(`DEBUG - Added ${item.name}`);\n            }\n        });\n        \n        console.error(\"DEBUG - Final keys:\", Object.keys(result));\n        return result;\n    }\n    \n    // אחרת להחזיר את הפריט הראשון\n    return firstItem;\n}\n\n// ============================================================================\n// נקודת כניסה ראשית\n// ============================================================================\n\n// Make מעביר את המשתנים דרך object בשם 'input'\n\nconst processInput = {\n    learned_config: input.learned_config,\n    docs_list: input.docs_list,\n    import_files: input.import_files,\n    AZURE_RESULT: input.AZURE_RESULT,\n    AZURE_TEXT: input.AZURE_TEXT\n};\n\nconst result = processInvoice(processInput);\n\n// כיסוי כפול - גם stdout וגם return\nconsole.log(JSON.stringify(result));\nreturn result;"
                        },
                        "metadata": {
                            "designer": {
                                "x": 0,
                                "y": 300,
                                "messages": [
                                    {
                                        "category": "reference",
                                        "severity": "error",
                                        "message": "Module references non-existing module '88'."
                                    },
                                    {
                                        "category": "reference",
                                        "severity": "warning",
                                        "message": "Referenced module 'Make Code - Run code' [79] is not accessible."
                                    },
                                    {
                                        "category": "reference",
                                        "severity": "warning",
                                        "message": "Referenced module 'Scenarios - Call a subscenario' [90] is not accessible."
                                    },
                                    {
                                        "category": "reference",
                                        "severity": "warning",
                                        "message": "Referenced module 'Scenarios - Call a subscenario' [112] is not accessible."
                                    },
                                    {
                                        "category": "reference",
                                        "severity": "warning",
                                        "message": "Referenced module 'Make Code - Run code' [114] is not accessible."
                                    },
                                    {
                                        "category": "link",
                                        "severity": "warning",
                                        "message": "The module is not connected to the data flow."
                                    }
                                ]
                            },
                            "restore": {
                                "expect": {
                                    "input": {
                                        "items": [
                                            null,
                                            null,
                                            null,
                                            null,
                                            null
                                        ]
                                    },
                                    "language": {
                                        "mode": "chose",
                                        "label": "JavaScript"
                                    },
                                    "inputFormat": {
                                        "label": "Code editor"
                                    }
                                }
                            },
                            "expect": [
                                {
                                    "name": "language",
                                    "type": "select",
                                    "label": "Language",
                                    "required": true,
                                    "validate": {
                                        "enum": [
                                            "javascript",
                                            "python"
                                        ]
                                    }
                                },
                                {
                                    "name": "input",
                                    "spec": {
                                        "name": "value",
                                        "spec": [
                                            {
                                                "name": "name",
                                                "type": "text",
                                                "label": "Name",
                                                "required": true,
                                                "validate": {
                                                    "max": 32,
                                                    "min": 1,
                                                    "pattern": "^[a-zA-Z0-9_]{1,32}$"
                                                }
                                            },
                                            {
                                                "name": "value",
                                                "type": "any",
                                                "label": "Value",
                                                "required": true
                                            }
                                        ],
                                        "type": "collection",
                                        "label": "Variable"
                                    },
                                    "type": "array",
                                    "label": "Input"
                                },
                                {
                                    "name": "dependencies",
                                    "spec": {
                                        "name": "value",
                                        "type": "text",
                                        "label": "Dependency",
                                        "required": true,
                                        "validate": {
                                            "max": 214,
                                            "min": 1,
                                            "pattern": "^[A-Za-z0-9_@\\./<>\\=\\!~\\^+\\-]{1,214}$"
                                        }
                                    },
                                    "type": "array",
                                    "label": "Additional dependencies (Enterprise plans only)"
                                },
                                {
                                    "name": "inputFormat",
                                    "type": "select",
                                    "label": "Input format",
                                    "required": true,
                                    "validate": {
                                        "enum": [
                                            "editor",
                                            "string"
                                        ]
                                    }
                                },
                                {
                                    "name": "codeEditorJavascript",
                                    "type": "editor",
                                    "label": "Code",
                                    "required": true
                                }
                            ]
                        }
                    },
                    {
                        "id": 123,
                        "module": "code:ExecuteCode",
                        "version": 0,
                        "parameters": {},
                        "mapper": {
                            "input": [
                                {
                                    "name": "learned_config",
                                    "value": "{{79.result}}"
                                },
                                {
                                    "name": "docs_list",
                                    "value": "{{`88`}}"
                                },
                                {
                                    "name": "import_files",
                                    "value": "{{`90`}}"
                                },
                                {
                                    "name": "AZURE_RESULT",
                                    "value": "{{114.result}}"
                                },
                                {
                                    "name": "AZURE_TEXT",
                                    "value": "{{112.AZURE_AI_TEXT}}"
                                }
                            ],
                            "language": "javascript",
                            "inputFormat": "editor",
                            "dependencies": [],
                            "codeEditorJavascript": "// ============================================================================\n// קוד עיבוד חשבוניות - קוד 2\n// מקבל: OCR + קובץ הגדרות + תעודות + יבוא\n// מייצר: JSON לפריוריטי\n// ============================================================================\n\nfunction processInvoice(input) {\n    try {\n        // שלב 1: אימות קלט\n        validateInput(input);\n        \n        // שלב 2: זיהוי תבנית\n        const templateIndex = identifyTemplate(\n            input.AZURE_RESULT.data.fields,\n            input.learned_config.config\n        );\n        \n        // שלב 3: עיבוד תעודות\n        const documents = processDocs(input.docs_list);\n        \n        // שלב 4: עיבוד יבוא\n        const importFiles = processImportFiles(input.import_files);\n        \n        // שלב 5: בניית חשבונית\n        const invoice = buildInvoice(\n            input.AZURE_RESULT.data.fields,\n            input.learned_config,\n            templateIndex,\n            documents,\n            importFiles\n        );\n        \n        // שלב 6: בדיקות תקינות\n        const validation = validateInvoice(\n            invoice,\n            input.AZURE_RESULT.data.fields,\n            input.learned_config.config\n        );\n        \n        // שלב 7: החזרת תוצאה\n        return {\n            status: \"success\",\n            supplier_identification: {\n                supplier_code: input.learned_config.supplier_id,\n                supplier_name: input.learned_config.supplier_name,\n                identification_method: \"vendor_tax_id\",\n                confidence: \"high\"\n            },\n            invoice_data: {\n                PINVOICES: [invoice]\n            },\n            validation: validation,\n            metadata: createMetadata(input.AZURE_RESULT.data.fields),\n            learning_analysis: analyzeLearningNeeds(\n                invoice,\n                input.learned_config,\n                input.AZURE_RESULT.data.fields\n            )\n        };\n        \n    } catch (error) {\n        return {\n            status: \"error\",\n            error_type: error.name || \"processing_error\",\n            message: error.message,\n            stack: error.stack\n        };\n    }\n}\n\n// ============================================================================\n// שלב 1: אימות קלט\n// ============================================================================\n\nfunction validateInput(input) {\n    if (!input.AZURE_RESULT || !input.AZURE_RESULT.data) {\n        throw new Error(\"חסר AZURE_RESULT\");\n    }\n    \n    if (!input.learned_config || !input.learned_config.config) {\n        throw new Error(\"חסר learned_config\");\n    }\n    \n    if (input.AZURE_RESULT.status !== \"success\") {\n        throw new Error(\"AZURE_RESULT לא תקין\");\n    }\n    \n    const vendorTaxId = input.AZURE_RESULT.data.fields.VendorTaxId;\n    const configTaxId = input.learned_config.vendor_tax_id_reference;\n    \n    if (vendorTaxId && configTaxId && vendorTaxId !== configTaxId) {\n        throw new Error(\n            `אי התאמה ספק: OCR=${vendorTaxId}, Config=${configTaxId}`\n        );\n    }\n}\n\n// ============================================================================\n// שלב 2: זיהוי תבנית\n// ============================================================================\n\nfunction identifyTemplate(ocrFields, config) {\n    const structures = config.structure;\n    \n    // זיהוי DEBIT\n    const debitType = determineDebitType(ocrFields);\n    \n    // זיהוי תעודות\n    const hasDoc = detectDocuments(ocrFields);\n    \n    // זיהוי יבוא\n    const hasImport = detectImport(ocrFields);\n    \n    // חיפוש תבנית מתאימה\n    for (let i = 0; i < structures.length; i++) {\n        const struct = structures[i];\n        \n        if (struct.debit_type === debitType &&\n            struct.has_doc === hasDoc &&\n            struct.has_import === hasImport) {\n            return i;\n        }\n    }\n    \n    // אם לא נמצא - תבנית ראשונה\n    return 0;\n}\n\nfunction determineDebitType(ocrFields) {\n    const total = ocrFields.InvoiceTotal_amount || 0;\n    return total >= 0 ? \"D\" : \"C\";\n}\n\nfunction detectDocuments(ocrFields) {\n    const unidentified = ocrFields.UnidentifiedNumbers || [];\n    \n    // חיפוש מספרים שמתחילים ב-25 ו-8 ספרות\n    const docPattern = /^25\\d{6}$/;\n    return unidentified.some(num => docPattern.test(num));\n}\n\nfunction detectDocumentsInOCR(unidentifiedNumbers) {\n    if (!unidentifiedNumbers || unidentifiedNumbers.length === 0) {\n        return false;\n    }\n    \n    // חיפוש מספרים שמתחילים ב-25 ו-8 ספרות\n    const docPattern = /^25\\d{6}$/;\n    return unidentifiedNumbers.some(num => docPattern.test(num));\n}\n\nfunction detectImport(ocrFields) {\n    // חיפוש IMPFNUM ב-UnidentifiedNumbers\n    const unidentified = ocrFields.UnidentifiedNumbers || [];\n    \n    // דפוס תיק יבוא: XXcXXXXX\n    const impPattern = /^\\d{2}c\\d{5}$/;\n    return unidentified.some(num => impPattern.test(num));\n}\n\n// ============================================================================\n// שלב 3: עיבוד תעודות\n// ============================================================================\n\nfunction processDocs(docsList) {\n    if (!docsList || docsList.DOC_YES_NO !== \"Y\") {\n        return [];\n    }\n    \n    const docs = docsList.list_of_docs || [];\n    \n    return docs.map(docString => {\n        try {\n            return JSON.parse(docString);\n        } catch (e) {\n            return null;\n        }\n    }).filter(doc => doc !== null);\n}\n\n// ============================================================================\n// שלב 4: עיבוד יבוא\n// ============================================================================\n\nfunction processImportFiles(importFiles) {\n    if (!importFiles || !importFiles.IMPFILES || importFiles.IMPFILES.length === 0) {\n        return [];\n    }\n    \n    const rawString = importFiles.IMPFILES[0];\n    \n    if (!rawString) {\n        return [];\n    }\n    \n    try {\n        // תיקון: הוספת [] מסביב\n        const fixedString = '[' + rawString + ']';\n        return JSON.parse(fixedString);\n    } catch (e) {\n        return [];\n    }\n}\n\n// ============================================================================\n// שלב 5: בניית חשבונית\n// ============================================================================\n\nfunction buildInvoice(ocrFields, learnedConfig, templateIndex, documents, importFiles) {\n    const config = learnedConfig.config;\n    const template = learnedConfig.template.PINVOICES[templateIndex];\n    const structure = config.structure[templateIndex];\n    \n    // בניית חשבונית בסיסית\n    const invoice = {\n        SUPNAME: config.supplier_config.supplier_code,\n        CODE: template.CODE,\n        DEBIT: structure.debit_type,\n        IVDATE: convertDate(ocrFields.InvoiceDate),\n        BOOKNUM: extractBooknum(ocrFields.InvoiceId)\n    };\n    \n    // ORDNAME\n    if (structure.has_purchase_orders || (!structure.has_doc && !structure.has_import)) {\n        const ordname = extractOrdname(ocrFields.UnidentifiedNumbers);\n        if (ordname) {\n            invoice.ORDNAME = ordname;\n        }\n    }\n    \n    // IMPFNUM\n    if (structure.has_import) {\n        const impfnum = extractImpfnum(ocrFields.UnidentifiedNumbers, importFiles);\n        if (impfnum) {\n            invoice.IMPFNUM = impfnum;\n        }\n    }\n    \n    // DETAILS\n    if (ocrFields.InvoiceDescription) {\n        invoice.DETAILS = ocrFields.InvoiceDescription;\n    }\n    \n    // תעודות - קודם כל בודקים אם יש\n    const hasDocsInOCR = detectDocumentsInOCR(ocrFields.UnidentifiedNumbers);\n    \n    // Debug\n    if (structure.has_doc) {\n        console.error(\"DEBUG - has_doc: true\");\n        console.error(\"DEBUG - UnidentifiedNumbers:\", ocrFields.UnidentifiedNumbers);\n        console.error(\"DEBUG - hasDocsInOCR:\", hasDocsInOCR);\n    }\n    \n    if (structure.has_doc && hasDocsInOCR) {\n        addDocuments(invoice, ocrFields.UnidentifiedNumbers, documents);\n        console.error(\"DEBUG - Added documents to invoice\");\n    }\n    \n    // פריטים - רק לפי הכללים\n    const shouldAddItems = \n        (!structure.has_doc) || // אם אין תעודות בכלל\n        (structure.has_doc && !hasDocsInOCR) || // יש תעודות בתבנית אבל לא במסמך\n        (structure.has_doc && structure.inventory_management === \"not_managed_inventory\"); // תעודות + מלאי לא מנוהל\n    \n    if (shouldAddItems && ocrFields.Items && ocrFields.Items.length > 0) {\n        addItems(invoice, ocrFields.Items, config, structure, template);\n    }\n    \n    // PINVOICESCONT_SUBFORM\n    if (template.PINVOICESCONT_SUBFORM) {\n        invoice.PINVOICESCONT_SUBFORM = template.PINVOICESCONT_SUBFORM;\n    }\n    \n    return invoice;\n}\n\n// ============================================================================\n// המרות ועזרים\n// ============================================================================\n\nfunction convertDate(isoDate) {\n    if (!isoDate) return \"\";\n    \n    // \"2025-09-18\" → \"18/09/25\"\n    const date = new Date(isoDate);\n    const day = String(date.getDate()).padStart(2, '0');\n    const month = String(date.getMonth() + 1).padStart(2, '0');\n    const year = String(date.getFullYear()).slice(-2);\n    \n    return `${day}/${month}/${year}`;\n}\n\nfunction extractBooknum(invoiceId) {\n    if (!invoiceId) return \"\";\n    \n    // הסרת קידומת SI אם יש\n    let booknum = String(invoiceId).replace(/^SI/i, '');\n    \n    // לקיחת 6 ספרות אחרונות אם יותר\n    if (booknum.length > 6) {\n        booknum = booknum.slice(-6);\n    }\n    \n    return booknum;\n}\n\nfunction extractOrdname(unidentifiedNumbers) {\n    if (!unidentifiedNumbers) return null;\n    \n    // חיפוש מספר 10 ספרות\n    const ordPattern = /^\\d{10}$/;\n    const found = unidentifiedNumbers.find(num => ordPattern.test(num));\n    \n    return found || null;\n}\n\nfunction extractImpfnum(unidentifiedNumbers, importFiles) {\n    // נסיון 1: מ-UnidentifiedNumbers\n    if (unidentifiedNumbers) {\n        const impPattern = /^\\d{2}c\\d{5}$/;\n        const found = unidentifiedNumbers.find(num => impPattern.test(num));\n        if (found) return found;\n    }\n    \n    // נסיון 2: מרשימת יבוא\n    if (importFiles && importFiles.length > 0) {\n        return importFiles[0].IMPFNUM;\n    }\n    \n    return null;\n}\n\nfunction addDocuments(invoice, unidentifiedNumbers, documentsFromPriority) {\n    const docPattern = /^25\\d{6}$/;\n    const docsFromOCR = (unidentifiedNumbers || [])\n        .filter(num => docPattern.test(num))\n        .map(num => 'SH' + num);\n    \n    // רק אם יש תעודות אמיתיות\n    if (docsFromOCR.length === 0) {\n        return; // אין תעודות - לא להוסיף כלום\n    }\n    \n    if (docsFromOCR.length === 1) {\n        // תעודה אחת\n        invoice.DOCNO = docsFromOCR[0];\n    } else {\n        // תעודות מרובות\n        invoice.PIVDOC_SUBFORM = docsFromOCR.map(booknum => {\n            // חיפוש DOCNO מהרשימה\n            const found = documentsFromPriority.find(d => d.BOOKNUM === booknum);\n            \n            return {\n                DOCNO: found ? found.DOCNO : \"\",\n                BOOKNUM: booknum\n            };\n        });\n    }\n}\n\nfunction addItems(invoice, ocrItems, config, structure, template) {\n    if (!ocrItems || ocrItems.length === 0) {\n        return;\n    }\n    \n    // קבלת ערכי ברירת מחדל מהתבנית\n    const templateItems = template && template.PINVOICEITEMS_SUBFORM \n        ? template.PINVOICEITEMS_SUBFORM \n        : [];\n    \n    const defaultBudcode = templateItems.length > 0 && templateItems[0].BUDCODE \n        ? templateItems[0].BUDCODE \n        : \"\";\n    \n    // אם אין ACCNAME בתבנית, לקחת מ-document_types\n    let defaultAccname = templateItems.length > 0 && templateItems[0].ACCNAME \n        ? templateItems[0].ACCNAME \n        : \"\";\n    \n    if (!defaultAccname && config.document_types && config.document_types.length > 0) {\n        const docType = config.document_types[0];\n        if (docType.accnames && docType.accnames.length > 0) {\n            defaultAccname = docType.accnames[0];\n        }\n    }\n    \n    const items = ocrItems.map(ocrItem => {\n        const item = {\n            PARTNAME: extractPartname(ocrItem.ProductCode),\n            PDES: ocrItem.Description || \"\",\n            TQUANT: ocrItem.Quantity || 1,\n            TUNITNAME: ocrItem.Unit || \"יח'\",\n            PRICE: ocrItem.UnitPrice_amount || 0,\n            VATFLAG: \"Y\",\n            ACCNAME: defaultAccname // ברירת מחדל\n        };\n        \n        // חוקי רכבים - דורסים את ברירת המחדל\n        if (item.PARTNAME === \"car\") {\n            applyVehicleRules(item, ocrItem.Description, config.rules.critical_patterns.vehicle_rules);\n        }\n        \n        // חוקי מקטים - דורסים את ברירת המחדל\n        applyPartnameRules(item, config.rules.critical_patterns.partname_rules);\n        \n        // BUDCODE\n        if (structure.has_budcode && defaultBudcode) {\n            item.BUDCODE = defaultBudcode;\n        }\n        \n        return item;\n    });\n    \n    invoice.PINVOICEITEMS_SUBFORM = items;\n}\n\nfunction extractPartname(productCode) {\n    if (!productCode) return \"\";\n    \n    // אם יש \\n - לקחת את החלק הראשון\n    const codes = String(productCode).split('\\n');\n    \n    // לקחת את הקוד שמתחיל באות גדולה או המספרי\n    const priorityCode = codes.find(c => /^[A-Z]/.test(c) || /^\\d+$/.test(c));\n    \n    return priorityCode || codes[0] || \"\";\n}\n\nfunction applyVehicleRules(item, description, vehicleRules) {\n    if (!vehicleRules || !vehicleRules.vehicle_account_mapping) {\n        return;\n    }\n    \n    // חילוץ מספר רכב מתיאור\n    const vehicleMatch = description.match(/\\d{3}-\\d{2}-\\d{3}/);\n    \n    if (!vehicleMatch) {\n        return;\n    }\n    \n    const vehicleNum = vehicleMatch[0];\n    const mapping = vehicleRules.vehicle_account_mapping[vehicleNum];\n    \n    if (mapping) {\n        item.ACCNAME = mapping.accname;\n        item.VATFLAG = mapping.vat_pattern.VATFLAG;\n        \n        if (mapping.vat_pattern.SPECIALVATFLAG && \n            mapping.vat_pattern.SPECIALVATFLAG !== \"varies\") {\n            item.SPECIALVATFLAG = mapping.vat_pattern.SPECIALVATFLAG;\n        }\n    }\n}\n\nfunction applyPartnameRules(item, partnameRules) {\n    if (!partnameRules || Object.keys(partnameRules).length === 0) {\n        return;\n    }\n    \n    const rule = partnameRules[item.PARTNAME];\n    \n    if (rule) {\n        if (rule.accname) {\n            item.ACCNAME = rule.accname;\n        }\n        if (rule.vatflag) {\n            item.VATFLAG = rule.vatflag;\n        }\n        if (rule.specialvatflag) {\n            item.SPECIALVATFLAG = rule.specialvatflag;\n        }\n    }\n}\n\n// ============================================================================\n// שלב 6: בדיקות תקינות\n// ============================================================================\n\nfunction validateInvoice(invoice, ocrFields, config) {\n    const warnings = [];\n    \n    // בדיקת TOTQUANT - רק שיש פריטים\n    let totquant = 0;\n    if (invoice.PINVOICEITEMS_SUBFORM) {\n        totquant = invoice.PINVOICEITEMS_SUBFORM.reduce(\n            (sum, item) => sum + (item.TQUANT || 0), \n            0\n        );\n    }\n    \n    const hasTotquant = totquant > 0;\n    \n    if (!hasTotquant && config.structure[0].inventory_management === \"managed_inventory\") {\n        warnings.push(\"חסרים פריטים - TOTQUANT=0\");\n    }\n    \n    // בדיקת שדות חובה\n    const missingFields = [];\n    \n    if (!invoice.SUPNAME) missingFields.push(\"SUPNAME\");\n    if (!invoice.CODE) missingFields.push(\"CODE\");\n    if (!invoice.DEBIT) missingFields.push(\"DEBIT\");\n    if (!invoice.IVDATE) missingFields.push(\"IVDATE\");\n    if (!invoice.BOOKNUM) missingFields.push(\"BOOKNUM\");\n    \n    if (missingFields.length > 0) {\n        warnings.push(`שדות חובה חסרים: ${missingFields.join(', ')}`);\n    }\n    \n    // בדיקת חשבונות ריקים\n    if (invoice.PINVOICEITEMS_SUBFORM) {\n        const emptyAccounts = invoice.PINVOICEITEMS_SUBFORM.filter(\n            item => !item.ACCNAME || item.ACCNAME === \"\"\n        );\n        \n        if (emptyAccounts.length > 0) {\n            warnings.push(`${emptyAccounts.length} פריטים ללא חשבון (ACCNAME)`);\n        }\n    }\n    \n    return {\n        all_valid: warnings.length === 0,\n        totquant: totquant,\n        has_items: hasTotquant,\n        template_matched: true,\n        warnings: warnings\n    };\n}\n\n// ============================================================================\n// שלב 7: ניתוח צרכי למידה\n// ============================================================================\n\nfunction analyzeLearningNeeds(invoice, learnedConfig, ocrFields) {\n    const config = learnedConfig.config;\n    const newPatterns = {\n        new_partnames: [],\n        new_vehicles: [],\n        unknown_accounts: [],\n        new_budcodes: []\n    };\n    \n    const learningInstructions = [];\n    \n    // ניתוח פריטים\n    if (invoice.PINVOICEITEMS_SUBFORM) {\n        invoice.PINVOICEITEMS_SUBFORM.forEach(item => {\n            // מקט חדש?\n            const partnameExists = checkIfPartnameKnown(item.PARTNAME, config);\n            if (!partnameExists) {\n                newPatterns.new_partnames.push({\n                    partname: item.PARTNAME,\n                    pdes: item.PDES,\n                    suggested_accname: item.ACCNAME,\n                    occurrences: 1\n                });\n                \n                learningInstructions.push({\n                    type: \"add_partname_rule\",\n                    partname: item.PARTNAME,\n                    pdes: item.PDES,\n                    suggested_accname: item.ACCNAME,\n                    vatflag: item.VATFLAG,\n                    specialvatflag: item.SPECIALVATFLAG || null,\n                    priority: \"medium\"\n                });\n            }\n            \n            // רכב חדש?\n            if (item.PARTNAME === \"car\") {\n                const vehicleNum = extractVehicleNumber(item.PDES);\n                if (vehicleNum) {\n                    const vehicleExists = checkIfVehicleKnown(vehicleNum, config);\n                    if (!vehicleExists) {\n                        newPatterns.new_vehicles.push({\n                            vehicle_number: vehicleNum,\n                            description: item.PDES,\n                            suggested_accname: item.ACCNAME,\n                            occurrences: 1\n                        });\n                        \n                        learningInstructions.push({\n                            type: \"add_vehicle_rule\",\n                            vehicle_number: vehicleNum,\n                            suggested_accname: item.ACCNAME,\n                            vat_pattern: {\n                                VATFLAG: item.VATFLAG,\n                                SPECIALVATFLAG: item.SPECIALVATFLAG || \"\"\n                            },\n                            priority: \"high\"\n                        });\n                    }\n                }\n            }\n            \n            // חשבון לא ידוע?\n            if (!item.ACCNAME || item.ACCNAME === \"\") {\n                newPatterns.unknown_accounts.push({\n                    partname: item.PARTNAME,\n                    pdes: item.PDES,\n                    needs_mapping: true\n                });\n                \n                learningInstructions.push({\n                    type: \"missing_account\",\n                    partname: item.PARTNAME,\n                    pdes: item.PDES,\n                    priority: \"critical\"\n                });\n            }\n            \n            // BUDCODE חדש?\n            if (item.BUDCODE) {\n                const budcodeExists = checkIfBudcodeKnown(item.BUDCODE, config, learnedConfig);\n                if (!budcodeExists) {\n                    newPatterns.new_budcodes.push(item.BUDCODE);\n                }\n            }\n        });\n    }\n    \n    // סיכום\n    const learningRequired = \n        newPatterns.new_partnames.length > 0 ||\n        newPatterns.new_vehicles.length > 0 ||\n        newPatterns.unknown_accounts.length > 0 ||\n        newPatterns.new_budcodes.length > 0;\n    \n    return {\n        learning_required: learningRequired,\n        new_patterns: newPatterns,\n        learning_instructions: learningInstructions,\n        confidence_score: calculateConfidenceScore(newPatterns, invoice),\n        recommendation: learningRequired \n            ? \"שלח לקוד 3 ללמידה מתקדמת\" \n            : \"אין צורך בלמידה נוספת\"\n    };\n}\n\nfunction checkIfPartnameKnown(partname, config) {\n    // בדיקה אם המקט קיים בחוקים\n    if (!config.rules.critical_patterns.partname_rules) {\n        return false;\n    }\n    \n    return config.rules.critical_patterns.partname_rules.hasOwnProperty(partname);\n}\n\nfunction checkIfVehicleKnown(vehicleNum, config) {\n    // בדיקה אם הרכב קיים במיפוי\n    if (!config.rules.critical_patterns.vehicle_rules || \n        !config.rules.critical_patterns.vehicle_rules.vehicle_account_mapping) {\n        return false;\n    }\n    \n    return config.rules.critical_patterns.vehicle_rules.vehicle_account_mapping\n        .hasOwnProperty(vehicleNum);\n}\n\nfunction checkIfBudcodeKnown(budcode, config, learnedConfig) {\n    // בדיקה פשוטה - אם יש BUDCODE בתבנית\n    const template = learnedConfig.template;\n    if (template && template.PINVOICES && template.PINVOICES.length > 0) {\n        const firstInvoice = template.PINVOICES[0];\n        if (firstInvoice.PINVOICEITEMS_SUBFORM) {\n            return firstInvoice.PINVOICEITEMS_SUBFORM.some(\n                item => item.BUDCODE === budcode\n            );\n        }\n    }\n    return false;\n}\n\nfunction extractVehicleNumber(description) {\n    if (!description) return null;\n    \n    const match = description.match(/\\d{3}-\\d{2}-\\d{3}/);\n    return match ? match[0] : null;\n}\n\nfunction calculateConfidenceScore(newPatterns, invoice) {\n    let score = 100;\n    \n    // הורדת ציון על כל חוסר\n    score -= newPatterns.unknown_accounts.length * 20;\n    score -= newPatterns.new_partnames.length * 5;\n    score -= newPatterns.new_vehicles.length * 10;\n    \n    // לא לרדת מתחת ל-0\n    return Math.max(0, score);\n}\n\n// ============================================================================\n// שלב 8: מטא-דאטה\n// ============================================================================\n\nfunction createMetadata(ocrFields) {\n    return {\n        ocr_invoice_id: ocrFields.InvoiceId || \"\",\n        ocr_invoice_date: ocrFields.InvoiceDate || \"\",\n        ocr_total_amount: ocrFields.InvoiceTotal_amount || 0,\n        ocr_vendor_tax_id: ocrFields.VendorTaxId || \"\",\n        processing_timestamp: new Date().toISOString()\n    };\n}\n\n// ============================================================================\n// פרסור INPUT מ-Make\n// ============================================================================\n\nfunction parseInputFromMake(makeInput) {\n    console.error(\"DEBUG - Raw input type:\", typeof makeInput);\n    console.error(\"DEBUG - Is array:\", Array.isArray(makeInput));\n    \n    // אם זה לא מערך, להחזיר כמו שזה\n    if (!Array.isArray(makeInput)) {\n        return makeInput;\n    }\n    \n    // אם המערך ריק\n    if (makeInput.length === 0) {\n        return {};\n    }\n    \n    const firstItem = makeInput[0];\n    console.error(\"DEBUG - First item keys:\", Object.keys(firstItem));\n    \n    // אם יש InputArray\n    if (firstItem.InputArray && Array.isArray(firstItem.InputArray)) {\n        const result = {};\n        \n        console.error(\"DEBUG - InputArray length:\", firstItem.InputArray.length);\n        \n        firstItem.InputArray.forEach((item, index) => {\n            console.error(`DEBUG - Item ${index}:`, {\n                name: item.name,\n                hasValue: item.value !== undefined,\n                hasValueCollection: item.valueCollection !== undefined\n            });\n            \n            // בחירת הערך הנכון\n            let value = null;\n            \n            if (item.valueCollection !== undefined) {\n                value = item.valueCollection;\n            } else if (item.value !== undefined) {\n                value = item.value;\n            }\n            \n            if (item.name && value !== null) {\n                result[item.name] = value;\n                console.error(`DEBUG - Added ${item.name}`);\n            }\n        });\n        \n        console.error(\"DEBUG - Final keys:\", Object.keys(result));\n        return result;\n    }\n    \n    // אחרת להחזיר את הפריט הראשון\n    return firstItem;\n}\n\n// ============================================================================\n// נקודת כניסה ראשית\n// ============================================================================\n\n// Make מעביר את המשתנים דרך object בשם 'input'\n\nconst processInput = {\n    learned_config: input.learned_config,\n    docs_list: input.docs_list,\n    import_files: input.import_files,\n    AZURE_RESULT: input.AZURE_RESULT,\n    AZURE_TEXT: input.AZURE_TEXT\n};\n\nconst result = processInvoice(processInput);\n\n// כיסוי כפול - גם stdout וגם return\nconsole.log(JSON.stringify(result));\nreturn result;"
                        },
                        "metadata": {
                            "designer": {
                                "x": 300,
                                "y": 300,
                                "messages": [
                                    {
                                        "category": "reference",
                                        "severity": "error",
                                        "message": "Module references non-existing module '88'."
                                    },
                                    {
                                        "category": "reference",
                                        "severity": "warning",
                                        "message": "Referenced module 'Make Code - Run code' [79] is not accessible."
                                    },
                                    {
                                        "category": "reference",
                                        "severity": "warning",
                                        "message": "Referenced module 'Scenarios - Call a subscenario' [90] is not accessible."
                                    },
                                    {
                                        "category": "reference",
                                        "severity": "warning",
                                        "message": "Referenced module 'Scenarios - Call a subscenario' [112] is not accessible."
                                    },
                                    {
                                        "category": "reference",
                                        "severity": "warning",
                                        "message": "Referenced module 'Make Code - Run code' [114] is not accessible."
                                    }
                                ]
                            },
                            "restore": {
                                "expect": {
                                    "input": {
                                        "items": [
                                            null,
                                            null,
                                            null,
                                            null,
                                            null
                                        ]
                                    },
                                    "language": {
                                        "mode": "chose",
                                        "label": "JavaScript"
                                    },
                                    "inputFormat": {
                                        "label": "Code editor"
                                    }
                                }
                            },
                            "expect": [
                                {
                                    "name": "language",
                                    "type": "select",
                                    "label": "Language",
                                    "required": true,
                                    "validate": {
                                        "enum": [
                                            "javascript",
                                            "python"
                                        ]
                                    }
                                },
                                {
                                    "name": "input",
                                    "spec": {
                                        "name": "value",
                                        "spec": [
                                            {
                                                "name": "name",
                                                "type": "text",
                                                "label": "Name",
                                                "required": true,
                                                "validate": {
                                                    "max": 32,
                                                    "min": 1,
                                                    "pattern": "^[a-zA-Z0-9_]{1,32}$"
                                                }
                                            },
                                            {
                                                "name": "value",
                                                "type": "any",
                                                "label": "Value",
                                                "required": true
                                            }
                                        ],
                                        "type": "collection",
                                        "label": "Variable"
                                    },
                                    "type": "array",
                                    "label": "Input"
                                },
                                {
                                    "name": "dependencies",
                                    "spec": {
                                        "name": "value",
                                        "type": "text",
                                        "label": "Dependency",
                                        "required": true,
                                        "validate": {
                                            "max": 214,
                                            "min": 1,
                                            "pattern": "^[A-Za-z0-9_@\\./<>\\=\\!~\\^+\\-]{1,214}$"
                                        }
                                    },
                                    "type": "array",
                                    "label": "Additional dependencies (Enterprise plans only)"
                                },
                                {
                                    "name": "inputFormat",
                                    "type": "select",
                                    "label": "Input format",
                                    "required": true,
                                    "validate": {
                                        "enum": [
                                            "editor",
                                            "string"
                                        ]
                                    }
                                },
                                {
                                    "name": "codeEditorJavascript",
                                    "type": "editor",
                                    "label": "Code",
                                    "required": true
                                }
                            ]
                        }
                    },
                    {
                        "id": 115,
                        "module": "code:ExecuteCode",
                        "version": 0,
                        "parameters": {},
                        "mapper": {
                            "input": [
                                {
                                    "name": "learned_config",
                                    "value": "{{118.conf}}"
                                },
                                {
                                    "name": "docs_list",
                                    "value": "{{118.docs}}"
                                },
                                {
                                    "name": "import_files",
                                    "value": "{{118.imfp.IMPFILES}}"
                                },
                                {
                                    "name": "AZURE_RESULT",
                                    "value": "{{118.AZURE_RESULT}}"
                                },
                                {
                                    "name": "AZURE_TEXT",
                                    "value": "{{118.azuretext}}"
                                }
                            ],
                            "language": "javascript",
                            "inputFormat": "editor",
                            "dependencies": [],
                            "codeEditorJavascript": "// ============================================================================\n// קוד עיבוד חשבוניות - קוד 2\n// מקבל: OCR + קובץ הגדרות + תעודות + יבוא\n// מייצר: JSON לפריוריטי\n// ============================================================================\n\nfunction processInvoice(input) {\n    try {\n        // שלב 1: אימות קלט\n        validateInput(input);\n        \n        // שלב 2: זיהוי תבנית\n        const templateIndex = identifyTemplate(\n            input.AZURE_RESULT.data.fields,\n            input.learned_config.config\n        );\n        \n        // שלב 3: עיבוד תעודות\n        const documents = processDocs(input.docs_list);\n        \n        // שלב 4: עיבוד יבוא\n        const importFiles = processImportFiles(input.import_files);\n        \n        // שלב 5: בניית חשבונית\n        const invoice = buildInvoice(\n            input.AZURE_RESULT.data.fields,\n            input.learned_config,\n            templateIndex,\n            documents,\n            importFiles\n        );\n        \n        // שלב 6: בדיקות תקינות\n        const validation = validateInvoice(\n            invoice,\n            input.AZURE_RESULT.data.fields,\n            input.learned_config.config\n        );\n        \n        // שלב 7: החזרת תוצאה\n        return {\n            status: \"success\",\n            supplier_identification: {\n                supplier_code: input.learned_config.supplier_id,\n                supplier_name: input.learned_config.supplier_name,\n                identification_method: \"vendor_tax_id\",\n                confidence: \"high\"\n            },\n            invoice_data: {\n                PINVOICES: [invoice]\n            },\n            validation: validation,\n            metadata: createMetadata(input.AZURE_RESULT.data.fields),\n            learning_analysis: analyzeLearningNeeds(\n                invoice,\n                input.learned_config,\n                input.AZURE_RESULT.data.fields\n            )\n        };\n        \n    } catch (error) {\n        return {\n            status: \"error\",\n            error_type: error.name || \"processing_error\",\n            message: error.message,\n            stack: error.stack\n        };\n    }\n}\n\n// ============================================================================\n// שלב 1: אימות קלט\n// ============================================================================\n\nfunction validateInput(input) {\n    if (!input.AZURE_RESULT || !input.AZURE_RESULT.data) {\n        throw new Error(\"חסר AZURE_RESULT\");\n    }\n    \n    if (!input.learned_config || !input.learned_config.config) {\n        throw new Error(\"חסר learned_config\");\n    }\n    \n    if (input.AZURE_RESULT.status !== \"success\") {\n        throw new Error(\"AZURE_RESULT לא תקין\");\n    }\n    \n    const vendorTaxId = input.AZURE_RESULT.data.fields.VendorTaxId;\n    const configTaxId = input.learned_config.vendor_tax_id_reference;\n    \n    if (vendorTaxId && configTaxId && vendorTaxId !== configTaxId) {\n        throw new Error(\n            `אי התאמה ספק: OCR=${vendorTaxId}, Config=${configTaxId}`\n        );\n    }\n}\n\n// ============================================================================\n// שלב 2: זיהוי תבנית\n// ============================================================================\n\nfunction identifyTemplate(ocrFields, config) {\n    const structures = config.structure;\n    \n    // זיהוי DEBIT\n    const debitType = determineDebitType(ocrFields);\n    \n    // זיהוי תעודות\n    const hasDoc = detectDocuments(ocrFields);\n    \n    // זיהוי יבוא\n    const hasImport = detectImport(ocrFields);\n    \n    // חיפוש תבנית מתאימה\n    for (let i = 0; i < structures.length; i++) {\n        const struct = structures[i];\n        \n        if (struct.debit_type === debitType &&\n            struct.has_doc === hasDoc &&\n            struct.has_import === hasImport) {\n            return i;\n        }\n    }\n    \n    // אם לא נמצא - תבנית ראשונה\n    return 0;\n}\n\nfunction determineDebitType(ocrFields) {\n    const total = ocrFields.InvoiceTotal_amount || 0;\n    return total >= 0 ? \"D\" : \"C\";\n}\n\nfunction detectDocuments(ocrFields) {\n    const unidentified = ocrFields.UnidentifiedNumbers || [];\n    \n    // חיפוש מספרים שמתחילים ב-25 ו-8 ספרות\n    const docPattern = /^25\\d{6}$/;\n    return unidentified.some(num => docPattern.test(num));\n}\n\nfunction detectDocumentsInOCR(unidentifiedNumbers) {\n    if (!unidentifiedNumbers || unidentifiedNumbers.length === 0) {\n        return false;\n    }\n    \n    // חיפוש מספרים שמתחילים ב-25 ו-8 ספרות\n    const docPattern = /^25\\d{6}$/;\n    return unidentifiedNumbers.some(num => docPattern.test(num));\n}\n\nfunction detectImport(ocrFields) {\n    // חיפוש IMPFNUM ב-UnidentifiedNumbers\n    const unidentified = ocrFields.UnidentifiedNumbers || [];\n    \n    // דפוס תיק יבוא: XXcXXXXX\n    const impPattern = /^\\d{2}c\\d{5}$/;\n    return unidentified.some(num => impPattern.test(num));\n}\n\n// ============================================================================\n// שלב 3: עיבוד תעודות\n// ============================================================================\n\nfunction processDocs(docsList) {\n    if (!docsList || docsList.DOC_YES_NO !== \"Y\") {\n        return [];\n    }\n    \n    const docs = docsList.list_of_docs || [];\n    \n    return docs.map(docString => {\n        try {\n            return JSON.parse(docString);\n        } catch (e) {\n            return null;\n        }\n    }).filter(doc => doc !== null);\n}\n\n// ============================================================================\n// שלב 4: עיבוד יבוא\n// ============================================================================\n\nfunction processImportFiles(importFiles) {\n    if (!importFiles || !importFiles.IMPFILES || importFiles.IMPFILES.length === 0) {\n        return [];\n    }\n    \n    const rawString = importFiles.IMPFILES[0];\n    \n    if (!rawString) {\n        return [];\n    }\n    \n    try {\n        // תיקון: הוספת [] מסביב\n        const fixedString = '[' + rawString + ']';\n        return JSON.parse(fixedString);\n    } catch (e) {\n        return [];\n    }\n}\n\n// ============================================================================\n// שלב 5: בניית חשבונית\n// ============================================================================\n\nfunction buildInvoice(ocrFields, learnedConfig, templateIndex, documents, importFiles) {\n    const config = learnedConfig.config;\n    const template = learnedConfig.template.PINVOICES[templateIndex];\n    const structure = config.structure[templateIndex];\n    \n    // בניית חשבונית בסיסית\n    const invoice = {\n        SUPNAME: config.supplier_config.supplier_code,\n        CODE: template.CODE,\n        DEBIT: structure.debit_type,\n        IVDATE: convertDate(ocrFields.InvoiceDate),\n        BOOKNUM: extractBooknum(ocrFields.InvoiceId)\n    };\n    \n    // ORDNAME\n    if (structure.has_purchase_orders || (!structure.has_doc && !structure.has_import)) {\n        const ordname = extractOrdname(ocrFields.UnidentifiedNumbers);\n        if (ordname) {\n            invoice.ORDNAME = ordname;\n        }\n    }\n    \n    // IMPFNUM\n    if (structure.has_import) {\n        const impfnum = extractImpfnum(ocrFields.UnidentifiedNumbers, importFiles);\n        if (impfnum) {\n            invoice.IMPFNUM = impfnum;\n        }\n    }\n    \n    // DETAILS\n    if (ocrFields.InvoiceDescription) {\n        invoice.DETAILS = ocrFields.InvoiceDescription;\n    }\n    \n    // תעודות - קודם כל בודקים אם יש\n    const hasDocsInOCR = detectDocumentsInOCR(ocrFields.UnidentifiedNumbers);\n    \n    // Debug\n    if (structure.has_doc) {\n        console.error(\"DEBUG - has_doc: true\");\n        console.error(\"DEBUG - UnidentifiedNumbers:\", ocrFields.UnidentifiedNumbers);\n        console.error(\"DEBUG - hasDocsInOCR:\", hasDocsInOCR);\n    }\n    \n    if (structure.has_doc && hasDocsInOCR) {\n        addDocuments(invoice, ocrFields.UnidentifiedNumbers, documents);\n        console.error(\"DEBUG - Added documents to invoice\");\n    }\n    \n    // פריטים - רק לפי הכללים\n    const shouldAddItems = \n        (!structure.has_doc) || // אם אין תעודות בכלל\n        (structure.has_doc && !hasDocsInOCR) || // יש תעודות בתבנית אבל לא במסמך\n        (structure.has_doc && structure.inventory_management === \"not_managed_inventory\"); // תעודות + מלאי לא מנוהל\n    \n    if (shouldAddItems && ocrFields.Items && ocrFields.Items.length > 0) {\n        addItems(invoice, ocrFields.Items, config, structure, template);\n    }\n    \n    // PINVOICESCONT_SUBFORM\n    if (template.PINVOICESCONT_SUBFORM) {\n        invoice.PINVOICESCONT_SUBFORM = template.PINVOICESCONT_SUBFORM;\n    }\n    \n    return invoice;\n}\n\n// ============================================================================\n// המרות ועזרים\n// ============================================================================\n\nfunction convertDate(isoDate) {\n    if (!isoDate) return \"\";\n    \n    // \"2025-09-18\" → \"18/09/25\"\n    const date = new Date(isoDate);\n    const day = String(date.getDate()).padStart(2, '0');\n    const month = String(date.getMonth() + 1).padStart(2, '0');\n    const year = String(date.getFullYear()).slice(-2);\n    \n    return `${day}/${month}/${year}`;\n}\n\nfunction extractBooknum(invoiceId) {\n    if (!invoiceId) return \"\";\n    \n    // הסרת קידומת SI אם יש\n    let booknum = String(invoiceId).replace(/^SI/i, '');\n    \n    // לקיחת 6 ספרות אחרונות אם יותר\n    if (booknum.length > 6) {\n        booknum = booknum.slice(-6);\n    }\n    \n    return booknum;\n}\n\nfunction extractOrdname(unidentifiedNumbers) {\n    if (!unidentifiedNumbers) return null;\n    \n    // חיפוש מספר 10 ספרות\n    const ordPattern = /^\\d{10}$/;\n    const found = unidentifiedNumbers.find(num => ordPattern.test(num));\n    \n    return found || null;\n}\n\nfunction extractImpfnum(unidentifiedNumbers, importFiles) {\n    // נסיון 1: מ-UnidentifiedNumbers\n    if (unidentifiedNumbers) {\n        const impPattern = /^\\d{2}c\\d{5}$/;\n        const found = unidentifiedNumbers.find(num => impPattern.test(num));\n        if (found) return found;\n    }\n    \n    // נסיון 2: מרשימת יבוא\n    if (importFiles && importFiles.length > 0) {\n        return importFiles[0].IMPFNUM;\n    }\n    \n    return null;\n}\n\nfunction addDocuments(invoice, unidentifiedNumbers, documentsFromPriority) {\n    const docPattern = /^25\\d{6}$/;\n    const docsFromOCR = (unidentifiedNumbers || [])\n        .filter(num => docPattern.test(num))\n        .map(num => 'SH' + num);\n    \n    // רק אם יש תעודות אמיתיות\n    if (docsFromOCR.length === 0) {\n        return; // אין תעודות - לא להוסיף כלום\n    }\n    \n    if (docsFromOCR.length === 1) {\n        // תעודה אחת\n        invoice.DOCNO = docsFromOCR[0];\n    } else {\n        // תעודות מרובות\n        invoice.PIVDOC_SUBFORM = docsFromOCR.map(booknum => {\n            // חיפוש DOCNO מהרשימה\n            const found = documentsFromPriority.find(d => d.BOOKNUM === booknum);\n            \n            return {\n                DOCNO: found ? found.DOCNO : \"\",\n                BOOKNUM: booknum\n            };\n        });\n    }\n}\n\nfunction addItems(invoice, ocrItems, config, structure, template) {\n    if (!ocrItems || ocrItems.length === 0) {\n        return;\n    }\n    \n    // קבלת ערכי ברירת מחדל מהתבנית\n    const templateItems = template && template.PINVOICEITEMS_SUBFORM \n        ? template.PINVOICEITEMS_SUBFORM \n        : [];\n    \n    const defaultBudcode = templateItems.length > 0 && templateItems[0].BUDCODE \n        ? templateItems[0].BUDCODE \n        : \"\";\n    \n    // אם אין ACCNAME בתבנית, לקחת מ-document_types\n    let defaultAccname = templateItems.length > 0 && templateItems[0].ACCNAME \n        ? templateItems[0].ACCNAME \n        : \"\";\n    \n    if (!defaultAccname && config.document_types && config.document_types.length > 0) {\n        const docType = config.document_types[0];\n        if (docType.accnames && docType.accnames.length > 0) {\n            defaultAccname = docType.accnames[0];\n        }\n    }\n    \n    const items = ocrItems.map(ocrItem => {\n        const item = {\n            PARTNAME: extractPartname(ocrItem.ProductCode),\n            PDES: ocrItem.Description || \"\",\n            TQUANT: ocrItem.Quantity || 1,\n            TUNITNAME: ocrItem.Unit || \"יח'\",\n            PRICE: ocrItem.UnitPrice_amount || 0,\n            VATFLAG: \"Y\",\n            ACCNAME: defaultAccname // ברירת מחדל\n        };\n        \n        // חוקי רכבים - דורסים את ברירת המחדל\n        if (item.PARTNAME === \"car\") {\n            applyVehicleRules(item, ocrItem.Description, config.rules.critical_patterns.vehicle_rules);\n        }\n        \n        // חוקי מקטים - דורסים את ברירת המחדל\n        applyPartnameRules(item, config.rules.critical_patterns.partname_rules);\n        \n        // BUDCODE\n        if (structure.has_budcode && defaultBudcode) {\n            item.BUDCODE = defaultBudcode;\n        }\n        \n        return item;\n    });\n    \n    invoice.PINVOICEITEMS_SUBFORM = items;\n}\n\nfunction extractPartname(productCode) {\n    if (!productCode) return \"\";\n    \n    // אם יש \\n - לקחת את החלק הראשון\n    const codes = String(productCode).split('\\n');\n    \n    // לקחת את הקוד שמתחיל באות גדולה או המספרי\n    const priorityCode = codes.find(c => /^[A-Z]/.test(c) || /^\\d+$/.test(c));\n    \n    return priorityCode || codes[0] || \"\";\n}\n\nfunction applyVehicleRules(item, description, vehicleRules) {\n    if (!vehicleRules || !vehicleRules.vehicle_account_mapping) {\n        return;\n    }\n    \n    // חילוץ מספר רכב מתיאור\n    const vehicleMatch = description.match(/\\d{3}-\\d{2}-\\d{3}/);\n    \n    if (!vehicleMatch) {\n        return;\n    }\n    \n    const vehicleNum = vehicleMatch[0];\n    const mapping = vehicleRules.vehicle_account_mapping[vehicleNum];\n    \n    if (mapping) {\n        item.ACCNAME = mapping.accname;\n        item.VATFLAG = mapping.vat_pattern.VATFLAG;\n        \n        if (mapping.vat_pattern.SPECIALVATFLAG && \n            mapping.vat_pattern.SPECIALVATFLAG !== \"varies\") {\n            item.SPECIALVATFLAG = mapping.vat_pattern.SPECIALVATFLAG;\n        }\n    }\n}\n\nfunction applyPartnameRules(item, partnameRules) {\n    if (!partnameRules || Object.keys(partnameRules).length === 0) {\n        return;\n    }\n    \n    const rule = partnameRules[item.PARTNAME];\n    \n    if (rule) {\n        if (rule.accname) {\n            item.ACCNAME = rule.accname;\n        }\n        if (rule.vatflag) {\n            item.VATFLAG = rule.vatflag;\n        }\n        if (rule.specialvatflag) {\n            item.SPECIALVATFLAG = rule.specialvatflag;\n        }\n    }\n}\n\n// ============================================================================\n// שלב 6: בדיקות תקינות\n// ============================================================================\n\nfunction validateInvoice(invoice, ocrFields, config) {\n    const warnings = [];\n    \n    // בדיקת TOTQUANT - רק שיש פריטים\n    let totquant = 0;\n    if (invoice.PINVOICEITEMS_SUBFORM) {\n        totquant = invoice.PINVOICEITEMS_SUBFORM.reduce(\n            (sum, item) => sum + (item.TQUANT || 0), \n            0\n        );\n    }\n    \n    const hasTotquant = totquant > 0;\n    \n    if (!hasTotquant && config.structure[0].inventory_management === \"managed_inventory\") {\n        warnings.push(\"חסרים פריטים - TOTQUANT=0\");\n    }\n    \n    // בדיקת שדות חובה\n    const missingFields = [];\n    \n    if (!invoice.SUPNAME) missingFields.push(\"SUPNAME\");\n    if (!invoice.CODE) missingFields.push(\"CODE\");\n    if (!invoice.DEBIT) missingFields.push(\"DEBIT\");\n    if (!invoice.IVDATE) missingFields.push(\"IVDATE\");\n    if (!invoice.BOOKNUM) missingFields.push(\"BOOKNUM\");\n    \n    if (missingFields.length > 0) {\n        warnings.push(`שדות חובה חסרים: ${missingFields.join(', ')}`);\n    }\n    \n    // בדיקת חשבונות ריקים\n    if (invoice.PINVOICEITEMS_SUBFORM) {\n        const emptyAccounts = invoice.PINVOICEITEMS_SUBFORM.filter(\n            item => !item.ACCNAME || item.ACCNAME === \"\"\n        );\n        \n        if (emptyAccounts.length > 0) {\n            warnings.push(`${emptyAccounts.length} פריטים ללא חשבון (ACCNAME)`);\n        }\n    }\n    \n    return {\n        all_valid: warnings.length === 0,\n        totquant: totquant,\n        has_items: hasTotquant,\n        template_matched: true,\n        warnings: warnings\n    };\n}\n\n// ============================================================================\n// שלב 7: ניתוח צרכי למידה\n// ============================================================================\n\nfunction analyzeLearningNeeds(invoice, learnedConfig, ocrFields) {\n    const config = learnedConfig.config;\n    const newPatterns = {\n        new_partnames: [],\n        new_vehicles: [],\n        unknown_accounts: [],\n        new_budcodes: []\n    };\n    \n    const learningInstructions = [];\n    \n    // ניתוח פריטים\n    if (invoice.PINVOICEITEMS_SUBFORM) {\n        invoice.PINVOICEITEMS_SUBFORM.forEach(item => {\n            // מקט חדש?\n            const partnameExists = checkIfPartnameKnown(item.PARTNAME, config);\n            if (!partnameExists) {\n                newPatterns.new_partnames.push({\n                    partname: item.PARTNAME,\n                    pdes: item.PDES,\n                    suggested_accname: item.ACCNAME,\n                    occurrences: 1\n                });\n                \n                learningInstructions.push({\n                    type: \"add_partname_rule\",\n                    partname: item.PARTNAME,\n                    pdes: item.PDES,\n                    suggested_accname: item.ACCNAME,\n                    vatflag: item.VATFLAG,\n                    specialvatflag: item.SPECIALVATFLAG || null,\n                    priority: \"medium\"\n                });\n            }\n            \n            // רכב חדש?\n            if (item.PARTNAME === \"car\") {\n                const vehicleNum = extractVehicleNumber(item.PDES);\n                if (vehicleNum) {\n                    const vehicleExists = checkIfVehicleKnown(vehicleNum, config);\n                    if (!vehicleExists) {\n                        newPatterns.new_vehicles.push({\n                            vehicle_number: vehicleNum,\n                            description: item.PDES,\n                            suggested_accname: item.ACCNAME,\n                            occurrences: 1\n                        });\n                        \n                        learningInstructions.push({\n                            type: \"add_vehicle_rule\",\n                            vehicle_number: vehicleNum,\n                            suggested_accname: item.ACCNAME,\n                            vat_pattern: {\n                                VATFLAG: item.VATFLAG,\n                                SPECIALVATFLAG: item.SPECIALVATFLAG || \"\"\n                            },\n                            priority: \"high\"\n                        });\n                    }\n                }\n            }\n            \n            // חשבון לא ידוע?\n            if (!item.ACCNAME || item.ACCNAME === \"\") {\n                newPatterns.unknown_accounts.push({\n                    partname: item.PARTNAME,\n                    pdes: item.PDES,\n                    needs_mapping: true\n                });\n                \n                learningInstructions.push({\n                    type: \"missing_account\",\n                    partname: item.PARTNAME,\n                    pdes: item.PDES,\n                    priority: \"critical\"\n                });\n            }\n            \n            // BUDCODE חדש?\n            if (item.BUDCODE) {\n                const budcodeExists = checkIfBudcodeKnown(item.BUDCODE, config, learnedConfig);\n                if (!budcodeExists) {\n                    newPatterns.new_budcodes.push(item.BUDCODE);\n                }\n            }\n        });\n    }\n    \n    // סיכום\n    const learningRequired = \n        newPatterns.new_partnames.length > 0 ||\n        newPatterns.new_vehicles.length > 0 ||\n        newPatterns.unknown_accounts.length > 0 ||\n        newPatterns.new_budcodes.length > 0;\n    \n    return {\n        learning_required: learningRequired,\n        new_patterns: newPatterns,\n        learning_instructions: learningInstructions,\n        confidence_score: calculateConfidenceScore(newPatterns, invoice),\n        recommendation: learningRequired \n            ? \"שלח לקוד 3 ללמידה מתקדמת\" \n            : \"אין צורך בלמידה נוספת\"\n    };\n}\n\nfunction checkIfPartnameKnown(partname, config) {\n    // בדיקה אם המקט קיים בחוקים\n    if (!config.rules.critical_patterns.partname_rules) {\n        return false;\n    }\n    \n    return config.rules.critical_patterns.partname_rules.hasOwnProperty(partname);\n}\n\nfunction checkIfVehicleKnown(vehicleNum, config) {\n    // בדיקה אם הרכב קיים במיפוי\n    if (!config.rules.critical_patterns.vehicle_rules || \n        !config.rules.critical_patterns.vehicle_rules.vehicle_account_mapping) {\n        return false;\n    }\n    \n    return config.rules.critical_patterns.vehicle_rules.vehicle_account_mapping\n        .hasOwnProperty(vehicleNum);\n}\n\nfunction checkIfBudcodeKnown(budcode, config, learnedConfig) {\n    // בדיקה פשוטה - אם יש BUDCODE בתבנית\n    const template = learnedConfig.template;\n    if (template && template.PINVOICES && template.PINVOICES.length > 0) {\n        const firstInvoice = template.PINVOICES[0];\n        if (firstInvoice.PINVOICEITEMS_SUBFORM) {\n            return firstInvoice.PINVOICEITEMS_SUBFORM.some(\n                item => item.BUDCODE === budcode\n            );\n        }\n    }\n    return false;\n}\n\nfunction extractVehicleNumber(description) {\n    if (!description) return null;\n    \n    const match = description.match(/\\d{3}-\\d{2}-\\d{3}/);\n    return match ? match[0] : null;\n}\n\nfunction calculateConfidenceScore(newPatterns, invoice) {\n    let score = 100;\n    \n    // הורדת ציון על כל חוסר\n    score -= newPatterns.unknown_accounts.length * 20;\n    score -= newPatterns.new_partnames.length * 5;\n    score -= newPatterns.new_vehicles.length * 10;\n    \n    // לא לרדת מתחת ל-0\n    return Math.max(0, score);\n}\n\n// ============================================================================\n// שלב 8: מטא-דאטה\n// ============================================================================\n\nfunction createMetadata(ocrFields) {\n    return {\n        ocr_invoice_id: ocrFields.InvoiceId || \"\",\n        ocr_invoice_date: ocrFields.InvoiceDate || \"\",\n        ocr_total_amount: ocrFields.InvoiceTotal_amount || 0,\n        ocr_vendor_tax_id: ocrFields.VendorTaxId || \"\",\n        processing_timestamp: new Date().toISOString()\n    };\n}\n\n// ============================================================================\n// פרסור INPUT מ-Make\n// ============================================================================\n\nfunction parseInputFromMake(makeInput) {\n    console.error(\"DEBUG - Raw input type:\", typeof makeInput);\n    console.error(\"DEBUG - Is array:\", Array.isArray(makeInput));\n    \n    // אם זה לא מערך, להחזיר כמו שזה\n    if (!Array.isArray(makeInput)) {\n        return makeInput;\n    }\n    \n    // אם המערך ריק\n    if (makeInput.length === 0) {\n        return {};\n    }\n    \n    const firstItem = makeInput[0];\n    console.error(\"DEBUG - First item keys:\", Object.keys(firstItem));\n    \n    // אם יש InputArray\n    if (firstItem.InputArray && Array.isArray(firstItem.InputArray)) {\n        const result = {};\n        \n        console.error(\"DEBUG - InputArray length:\", firstItem.InputArray.length);\n        \n        firstItem.InputArray.forEach((item, index) => {\n            console.error(`DEBUG - Item ${index}:`, {\n                name: item.name,\n                hasValue: item.value !== undefined,\n                hasValueCollection: item.valueCollection !== undefined\n            });\n            \n            // בחירת הערך הנכון\n            let value = null;\n            \n            if (item.valueCollection !== undefined) {\n                value = item.valueCollection;\n            } else if (item.value !== undefined) {\n                value = item.value;\n            }\n            \n            if (item.name && value !== null) {\n                result[item.name] = value;\n                console.error(`DEBUG - Added ${item.name}`);\n            }\n        });\n        \n        console.error(\"DEBUG - Final keys:\", Object.keys(result));\n        return result;\n    }\n    \n    // אחרת להחזיר את הפריט הראשון\n    return firstItem;\n}\n\n// ============================================================================\n// נקודת כניסה ראשית\n// ============================================================================\n\n// Make מעביר את המשתנים דרך object בשם 'input'\n\nconst processInput = {\n    learned_config: input.learned_config,\n    docs_list: input.docs_list,\n    import_files: input.import_files,\n    AZURE_RESULT: input.AZURE_RESULT,\n    AZURE_TEXT: input.AZURE_TEXT\n};\n\nconst result = processInvoice(processInput);\n\n// כיסוי כפול - גם stdout וגם return\nconsole.log(JSON.stringify(result));\nreturn result;"
                        },
                        "metadata": {
                            "designer": {
                                "x": 600,
                                "y": 300,
                                "messages": [
                                    {
                                        "category": "reference",
                                        "severity": "warning",
                                        "message": "Referenced module 'Tools - Set multiple variables' [118] is not accessible."
                                    }
                                ]
                            },
                            "restore": {
                                "expect": {
                                    "input": {
                                        "items": [
                                            null,
                                            null,
                                            null,
                                            null,
                                            null
                                        ]
                                    },
                                    "language": {
                                        "mode": "chose",
                                        "label": "JavaScript"
                                    },
                                    "inputFormat": {
                                        "label": "Code editor"
                                    }
                                }
                            },
                            "expect": [
                                {
                                    "name": "language",
                                    "type": "select",
                                    "label": "Language",
                                    "required": true,
                                    "validate": {
                                        "enum": [
                                            "javascript",
                                            "python"
                                        ]
                                    }
                                },
                                {
                                    "name": "input",
                                    "spec": {
                                        "name": "value",
                                        "spec": [
                                            {
                                                "name": "name",
                                                "type": "text",
                                                "label": "Name",
                                                "required": true,
                                                "validate": {
                                                    "max": 32,
                                                    "min": 1,
                                                    "pattern": "^[a-zA-Z0-9_]{1,32}$"
                                                }
                                            },
                                            {
                                                "name": "value",
                                                "type": "any",
                                                "label": "Value",
                                                "required": true
                                            }
                                        ],
                                        "type": "collection",
                                        "label": "Variable"
                                    },
                                    "type": "array",
                                    "label": "Input"
                                },
                                {
                                    "name": "dependencies",
                                    "spec": {
                                        "name": "value",
                                        "type": "text",
                                        "label": "Dependency",
                                        "required": true,
                                        "validate": {
                                            "max": 214,
                                            "min": 1,
                                            "pattern": "^[A-Za-z0-9_@\\./<>\\=\\!~\\^+\\-]{1,214}$"
                                        }
                                    },
                                    "type": "array",
                                    "label": "Additional dependencies (Enterprise plans only)"
                                },
                                {
                                    "name": "inputFormat",
                                    "type": "select",
                                    "label": "Input format",
                                    "required": true,
                                    "validate": {
                                        "enum": [
                                            "editor",
                                            "string"
                                        ]
                                    }
                                },
                                {
                                    "name": "codeEditorJavascript",
                                    "type": "editor",
                                    "label": "Code",
                                    "required": true
                                }
                            ]
                        }
                    },
                    {
                        "id": 124,
                        "module": "util:SetVariables",
                        "version": 1,
                        "parameters": {},
                        "mapper": {
                            "scope": "roundtrip",
                            "variables": [
                                {
                                    "name": "AZURE_RESULT",
                                    "value": "{{114.result}}"
                                },
                                {
                                    "name": "azuretext",
                                    "value": "{{112.AZURE_AI_TEXT}}"
                                },
                                {
                                    "name": "docs",
                                    "value": "{{`88`}}"
                                },
                                {
                                    "name": "imfp",
                                    "value": "{{`90`}}"
                                },
                                {
                                    "name": "conf",
                                    "value": "{{79.result}}"
                                }
                            ]
                        },
                        "metadata": {
                            "designer": {
                                "x": 900,
                                "y": 300,
                                "messages": [
                                    {
                                        "category": "reference",
                                        "severity": "error",
                                        "message": "Module references non-existing module '88'."
                                    },
                                    {
                                        "category": "reference",
                                        "severity": "warning",
                                        "message": "Referenced module 'Make Code - Run code' [79] is not accessible."
                                    },
                                    {
                                        "category": "reference",
                                        "severity": "warning",
                                        "message": "Referenced module 'Scenarios - Call a subscenario' [90] is not accessible."
                                    },
                                    {
                                        "category": "reference",
                                        "severity": "warning",
                                        "message": "Referenced module 'Scenarios - Call a subscenario' [112] is not accessible."
                                    },
                                    {
                                        "category": "reference",
                                        "severity": "warning",
                                        "message": "Referenced module 'Make Code - Run code' [114] is not accessible."
                                    }
                                ]
                            },
                            "restore": {
                                "expect": {
                                    "scope": {
                                        "label": "One cycle"
                                    },
                                    "variables": {
                                        "items": [
                                            null,
                                            null,
                                            null,
                                            null,
                                            null
                                        ]
                                    }
                                }
                            },
                            "expect": [
                                {
                                    "name": "variables",
                                    "spec": [
                                        {
                                            "name": "name",
                                            "type": "text",
                                            "label": "Variable name",
                                            "required": true
                                        },
                                        {
                                            "name": "value",
                                            "type": "any",
                                            "label": "Variable value"
                                        }
                                    ],
                                    "type": "array",
                                    "label": "Variables"
                                },
                                {
                                    "name": "scope",
                                    "type": "select",
                                    "label": "Variable lifetime",
                                    "required": true,
                                    "validate": {
                                        "enum": [
                                            "roundtrip",
                                            "execution"
                                        ]
                                    }
                                }
                            ],
                            "interface": [
                                {
                                    "name": "AZURE_RESULT",
                                    "type": "any",
                                    "label": "AZURE_RESULT"
                                },
                                {
                                    "name": "azuretext",
                                    "type": "any",
                                    "label": "azuretext"
                                },
                                {
                                    "name": "docs",
                                    "type": "any",
                                    "label": "docs"
                                },
                                {
                                    "name": "imfp",
                                    "type": "any",
                                    "label": "imfp"
                                },
                                {
                                    "name": "conf",
                                    "type": "any",
                                    "label": "conf"
                                }
                            ]
                        }
                    },
                    {
                        "id": 127,
                        "module": "builtin:BasicAggregator",
                        "version": 1,
                        "parameters": {
                            "feeder": 124
                        },
                        "mapper": {
                            "conf": "{{124.conf}}",
                            "docs": "{{124.docs}}",
                            "imfp": "{{124.imfp}}",
                            "azuretext": "{{124.azuretext}}",
                            "AZURE_RESULT": "{{124.AZURE_RESULT}}"
                        },
                        "metadata": {
                            "designer": {
                                "x": 1200,
                                "y": 300
                            },
                            "restore": {
                                "extra": {
                                    "feeder": {
                                        "label": "Tools - Set multiple variables [124]"
                                    },
                                    "target": {
                                        "label": "Custom"
                                    }
                                }
                            }
                        }
                    },
                    {
                        "id": 132,
                        "module": "code:ExecuteCode",
                        "version": 0,
                        "parameters": {},
                        "mapper": {
                            "input": [
                                {
                                    "name": "azureJsonInput",
                                    "value": "{{`113`}}"
                                }
                            ],
                            "language": "javascript",
                            "inputFormat": "editor",
                            "dependencies": [],
                            "codeEditorJavascript": "// ================================================================\n// Azure Invoice Processor - Make Compatible\n// ================================================================\n\nconst azureJsonInput = input.azureJsonInput;\n\nfunction processAzureInvoice(azureInput) {\n    const analyzeResult = loadAnalyzeResult(azureInput);\n    \n    const rawContent = analyzeResult.content || '';\n    const tables = analyzeResult.tables || [];\n    const documents = analyzeResult.documents || [];\n    \n    const result = {\n        docType: 'invoice',\n        fields: {}\n    };\n    \n    if (documents.length > 0 && documents[0].fields) {\n        extractAzureFields(documents[0].fields, result.fields);\n    }\n    \n    const itemsData = extractRealItemsFromTable(tables, result.fields.Items);\n    if (itemsData.length > 0) {\n        result.fields.Items = itemsData;\n    }\n    \n    const detectedNumbers = detectNumbersByContext(rawContent, result.fields);\n    Object.assign(result.fields, detectedNumbers);\n    \n    const structure = buildStructure(result.fields);\n    const data = buildData(result);\n    \n    return {\n        structure: structure,\n        data: data,\n        metadata: {\n            modelId: analyzeResult.modelId,\n            totalFields: Object.keys(result.fields).length\n        }\n    };\n}\n\nfunction loadAnalyzeResult(input) {\n    if (Array.isArray(input) && input[0] && input[0].analyzeResult) {\n        return input[0].analyzeResult;\n    }\n    if (input.analyzeResult) {\n        return input.analyzeResult;\n    }\n    if (input.content || input.tables) {\n        return input;\n    }\n    throw new Error('Invalid input format');\n}\n\nfunction extractAzureFields(fields, target) {\n    for (const fieldName in fields) {\n        const fieldData = fields[fieldName];\n        if (!fieldData) continue;\n        \n        const type = fieldData.type;\n        \n        if (type === 'string') {\n            target[fieldName] = fieldData.valueString || fieldData.content;\n        }\n        else if (type === 'date') {\n            target[fieldName] = fieldData.valueDate || fieldData.content;\n        }\n        else if (type === 'number') {\n            target[fieldName] = fieldData.valueNumber;\n        }\n        else if (type === 'currency') {\n            if (fieldData.valueCurrency) {\n                target[fieldName + '_amount'] = fieldData.valueCurrency.amount;\n                target[fieldName + '_currency'] = fieldData.valueCurrency.currencyCode;\n            }\n        }\n        else if (type === 'address') {\n            target[fieldName] = fieldData.content;\n            if (fieldData.valueAddress) {\n                for (const key in fieldData.valueAddress) {\n                    const value = fieldData.valueAddress[key];\n                    if (value) {\n                        target[fieldName + '_' + key] = value;\n                    }\n                }\n            }\n        }\n        else if (type === 'array') {\n            if (fieldName === 'Items' && fieldData.valueArray) {\n                target.Items = [];\n                for (let i = 0; i < fieldData.valueArray.length; i++) {\n                    const item = fieldData.valueArray[i];\n                    if (item.valueObject) {\n                        const itemData = {};\n                        for (const key in item.valueObject) {\n                            const val = item.valueObject[key];\n                            if (val.type === 'currency' && val.valueCurrency) {\n                                itemData[key + '_amount'] = val.valueCurrency.amount;\n                                itemData[key + '_currency'] = val.valueCurrency.currencyCode;\n                            }\n                            else if (val.type === 'number') {\n                                itemData[key] = val.valueNumber;\n                            }\n                            else {\n                                itemData[key] = val.valueString || val.content;\n                            }\n                        }\n                        target.Items.push(itemData);\n                    }\n                }\n            }\n            else if (fieldName === 'PaymentDetails' && fieldData.valueArray) {\n                for (let i = 0; i < fieldData.valueArray.length; i++) {\n                    const payment = fieldData.valueArray[i];\n                    if (payment.valueObject) {\n                        for (const key in payment.valueObject) {\n                            const val = payment.valueObject[key];\n                            target['PaymentDetails_' + key] = val.valueString || val.content;\n                        }\n                    }\n                }\n            }\n        }\n    }\n}\n\nfunction extractRealItemsFromTable(tables, azureItems) {\n    if (azureItems && azureItems.length > 0) {\n        return azureItems;\n    }\n    \n    if (!tables || tables.length === 0) {\n        return [];\n    }\n    \n    let mainTable = {};\n    let maxCells = 0;\n    \n    for (let i = 0; i < tables.length; i++) {\n        const table = tables[i];\n        if (table.cells && table.cells.length > maxCells) {\n            mainTable = table;\n            maxCells = table.cells.length;\n        }\n    }\n    \n    if (!mainTable.cells) {\n        return [];\n    }\n    \n    const headers = [];\n    const dataCells = [];\n    \n    for (let i = 0; i < mainTable.cells.length; i++) {\n        const cell = mainTable.cells[i];\n        if (cell.kind === 'columnHeader') {\n            headers.push(cell);\n        } else {\n            dataCells.push(cell);\n        }\n    }\n    \n    const columnMap = {};\n    for (let i = 0; i < headers.length; i++) {\n        const header = headers[i];\n        columnMap[header.columnIndex] = {\n            content: header.content,\n            fieldName: guessFieldNameGeneric(header.content, header.columnIndex)\n        };\n    }\n    \n    const rowsData = {};\n    for (let i = 0; i < dataCells.length; i++) {\n        const cell = dataCells[i];\n        const rowIdx = cell.rowIndex;\n        \n        if (!rowsData[rowIdx]) {\n            rowsData[rowIdx] = {};\n        }\n        \n        const colInfo = columnMap[cell.columnIndex];\n        if (colInfo && cell.content && cell.content.trim()) {\n            rowsData[rowIdx][colInfo.fieldName] = parseValue(cell.content);\n        }\n    }\n    \n    const items = [];\n    for (const rowIdx in rowsData) {\n        const rowData = rowsData[rowIdx];\n        if (isRealItemRow(rowData)) {\n            items.push(rowData);\n        }\n    }\n    \n    return items;\n}\n\nfunction guessFieldNameGeneric(content, colIndex) {\n    if (!content || content.trim() === '') {\n        return 'Col' + colIndex;\n    }\n    \n    const text = content.toLowerCase();\n    \n    if (content === '=' || text.indexOf('total') >= 0 || text.indexOf('amount') >= 0 || \n        text.indexOf('סכום') >= 0 || text.indexOf('סה') >= 0) return 'Amount';\n    if (content === '%' || text.indexOf('discount') >= 0 || text.indexOf('הנח') >= 0) return 'Discount';\n    if (text.indexOf('qty') >= 0 || text.indexOf('quantity') >= 0 || text.indexOf('כמות') >= 0) return 'Quantity';\n    if (text.indexOf('price') >= 0 || text.indexOf('מחיר') >= 0) return 'UnitPrice';\n    if (text.indexOf('code') >= 0 || text.indexOf('sku') >= 0 || text.indexOf('item') >= 0 || \n        text.indexOf('מק') >= 0 || text.indexOf('פריט') >= 0) return 'ProductCode';\n    if (text.indexOf('desc') >= 0 || text.indexOf('name') >= 0 || \n        text.indexOf('תאור') >= 0 || text.indexOf('שם') >= 0) return 'Description';\n    if (text.indexOf('unit') >= 0 || text.indexOf('יח') >= 0) return 'Unit';\n    \n    return 'Col' + colIndex;\n}\n\nfunction isRealItemRow(rowData) {\n    const keys = Object.keys(rowData);\n    \n    if (keys.length < 2) {\n        return false;\n    }\n    \n    const hasAmount = rowData.Amount !== undefined;\n    const hasProductCode = rowData.ProductCode !== undefined;\n    const hasDescription = rowData.Description !== undefined;\n    \n    if (!hasAmount && !hasProductCode && !hasDescription) {\n        return false;\n    }\n    \n    if (hasAmount && keys.length === 1) {\n        return false;\n    }\n    \n    if (hasAmount) {\n        const amount = rowData.Amount;\n        if (typeof amount === 'number' && amount > 0) {\n            return true;\n        }\n    }\n    \n    if (hasProductCode) {\n        const code = rowData.ProductCode;\n        if (typeof code === 'number' || (typeof code === 'string' && code.length > 0)) {\n            return true;\n        }\n    }\n    \n    return true;\n}\n\nfunction parseValue(value) {\n    if (typeof value !== 'string') return value;\n    \n    const cleaned = value.replace(/,/g, '').trim();\n    const numPattern = new RegExp('^[0-9]+\\\\.?[0-9]*$');\n    \n    if (numPattern.test(cleaned)) {\n        const num = parseFloat(cleaned);\n        if (!isNaN(num)) {\n            return num;\n        }\n    }\n    \n    return value;\n}\n\nfunction detectNumbersByContext(content, existingFields) {\n    const detected = {};\n    \n    if (!content) return detected;\n    \n    detectVendorAdditionalId(content, existingFields, detected);\n    detectPhoneNumbers(content, existingFields, detected);\n    detectTimes(content, existingFields, detected);\n    detectDates(content, existingFields, detected);\n    detectBankDetails(content, existingFields, detected);\n    detectEmails(content, existingFields, detected);\n    detectUnidentifiedNumbers(content, existingFields, detected);\n    \n    return detected;\n}\n\nfunction detectVendorAdditionalId(content, existing, detected) {\n    const companyIdx = content.indexOf('Company');\n    if (companyIdx === -1) return;\n    \n    const afterCompany = content.substring(companyIdx);\n    const numbers = findAllNumbers(afterCompany, 9, 10);\n    \n    if (numbers.length >= 2) {\n        const first = numbers[0];\n        const second = numbers[1];\n        \n        if (second !== first && \n            second !== existing.VendorTaxId &&\n            second !== existing.CustomerTaxId) {\n            detected.VendorAdditionalId = second;\n        }\n    }\n}\n\nfunction detectPhoneNumbers(content, existing, detected) {\n    const phonePattern = new RegExp('[0-9]{2,3}[-\\\\s][0-9]{7,8}', 'g');\n    const matches = content.match(phonePattern) || [];\n    \n    const usedNumbers = [];\n    if (existing.VendorTaxId) usedNumbers.push(existing.VendorTaxId);\n    if (existing.CustomerTaxId) usedNumbers.push(existing.CustomerTaxId);\n    \n    const phones = [];\n    for (let i = 0; i < matches.length; i++) {\n        const phone = matches[i];\n        \n        if (phone.indexOf('\\n') >= 0 || phone.indexOf('\\r') >= 0) {\n            continue;\n        }\n        \n        const cleanPhone = phone.replace(/[-\\s]/g, '');\n        \n        let isUsed = false;\n        for (let j = 0; j < usedNumbers.length; j++) {\n            if (usedNumbers[j] === cleanPhone) {\n                isUsed = true;\n                break;\n            }\n        }\n        \n        if (!isUsed) {\n            const position = content.indexOf(phone);\n            phones.push({\n                phone: phone,\n                position: position,\n                isVendor: position < content.length / 3\n            });\n        }\n    }\n    \n    const vendorPhones = [];\n    const customerPhones = [];\n    \n    for (let i = 0; i < phones.length; i++) {\n        if (phones[i].isVendor) {\n            vendorPhones.push(phones[i]);\n        } else {\n            customerPhones.push(phones[i]);\n        }\n    }\n    \n    if (vendorPhones.length > 0 && !existing.VendorTel) {\n        detected.VendorTel = vendorPhones[0].phone;\n    }\n    if (vendorPhones.length > 1 && !existing.VendorFax) {\n        detected.VendorFax = vendorPhones[1].phone;\n    }\n    if (customerPhones.length > 0 && !existing.CustomerTel) {\n        detected.CustomerTel = customerPhones[0].phone;\n    }\n    if (customerPhones.length > 1 && !existing.CustomerFax) {\n        detected.CustomerFax = customerPhones[1].phone;\n    }\n}\n\nfunction detectTimes(content, existing, detected) {\n    const timePattern = new RegExp('[0-9]{1,2}:[0-9]{2}(:[0-9]{2})?', 'g');\n    const matches = content.match(timePattern) || [];\n    \n    if (matches.length > 0 && !existing.InvoiceTime) {\n        detected.InvoiceTime = matches[0];\n    }\n    if (matches.length > 1 && !existing.PrintTime) {\n        detected.PrintTime = matches[matches.length - 1];\n    }\n}\n\nfunction detectDates(content, existing, detected) {\n    const dates = [];\n    \n    const pattern1 = new RegExp('[0-9]{1,2}[./][0-9]{1,2}[./][0-9]{4}', 'g');\n    const matches1 = content.match(pattern1) || [];\n    for (let i = 0; i < matches1.length; i++) {\n        const parsed = parseDateString(matches1[i]);\n        if (parsed) {\n            dates.push({\n                date: parsed,\n                position: content.indexOf(matches1[i])\n            });\n        }\n    }\n    \n    dates.sort(function(a, b) { return a.position - b.position; });\n    \n    if (dates.length > 0 && !existing.InvoiceDate) {\n        detected.InvoiceDate = dates[0].date;\n    }\n    if (dates.length > 1 && !existing.DueDate) {\n        detected.DueDate = dates[dates.length - 1].date;\n    }\n}\n\nfunction parseDateString(dateStr) {\n    const parts1 = dateStr.match(/([0-9]{1,2})[./]([0-9]{1,2})[./]([0-9]{4})/);\n    if (parts1) {\n        const day = parts1[1].length === 1 ? '0' + parts1[1] : parts1[1];\n        const month = parts1[2].length === 1 ? '0' + parts1[2] : parts1[2];\n        return parts1[3] + '-' + month + '-' + day;\n    }\n    \n    return null;\n}\n\nfunction detectBankDetails(content, existing, detected) {\n    if (!existing.PaymentDetails_IBAN) {\n        const ibanIdx = content.indexOf('IBAN');\n        if (ibanIdx >= 0) {\n            const afterIban = content.substring(ibanIdx);\n            const ibanPattern = new RegExp('IL[0-9]{21}');\n            const match = afterIban.match(ibanPattern);\n            if (match) {\n                detected.PaymentDetails_IBAN = match[0];\n                \n                const accountNum = match[0].substring(match[0].length - 6);\n                if (!existing.PaymentDetails_AccountNumber) {\n                    detected.PaymentDetails_AccountNumber = accountNum;\n                }\n            }\n        }\n    }\n    \n    if (!existing.PaymentDetails_SWIFT) {\n        const swiftIdx = content.indexOf('SWIFT');\n        if (swiftIdx >= 0) {\n            const afterSwift = content.substring(swiftIdx);\n            const swiftPattern = new RegExp('[A-Z0-9]{8,11}');\n            const match = afterSwift.match(swiftPattern);\n            if (match) {\n                detected.PaymentDetails_SWIFT = match[0];\n            }\n        }\n    }\n}\n\nfunction detectEmails(content, existing, detected) {\n    const emailPattern = new RegExp('[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\\\.[a-zA-Z]{2,}', 'g');\n    const matches = content.match(emailPattern) || [];\n    \n    for (let i = 0; i < matches.length; i++) {\n        const email = matches[i];\n        const position = content.indexOf(email);\n        const isVendor = position < content.length / 3;\n        \n        if (isVendor && !existing.VendorEmail && !detected.VendorEmail) {\n            detected.VendorEmail = email;\n        } else if (!isVendor && !existing.CustomerEmail && !detected.CustomerEmail) {\n            detected.CustomerEmail = email;\n        }\n    }\n}\n\nfunction detectUnidentifiedNumbers(content, existing, detected) {\n    const longNumbers = findAllNumbers(content, 8, 12);\n    \n    const unidentified = [];\n    const allExisting = Object.assign({}, existing, detected);\n    \n    for (let i = 0; i < longNumbers.length && unidentified.length < 20; i++) {\n        const num = longNumbers[i];\n        \n        let exists = false;\n        for (const key in allExisting) {\n            const v = allExisting[key];\n            if (typeof v === 'string' && v.indexOf(num) >= 0) {\n                exists = true;\n                break;\n            }\n            if (typeof v === 'number' && v.toString() === num) {\n                exists = true;\n                break;\n            }\n            if (Array.isArray(v)) {\n                for (let j = 0; j < v.length; j++) {\n                    if (typeof v[j] === 'string' && v[j].indexOf(num) >= 0) {\n                        exists = true;\n                        break;\n                    }\n                }\n            }\n        }\n        \n        if (!exists) {\n            unidentified.push(num);\n        }\n    }\n    \n    if (unidentified.length > 0) {\n        detected.UnidentifiedNumbers = unidentified;\n    }\n}\n\nfunction findAllNumbers(text, minLen, maxLen) {\n    const numbers = [];\n    let currentNum = '';\n    \n    for (let i = 0; i < text.length; i++) {\n        const char = text[i];\n        if (char >= '0' && char <= '9') {\n            currentNum += char;\n        } else {\n            if (currentNum.length >= minLen && currentNum.length <= maxLen) {\n                numbers.push(currentNum);\n            }\n            currentNum = '';\n        }\n    }\n    \n    if (currentNum.length >= minLen && currentNum.length <= maxLen) {\n        numbers.push(currentNum);\n    }\n    \n    return numbers;\n}\n\nfunction buildStructure(fields) {\n    const structure = {\n        docType: \"string\",\n        fields: {}\n    };\n    \n    for (const fieldName in fields) {\n        const fieldValue = fields[fieldName];\n        if (fieldName === 'Items') {\n            structure.Items = buildItemsStructure(fieldValue);\n        }\n        else if (Array.isArray(fieldValue)) {\n            structure.fields[fieldName] = [\"string\"];\n        }\n        else {\n            structure.fields[fieldName] = getFieldType(fieldName, fieldValue);\n        }\n    }\n    \n    return structure;\n}\n\nfunction buildItemsStructure(items) {\n    if (!items || items.length === 0) {\n        return [];\n    }\n    \n    const itemStructure = {};\n    const firstItem = items[0];\n    \n    for (const fieldName in firstItem) {\n        itemStructure[fieldName] = getFieldType(fieldName, firstItem[fieldName]);\n    }\n    \n    return [itemStructure];\n}\n\nfunction getFieldType(fieldName, fieldValue) {\n    if (fieldName.indexOf('Date') >= 0) return \"YYYY-MM-DD\";\n    if (fieldName.indexOf('Time') >= 0) return \"HH:MM:SS\";\n    if (fieldName.indexOf('_amount') >= 0) return \"number\";\n    if (fieldName.indexOf('_currency') >= 0) return \"string\";\n    if (typeof fieldValue === 'number') return \"number\";\n    return \"string\";\n}\n\nfunction buildData(result) {\n    return {\n        docType: result.docType,\n        fields: result.fields\n    };\n}\n\n// הרץ את הפונקציה והחזר תוצאה\nconst finalResult = processAzureInvoice(azureJsonInput);\n\nfinalResult.status = 'success';\n\nreturn finalResult;"
                        },
                        "metadata": {
                            "designer": {
                                "x": 1500,
                                "y": 300,
                                "name": "Azure Invoice Processor",
                                "messages": [
                                    {
                                        "category": "reference",
                                        "severity": "warning",
                                        "message": "Referenced module 'JSON - Parse JSON' [113] is not accessible."
                                    }
                                ]
                            },
                            "restore": {
                                "expect": {
                                    "input": {
                                        "items": [
                                            null
                                        ]
                                    },
                                    "language": {
                                        "mode": "chose",
                                        "label": "JavaScript"
                                    },
                                    "inputFormat": {
                                        "label": "Code editor"
                                    }
                                }
                            },
                            "expect": [
                                {
                                    "name": "language",
                                    "type": "select",
                                    "label": "Language",
                                    "required": true,
                                    "validate": {
                                        "enum": [
                                            "javascript",
                                            "python"
                                        ]
                                    }
                                },
                                {
                                    "name": "input",
                                    "spec": {
                                        "name": "value",
                                        "spec": [
                                            {
                                                "name": "name",
                                                "type": "text",
                                                "label": "Name",
                                                "required": true,
                                                "validate": {
                                                    "max": 32,
                                                    "min": 1,
                                                    "pattern": "^[a-zA-Z0-9_]{1,32}$"
                                                }
                                            },
                                            {
                                                "name": "value",
                                                "type": "any",
                                                "label": "Value",
                                                "required": true
                                            }
                                        ],
                                        "type": "collection",
                                        "label": "Variable"
                                    },
                                    "type": "array",
                                    "label": "Input"
                                },
                                {
                                    "name": "dependencies",
                                    "spec": {
                                        "name": "value",
                                        "type": "text",
                                        "label": "Dependency",
                                        "required": true,
                                        "validate": {
                                            "max": 214,
                                            "min": 1,
                                            "pattern": "^[A-Za-z0-9_@\\./<>\\=\\!~\\^+\\-]{1,214}$"
                                        }
                                    },
                                    "type": "array",
                                    "label": "Additional dependencies (Enterprise plans only)"
                                },
                                {
                                    "name": "inputFormat",
                                    "type": "select",
                                    "label": "Input format",
                                    "required": true,
                                    "validate": {
                                        "enum": [
                                            "editor",
                                            "string"
                                        ]
                                    }
                                },
                                {
                                    "name": "codeEditorJavascript",
                                    "type": "editor",
                                    "label": "Code",
                                    "required": true
                                }
                            ]
                        }
                    },
                    {
                        "id": 133,
                        "module": "code:ExecuteCode",
                        "version": 0,
                        "parameters": {},
                        "mapper": {
                            "input": [
                                {
                                    "name": "azureJsonInput",
                                    "value": "{{`113`}}"
                                }
                            ],
                            "language": "javascript",
                            "inputFormat": "editor",
                            "dependencies": [],
                            "codeEditorJavascript": "// ================================================================\n// Azure Invoice Processor v2.0 - Make Compatible\n// תאריך: 30 אוקטובר 2025\n// ================================================================\n\nconst azureJsonInput = input.azureJsonInput;\n\nfunction processAzureInvoice(azureInput) {\n    const analyzeResult = loadAnalyzeResult(azureInput);\n    \n    const rawContent = analyzeResult.content || '';\n    const tables = analyzeResult.tables || [];\n    const documents = analyzeResult.documents || [];\n    \n    const result = {\n        docType: 'invoice',\n        fields: {}\n    };\n    \n    if (documents.length > 0 && documents[0].fields) {\n        extractAzureFields(documents[0].fields, result.fields);\n    }\n    \n    const itemsData = extractRealItemsFromTable(tables, result.fields.Items);\n    if (itemsData.length > 0) {\n        result.fields.Items = itemsData;\n    }\n    \n    const detectedNumbers = detectNumbersByContext(rawContent, result.fields);\n    Object.assign(result.fields, detectedNumbers);\n    \n    // ✨ חדש! זיהוי דינמי של מידע ייחודי\n    const uniqueData = extractUniqueData(rawContent, result.fields);\n    if (uniqueData.length > 0) {\n        result.fields.UnidentifiedNumbers = uniqueData;\n    }\n    \n    const structure = buildStructure(result.fields);\n    const data = buildData(result);\n    \n    return {\n        structure: structure,\n        data: data,\n        metadata: {\n            modelId: analyzeResult.modelId,\n            totalFields: Object.keys(result.fields).length,\n            uniqueDataFound: uniqueData.length\n        }\n    };\n}\n\nfunction loadAnalyzeResult(input) {\n    if (Array.isArray(input) && input[0] && input[0].analyzeResult) {\n        return input[0].analyzeResult;\n    }\n    if (input.analyzeResult) {\n        return input.analyzeResult;\n    }\n    if (input.content || input.tables) {\n        return input;\n    }\n    throw new Error('Invalid input format');\n}\n\nfunction extractAzureFields(fields, target) {\n    for (const fieldName in fields) {\n        const fieldData = fields[fieldName];\n        if (!fieldData) continue;\n        \n        const type = fieldData.type;\n        \n        if (type === 'string') {\n            target[fieldName] = fieldData.valueString || fieldData.content;\n        }\n        else if (type === 'date') {\n            target[fieldName] = fieldData.valueDate || fieldData.content;\n        }\n        else if (type === 'number') {\n            target[fieldName] = fieldData.valueNumber;\n        }\n        else if (type === 'currency') {\n            if (fieldData.valueCurrency) {\n                target[fieldName + '_amount'] = fieldData.valueCurrency.amount;\n                target[fieldName + '_currency'] = fieldData.valueCurrency.currencyCode;\n            }\n        }\n        else if (type === 'address') {\n            target[fieldName] = fieldData.content;\n            if (fieldData.valueAddress) {\n                for (const key in fieldData.valueAddress) {\n                    const value = fieldData.valueAddress[key];\n                    if (value) {\n                        target[fieldName + '_' + key] = value;\n                    }\n                }\n            }\n        }\n        else if (type === 'array') {\n            if (fieldName === 'Items' && fieldData.valueArray) {\n                target.Items = [];\n                for (let i = 0; i < fieldData.valueArray.length; i++) {\n                    const item = fieldData.valueArray[i];\n                    if (item.valueObject) {\n                        const itemData = {};\n                        for (const key in item.valueObject) {\n                            const val = item.valueObject[key];\n                            if (val.type === 'currency' && val.valueCurrency) {\n                                itemData[key + '_amount'] = val.valueCurrency.amount;\n                                itemData[key + '_currency'] = val.valueCurrency.currencyCode;\n                            }\n                            else if (val.type === 'number') {\n                                itemData[key] = val.valueNumber;\n                            }\n                            else {\n                                itemData[key] = val.valueString || val.content;\n                            }\n                        }\n                        target.Items.push(itemData);\n                    }\n                }\n            }\n            else if (fieldName === 'PaymentDetails' && fieldData.valueArray) {\n                for (let i = 0; i < fieldData.valueArray.length; i++) {\n                    const payment = fieldData.valueArray[i];\n                    if (payment.valueObject) {\n                        for (const key in payment.valueObject) {\n                            const val = payment.valueObject[key];\n                            target['PaymentDetails_' + key] = val.valueString || val.content;\n                        }\n                    }\n                }\n            }\n        }\n    }\n}\n\nfunction extractRealItemsFromTable(tables, azureItems) {\n    if (azureItems && azureItems.length > 0) {\n        return azureItems;\n    }\n    \n    if (!tables || tables.length === 0) {\n        return [];\n    }\n    \n    let mainTable = {};\n    let maxCells = 0;\n    \n    for (let i = 0; i < tables.length; i++) {\n        const table = tables[i];\n        if (table.cells && table.cells.length > maxCells) {\n            mainTable = table;\n            maxCells = table.cells.length;\n        }\n    }\n    \n    if (!mainTable.cells) {\n        return [];\n    }\n    \n    const headers = [];\n    const dataCells = [];\n    \n    for (let i = 0; i < mainTable.cells.length; i++) {\n        const cell = mainTable.cells[i];\n        if (cell.kind === 'columnHeader') {\n            headers.push(cell);\n        } else {\n            dataCells.push(cell);\n        }\n    }\n    \n    const columnMap = {};\n    for (let i = 0; i < headers.length; i++) {\n        const header = headers[i];\n        columnMap[header.columnIndex] = {\n            content: header.content,\n            fieldName: guessFieldNameGeneric(header.content, header.columnIndex)\n        };\n    }\n    \n    const rowsData = {};\n    for (let i = 0; i < dataCells.length; i++) {\n        const cell = dataCells[i];\n        const rowIdx = cell.rowIndex;\n        \n        if (!rowsData[rowIdx]) {\n            rowsData[rowIdx] = {};\n        }\n        \n        const colInfo = columnMap[cell.columnIndex];\n        if (colInfo && cell.content && cell.content.trim()) {\n            rowsData[rowIdx][colInfo.fieldName] = parseValue(cell.content);\n        }\n    }\n    \n    const items = [];\n    for (const rowIdx in rowsData) {\n        const rowData = rowsData[rowIdx];\n        if (isRealItemRow(rowData)) {\n            items.push(rowData);\n        }\n    }\n    \n    return items;\n}\n\nfunction guessFieldNameGeneric(content, colIndex) {\n    if (!content || content.trim() === '') {\n        return 'Col' + colIndex;\n    }\n    \n    const text = content.toLowerCase();\n    \n    if (content === '=' || text.indexOf('total') >= 0 || text.indexOf('amount') >= 0 || \n        text.indexOf('סכום') >= 0 || text.indexOf('סה') >= 0) return 'Amount';\n    if (content === '%' || text.indexOf('discount') >= 0 || text.indexOf('הנח') >= 0) return 'Discount';\n    if (text.indexOf('qty') >= 0 || text.indexOf('quantity') >= 0 || text.indexOf('כמות') >= 0) return 'Quantity';\n    if (text.indexOf('price') >= 0 || text.indexOf('מחיר') >= 0) return 'UnitPrice';\n    if (text.indexOf('code') >= 0 || text.indexOf('sku') >= 0 || text.indexOf('item') >= 0 || \n        text.indexOf('מק') >= 0 || text.indexOf('פריט') >= 0) return 'ProductCode';\n    if (text.indexOf('desc') >= 0 || text.indexOf('name') >= 0 || \n        text.indexOf('תאור') >= 0 || text.indexOf('שם') >= 0) return 'Description';\n    if (text.indexOf('unit') >= 0 || text.indexOf('יח') >= 0) return 'Unit';\n    \n    return 'Col' + colIndex;\n}\n\nfunction isRealItemRow(rowData) {\n    const keys = Object.keys(rowData);\n    \n    if (keys.length < 2) {\n        return false;\n    }\n    \n    const hasAmount = rowData.Amount !== undefined;\n    const hasProductCode = rowData.ProductCode !== undefined;\n    const hasDescription = rowData.Description !== undefined;\n    \n    if (!hasAmount && !hasProductCode && !hasDescription) {\n        return false;\n    }\n    \n    if (hasAmount && keys.length === 1) {\n        return false;\n    }\n    \n    if (hasAmount) {\n        const amount = rowData.Amount;\n        if (typeof amount === 'number' && amount > 0) {\n            return true;\n        }\n    }\n    \n    if (hasProductCode) {\n        const code = rowData.ProductCode;\n        if (typeof code === 'number' || (typeof code === 'string' && code.length > 0)) {\n            return true;\n        }\n    }\n    \n    return true;\n}\n\nfunction parseValue(value) {\n    if (typeof value !== 'string') return value;\n    \n    const cleaned = value.replace(/,/g, '').trim();\n    const numPattern = new RegExp('^[0-9]+\\\\.?[0-9]*$');\n    \n    if (numPattern.test(cleaned)) {\n        const num = parseFloat(cleaned);\n        if (!isNaN(num)) {\n            return num;\n        }\n    }\n    \n    return value;\n}\n\nfunction detectNumbersByContext(content, existingFields) {\n    const detected = {};\n    \n    if (!content) return detected;\n    \n    detectVendorAdditionalId(content, existingFields, detected);\n    detectPhoneNumbers(content, existingFields, detected);\n    detectTimes(content, existingFields, detected);\n    detectDates(content, existingFields, detected);\n    detectBankDetails(content, existingFields, detected);\n    detectEmails(content, existingFields, detected);\n    \n    return detected;\n}\n\nfunction detectVendorAdditionalId(content, existing, detected) {\n    const companyIdx = content.indexOf('Company');\n    if (companyIdx === -1) return;\n    \n    const afterCompany = content.substring(companyIdx);\n    const numbers = findAllNumbers(afterCompany, 9, 10);\n    \n    if (numbers.length >= 2) {\n        const first = numbers[0];\n        const second = numbers[1];\n        \n        if (second !== first && \n            second !== existing.VendorTaxId &&\n            second !== existing.CustomerTaxId) {\n            detected.VendorAdditionalId = second;\n        }\n    }\n}\n\nfunction detectPhoneNumbers(content, existing, detected) {\n    const phonePattern = new RegExp('[0-9]{2,3}[-\\\\s][0-9]{7,8}', 'g');\n    const matches = content.match(phonePattern) || [];\n    \n    const usedNumbers = [];\n    if (existing.VendorTaxId) usedNumbers.push(existing.VendorTaxId);\n    if (existing.CustomerTaxId) usedNumbers.push(existing.CustomerTaxId);\n    \n    const phones = [];\n    for (let i = 0; i < matches.length; i++) {\n        const phone = matches[i];\n        \n        if (phone.indexOf('\\n') >= 0 || phone.indexOf('\\r') >= 0) {\n            continue;\n        }\n        \n        const cleanPhone = phone.replace(/[-\\s]/g, '');\n        \n        let isUsed = false;\n        for (let j = 0; j < usedNumbers.length; j++) {\n            if (usedNumbers[j] === cleanPhone) {\n                isUsed = true;\n                break;\n            }\n        }\n        \n        if (!isUsed) {\n            const position = content.indexOf(phone);\n            phones.push({\n                phone: phone,\n                position: position,\n                isVendor: position < content.length / 3\n            });\n        }\n    }\n    \n    const vendorPhones = [];\n    const customerPhones = [];\n    \n    for (let i = 0; i < phones.length; i++) {\n        if (phones[i].isVendor) {\n            vendorPhones.push(phones[i]);\n        } else {\n            customerPhones.push(phones[i]);\n        }\n    }\n    \n    if (vendorPhones.length > 0 && !existing.VendorTel) {\n        detected.VendorTel = vendorPhones[0].phone;\n    }\n    if (vendorPhones.length > 1 && !existing.VendorFax) {\n        detected.VendorFax = vendorPhones[1].phone;\n    }\n    if (customerPhones.length > 0 && !existing.CustomerTel) {\n        detected.CustomerTel = customerPhones[0].phone;\n    }\n    if (customerPhones.length > 1 && !existing.CustomerFax) {\n        detected.CustomerFax = customerPhones[1].phone;\n    }\n}\n\nfunction detectTimes(content, existing, detected) {\n    const timePattern = new RegExp('[0-9]{1,2}:[0-9]{2}(:[0-9]{2})?', 'g');\n    const matches = content.match(timePattern) || [];\n    \n    if (matches.length > 0 && !existing.InvoiceTime) {\n        detected.InvoiceTime = matches[0];\n    }\n    if (matches.length > 1 && !existing.PrintTime) {\n        detected.PrintTime = matches[matches.length - 1];\n    }\n}\n\nfunction detectDates(content, existing, detected) {\n    const dates = [];\n    \n    const pattern1 = new RegExp('[0-9]{1,2}[./][0-9]{1,2}[./][0-9]{4}', 'g');\n    const matches1 = content.match(pattern1) || [];\n    for (let i = 0; i < matches1.length; i++) {\n        const parsed = parseDateString(matches1[i]);\n        if (parsed) {\n            dates.push({\n                date: parsed,\n                position: content.indexOf(matches1[i])\n            });\n        }\n    }\n    \n    dates.sort(function(a, b) { return a.position - b.position; });\n    \n    if (dates.length > 0 && !existing.InvoiceDate) {\n        detected.InvoiceDate = dates[0].date;\n    }\n    if (dates.length > 1 && !existing.DueDate) {\n        detected.DueDate = dates[dates.length - 1].date;\n    }\n}\n\nfunction parseDateString(dateStr) {\n    const parts1 = dateStr.match(/([0-9]{1,2})[./]([0-9]{1,2})[./]([0-9]{4})/);\n    if (parts1) {\n        const day = parts1[1].length === 1 ? '0' + parts1[1] : parts1[1];\n        const month = parts1[2].length === 1 ? '0' + parts1[2] : parts1[2];\n        return parts1[3] + '-' + month + '-' + day;\n    }\n    \n    return null;\n}\n\nfunction detectBankDetails(content, existing, detected) {\n    if (!existing.PaymentDetails_IBAN) {\n        const ibanIdx = content.indexOf('IBAN');\n        if (ibanIdx >= 0) {\n            const afterIban = content.substring(ibanIdx);\n            const ibanPattern = new RegExp('IL[0-9]{21}');\n            const match = afterIban.match(ibanPattern);\n            if (match) {\n                detected.PaymentDetails_IBAN = match[0];\n                \n                const accountNum = match[0].substring(match[0].length - 6);\n                if (!existing.PaymentDetails_AccountNumber) {\n                    detected.PaymentDetails_AccountNumber = accountNum;\n                }\n            }\n        }\n    }\n    \n    if (!existing.PaymentDetails_SWIFT) {\n        const swiftIdx = content.indexOf('SWIFT');\n        if (swiftIdx >= 0) {\n            const afterSwift = content.substring(swiftIdx);\n            const swiftPattern = new RegExp('[A-Z0-9]{8,11}');\n            const match = afterSwift.match(swiftPattern);\n            if (match) {\n                detected.PaymentDetails_SWIFT = match[0];\n            }\n        }\n    }\n}\n\nfunction detectEmails(content, existing, detected) {\n    const emailPattern = new RegExp('[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\\\.[a-zA-Z]{2,}', 'g');\n    const matches = content.match(emailPattern) || [];\n    \n    for (let i = 0; i < matches.length; i++) {\n        const email = matches[i];\n        const position = content.indexOf(email);\n        const isVendor = position < content.length / 3;\n        \n        if (isVendor && !existing.VendorEmail && !detected.VendorEmail) {\n            detected.VendorEmail = email;\n        } else if (!isVendor && !existing.CustomerEmail && !detected.CustomerEmail) {\n            detected.CustomerEmail = email;\n        }\n    }\n}\n\n// ================================================================\n// ✨ חדש! זיהוי דינמי של מידע ייחודי\n// ================================================================\n\nfunction extractUniqueData(content, existingFields) {\n    const uniqueData = [];\n    \n    // 1. זיהוי תבניות \"כותרת: ערך\"\n    const labelValuePairs = extractLabelValuePairs(content, existingFields);\n    for (let i = 0; i < labelValuePairs.length; i++) {\n        uniqueData.push(labelValuePairs[i]);\n    }\n    \n    // 2. זיהוי קודי חלקים/מוצרים\n    const partCodes = extractPartCodes(content, existingFields);\n    for (let i = 0; i < partCodes.length; i++) {\n        uniqueData.push(partCodes[i]);\n    }\n    \n    // 3. זיהוי מספרי רכב\n    const vehicleNumbers = extractVehicleNumbers(content, existingFields);\n    for (let i = 0; i < vehicleNumbers.length; i++) {\n        uniqueData.push(vehicleNumbers[i]);\n    }\n    \n    // 4. זיהוי מספרים ייחודיים באורכים מיוחדים\n    const specialNumbers = extractSpecialLengthNumbers(content, existingFields);\n    for (let i = 0; i < specialNumbers.length; i++) {\n        uniqueData.push(specialNumbers[i]);\n    }\n    \n    return uniqueData;\n}\n\nfunction extractLabelValuePairs(content, existing) {\n    const pairs = [];\n    const lines = content.split('\\n');\n    \n    // דפוסים נפוצים: \"כותרת: ערך\" או \"כותרת ערך\" עם רווח\n    const patterns = [\n        /^([א-תA-Za-z\\s\\.]+):\\s*([^\\n]+)$/,           // כותרת: ערך\n        /^([א-תA-Za-z\\s\\.]{2,20})\\s{2,}([^\\n]+)$/    // כותרת    ערך (2+ רווחים)\n    ];\n    \n    for (let i = 0; i < lines.length; i++) {\n        const line = lines[i].trim();\n        if (!line || line.length < 5) continue;\n        \n        for (let p = 0; p < patterns.length; p++) {\n            const match = line.match(patterns[p]);\n            if (match) {\n                const label = match[1].trim();\n                const value = match[2].trim();\n                \n                // בדוק שהערך לא קיים כבר\n                if (!isValueExists(value, existing) && !isCommonLabel(label)) {\n                    pairs.push({\n                        label: label,\n                        value: value\n                    });\n                }\n                break;\n            }\n        }\n    }\n    \n    return pairs;\n}\n\nfunction extractPartCodes(content, existing) {\n    const codes = [];\n    \n    // דפוסים נפוצים לקודי חלקים:\n    // TOY-XXXXXX, ABC-123456, XXX-XXXXXX\n    const patterns = [\n        /([A-Z]{2,4}-[A-Z0-9]{5,})/g,     // ABC-12345\n        /([A-Z]{3}\\d{5,})/g,               // ABC12345\n        /([A-Z]\\d{5,})/g                   // A12345\n    ];\n    \n    for (let p = 0; p < patterns.length; p++) {\n        const matches = content.match(patterns[p]) || [];\n        for (let i = 0; i < matches.length; i++) {\n            const code = matches[i];\n            if (!isValueExists(code, existing) && !codeAlreadyFound(code, codes)) {\n                // מצא את ההקשר (השורה שבה נמצא)\n                const context = findContext(content, code);\n                codes.push({\n                    label: 'קוד חלק',\n                    value: code,\n                    context: context\n                });\n            }\n        }\n    }\n    \n    return codes;\n}\n\nfunction extractVehicleNumbers(content, existing) {\n    const vehicles = [];\n    \n    // תבניות מספר רכב:\n    // XXX-XX-XXX (ישראל)\n    // XXXXXXX (7 ספרות)\n    const patterns = [\n        /\\b(\\d{2,3}-\\d{2}-\\d{3})\\b/g,      // 123-45-678\n        /\\b(\\d{7,8})\\b/g                    // 1234567\n    ];\n    \n    for (let p = 0; p < patterns.length; p++) {\n        const matches = content.match(patterns[p]) || [];\n        for (let i = 0; i < matches.length && vehicles.length < 5; i++) {\n            const number = matches[i];\n            \n            // בדוק אם זה לא טלפון או תז\n            if (number.indexOf('-') === -1 && (number.length === 9 || number.length === 10)) {\n                continue;\n            }\n            \n            if (!isValueExists(number, existing) && !codeAlreadyFound(number, vehicles)) {\n                const context = findContext(content, number);\n                \n                // נסה לזהות אם זה באמת רכב לפי ההקשר\n                if (context.indexOf('רכב') >= 0 || context.indexOf('כרטיס') >= 0 || \n                    context.indexOf('vehicle') >= 0 || context.indexOf('car') >= 0) {\n                    vehicles.push({\n                        label: 'מספר רכב',\n                        value: number,\n                        context: context\n                    });\n                }\n            }\n        }\n    }\n    \n    return vehicles;\n}\n\nfunction extractSpecialLengthNumbers(content, existing) {\n    const numbers = [];\n    \n    // מספרים באורכים מיוחדים שעשויים להיות חשובים:\n    // 13 ספרות - מספר הקצאה/אסמכתא\n    // 17 תווים - VIN (כבר נתפס על ידי אז'ור, אבל נבדוק)\n    \n    const longNumbers = findAllNumbers(content, 13, 17);\n    \n    for (let i = 0; i < longNumbers.length && numbers.length < 10; i++) {\n        const num = longNumbers[i];\n        \n        if (!isValueExists(num, existing)) {\n            const context = findContext(content, num);\n            \n            let label = 'מספר ייחודי';\n            if (num.length === 13) label = 'מספר הקצאה/אסמכתא';\n            if (num.length === 17) label = 'מספר זיהוי (VIN)';\n            \n            numbers.push({\n                label: label,\n                value: num,\n                context: context\n            });\n        }\n    }\n    \n    return numbers;\n}\n\nfunction findContext(content, value) {\n    const index = content.indexOf(value);\n    if (index === -1) return '';\n    \n    // קח 30 תווים לפני ו-30 אחרי\n    const start = Math.max(0, index - 30);\n    const end = Math.min(content.length, index + value.length + 30);\n    \n    let context = content.substring(start, end);\n    \n    // נקה שורות חדשות מרובות\n    context = context.replace(/\\n+/g, ' ').trim();\n    \n    return context;\n}\n\nfunction isValueExists(value, existing) {\n    // בדוק אם הערך קיים כבר בשדות קיימים\n    const valueStr = value.toString().toLowerCase();\n    \n    for (const key in existing) {\n        const fieldValue = existing[key];\n        \n        if (typeof fieldValue === 'string') {\n            if (fieldValue.toLowerCase().indexOf(valueStr) >= 0) {\n                return true;\n            }\n        } else if (typeof fieldValue === 'number') {\n            if (fieldValue.toString() === valueStr) {\n                return true;\n            }\n        } else if (Array.isArray(fieldValue)) {\n            for (let i = 0; i < fieldValue.length; i++) {\n                const item = fieldValue[i];\n                if (typeof item === 'string' && item.toLowerCase().indexOf(valueStr) >= 0) {\n                    return true;\n                }\n                if (typeof item === 'object') {\n                    if (isValueExists(value, item)) {\n                        return true;\n                    }\n                }\n            }\n        } else if (typeof fieldValue === 'object' && fieldValue !== null) {\n            if (isValueExists(value, fieldValue)) {\n                return true;\n            }\n        }\n    }\n    \n    return false;\n}\n\nfunction isCommonLabel(label) {\n    // רשימת כותרות נפוצות שלא מעניינות\n    const common = [\n        'total', 'sum', 'סך', 'סכום', 'page', 'עמוד',\n        'date', 'תאריך', 'amount', 'כמות', 'price', 'מחיר'\n    ];\n    \n    const labelLower = label.toLowerCase();\n    for (let i = 0; i < common.length; i++) {\n        if (labelLower.indexOf(common[i]) >= 0) {\n            return true;\n        }\n    }\n    \n    return false;\n}\n\nfunction codeAlreadyFound(code, list) {\n    for (let i = 0; i < list.length; i++) {\n        if (list[i].value === code) {\n            return true;\n        }\n    }\n    return false;\n}\n\nfunction findAllNumbers(text, minLen, maxLen) {\n    const numbers = [];\n    let currentNum = '';\n    \n    for (let i = 0; i < text.length; i++) {\n        const char = text[i];\n        if (char >= '0' && char <= '9') {\n            currentNum += char;\n        } else {\n            if (currentNum.length >= minLen && currentNum.length <= maxLen) {\n                numbers.push(currentNum);\n            }\n            currentNum = '';\n        }\n    }\n    \n    if (currentNum.length >= minLen && currentNum.length <= maxLen) {\n        numbers.push(currentNum);\n    }\n    \n    return numbers;\n}\n\nfunction buildStructure(fields) {\n    const structure = {\n        docType: \"string\",\n        fields: {}\n    };\n    \n    for (const fieldName in fields) {\n        const fieldValue = fields[fieldName];\n        if (fieldName === 'Items') {\n            structure.Items = buildItemsStructure(fieldValue);\n        }\n        else if (fieldName === 'UnidentifiedNumbers') {\n            structure.fields.UnidentifiedNumbers = [\"object\"];\n        }\n        else if (Array.isArray(fieldValue)) {\n            structure.fields[fieldName] = [\"string\"];\n        }\n        else {\n            structure.fields[fieldName] = getFieldType(fieldName, fieldValue);\n        }\n    }\n    \n    return structure;\n}\n\nfunction buildItemsStructure(items) {\n    if (!items || items.length === 0) {\n        return [];\n    }\n    \n    const itemStructure = {};\n    const firstItem = items[0];\n    \n    for (const fieldName in firstItem) {\n        itemStructure[fieldName] = getFieldType(fieldName, firstItem[fieldName]);\n    }\n    \n    return [itemStructure];\n}\n\nfunction getFieldType(fieldName, fieldValue) {\n    if (fieldName.indexOf('Date') >= 0) return \"YYYY-MM-DD\";\n    if (fieldName.indexOf('Time') >= 0) return \"HH:MM:SS\";\n    if (fieldName.indexOf('_amount') >= 0) return \"number\";\n    if (fieldName.indexOf('_currency') >= 0) return \"string\";\n    if (typeof fieldValue === 'number') return \"number\";\n    return \"string\";\n}\n\nfunction buildData(result) {\n    return {\n        docType: result.docType,\n        fields: result.fields\n    };\n}\n\n// הרץ את הפונקציה והחזר תוצאה\nconst finalResult = processAzureInvoice(azureJsonInput);\n\nfinalResult.status = 'success';\n\nreturn finalResult;"
                        },
                        "metadata": {
                            "designer": {
                                "x": 1800,
                                "y": 300,
                                "name": "Azure Invoice Processor",
                                "messages": [
                                    {
                                        "category": "reference",
                                        "severity": "warning",
                                        "message": "Referenced module 'JSON - Parse JSON' [113] is not accessible."
                                    }
                                ]
                            },
                            "restore": {
                                "expect": {
                                    "input": {
                                        "items": [
                                            null
                                        ]
                                    },
                                    "language": {
                                        "mode": "chose",
                                        "label": "JavaScript"
                                    },
                                    "inputFormat": {
                                        "label": "Code editor"
                                    }
                                }
                            },
                            "expect": [
                                {
                                    "name": "language",
                                    "type": "select",
                                    "label": "Language",
                                    "required": true,
                                    "validate": {
                                        "enum": [
                                            "javascript",
                                            "python"
                                        ]
                                    }
                                },
                                {
                                    "name": "input",
                                    "spec": {
                                        "name": "value",
                                        "spec": [
                                            {
                                                "name": "name",
                                                "type": "text",
                                                "label": "Name",
                                                "required": true,
                                                "validate": {
                                                    "max": 32,
                                                    "min": 1,
                                                    "pattern": "^[a-zA-Z0-9_]{1,32}$"
                                                }
                                            },
                                            {
                                                "name": "value",
                                                "type": "any",
                                                "label": "Value",
                                                "required": true
                                            }
                                        ],
                                        "type": "collection",
                                        "label": "Variable"
                                    },
                                    "type": "array",
                                    "label": "Input"
                                },
                                {
                                    "name": "dependencies",
                                    "spec": {
                                        "name": "value",
                                        "type": "text",
                                        "label": "Dependency",
                                        "required": true,
                                        "validate": {
                                            "max": 214,
                                            "min": 1,
                                            "pattern": "^[A-Za-z0-9_@\\./<>\\=\\!~\\^+\\-]{1,214}$"
                                        }
                                    },
                                    "type": "array",
                                    "label": "Additional dependencies (Enterprise plans only)"
                                },
                                {
                                    "name": "inputFormat",
                                    "type": "select",
                                    "label": "Input format",
                                    "required": true,
                                    "validate": {
                                        "enum": [
                                            "editor",
                                            "string"
                                        ]
                                    }
                                },
                                {
                                    "name": "codeEditorJavascript",
                                    "type": "editor",
                                    "label": "Code",
                                    "required": true
                                }
                            ]
                        }
                    },
                    {
                        "id": 135,
                        "module": "code:ExecuteCode",
                        "version": 0,
                        "parameters": {},
                        "mapper": {
                            "input": [
                                {
                                    "name": "azureJsonInput",
                                    "value": "{{`113`}}"
                                }
                            ],
                            "language": "javascript",
                            "inputFormat": "editor",
                            "dependencies": [],
                            "codeEditorJavascript": "// ================================================================\n// Azure Invoice Processor v2.0 - Make Compatible\n// תאריך: 30 אוקטובר 2025\n// ================================================================\n\nconst azureJsonInput = input.azureJsonInput;\n\nfunction processAzureInvoice(azureInput) {\n    const analyzeResult = loadAnalyzeResult(azureInput);\n    \n    const rawContent = analyzeResult.content || '';\n    const tables = analyzeResult.tables || [];\n    const documents = analyzeResult.documents || [];\n    \n    const result = {\n        docType: 'invoice',\n        fields: {}\n    };\n    \n    if (documents.length > 0 && documents[0].fields) {\n        extractAzureFields(documents[0].fields, result.fields);\n    }\n    \n    const itemsData = extractRealItemsFromTable(tables, result.fields.Items);\n    if (itemsData.length > 0) {\n        result.fields.Items = itemsData;\n    }\n    \n    const detectedNumbers = detectNumbersByContext(rawContent, result.fields);\n    Object.assign(result.fields, detectedNumbers);\n    \n    // ✨ חדש! זיהוי דינמי של מידע ייחודי\n    const uniqueData = extractUniqueData(rawContent, result.fields);\n    if (uniqueData.length > 0) {\n        result.fields.UnidentifiedNumbers = uniqueData;\n    }\n    \n    const structure = buildStructure(result.fields);\n    const data = buildData(result);\n    \n    return {\n        structure: structure,\n        data: data,\n        metadata: {\n            modelId: analyzeResult.modelId,\n            totalFields: Object.keys(result.fields).length,\n            uniqueDataFound: uniqueData.length\n        }\n    };\n}\n\nfunction loadAnalyzeResult(input) {\n    if (Array.isArray(input) && input[0] && input[0].analyzeResult) {\n        return input[0].analyzeResult;\n    }\n    if (input.analyzeResult) {\n        return input.analyzeResult;\n    }\n    if (input.content || input.tables) {\n        return input;\n    }\n    throw new Error('Invalid input format');\n}\n\nfunction extractAzureFields(fields, target) {\n    for (const fieldName in fields) {\n        const fieldData = fields[fieldName];\n        if (!fieldData) continue;\n        \n        const type = fieldData.type;\n        \n        if (type === 'string') {\n            target[fieldName] = fieldData.valueString || fieldData.content;\n        }\n        else if (type === 'date') {\n            target[fieldName] = fieldData.valueDate || fieldData.content;\n        }\n        else if (type === 'number') {\n            target[fieldName] = fieldData.valueNumber;\n        }\n        else if (type === 'currency') {\n            if (fieldData.valueCurrency) {\n                target[fieldName + '_amount'] = fieldData.valueCurrency.amount;\n                target[fieldName + '_currency'] = fieldData.valueCurrency.currencyCode;\n            }\n        }\n        else if (type === 'address') {\n            target[fieldName] = fieldData.content;\n            if (fieldData.valueAddress) {\n                for (const key in fieldData.valueAddress) {\n                    const value = fieldData.valueAddress[key];\n                    if (value) {\n                        target[fieldName + '_' + key] = value;\n                    }\n                }\n            }\n        }\n        else if (type === 'array') {\n            if (fieldName === 'Items' && fieldData.valueArray) {\n                target.Items = [];\n                for (let i = 0; i < fieldData.valueArray.length; i++) {\n                    const item = fieldData.valueArray[i];\n                    if (item.valueObject) {\n                        const itemData = {};\n                        for (const key in item.valueObject) {\n                            const val = item.valueObject[key];\n                            if (val.type === 'currency' && val.valueCurrency) {\n                                itemData[key + '_amount'] = val.valueCurrency.amount;\n                                itemData[key + '_currency'] = val.valueCurrency.currencyCode;\n                            }\n                            else if (val.type === 'number') {\n                                itemData[key] = val.valueNumber;\n                            }\n                            else {\n                                itemData[key] = val.valueString || val.content;\n                            }\n                        }\n                        target.Items.push(itemData);\n                    }\n                }\n            }\n            else if (fieldName === 'PaymentDetails' && fieldData.valueArray) {\n                for (let i = 0; i < fieldData.valueArray.length; i++) {\n                    const payment = fieldData.valueArray[i];\n                    if (payment.valueObject) {\n                        for (const key in payment.valueObject) {\n                            const val = payment.valueObject[key];\n                            target['PaymentDetails_' + key] = val.valueString || val.content;\n                        }\n                    }\n                }\n            }\n        }\n    }\n}\n\nfunction extractRealItemsFromTable(tables, azureItems) {\n    if (azureItems && azureItems.length > 0) {\n        return azureItems;\n    }\n    \n    if (!tables || tables.length === 0) {\n        return [];\n    }\n    \n    let mainTable = {};\n    let maxCells = 0;\n    \n    for (let i = 0; i < tables.length; i++) {\n        const table = tables[i];\n        if (table.cells && table.cells.length > maxCells) {\n            mainTable = table;\n            maxCells = table.cells.length;\n        }\n    }\n    \n    if (!mainTable.cells) {\n        return [];\n    }\n    \n    const headers = [];\n    const dataCells = [];\n    \n    for (let i = 0; i < mainTable.cells.length; i++) {\n        const cell = mainTable.cells[i];\n        if (cell.kind === 'columnHeader') {\n            headers.push(cell);\n        } else {\n            dataCells.push(cell);\n        }\n    }\n    \n    const columnMap = {};\n    for (let i = 0; i < headers.length; i++) {\n        const header = headers[i];\n        columnMap[header.columnIndex] = {\n            content: header.content,\n            fieldName: guessFieldNameGeneric(header.content, header.columnIndex)\n        };\n    }\n    \n    const rowsData = {};\n    for (let i = 0; i < dataCells.length; i++) {\n        const cell = dataCells[i];\n        const rowIdx = cell.rowIndex;\n        \n        if (!rowsData[rowIdx]) {\n            rowsData[rowIdx] = {};\n        }\n        \n        const colInfo = columnMap[cell.columnIndex];\n        if (colInfo && cell.content && cell.content.trim()) {\n            rowsData[rowIdx][colInfo.fieldName] = parseValue(cell.content);\n        }\n    }\n    \n    const items = [];\n    for (const rowIdx in rowsData) {\n        const rowData = rowsData[rowIdx];\n        if (isRealItemRow(rowData)) {\n            items.push(rowData);\n        }\n    }\n    \n    return items;\n}\n\nfunction guessFieldNameGeneric(content, colIndex) {\n    if (!content || content.trim() === '') {\n        return 'Col' + colIndex;\n    }\n    \n    const text = content.toLowerCase();\n    \n    if (content === '=' || text.indexOf('total') >= 0 || text.indexOf('amount') >= 0 || \n        text.indexOf('סכום') >= 0 || text.indexOf('סה') >= 0) return 'Amount';\n    if (content === '%' || text.indexOf('discount') >= 0 || text.indexOf('הנח') >= 0) return 'Discount';\n    if (text.indexOf('qty') >= 0 || text.indexOf('quantity') >= 0 || text.indexOf('כמות') >= 0) return 'Quantity';\n    if (text.indexOf('price') >= 0 || text.indexOf('מחיר') >= 0) return 'UnitPrice';\n    if (text.indexOf('code') >= 0 || text.indexOf('sku') >= 0 || text.indexOf('item') >= 0 || \n        text.indexOf('מק') >= 0 || text.indexOf('פריט') >= 0) return 'ProductCode';\n    if (text.indexOf('desc') >= 0 || text.indexOf('name') >= 0 || \n        text.indexOf('תאור') >= 0 || text.indexOf('שם') >= 0) return 'Description';\n    if (text.indexOf('unit') >= 0 || text.indexOf('יח') >= 0) return 'Unit';\n    \n    return 'Col' + colIndex;\n}\n\nfunction isRealItemRow(rowData) {\n    const keys = Object.keys(rowData);\n    \n    if (keys.length < 2) {\n        return false;\n    }\n    \n    const hasAmount = rowData.Amount !== undefined;\n    const hasProductCode = rowData.ProductCode !== undefined;\n    const hasDescription = rowData.Description !== undefined;\n    \n    if (!hasAmount && !hasProductCode && !hasDescription) {\n        return false;\n    }\n    \n    if (hasAmount && keys.length === 1) {\n        return false;\n    }\n    \n    if (hasAmount) {\n        const amount = rowData.Amount;\n        if (typeof amount === 'number' && amount > 0) {\n            return true;\n        }\n    }\n    \n    if (hasProductCode) {\n        const code = rowData.ProductCode;\n        if (typeof code === 'number' || (typeof code === 'string' && code.length > 0)) {\n            return true;\n        }\n    }\n    \n    return true;\n}\n\nfunction parseValue(value) {\n    if (typeof value !== 'string') return value;\n    \n    const cleaned = value.replace(/,/g, '').trim();\n    const numPattern = new RegExp('^[0-9]+\\\\.?[0-9]*$');\n    \n    if (numPattern.test(cleaned)) {\n        const num = parseFloat(cleaned);\n        if (!isNaN(num)) {\n            return num;\n        }\n    }\n    \n    return value;\n}\n\nfunction detectNumbersByContext(content, existingFields) {\n    const detected = {};\n    \n    if (!content) return detected;\n    \n    detectVendorAdditionalId(content, existingFields, detected);\n    detectPhoneNumbers(content, existingFields, detected);\n    detectTimes(content, existingFields, detected);\n    detectDates(content, existingFields, detected);\n    detectBankDetails(content, existingFields, detected);\n    detectEmails(content, existingFields, detected);\n    \n    return detected;\n}\n\nfunction detectVendorAdditionalId(content, existing, detected) {\n    const companyIdx = content.indexOf('Company');\n    if (companyIdx === -1) return;\n    \n    const afterCompany = content.substring(companyIdx);\n    const numbers = findAllNumbers(afterCompany, 9, 10);\n    \n    if (numbers.length >= 2) {\n        const first = numbers[0];\n        const second = numbers[1];\n        \n        if (second !== first && \n            second !== existing.VendorTaxId &&\n            second !== existing.CustomerTaxId) {\n            detected.VendorAdditionalId = second;\n        }\n    }\n}\n\nfunction detectPhoneNumbers(content, existing, detected) {\n    const phonePattern = new RegExp('[0-9]{2,3}[-\\\\s][0-9]{7,8}', 'g');\n    const matches = content.match(phonePattern) || [];\n    \n    const usedNumbers = [];\n    if (existing.VendorTaxId) usedNumbers.push(existing.VendorTaxId);\n    if (existing.CustomerTaxId) usedNumbers.push(existing.CustomerTaxId);\n    \n    const phones = [];\n    for (let i = 0; i < matches.length; i++) {\n        const phone = matches[i];\n        \n        if (phone.indexOf('\\n') >= 0 || phone.indexOf('\\r') >= 0) {\n            continue;\n        }\n        \n        const cleanPhone = phone.replace(/[-\\s]/g, '');\n        \n        let isUsed = false;\n        for (let j = 0; j < usedNumbers.length; j++) {\n            if (usedNumbers[j] === cleanPhone) {\n                isUsed = true;\n                break;\n            }\n        }\n        \n        if (!isUsed) {\n            const position = content.indexOf(phone);\n            phones.push({\n                phone: phone,\n                position: position,\n                isVendor: position < content.length / 3\n            });\n        }\n    }\n    \n    const vendorPhones = [];\n    const customerPhones = [];\n    \n    for (let i = 0; i < phones.length; i++) {\n        if (phones[i].isVendor) {\n            vendorPhones.push(phones[i]);\n        } else {\n            customerPhones.push(phones[i]);\n        }\n    }\n    \n    if (vendorPhones.length > 0 && !existing.VendorTel) {\n        detected.VendorTel = vendorPhones[0].phone;\n    }\n    if (vendorPhones.length > 1 && !existing.VendorFax) {\n        detected.VendorFax = vendorPhones[1].phone;\n    }\n    if (customerPhones.length > 0 && !existing.CustomerTel) {\n        detected.CustomerTel = customerPhones[0].phone;\n    }\n    if (customerPhones.length > 1 && !existing.CustomerFax) {\n        detected.CustomerFax = customerPhones[1].phone;\n    }\n}\n\nfunction detectTimes(content, existing, detected) {\n    const timePattern = new RegExp('[0-9]{1,2}:[0-9]{2}(:[0-9]{2})?', 'g');\n    const matches = content.match(timePattern) || [];\n    \n    if (matches.length > 0 && !existing.InvoiceTime) {\n        detected.InvoiceTime = matches[0];\n    }\n    if (matches.length > 1 && !existing.PrintTime) {\n        detected.PrintTime = matches[matches.length - 1];\n    }\n}\n\nfunction detectDates(content, existing, detected) {\n    const dates = [];\n    \n    const pattern1 = new RegExp('[0-9]{1,2}[./][0-9]{1,2}[./][0-9]{4}', 'g');\n    const matches1 = content.match(pattern1) || [];\n    for (let i = 0; i < matches1.length; i++) {\n        const parsed = parseDateString(matches1[i]);\n        if (parsed) {\n            dates.push({\n                date: parsed,\n                position: content.indexOf(matches1[i])\n            });\n        }\n    }\n    \n    dates.sort(function(a, b) { return a.position - b.position; });\n    \n    if (dates.length > 0 && !existing.InvoiceDate) {\n        detected.InvoiceDate = dates[0].date;\n    }\n    if (dates.length > 1 && !existing.DueDate) {\n        detected.DueDate = dates[dates.length - 1].date;\n    }\n}\n\nfunction parseDateString(dateStr) {\n    const parts1 = dateStr.match(/([0-9]{1,2})[./]([0-9]{1,2})[./]([0-9]{4})/);\n    if (parts1) {\n        const day = parts1[1].length === 1 ? '0' + parts1[1] : parts1[1];\n        const month = parts1[2].length === 1 ? '0' + parts1[2] : parts1[2];\n        return parts1[3] + '-' + month + '-' + day;\n    }\n    \n    return null;\n}\n\nfunction detectBankDetails(content, existing, detected) {\n    if (!existing.PaymentDetails_IBAN) {\n        const ibanIdx = content.indexOf('IBAN');\n        if (ibanIdx >= 0) {\n            const afterIban = content.substring(ibanIdx);\n            const ibanPattern = new RegExp('IL[0-9]{21}');\n            const match = afterIban.match(ibanPattern);\n            if (match) {\n                detected.PaymentDetails_IBAN = match[0];\n                \n                const accountNum = match[0].substring(match[0].length - 6);\n                if (!existing.PaymentDetails_AccountNumber) {\n                    detected.PaymentDetails_AccountNumber = accountNum;\n                }\n            }\n        }\n    }\n    \n    if (!existing.PaymentDetails_SWIFT) {\n        const swiftIdx = content.indexOf('SWIFT');\n        if (swiftIdx >= 0) {\n            const afterSwift = content.substring(swiftIdx);\n            const swiftPattern = new RegExp('[A-Z0-9]{8,11}');\n            const match = afterSwift.match(swiftPattern);\n            if (match) {\n                detected.PaymentDetails_SWIFT = match[0];\n            }\n        }\n    }\n}\n\nfunction detectEmails(content, existing, detected) {\n    const emailPattern = new RegExp('[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\\\.[a-zA-Z]{2,}', 'g');\n    const matches = content.match(emailPattern) || [];\n    \n    for (let i = 0; i < matches.length; i++) {\n        const email = matches[i];\n        const position = content.indexOf(email);\n        const isVendor = position < content.length / 3;\n        \n        if (isVendor && !existing.VendorEmail && !detected.VendorEmail) {\n            detected.VendorEmail = email;\n        } else if (!isVendor && !existing.CustomerEmail && !detected.CustomerEmail) {\n            detected.CustomerEmail = email;\n        }\n    }\n}\n\n// ================================================================\n// ✨ חדש! זיהוי דינמי של מידע ייחודי\n// ================================================================\n\nfunction extractUniqueData(content, existingFields) {\n    const uniqueData = [];\n    \n    // 1. זיהוי תבניות \"כותרת: ערך\"\n    const labelValuePairs = extractLabelValuePairs(content, existingFields);\n    for (let i = 0; i < labelValuePairs.length; i++) {\n        uniqueData.push(labelValuePairs[i]);\n    }\n    \n    // 2. זיהוי קודי חלקים/מוצרים\n    const partCodes = extractPartCodes(content, existingFields);\n    for (let i = 0; i < partCodes.length; i++) {\n        uniqueData.push(partCodes[i]);\n    }\n    \n    // 3. זיהוי מספרי רכב\n    const vehicleNumbers = extractVehicleNumbers(content, existingFields);\n    for (let i = 0; i < vehicleNumbers.length; i++) {\n        uniqueData.push(vehicleNumbers[i]);\n    }\n    \n    // 4. זיהוי מספרים ייחודיים באורכים מיוחדים\n    const specialNumbers = extractSpecialLengthNumbers(content, existingFields);\n    for (let i = 0; i < specialNumbers.length; i++) {\n        uniqueData.push(specialNumbers[i]);\n    }\n    \n    return uniqueData;\n}\n\nfunction extractLabelValuePairs(content, existing) {\n    const pairs = [];\n    const lines = content.split('\\n');\n    \n    // דפוסים נפוצים: \"כותרת: ערך\" או \"כותרת ערך\" עם רווח\n    const patterns = [\n        /^([א-תA-Za-z\\s\\.]+):\\s*([^\\n]+)$/,           // כותרת: ערך\n        /^([א-תA-Za-z\\s\\.]{2,20})\\s{2,}([^\\n]+)$/    // כותרת    ערך (2+ רווחים)\n    ];\n    \n    for (let i = 0; i < lines.length; i++) {\n        const line = lines[i].trim();\n        if (!line || line.length < 5) continue;\n        \n        for (let p = 0; p < patterns.length; p++) {\n            const match = line.match(patterns[p]);\n            if (match) {\n                const label = match[1].trim();\n                const value = match[2].trim();\n                \n                // בדוק שהערך לא קיים כבר\n                if (!isValueExists(value, existing) && !isCommonLabel(label)) {\n                    pairs.push({\n                        label: label,\n                        value: value\n                    });\n                }\n                break;\n            }\n        }\n    }\n    \n    return pairs;\n}\n\nfunction extractPartCodes(content, existing) {\n    const codes = [];\n    \n    // דפוסים נפוצים לקודי חלקים:\n    // TOY-XXXXXX, ABC-123456, XXX-XXXXXX\n    const patterns = [\n        /([A-Z]{2,4}-[A-Z0-9]{5,})/g,     // ABC-12345\n        /([A-Z]{3}\\d{5,})/g,               // ABC12345\n        /([A-Z]\\d{5,})/g                   // A12345\n    ];\n    \n    for (let p = 0; p < patterns.length; p++) {\n        const matches = content.match(patterns[p]) || [];\n        for (let i = 0; i < matches.length; i++) {\n            const code = matches[i];\n            if (!isValueExists(code, existing) && !codeAlreadyFound(code, codes)) {\n                // מצא את ההקשר (השורה שבה נמצא)\n                const context = findContext(content, code);\n                codes.push({\n                    label: 'קוד חלק',\n                    value: code,\n                    context: context\n                });\n            }\n        }\n    }\n    \n    return codes;\n}\n\nfunction extractVehicleNumbers(content, existing) {\n    const vehicles = [];\n    \n    // תבניות מספר רכב:\n    // XXX-XX-XXX (ישראל)\n    // XXXXXXX (7 ספרות)\n    const patterns = [\n        /\\b(\\d{2,3}-\\d{2}-\\d{3})\\b/g,      // 123-45-678\n        /\\b(\\d{7,8})\\b/g                    // 1234567\n    ];\n    \n    for (let p = 0; p < patterns.length; p++) {\n        const matches = content.match(patterns[p]) || [];\n        for (let i = 0; i < matches.length && vehicles.length < 5; i++) {\n            const number = matches[i];\n            \n            // בדוק אם זה לא טלפון או תז\n            if (number.indexOf('-') === -1 && (number.length === 9 || number.length === 10)) {\n                continue;\n            }\n            \n            if (!isValueExists(number, existing) && !codeAlreadyFound(number, vehicles)) {\n                const context = findContext(content, number);\n                \n                // נסה לזהות אם זה באמת רכב לפי ההקשר\n                if (context.indexOf('רכב') >= 0 || context.indexOf('כרטיס') >= 0 || \n                    context.indexOf('vehicle') >= 0 || context.indexOf('car') >= 0) {\n                    vehicles.push({\n                        label: 'מספר רכב',\n                        value: number,\n                        context: context\n                    });\n                }\n            }\n        }\n    }\n    \n    return vehicles;\n}\n\nfunction extractSpecialLengthNumbers(content, existing) {\n    const numbers = [];\n    \n    // מספרים באורכים מיוחדים שעשויים להיות חשובים:\n    // 13 ספרות - מספר הקצאה/אסמכתא\n    // 17 תווים - VIN (כבר נתפס על ידי אז'ור, אבל נבדוק)\n    \n    const longNumbers = findAllNumbers(content, 13, 17);\n    \n    for (let i = 0; i < longNumbers.length && numbers.length < 10; i++) {\n        const num = longNumbers[i];\n        \n        if (!isValueExists(num, existing)) {\n            const context = findContext(content, num);\n            \n            let label = 'מספר ייחודי';\n            if (num.length === 13) label = 'מספר הקצאה/אסמכתא';\n            if (num.length === 17) label = 'מספר זיהוי (VIN)';\n            \n            numbers.push({\n                label: label,\n                value: num,\n                context: context\n            });\n        }\n    }\n    \n    return numbers;\n}\n\nfunction findContext(content, value) {\n    const index = content.indexOf(value);\n    if (index === -1) return '';\n    \n    // קח 30 תווים לפני ו-30 אחרי\n    const start = Math.max(0, index - 30);\n    const end = Math.min(content.length, index + value.length + 30);\n    \n    let context = content.substring(start, end);\n    \n    // נקה שורות חדשות מרובות\n    context = context.replace(/\\n+/g, ' ').trim();\n    \n    return context;\n}\n\nfunction isValueExists(value, existing) {\n    // בדוק אם הערך קיים כבר בשדות קיימים\n    const valueStr = value.toString().toLowerCase();\n    \n    for (const key in existing) {\n        const fieldValue = existing[key];\n        \n        if (typeof fieldValue === 'string') {\n            if (fieldValue.toLowerCase().indexOf(valueStr) >= 0) {\n                return true;\n            }\n        } else if (typeof fieldValue === 'number') {\n            if (fieldValue.toString() === valueStr) {\n                return true;\n            }\n        } else if (Array.isArray(fieldValue)) {\n            for (let i = 0; i < fieldValue.length; i++) {\n                const item = fieldValue[i];\n                if (typeof item === 'string' && item.toLowerCase().indexOf(valueStr) >= 0) {\n                    return true;\n                }\n                if (typeof item === 'object') {\n                    if (isValueExists(value, item)) {\n                        return true;\n                    }\n                }\n            }\n        } else if (typeof fieldValue === 'object' && fieldValue !== null) {\n            if (isValueExists(value, fieldValue)) {\n                return true;\n            }\n        }\n    }\n    \n    return false;\n}\n\nfunction isCommonLabel(label) {\n    // רשימת כותרות נפוצות שלא מעניינות\n    const common = [\n        'total', 'sum', 'סך', 'סכום', 'page', 'עמוד',\n        'date', 'תאריך', 'amount', 'כמות', 'price', 'מחיר'\n    ];\n    \n    const labelLower = label.toLowerCase();\n    for (let i = 0; i < common.length; i++) {\n        if (labelLower.indexOf(common[i]) >= 0) {\n            return true;\n        }\n    }\n    \n    return false;\n}\n\nfunction codeAlreadyFound(code, list) {\n    for (let i = 0; i < list.length; i++) {\n        if (list[i].value === code) {\n            return true;\n        }\n    }\n    return false;\n}\n\nfunction findAllNumbers(text, minLen, maxLen) {\n    const numbers = [];\n    let currentNum = '';\n    \n    for (let i = 0; i < text.length; i++) {\n        const char = text[i];\n        if (char >= '0' && char <= '9') {\n            currentNum += char;\n        } else {\n            if (currentNum.length >= minLen && currentNum.length <= maxLen) {\n                numbers.push(currentNum);\n            }\n            currentNum = '';\n        }\n    }\n    \n    if (currentNum.length >= minLen && currentNum.length <= maxLen) {\n        numbers.push(currentNum);\n    }\n    \n    return numbers;\n}\n\nfunction buildStructure(fields) {\n    const structure = {\n        docType: \"string\",\n        fields: {}\n    };\n    \n    for (const fieldName in fields) {\n        const fieldValue = fields[fieldName];\n        if (fieldName === 'Items') {\n            structure.Items = buildItemsStructure(fieldValue);\n        }\n        else if (fieldName === 'UnidentifiedNumbers') {\n            structure.fields.UnidentifiedNumbers = [\"object\"];\n        }\n        else if (Array.isArray(fieldValue)) {\n            structure.fields[fieldName] = [\"string\"];\n        }\n        else {\n            structure.fields[fieldName] = getFieldType(fieldName, fieldValue);\n        }\n    }\n    \n    return structure;\n}\n\nfunction buildItemsStructure(items) {\n    if (!items || items.length === 0) {\n        return [];\n    }\n    \n    const itemStructure = {};\n    const firstItem = items[0];\n    \n    for (const fieldName in firstItem) {\n        itemStructure[fieldName] = getFieldType(fieldName, firstItem[fieldName]);\n    }\n    \n    return [itemStructure];\n}\n\nfunction getFieldType(fieldName, fieldValue) {\n    if (fieldName.indexOf('Date') >= 0) return \"YYYY-MM-DD\";\n    if (fieldName.indexOf('Time') >= 0) return \"HH:MM:SS\";\n    if (fieldName.indexOf('_amount') >= 0) return \"number\";\n    if (fieldName.indexOf('_currency') >= 0) return \"string\";\n    if (typeof fieldValue === 'number') return \"number\";\n    return \"string\";\n}\n\nfunction buildData(result) {\n    return {\n        docType: result.docType,\n        fields: result.fields\n    };\n}\n\n// הרץ את הפונקציה והחזר תוצאה\nconst finalResult = processAzureInvoice(azureJsonInput);\n\nfinalResult.status = 'success';\n\nreturn finalResult;"
                        },
                        "metadata": {
                            "designer": {
                                "x": 2100,
                                "y": 300,
                                "name": "Azure Invoice Processor",
                                "messages": [
                                    {
                                        "category": "reference",
                                        "severity": "warning",
                                        "message": "Referenced module 'JSON - Parse JSON' [113] is not accessible."
                                    }
                                ]
                            },
                            "restore": {
                                "expect": {
                                    "input": {
                                        "items": [
                                            null
                                        ]
                                    },
                                    "language": {
                                        "mode": "chose",
                                        "label": "JavaScript"
                                    },
                                    "inputFormat": {
                                        "label": "Code editor"
                                    }
                                }
                            },
                            "expect": [
                                {
                                    "name": "language",
                                    "type": "select",
                                    "label": "Language",
                                    "required": true,
                                    "validate": {
                                        "enum": [
                                            "javascript",
                                            "python"
                                        ]
                                    }
                                },
                                {
                                    "name": "input",
                                    "spec": {
                                        "name": "value",
                                        "spec": [
                                            {
                                                "name": "name",
                                                "type": "text",
                                                "label": "Name",
                                                "required": true,
                                                "validate": {
                                                    "max": 32,
                                                    "min": 1,
                                                    "pattern": "^[a-zA-Z0-9_]{1,32}$"
                                                }
                                            },
                                            {
                                                "name": "value",
                                                "type": "any",
                                                "label": "Value",
                                                "required": true
                                            }
                                        ],
                                        "type": "collection",
                                        "label": "Variable"
                                    },
                                    "type": "array",
                                    "label": "Input"
                                },
                                {
                                    "name": "dependencies",
                                    "spec": {
                                        "name": "value",
                                        "type": "text",
                                        "label": "Dependency",
                                        "required": true,
                                        "validate": {
                                            "max": 214,
                                            "min": 1,
                                            "pattern": "^[A-Za-z0-9_@\\./<>\\=\\!~\\^+\\-]{1,214}$"
                                        }
                                    },
                                    "type": "array",
                                    "label": "Additional dependencies (Enterprise plans only)"
                                },
                                {
                                    "name": "inputFormat",
                                    "type": "select",
                                    "label": "Input format",
                                    "required": true,
                                    "validate": {
                                        "enum": [
                                            "editor",
                                            "string"
                                        ]
                                    }
                                },
                                {
                                    "name": "codeEditorJavascript",
                                    "type": "editor",
                                    "label": "Code",
                                    "required": true
                                }
                            ]
                        }
                    },
                    {
                        "id": 147,
                        "module": "code:ExecuteCode",
                        "version": 0,
                        "parameters": {},
                        "mapper": {
                            "input": [
                                {
                                    "name": "azureJsonInput",
                                    "value": "{{`113`}}"
                                }
                            ],
                            "language": "javascript",
                            "inputFormat": "editor",
                            "dependencies": [],
                            "codeEditorJavascript": "// ================================================================\n// Azure Invoice Processor v2.0 - Make Compatible\n// תאריך: 30 אוקטובר 2025\n// ================================================================\n\nconst azureJsonInput = input.azureJsonInput;\n\nfunction processAzureInvoice(azureInput) {\n    const analyzeResult = loadAnalyzeResult(azureInput);\n    \n    const rawContent = analyzeResult.content || '';\n    const tables = analyzeResult.tables || [];\n    const documents = analyzeResult.documents || [];\n    \n    const result = {\n        docType: 'invoice',\n        fields: {}\n    };\n    \n    if (documents.length > 0 && documents[0].fields) {\n        extractAzureFields(documents[0].fields, result.fields);\n    }\n    \n    const itemsData = extractRealItemsFromTable(tables, result.fields.Items);\n    if (itemsData.length > 0) {\n        result.fields.Items = itemsData;\n    }\n    \n    const detectedNumbers = detectNumbersByContext(rawContent, result.fields);\n    Object.assign(result.fields, detectedNumbers);\n    \n    // ✨ חדש! זיהוי דינמי של מידע ייחודי\n    const uniqueData = extractUniqueData(rawContent, result.fields);\n    if (uniqueData.length > 0) {\n        result.fields.UnidentifiedNumbers = uniqueData;\n    }\n    \n    const structure = buildStructure(result.fields);\n    const data = buildData(result);\n    \n    return {\n        structure: structure,\n        data: data,\n        metadata: {\n            modelId: analyzeResult.modelId,\n            totalFields: Object.keys(result.fields).length,\n            uniqueDataFound: uniqueData.length\n        }\n    };\n}\n\nfunction loadAnalyzeResult(input) {\n    if (Array.isArray(input) && input[0] && input[0].analyzeResult) {\n        return input[0].analyzeResult;\n    }\n    if (input.analyzeResult) {\n        return input.analyzeResult;\n    }\n    if (input.content || input.tables) {\n        return input;\n    }\n    throw new Error('Invalid input format');\n}\n\nfunction extractAzureFields(fields, target) {\n    for (const fieldName in fields) {\n        const fieldData = fields[fieldName];\n        if (!fieldData) continue;\n        \n        const type = fieldData.type;\n        \n        if (type === 'string') {\n            target[fieldName] = fieldData.valueString || fieldData.content;\n        }\n        else if (type === 'date') {\n            target[fieldName] = fieldData.valueDate || fieldData.content;\n        }\n        else if (type === 'number') {\n            target[fieldName] = fieldData.valueNumber;\n        }\n        else if (type === 'currency') {\n            if (fieldData.valueCurrency) {\n                target[fieldName + '_amount'] = fieldData.valueCurrency.amount;\n                target[fieldName + '_currency'] = fieldData.valueCurrency.currencyCode;\n            }\n        }\n        else if (type === 'address') {\n            target[fieldName] = fieldData.content;\n            if (fieldData.valueAddress) {\n                for (const key in fieldData.valueAddress) {\n                    const value = fieldData.valueAddress[key];\n                    if (value) {\n                        target[fieldName + '_' + key] = value;\n                    }\n                }\n            }\n        }\n        else if (type === 'array') {\n            if (fieldName === 'Items' && fieldData.valueArray) {\n                target.Items = [];\n                for (let i = 0; i < fieldData.valueArray.length; i++) {\n                    const item = fieldData.valueArray[i];\n                    if (item.valueObject) {\n                        const itemData = {};\n                        for (const key in item.valueObject) {\n                            const val = item.valueObject[key];\n                            if (val.type === 'currency' && val.valueCurrency) {\n                                itemData[key + '_amount'] = val.valueCurrency.amount;\n                                itemData[key + '_currency'] = val.valueCurrency.currencyCode;\n                            }\n                            else if (val.type === 'number') {\n                                itemData[key] = val.valueNumber;\n                            }\n                            else {\n                                itemData[key] = val.valueString || val.content;\n                            }\n                        }\n                        target.Items.push(itemData);\n                    }\n                }\n            }\n            else if (fieldName === 'PaymentDetails' && fieldData.valueArray) {\n                for (let i = 0; i < fieldData.valueArray.length; i++) {\n                    const payment = fieldData.valueArray[i];\n                    if (payment.valueObject) {\n                        for (const key in payment.valueObject) {\n                            const val = payment.valueObject[key];\n                            target['PaymentDetails_' + key] = val.valueString || val.content;\n                        }\n                    }\n                }\n            }\n        }\n    }\n}\n\nfunction extractRealItemsFromTable(tables, azureItems) {\n    if (azureItems && azureItems.length > 0) {\n        return azureItems;\n    }\n    \n    if (!tables || tables.length === 0) {\n        return [];\n    }\n    \n    let mainTable = {};\n    let maxCells = 0;\n    \n    for (let i = 0; i < tables.length; i++) {\n        const table = tables[i];\n        if (table.cells && table.cells.length > maxCells) {\n            mainTable = table;\n            maxCells = table.cells.length;\n        }\n    }\n    \n    if (!mainTable.cells) {\n        return [];\n    }\n    \n    const headers = [];\n    const dataCells = [];\n    \n    for (let i = 0; i < mainTable.cells.length; i++) {\n        const cell = mainTable.cells[i];\n        if (cell.kind === 'columnHeader') {\n            headers.push(cell);\n        } else {\n            dataCells.push(cell);\n        }\n    }\n    \n    const columnMap = {};\n    for (let i = 0; i < headers.length; i++) {\n        const header = headers[i];\n        columnMap[header.columnIndex] = {\n            content: header.content,\n            fieldName: guessFieldNameGeneric(header.content, header.columnIndex)\n        };\n    }\n    \n    const rowsData = {};\n    for (let i = 0; i < dataCells.length; i++) {\n        const cell = dataCells[i];\n        const rowIdx = cell.rowIndex;\n        \n        if (!rowsData[rowIdx]) {\n            rowsData[rowIdx] = {};\n        }\n        \n        const colInfo = columnMap[cell.columnIndex];\n        if (colInfo && cell.content && cell.content.trim()) {\n            rowsData[rowIdx][colInfo.fieldName] = parseValue(cell.content);\n        }\n    }\n    \n    const items = [];\n    for (const rowIdx in rowsData) {\n        const rowData = rowsData[rowIdx];\n        if (isRealItemRow(rowData)) {\n            items.push(rowData);\n        }\n    }\n    \n    return items;\n}\n\nfunction guessFieldNameGeneric(content, colIndex) {\n    if (!content || content.trim() === '') {\n        return 'Col' + colIndex;\n    }\n    \n    const text = content.toLowerCase();\n    \n    if (content === '=' || text.indexOf('total') >= 0 || text.indexOf('amount') >= 0 || \n        text.indexOf('סכום') >= 0 || text.indexOf('סה') >= 0) return 'Amount';\n    if (content === '%' || text.indexOf('discount') >= 0 || text.indexOf('הנח') >= 0) return 'Discount';\n    if (text.indexOf('qty') >= 0 || text.indexOf('quantity') >= 0 || text.indexOf('כמות') >= 0) return 'Quantity';\n    if (text.indexOf('price') >= 0 || text.indexOf('מחיר') >= 0) return 'UnitPrice';\n    if (text.indexOf('code') >= 0 || text.indexOf('sku') >= 0 || text.indexOf('item') >= 0 || \n        text.indexOf('מק') >= 0 || text.indexOf('פריט') >= 0) return 'ProductCode';\n    if (text.indexOf('desc') >= 0 || text.indexOf('name') >= 0 || \n        text.indexOf('תאור') >= 0 || text.indexOf('שם') >= 0) return 'Description';\n    if (text.indexOf('unit') >= 0 || text.indexOf('יח') >= 0) return 'Unit';\n    \n    return 'Col' + colIndex;\n}\n\nfunction isRealItemRow(rowData) {\n    const keys = Object.keys(rowData);\n    \n    if (keys.length < 2) {\n        return false;\n    }\n    \n    const hasAmount = rowData.Amount !== undefined;\n    const hasProductCode = rowData.ProductCode !== undefined;\n    const hasDescription = rowData.Description !== undefined;\n    \n    if (!hasAmount && !hasProductCode && !hasDescription) {\n        return false;\n    }\n    \n    if (hasAmount && keys.length === 1) {\n        return false;\n    }\n    \n    if (hasAmount) {\n        const amount = rowData.Amount;\n        if (typeof amount === 'number' && amount > 0) {\n            return true;\n        }\n    }\n    \n    if (hasProductCode) {\n        const code = rowData.ProductCode;\n        if (typeof code === 'number' || (typeof code === 'string' && code.length > 0)) {\n            return true;\n        }\n    }\n    \n    return true;\n}\n\nfunction parseValue(value) {\n    if (typeof value !== 'string') return value;\n    \n    const cleaned = value.replace(/,/g, '').trim();\n    const numPattern = new RegExp('^[0-9]+\\\\.?[0-9]*$');\n    \n    if (numPattern.test(cleaned)) {\n        const num = parseFloat(cleaned);\n        if (!isNaN(num)) {\n            return num;\n        }\n    }\n    \n    return value;\n}\n\nfunction detectNumbersByContext(content, existingFields) {\n    const detected = {};\n    \n    if (!content) return detected;\n    \n    detectVendorAdditionalId(content, existingFields, detected);\n    detectPhoneNumbers(content, existingFields, detected);\n    detectTimes(content, existingFields, detected);\n    detectDates(content, existingFields, detected);\n    detectBankDetails(content, existingFields, detected);\n    detectEmails(content, existingFields, detected);\n    \n    return detected;\n}\n\nfunction detectVendorAdditionalId(content, existing, detected) {\n    const companyIdx = content.indexOf('Company');\n    if (companyIdx === -1) return;\n    \n    const afterCompany = content.substring(companyIdx);\n    const numbers = findAllNumbers(afterCompany, 9, 10);\n    \n    if (numbers.length >= 2) {\n        const first = numbers[0];\n        const second = numbers[1];\n        \n        if (second !== first && \n            second !== existing.VendorTaxId &&\n            second !== existing.CustomerTaxId) {\n            detected.VendorAdditionalId = second;\n        }\n    }\n}\n\nfunction detectPhoneNumbers(content, existing, detected) {\n    const phonePattern = new RegExp('[0-9]{2,3}[-\\\\s][0-9]{7,8}', 'g');\n    const matches = content.match(phonePattern) || [];\n    \n    const usedNumbers = [];\n    if (existing.VendorTaxId) usedNumbers.push(existing.VendorTaxId);\n    if (existing.CustomerTaxId) usedNumbers.push(existing.CustomerTaxId);\n    \n    const phones = [];\n    for (let i = 0; i < matches.length; i++) {\n        const phone = matches[i];\n        \n        if (phone.indexOf('\\n') >= 0 || phone.indexOf('\\r') >= 0) {\n            continue;\n        }\n        \n        const cleanPhone = phone.replace(/[-\\s]/g, '');\n        \n        let isUsed = false;\n        for (let j = 0; j < usedNumbers.length; j++) {\n            if (usedNumbers[j] === cleanPhone) {\n                isUsed = true;\n                break;\n            }\n        }\n        \n        if (!isUsed) {\n            const position = content.indexOf(phone);\n            phones.push({\n                phone: phone,\n                position: position,\n                isVendor: position < content.length / 3\n            });\n        }\n    }\n    \n    const vendorPhones = [];\n    const customerPhones = [];\n    \n    for (let i = 0; i < phones.length; i++) {\n        if (phones[i].isVendor) {\n            vendorPhones.push(phones[i]);\n        } else {\n            customerPhones.push(phones[i]);\n        }\n    }\n    \n    if (vendorPhones.length > 0 && !existing.VendorTel) {\n        detected.VendorTel = vendorPhones[0].phone;\n    }\n    if (vendorPhones.length > 1 && !existing.VendorFax) {\n        detected.VendorFax = vendorPhones[1].phone;\n    }\n    if (customerPhones.length > 0 && !existing.CustomerTel) {\n        detected.CustomerTel = customerPhones[0].phone;\n    }\n    if (customerPhones.length > 1 && !existing.CustomerFax) {\n        detected.CustomerFax = customerPhones[1].phone;\n    }\n}\n\nfunction detectTimes(content, existing, detected) {\n    const timePattern = new RegExp('[0-9]{1,2}:[0-9]{2}(:[0-9]{2})?', 'g');\n    const matches = content.match(timePattern) || [];\n    \n    if (matches.length > 0 && !existing.InvoiceTime) {\n        detected.InvoiceTime = matches[0];\n    }\n    if (matches.length > 1 && !existing.PrintTime) {\n        detected.PrintTime = matches[matches.length - 1];\n    }\n}\n\nfunction detectDates(content, existing, detected) {\n    const dates = [];\n    \n    const pattern1 = new RegExp('[0-9]{1,2}[./][0-9]{1,2}[./][0-9]{4}', 'g');\n    const matches1 = content.match(pattern1) || [];\n    for (let i = 0; i < matches1.length; i++) {\n        const parsed = parseDateString(matches1[i]);\n        if (parsed) {\n            dates.push({\n                date: parsed,\n                position: content.indexOf(matches1[i])\n            });\n        }\n    }\n    \n    dates.sort(function(a, b) { return a.position - b.position; });\n    \n    if (dates.length > 0 && !existing.InvoiceDate) {\n        detected.InvoiceDate = dates[0].date;\n    }\n    if (dates.length > 1 && !existing.DueDate) {\n        detected.DueDate = dates[dates.length - 1].date;\n    }\n}\n\nfunction parseDateString(dateStr) {\n    const parts1 = dateStr.match(/([0-9]{1,2})[./]([0-9]{1,2})[./]([0-9]{4})/);\n    if (parts1) {\n        const day = parts1[1].length === 1 ? '0' + parts1[1] : parts1[1];\n        const month = parts1[2].length === 1 ? '0' + parts1[2] : parts1[2];\n        return parts1[3] + '-' + month + '-' + day;\n    }\n    \n    return null;\n}\n\nfunction detectBankDetails(content, existing, detected) {\n    if (!existing.PaymentDetails_IBAN) {\n        const ibanIdx = content.indexOf('IBAN');\n        if (ibanIdx >= 0) {\n            const afterIban = content.substring(ibanIdx);\n            const ibanPattern = new RegExp('IL[0-9]{21}');\n            const match = afterIban.match(ibanPattern);\n            if (match) {\n                detected.PaymentDetails_IBAN = match[0];\n                \n                const accountNum = match[0].substring(match[0].length - 6);\n                if (!existing.PaymentDetails_AccountNumber) {\n                    detected.PaymentDetails_AccountNumber = accountNum;\n                }\n            }\n        }\n    }\n    \n    if (!existing.PaymentDetails_SWIFT) {\n        const swiftIdx = content.indexOf('SWIFT');\n        if (swiftIdx >= 0) {\n            const afterSwift = content.substring(swiftIdx);\n            const swiftPattern = new RegExp('[A-Z0-9]{8,11}');\n            const match = afterSwift.match(swiftPattern);\n            if (match) {\n                detected.PaymentDetails_SWIFT = match[0];\n            }\n        }\n    }\n}\n\nfunction detectEmails(content, existing, detected) {\n    const emailPattern = new RegExp('[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\\\.[a-zA-Z]{2,}', 'g');\n    const matches = content.match(emailPattern) || [];\n    \n    for (let i = 0; i < matches.length; i++) {\n        const email = matches[i];\n        const position = content.indexOf(email);\n        const isVendor = position < content.length / 3;\n        \n        if (isVendor && !existing.VendorEmail && !detected.VendorEmail) {\n            detected.VendorEmail = email;\n        } else if (!isVendor && !existing.CustomerEmail && !detected.CustomerEmail) {\n            detected.CustomerEmail = email;\n        }\n    }\n}\n\n// ================================================================\n// ✨ חדש! זיהוי דינמי של מידע ייחודי\n// ================================================================\n\nfunction extractUniqueData(content, existingFields) {\n    const uniqueData = [];\n\n    // 1. זיהוי תבניות \"כותרת: ערך\"\n    const labelValuePairs = extractLabelValuePairs(content, existingFields);\n    for (let i = 0; i < labelValuePairs.length; i++) {\n        uniqueData.push(labelValuePairs[i]);\n    }\n\n    // 2. זיהוי קודי חלקים/מוצרים\n    const partCodes = extractPartCodes(content, existingFields);\n    for (let i = 0; i < partCodes.length; i++) {\n        uniqueData.push(partCodes[i]);\n    }\n\n    // 3. זיהוי מספרי רכב\n    const vehicleNumbers = extractVehicleNumbers(content, existingFields);\n    for (let i = 0; i < vehicleNumbers.length; i++) {\n        uniqueData.push(vehicleNumbers[i]);\n    }\n\n    // 4. זיהוי מספרי תעודות (DOCNO, BOOKNUM)\n    const documentNumbers = extractDocumentNumbers(content, existingFields);\n    for (let i = 0; i < documentNumbers.length; i++) {\n        uniqueData.push(documentNumbers[i]);\n    }\n\n    // 5. זיהוי מספרים ייחודיים באורכים מיוחדים\n    const specialNumbers = extractSpecialLengthNumbers(content, existingFields);\n    for (let i = 0; i < specialNumbers.length; i++) {\n        uniqueData.push(specialNumbers[i]);\n    }\n\n    return uniqueData;\n}\n\nfunction extractLabelValuePairs(content, existing) {\n    const pairs = [];\n    const lines = content.split('\\n');\n    \n    // דפוסים נפוצים: \"כותרת: ערך\" או \"כותרת ערך\" עם רווח\n    const patterns = [\n        /^([א-תA-Za-z\\s\\.]+):\\s*([^\\n]+)$/,           // כותרת: ערך\n        /^([א-תA-Za-z\\s\\.]{2,20})\\s{2,}([^\\n]+)$/    // כותרת    ערך (2+ רווחים)\n    ];\n    \n    for (let i = 0; i < lines.length; i++) {\n        const line = lines[i].trim();\n        if (!line || line.length < 5) continue;\n        \n        for (let p = 0; p < patterns.length; p++) {\n            const match = line.match(patterns[p]);\n            if (match) {\n                const label = match[1].trim();\n                const value = match[2].trim();\n                \n                // בדוק שהערך לא קיים כבר\n                if (!isValueExists(value, existing) && !isCommonLabel(label)) {\n                    pairs.push({\n                        label: label,\n                        value: value\n                    });\n                }\n                break;\n            }\n        }\n    }\n    \n    return pairs;\n}\n\nfunction extractPartCodes(content, existing) {\n    const codes = [];\n    \n    // דפוסים נפוצים לקודי חלקים:\n    // TOY-XXXXXX, ABC-123456, XXX-XXXXXX\n    const patterns = [\n        /([A-Z]{2,4}-[A-Z0-9]{5,})/g,     // ABC-12345\n        /([A-Z]{3}\\d{5,})/g,               // ABC12345\n        /([A-Z]\\d{5,})/g                   // A12345\n    ];\n    \n    for (let p = 0; p < patterns.length; p++) {\n        const matches = content.match(patterns[p]) || [];\n        for (let i = 0; i < matches.length; i++) {\n            const code = matches[i];\n            if (!isValueExists(code, existing) && !codeAlreadyFound(code, codes)) {\n                // מצא את ההקשר (השורה שבה נמצא)\n                const context = findContext(content, code);\n                codes.push({\n                    label: 'קוד חלק',\n                    value: code,\n                    context: context\n                });\n            }\n        }\n    }\n    \n    return codes;\n}\n\nfunction extractVehicleNumbers(content, existing) {\n    const vehicles = [];\n    \n    // תבניות מספר רכב:\n    // XXX-XX-XXX (ישראל)\n    // XXXXXXX (7 ספרות)\n    const patterns = [\n        /\\b(\\d{2,3}-\\d{2}-\\d{3})\\b/g,      // 123-45-678\n        /\\b(\\d{7,8})\\b/g                    // 1234567\n    ];\n    \n    for (let p = 0; p < patterns.length; p++) {\n        const matches = content.match(patterns[p]) || [];\n        for (let i = 0; i < matches.length && vehicles.length < 5; i++) {\n            const number = matches[i];\n            \n            // בדוק אם זה לא טלפון או תז\n            if (number.indexOf('-') === -1 && (number.length === 9 || number.length === 10)) {\n                continue;\n            }\n            \n            if (!isValueExists(number, existing) && !codeAlreadyFound(number, vehicles)) {\n                const context = findContext(content, number);\n                \n                // נסה לזהות אם זה באמת רכב לפי ההקשר\n                if (context.indexOf('רכב') >= 0 || context.indexOf('כרטיס') >= 0 || \n                    context.indexOf('vehicle') >= 0 || context.indexOf('car') >= 0) {\n                    vehicles.push({\n                        label: 'מספר רכב',\n                        value: number,\n                        context: context\n                    });\n                }\n            }\n        }\n    }\n    \n    return vehicles;\n}\n\nfunction extractDocumentNumbers(content, existing) {\n    const documents = [];\n\n    // תבניות מספרי תעודות:\n    // DOCNO: 25XXXXXX (8 ספרות, מתחיל ב-25)\n    // BOOKNUM: 108XXXXXX (9 ספרות, מתחיל ב-108)\n    const patterns = [\n        { pattern: /\\b(25\\d{6})\\b/g, label: 'מס׳ תעודה (DOCNO)' },\n        { pattern: /\\b(108\\d{6})\\b/g, label: 'מס׳ הקצאה (BOOKNUM)' }\n    ];\n\n    for (let p = 0; p < patterns.length; p++) {\n        const patternObj = patterns[p];\n        const matches = content.match(patternObj.pattern) || [];\n\n        for (let i = 0; i < matches.length; i++) {\n            const number = matches[i];\n\n            // בדוק אם המספר לא קיים כבר\n            if (!isValueExists(number, existing) && !codeAlreadyFound(number, documents)) {\n                const context = findContext(content, number);\n\n                documents.push({\n                    label: patternObj.label,\n                    value: number,\n                    context: context\n                });\n            }\n        }\n    }\n\n    return documents;\n}\n\nfunction extractSpecialLengthNumbers(content, existing) {\n    const numbers = [];\n\n    // מספרים באורכים מיוחדים שעשויים להיות חשובים:\n    // 13 ספרות - מספר הקצאה/אסמכתא\n    // 17 תווים - VIN (כבר נתפס על ידי אז'ור, אבל נבדוק)\n\n    const longNumbers = findAllNumbers(content, 13, 17);\n\n    for (let i = 0; i < longNumbers.length && numbers.length < 10; i++) {\n        const num = longNumbers[i];\n\n        if (!isValueExists(num, existing)) {\n            const context = findContext(content, num);\n\n            let label = 'מספר ייחודי';\n            if (num.length === 13) label = 'מספר הקצאה/אסמכתא';\n            if (num.length === 17) label = 'מספר זיהוי (VIN)';\n\n            numbers.push({\n                label: label,\n                value: num,\n                context: context\n            });\n        }\n    }\n\n    return numbers;\n}\n\nfunction findContext(content, value) {\n    const index = content.indexOf(value);\n    if (index === -1) return '';\n    \n    // קח 30 תווים לפני ו-30 אחרי\n    const start = Math.max(0, index - 30);\n    const end = Math.min(content.length, index + value.length + 30);\n    \n    let context = content.substring(start, end);\n    \n    // נקה שורות חדשות מרובות\n    context = context.replace(/\\n+/g, ' ').trim();\n    \n    return context;\n}\n\nfunction isValueExists(value, existing) {\n    // בדוק אם הערך קיים כבר בשדות קיימים\n    const valueStr = value.toString().toLowerCase();\n    \n    for (const key in existing) {\n        const fieldValue = existing[key];\n        \n        if (typeof fieldValue === 'string') {\n            if (fieldValue.toLowerCase().indexOf(valueStr) >= 0) {\n                return true;\n            }\n        } else if (typeof fieldValue === 'number') {\n            if (fieldValue.toString() === valueStr) {\n                return true;\n            }\n        } else if (Array.isArray(fieldValue)) {\n            for (let i = 0; i < fieldValue.length; i++) {\n                const item = fieldValue[i];\n                if (typeof item === 'string' && item.toLowerCase().indexOf(valueStr) >= 0) {\n                    return true;\n                }\n                if (typeof item === 'object') {\n                    if (isValueExists(value, item)) {\n                        return true;\n                    }\n                }\n            }\n        } else if (typeof fieldValue === 'object' && fieldValue !== null) {\n            if (isValueExists(value, fieldValue)) {\n                return true;\n            }\n        }\n    }\n    \n    return false;\n}\n\nfunction isCommonLabel(label) {\n    // רשימת כותרות נפוצות שלא מעניינות\n    const common = [\n        'total', 'sum', 'סך', 'סכום', 'page', 'עמוד',\n        'date', 'תאריך', 'amount', 'כמות', 'price', 'מחיר'\n    ];\n    \n    const labelLower = label.toLowerCase();\n    for (let i = 0; i < common.length; i++) {\n        if (labelLower.indexOf(common[i]) >= 0) {\n            return true;\n        }\n    }\n    \n    return false;\n}\n\nfunction codeAlreadyFound(code, list) {\n    for (let i = 0; i < list.length; i++) {\n        if (list[i].value === code) {\n            return true;\n        }\n    }\n    return false;\n}\n\nfunction findAllNumbers(text, minLen, maxLen) {\n    const numbers = [];\n    let currentNum = '';\n    \n    for (let i = 0; i < text.length; i++) {\n        const char = text[i];\n        if (char >= '0' && char <= '9') {\n            currentNum += char;\n        } else {\n            if (currentNum.length >= minLen && currentNum.length <= maxLen) {\n                numbers.push(currentNum);\n            }\n            currentNum = '';\n        }\n    }\n    \n    if (currentNum.length >= minLen && currentNum.length <= maxLen) {\n        numbers.push(currentNum);\n    }\n    \n    return numbers;\n}\n\nfunction buildStructure(fields) {\n    const structure = {\n        docType: \"string\",\n        fields: {}\n    };\n    \n    for (const fieldName in fields) {\n        const fieldValue = fields[fieldName];\n        if (fieldName === 'Items') {\n            structure.Items = buildItemsStructure(fieldValue);\n        }\n        else if (fieldName === 'UnidentifiedNumbers') {\n            structure.fields.UnidentifiedNumbers = [\"object\"];\n        }\n        else if (Array.isArray(fieldValue)) {\n            structure.fields[fieldName] = [\"string\"];\n        }\n        else {\n            structure.fields[fieldName] = getFieldType(fieldName, fieldValue);\n        }\n    }\n    \n    return structure;\n}\n\nfunction buildItemsStructure(items) {\n    if (!items || items.length === 0) {\n        return [];\n    }\n    \n    const itemStructure = {};\n    const firstItem = items[0];\n    \n    for (const fieldName in firstItem) {\n        itemStructure[fieldName] = getFieldType(fieldName, firstItem[fieldName]);\n    }\n    \n    return [itemStructure];\n}\n\nfunction getFieldType(fieldName, fieldValue) {\n    if (fieldName.indexOf('Date') >= 0) return \"YYYY-MM-DD\";\n    if (fieldName.indexOf('Time') >= 0) return \"HH:MM:SS\";\n    if (fieldName.indexOf('_amount') >= 0) return \"number\";\n    if (fieldName.indexOf('_currency') >= 0) return \"string\";\n    if (typeof fieldValue === 'number') return \"number\";\n    return \"string\";\n}\n\nfunction buildData(result) {\n    return {\n        docType: result.docType,\n        fields: result.fields\n    };\n}\n\n// הרץ את הפונקציה והחזר תוצאה\nconst finalResult = processAzureInvoice(azureJsonInput);\n\nfinalResult.status = 'success';\n\nreturn finalResult;"
                        },
                        "metadata": {
                            "designer": {
                                "x": 2400,
                                "y": 300,
                                "name": "Azure Invoice Processor",
                                "messages": [
                                    {
                                        "category": "reference",
                                        "severity": "warning",
                                        "message": "Referenced module 'JSON - Parse JSON' [113] is not accessible."
                                    }
                                ]
                            },
                            "restore": {
                                "expect": {
                                    "input": {
                                        "items": [
                                            null
                                        ]
                                    },
                                    "language": {
                                        "mode": "chose",
                                        "label": "JavaScript"
                                    },
                                    "inputFormat": {
                                        "label": "Code editor"
                                    }
                                }
                            },
                            "expect": [
                                {
                                    "name": "language",
                                    "type": "select",
                                    "label": "Language",
                                    "required": true,
                                    "validate": {
                                        "enum": [
                                            "javascript",
                                            "python"
                                        ]
                                    }
                                },
                                {
                                    "name": "input",
                                    "spec": {
                                        "name": "value",
                                        "spec": [
                                            {
                                                "name": "name",
                                                "type": "text",
                                                "label": "Name",
                                                "required": true,
                                                "validate": {
                                                    "max": 32,
                                                    "min": 1,
                                                    "pattern": "^[a-zA-Z0-9_]{1,32}$"
                                                }
                                            },
                                            {
                                                "name": "value",
                                                "type": "any",
                                                "label": "Value",
                                                "required": true
                                            }
                                        ],
                                        "type": "collection",
                                        "label": "Variable"
                                    },
                                    "type": "array",
                                    "label": "Input"
                                },
                                {
                                    "name": "dependencies",
                                    "spec": {
                                        "name": "value",
                                        "type": "text",
                                        "label": "Dependency",
                                        "required": true,
                                        "validate": {
                                            "max": 214,
                                            "min": 1,
                                            "pattern": "^[A-Za-z0-9_@\\./<>\\=\\!~\\^+\\-]{1,214}$"
                                        }
                                    },
                                    "type": "array",
                                    "label": "Additional dependencies (Enterprise plans only)"
                                },
                                {
                                    "name": "inputFormat",
                                    "type": "select",
                                    "label": "Input format",
                                    "required": true,
                                    "validate": {
                                        "enum": [
                                            "editor",
                                            "string"
                                        ]
                                    }
                                },
                                {
                                    "name": "codeEditorJavascript",
                                    "type": "editor",
                                    "label": "Code",
                                    "required": true
                                }
                            ]
                        }
                    },
                    {
                        "id": 148,
                        "module": "code:ExecuteCode",
                        "version": 0,
                        "parameters": {},
                        "mapper": {
                            "input": [
                                {
                                    "name": "supplier_id",
                                    "value": "{{65.result.invoices_summary[].SUPNAME}}"
                                },
                                {
                                    "name": "invoices_json",
                                    "value": "{{65.result.cleaned_json}}"
                                }
                            ],
                            "language": "javascript",
                            "inputFormat": "editor",
                            "dependencies": [],
                            "codeEditorJavascript": "// Supplier Data Learning - גרסה 1.2\n// תאריך: 28 אוקטובר 2025\n// עדכונים: מבנה JSON חדש, לוגיקה משופרת, תמיכה ברכבים, DEBIT כתבנית נפרדת\n\n// ============================================================================\n// פונקציות עזר - המרת תאריכים\n// ============================================================================\n\nfunction convertDateToFormat(dateStr) {\n    if (!dateStr) return '';\n    \n    // אם כבר בפורמט DD/MM/YY\n    if (typeof dateStr === 'string' && dateStr.match(/^\\d{2}\\/\\d{2}\\/\\d{2}$/)) {\n        return dateStr;\n    }\n    \n    // אם ISO format\n    const date = new Date(dateStr);\n    if (isNaN(date.getTime())) return dateStr;\n    \n    const day = String(date.getDate()).padStart(2, '0');\n    const month = String(date.getMonth() + 1).padStart(2, '0');\n    const year = String(date.getFullYear()).slice(-2);\n    \n    return `${day}/${month}/${year}`;\n}\n\n// ============================================================================\n// פונקציה לזיהוי סוג מסמך + DEBIT\n// ============================================================================\n\nfunction identifyDocumentType(invoice) {\n    const hasImport = !!invoice.IMPFNUM;\n    const debitType = invoice.DEBIT || 'D';\n    \n    const accnames = new Set();\n    let hasDateRange = false;\n    let hasBudcode = false;\n    let hasPdaccname = false;\n    \n    if (invoice.PINVOICEITEMS || invoice.PINVOICEITEMS_SUBFORM) {\n        const items = invoice.PINVOICEITEMS || invoice.PINVOICEITEMS_SUBFORM;\n        items.forEach(item => {\n            if (item.ACCNAME) accnames.add(item.ACCNAME);\n            if (item.FROMDATE || item.TODATE) hasDateRange = true;\n            if (item.BUDCODE) hasBudcode = true;\n            if (item.PDACCNAME) hasPdaccname = true;\n        });\n    }\n    \n    const hasDoc = !!((invoice.PIVDOC && invoice.PIVDOC.length > 0) || \n                      (invoice.PIVDOC_SUBFORM && invoice.PIVDOC_SUBFORM.length > 0) ||\n                      invoice.DOCNO);\n    \n    const accnamesSorted = Array.from(accnames).sort().join(',');\n    \n    return {\n        type_key: `${hasImport ? 'IMP' : 'REG'}_${debitType}_ACC_${accnamesSorted}_DR_${hasDateRange}_BUD_${hasBudcode}_PD_${hasPdaccname}_DOC_${hasDoc}`,\n        has_import: hasImport,\n        debit_type: debitType,\n        accnames: Array.from(accnames),\n        has_date_range: hasDateRange,\n        has_budcode: hasBudcode,\n        has_pdaccname: hasPdaccname,\n        has_doc: hasDoc\n    };\n}\n\n// ============================================================================\n// ניתוח inventory_management\n// ============================================================================\n\nfunction analyzeInventoryManagement(invoices) {\n    const prsourcenames = new Set();\n    \n    invoices.forEach(invoice => {\n        const items = invoice.PINVOICEITEMS || invoice.PINVOICEITEMS_SUBFORM;\n        if (items && items.length > 0 && items[0].PRSOURCENAME) {\n            prsourcenames.add(items[0].PRSOURCENAME);\n        }\n    });\n    \n    // אם כל החשבוניות עם אותו PRSOURCENAME\n    if (prsourcenames.size === 1) {\n        const value = Array.from(prsourcenames)[0];\n        if (value === 'קבלה למלאי') return 'managed_inventory';\n        if (value === 'ידני') return 'not_managed_inventory';\n    }\n    \n    return 'not_managed_inventory'; // ברירת מחדל\n}\n\n// ============================================================================\n// חילוץ מידע ספק (vendor_tax_id, phone, email)\n// ============================================================================\n\nfunction extractSupplierInfo(invoices) {\n    const info = {\n        vendor_tax_id_reference: '',\n        supplier_phone: '',\n        supplier_email: ''\n    };\n    \n    for (const invoice of invoices) {\n        const cont = invoice.PINVOICESCONT || invoice.PINVOICESCONT_SUBFORM;\n        if (cont && cont.length > 0) {\n            if (!info.vendor_tax_id_reference && cont[0].IVREF) {\n                info.vendor_tax_id_reference = cont[0].IVREF;\n            }\n            if (!info.supplier_phone && cont[0].PHONE) {\n                info.supplier_phone = cont[0].PHONE;\n            }\n            if (!info.supplier_email && cont[0].EMAIL) {\n                info.supplier_email = cont[0].EMAIL;\n            }\n        }\n        \n        if (info.vendor_tax_id_reference && info.supplier_phone && info.supplier_email) {\n            break;\n        }\n    }\n    \n    return info;\n}\n\n// ============================================================================\n// ניתוח חוקי רכבים\n// ============================================================================\n\nfunction analyzeVehicleRules(invoices) {\n    const vehicleData = {};\n    \n    invoices.forEach(invoice => {\n        const items = invoice.PINVOICEITEMS || invoice.PINVOICEITEMS_SUBFORM;\n        if (!items) return;\n        \n        items.forEach(item => {\n            if (item.PARTNAME !== 'car') return;\n            \n            // חילוץ מספר רכב מ-ACCDES\n            const accdes = item.ACCDES || '';\n            const vehicleMatch = accdes.match(/^(\\d{3}-\\d{2}-\\d{3})/);\n            \n            if (vehicleMatch && item.ACCNAME) {\n                const vehicleNumber = vehicleMatch[1];\n                \n                if (!vehicleData[vehicleNumber]) {\n                    vehicleData[vehicleNumber] = {\n                        accname: item.ACCNAME,\n                        accdes: accdes,\n                        vatflag_values: new Set(),\n                        specialvatflag_values: new Set(),\n                        has_fromdate: new Set(),\n                        has_todate: new Set(),\n                        has_pdaccname: new Set()\n                    };\n                }\n                \n                const vd = vehicleData[vehicleNumber];\n                if (item.VATFLAG) vd.vatflag_values.add(item.VATFLAG);\n                if (item.SPECIALVATFLAG) vd.specialvatflag_values.add(item.SPECIALVATFLAG);\n                vd.has_fromdate.add(!!item.FROMDATE);\n                vd.has_todate.add(!!item.TODATE);\n                vd.has_pdaccname.add(!!item.PDACCNAME);\n            }\n        });\n    });\n    \n    // המרה לפורמט סופי\n    const vehicleRules = {};\n    Object.keys(vehicleData).forEach(vehicleNumber => {\n        const vd = vehicleData[vehicleNumber];\n        \n        vehicleRules[vehicleNumber] = {\n            accname: vd.accname,\n            accdes: vd.accdes,\n            vat_pattern: {\n                VATFLAG: vd.vatflag_values.size === 1 ? Array.from(vd.vatflag_values)[0] : 'varies',\n                SPECIALVATFLAG: vd.specialvatflag_values.size === 1 ? Array.from(vd.specialvatflag_values)[0] : 'varies'\n            },\n            date_range_pattern: vd.has_fromdate.has(true) ? 'sometimes' : 'never',\n            pdaccname_pattern: vd.has_pdaccname.has(true) ? 'sometimes' : 'never'\n        };\n    });\n    \n    return vehicleRules;\n}\n\n// ============================================================================\n// ניתוח עמוק של ספק\n// ============================================================================\n\nfunction deepAnalyzeSupplier(invoices) {\n    const analysis = {\n        supplier_name: '',\n        supplier_info: {},\n        all_data: invoices,\n        partnames: {},\n        vehicle_rules: {},\n        has_doc: false,\n        has_pivordi: false,\n        has_delivery_notes: false,\n        has_docno: false,\n        has_ordname: false,\n        has_sdinumit: false,\n        has_impfnum: false,\n        inventory_management: 'not_managed_inventory',\n        document_types: [],\n        totquant_sample: 0\n    };\n    \n    const docTypesSeen = new Map();\n    \n    // שם ספק ומידע\n    if (invoices.length > 0 && invoices[0].SUPDES) {\n        analysis.supplier_name = invoices[0].SUPDES;\n    }\n    \n    analysis.supplier_info = extractSupplierInfo(invoices);\n    analysis.inventory_management = analyzeInventoryManagement(invoices);\n    \n    // ניתוח כל החשבוניות\n    invoices.forEach(data => {\n        const docType = identifyDocumentType(data);\n        if (!docTypesSeen.has(docType.type_key)) {\n            docTypesSeen.set(docType.type_key, {\n                ...docType,\n                sample: data\n            });\n        }\n        \n        // זיהוי שדות מיוחדים\n        if ((data.PIVDOC && data.PIVDOC.length > 0) || \n            (data.PIVDOC_SUBFORM && data.PIVDOC_SUBFORM.length > 0) ||\n            data.DOCNO) {\n            analysis.has_doc = true;\n        }\n        if (data.PIVORDI && data.PIVORDI.length > 0) analysis.has_pivordi = true;\n        if (data.SDINUMIT) analysis.has_sdinumit = true;\n        if (data.DOCNO) analysis.has_docno = true;\n        if (data.ORDNAME) analysis.has_ordname = true;\n        if (data.IMPFNUM) analysis.has_impfnum = true;\n        \n        // TOTQUANT לדוגמה\n        if (data.TOTQUANT && !analysis.totquant_sample) {\n            analysis.totquant_sample = data.TOTQUANT;\n        }\n    });\n    \n    analysis.has_delivery_notes = analysis.has_sdinumit || analysis.has_docno;\n    \n    // ניתוח מקטים (רק אם אין תעודות)\n    const needsPartnameAnalysis = !analysis.has_doc && !analysis.has_delivery_notes;\n    \n    if (needsPartnameAnalysis) {\n        invoices.forEach(data => {\n            const items = data.PINVOICEITEMS || data.PINVOICEITEMS_SUBFORM;\n            if (items) {\n                items.forEach(item => {\n                    const partname = item.PARTNAME || '';\n                    if (partname && partname !== 'car') {\n                        if (!analysis.partnames[partname]) {\n                            analysis.partnames[partname] = {\n                                accnames: new Set(),\n                                has_pdaccname: false,\n                                sample_pdes: new Set()\n                            };\n                        }\n                        \n                        if (item.ACCNAME) {\n                            analysis.partnames[partname].accnames.add(item.ACCNAME);\n                        }\n                        if (item.PDACCNAME) {\n                            analysis.partnames[partname].has_pdaccname = true;\n                        }\n                        if (item.PDES) {\n                            analysis.partnames[partname].sample_pdes.add(item.PDES.substring(0, 50));\n                        }\n                    }\n                });\n            }\n        });\n    }\n    \n    // ניתוח רכבים\n    analysis.vehicle_rules = analyzeVehicleRules(invoices);\n    \n    analysis.document_types = Array.from(docTypesSeen.values());\n    \n    return analysis;\n}\n\n// ============================================================================\n// בדיקה אם תבניות צריכות להתמזג (רק הבדל במקטים/חשבונות)\n// ============================================================================\n\nfunction shouldMergeTemplates(type1, type2) {\n    const fieldsToCompare = ['has_import', 'debit_type', 'has_date_range', 'has_budcode', 'has_pdaccname', 'has_doc'];\n    \n    for (const field of fieldsToCompare) {\n        if (type1[field] !== type2[field]) {\n            return false;\n        }\n    }\n    \n    return true;\n}\n\n// ============================================================================\n// מיזוג תבניות זהות (שההבדל רק במקטים)\n// ============================================================================\n\nfunction mergeIdenticalTemplates(documentTypes) {\n    if (documentTypes.length <= 1) {\n        return documentTypes;\n    }\n    \n    const merged = [];\n    const processed = new Set();\n    \n    for (let i = 0; i < documentTypes.length; i++) {\n        if (processed.has(i)) continue;\n        \n        let currentType = { ...documentTypes[i] };\n        const allAccnames = new Set(currentType.accnames || []);\n        let allSamples = [currentType.sample];\n        \n        for (let j = i + 1; j < documentTypes.length; j++) {\n            if (processed.has(j)) continue;\n            \n            if (shouldMergeTemplates(currentType, documentTypes[j])) {\n                // מיזוג accnames\n                (documentTypes[j].accnames || []).forEach(acc => allAccnames.add(acc));\n                allSamples.push(documentTypes[j].sample);\n                processed.add(j);\n            }\n        }\n        \n        currentType.accnames = Array.from(allAccnames);\n        currentType.all_samples = allSamples;\n        \n        merged.push(currentType);\n        processed.add(i);\n    }\n    \n    return merged;\n}\n\n// ============================================================================\n// חישוב type (סוג מסמך) לפי מבנה\n// ============================================================================\n\nfunction calculateDocumentType(docType) {\n    if (docType.debit_type === 'C') {\n        if (docType.has_import) {\n            return 'זיכוי יבוא';\n        }\n        if (docType.has_doc) {\n            return 'זיכוי עם תעודות ללא פירוט';\n        }\n        return 'זיכוי רגיל עם פירוט';\n    }\n    \n    if (docType.has_import) {\n        if (docType.has_doc) {\n            return 'חשבונית עם תיק יבוא עם תעודות';\n        }\n        return 'חשבונית עם תיק יבוא - הוצאות ללא תעודות';\n    }\n    \n    if (docType.has_doc) {\n        return 'חשבונית עם תעודות ללא פירוט';\n    }\n    \n    return 'חשבונית רגילה עם פירוט';\n}\n\n// ============================================================================\n// יצירת config מתקדם\n// ============================================================================\n\nfunction createAdvancedConfig(supplierId, analysis) {\n    const config = {\n        supplier_config: {\n            supplier_code: supplierId,\n            supplier_name: analysis.supplier_name,\n            vendor_tax_id_reference: analysis.supplier_info.vendor_tax_id_reference\n        },\n        structure: [],\n        rules: {\n            invoice_date_format: 'DD/MM/YY',\n            doc_variation: analysis.has_doc ? 'תעודה אחת (DOCNO) או מרובות (PIVDOC_SUBFORM) - שניהם בתבנית' : '',\n            validation_data: {\n                TOTQUANT: analysis.totquant_sample\n            },\n            critical_patterns: {\n                vehicle_rules: Object.keys(analysis.vehicle_rules).length > 0 ? {\n                    partname: 'car',\n                    vehicle_account_mapping: analysis.vehicle_rules\n                } : {},\n                partname_rules: {}\n            }\n        },\n        document_types: []\n    };\n    \n    // מיזוג תבניות\n    const mergedTypes = mergeIdenticalTemplates(analysis.document_types);\n    \n    // יצירת structure ו-document_types\n    mergedTypes.forEach(docType => {\n        // has_purchase_orders לפי הכלל החדש (סעיף 1)\n        let hasPurchaseOrders = false;\n        if (docType.has_import) {\n            hasPurchaseOrders = true; // יבוא - תמיד\n        } else if (!docType.has_doc && !analysis.has_delivery_notes && analysis.has_ordname) {\n            hasPurchaseOrders = true; // אין תעודות אבל יש הזמנה\n        }\n        \n        const structureItem = {\n            has_import: docType.has_import,\n            has_purchase_orders: hasPurchaseOrders,\n            has_doc: docType.has_doc,\n            has_date_range: docType.has_date_range,\n            has_budcode: docType.has_budcode,\n            has_pdaccname: docType.has_pdaccname,\n            inventory_management: analysis.inventory_management,\n            debit_type: docType.debit_type\n        };\n        \n        config.structure.push(structureItem);\n        \n        const documentTypeItem = {\n            type: calculateDocumentType(docType),\n            accnames: docType.accnames\n        };\n        \n        config.document_types.push(documentTypeItem);\n    });\n    \n    // הוספת partname_rules (רק אם אין תעודות ויש מקטים)\n    if (!analysis.has_doc && !analysis.has_delivery_notes && Object.keys(analysis.partnames).length > 0) {\n        const partnameRules = {};\n        \n        Object.keys(analysis.partnames).forEach(partname => {\n            const info = analysis.partnames[partname];\n            partnameRules[partname] = {\n                accnames: Array.from(info.accnames),\n                has_pdaccname: info.has_pdaccname,\n                sample_description: Array.from(info.sample_pdes)[0] || ''\n            };\n        });\n        \n        config.rules.critical_patterns.partname_rules = partnameRules;\n    }\n    \n    return config;\n}\n\n// ============================================================================\n// ניקוי תבנית - רק שדות רלוונטיים\n// ============================================================================\n\nfunction cleanTemplate(sample, analysis, docType) {\n    const cleaned = {\n        SUPNAME: sample.SUPNAME,\n        CODE: sample.CODE,\n        DEBIT: sample.DEBIT,\n        IVDATE: convertDateToFormat(sample.IVDATE),\n        BOOKNUM: sample.BOOKNUM\n    };\n    \n    // DOCNO אם יש תעודה אחת\n    if (sample.DOCNO) {\n        cleaned.DOCNO = sample.DOCNO;\n    }\n    \n    // ORDNAME רק אם צריך הזמנה\n    if (docType.has_import || (!docType.has_doc && !analysis.has_delivery_notes && analysis.has_ordname)) {\n        if (sample.ORDNAME) {\n            cleaned.ORDNAME = sample.ORDNAME;\n        }\n    }\n    \n    // IMPFNUM אם יבוא\n    if (docType.has_import && sample.IMPFNUM) {\n        cleaned.IMPFNUM = sample.IMPFNUM;\n    }\n    \n    // SDINUMIT אם יש\n    if (sample.SDINUMIT) {\n        cleaned.SDINUMIT = sample.SDINUMIT;\n    }\n    \n    // DETAILS אם יש\n    if (sample.DETAILS) {\n        cleaned.DETAILS = sample.DETAILS;\n    }\n    \n    // PIVDOC_SUBFORM אם יש תעודות מרובות\n    if (docType.has_doc) {\n        cleaned.PIVDOC_SUBFORM = [\n            {\n                DOCNO: '',\n                BOOKNUM: ''\n            }\n        ];\n    }\n    \n    // PINVOICEITEMS_SUBFORM אם אין תעודות\n    if (!docType.has_doc && !analysis.has_delivery_notes) {\n        const items = sample.PINVOICEITEMS || sample.PINVOICEITEMS_SUBFORM;\n        if (items && items.length > 0) {\n            cleaned.PINVOICEITEMS_SUBFORM = items.map(item => {\n                const cleanedItem = {\n                    PARTNAME: item.PARTNAME,\n                    PDES: item.PDES,\n                    TQUANT: item.TQUANT,\n                    TUNITNAME: item.TUNITNAME,\n                    PRICE: item.PRICE,\n                    VATFLAG: item.VATFLAG,\n                    ACCNAME: item.ACCNAME\n                };\n                \n                // ICODE רק אם שונה מכותרת\n                if (item.ICODE && item.ICODE !== sample.CODE) {\n                    cleanedItem.ICODE = item.ICODE;\n                }\n                \n                if (item.SPECIALVATFLAG) cleanedItem.SPECIALVATFLAG = item.SPECIALVATFLAG;\n                if (item.BUDCODE) cleanedItem.BUDCODE = item.BUDCODE;\n                if (item.FROMDATE) cleanedItem.FROMDATE = item.FROMDATE;\n                if (item.TODATE) cleanedItem.TODATE = item.TODATE;\n                if (item.PDACCNAME) cleanedItem.PDACCNAME = item.PDACCNAME;\n                \n                return cleanedItem;\n            });\n        }\n    }\n    \n    // PINVOICESCONT_SUBFORM - רק אם יש שדות רלוונטיים\n    const cont = sample.PINVOICESCONT || sample.PINVOICESCONT_SUBFORM;\n    if (cont && cont.length > 0) {\n        const fncpatname = cont[0].FNCPATNAME;\n        // רק אם FNCPATNAME שונה מ\"חסמ\"\n        if (fncpatname && fncpatname !== 'חסמ') {\n            cleaned.PINVOICESCONT_SUBFORM = [{\n                FNCPATNAME: fncpatname\n            }];\n        }\n    }\n    \n    return cleaned;\n}\n\n// ============================================================================\n// יצירת תבנית מרובה\n// ============================================================================\n\nfunction createMultiSampleTemplate(analysis) {\n    const mergedTypes = mergeIdenticalTemplates(analysis.document_types);\n    const samples = [];\n    \n    mergedTypes.forEach(docType => {\n        // אם יש מיזוג תבניות (פירוט) - לקחת כל הרשומות השונות\n        if (docType.all_samples && docType.all_samples.length > 1 && !docType.has_doc) {\n            // מיזוג כל הפריטים מכל הדוגמאות\n            const allItems = [];\n            const seenItems = new Set();\n            \n            docType.all_samples.forEach(sample => {\n                const items = sample.PINVOICEITEMS || sample.PINVOICEITEMS_SUBFORM;\n                if (items) {\n                    items.forEach(item => {\n                        const itemKey = `${item.PARTNAME}_${item.ACCNAME}`;\n                        if (!seenItems.has(itemKey)) {\n                            allItems.push(item);\n                            seenItems.add(itemKey);\n                        }\n                    });\n                }\n            });\n            \n            // יצירת תבנית אחת עם כל הפריטים\n            const baseSample = docType.all_samples[0];\n            const cleanedSample = cleanTemplate(baseSample, analysis, docType);\n            \n            if (allItems.length > 0) {\n                cleanedSample.PINVOICEITEMS_SUBFORM = allItems.map(item => {\n                    const cleanedItem = {\n                        PARTNAME: item.PARTNAME,\n                        PDES: item.PDES,\n                        TQUANT: item.TQUANT,\n                        TUNITNAME: item.TUNITNAME,\n                        PRICE: item.PRICE,\n                        VATFLAG: item.VATFLAG,\n                        ACCNAME: item.ACCNAME\n                    };\n                    \n                    if (item.ICODE && item.ICODE !== baseSample.CODE) {\n                        cleanedItem.ICODE = item.ICODE;\n                    }\n                    if (item.SPECIALVATFLAG) cleanedItem.SPECIALVATFLAG = item.SPECIALVATFLAG;\n                    if (item.BUDCODE) cleanedItem.BUDCODE = item.BUDCODE;\n                    if (item.FROMDATE) cleanedItem.FROMDATE = item.FROMDATE;\n                    if (item.TODATE) cleanedItem.TODATE = item.TODATE;\n                    if (item.PDACCNAME) cleanedItem.PDACCNAME = item.PDACCNAME;\n                    \n                    return cleanedItem;\n                });\n            }\n            \n            samples.push(cleanedSample);\n        } else {\n            // תבנית רגילה\n            const sample = docType.sample;\n            samples.push(cleanTemplate(sample, analysis, docType));\n        }\n    });\n    \n    return {\n        PINVOICES: samples,\n        document_types_count: samples.length\n    };\n}\n\n// ============================================================================\n// יצירת דוגמאות מומלצות (אקראיות)\n// ============================================================================\n\nfunction createRecommendedSamples(analysis) {\n    const mergedTypes = mergeIdenticalTemplates(analysis.document_types);\n    const samples = [];\n    \n    mergedTypes.forEach(() => {\n        // בחירה אקראית מתוך כל החשבוניות\n        const randomIndex = Math.floor(Math.random() * analysis.all_data.length);\n        const randomInvoice = analysis.all_data[randomIndex];\n        \n        samples.push({\n            sample_ivnum: randomInvoice.IVNUM || '',\n            sample_booknum: randomInvoice.BOOKNUM || '',\n            sample_impfnum: randomInvoice.IMPFNUM || '',\n            sample_supname: randomInvoice.SUPNAME || ''\n        });\n    });\n    \n    return {\n        samples: samples\n    };\n}\n\n// ============================================================================\n// הפונקציה הראשית\n// ============================================================================\n\nfunction processSupplierInvoices(invoicesJson, supplierId) {\n    try {\n        let invoices = invoicesJson;\n        if (typeof invoicesJson === 'string') {\n            invoices = JSON.parse(invoicesJson);\n        }\n        \n        if (!Array.isArray(invoices)) {\n            throw new Error('invoices_json must be an array');\n        }\n        \n        const analysis = deepAnalyzeSupplier(invoices);\n        const config = createAdvancedConfig(supplierId, analysis);\n        const template = createMultiSampleTemplate(analysis);\n        const recommended = createRecommendedSamples(analysis);\n        \n        return {\n            status: 'success',\n            supplier_id: supplierId,\n            supplier_name: analysis.supplier_name,\n            vendor_tax_id_reference: analysis.supplier_info.vendor_tax_id_reference,\n            supplier_phone: analysis.supplier_info.supplier_phone,\n            supplier_email: analysis.supplier_info.supplier_email,\n            json_files_analyzed: invoices.length,\n            templates_detected: template.document_types_count,\n            config: config,\n            template: template,\n            recommended_samples: recommended\n        };\n        \n    } catch (error) {\n        return {\n            status: 'error',\n            message: error.message,\n            stack: error.stack\n        };\n    }\n}\n\n// ============================================================================\n// קוד הרצה למייק\n// ============================================================================\n\nconst supplierId = input.supplier_id;\n\nlet invoices;\ntry {\n    let rawData = input.invoices_json;\n    \n    if (rawData && typeof rawData === 'object' && rawData.type === 'Buffer' && Array.isArray(rawData.data)) {\n        const uint8Array = new Uint8Array(rawData.data);\n        const decoder = new TextDecoder('utf-8');\n        const text = decoder.decode(uint8Array);\n        invoices = JSON.parse(text);\n    }\n    else if (typeof rawData === 'string') {\n        invoices = JSON.parse(rawData);\n    }\n    else {\n        invoices = rawData;\n    }\n    \n    if (!Array.isArray(invoices)) {\n        return {\n            status: 'error',\n            message: 'invoices_json must be an array after parsing. Received: ' + typeof invoices,\n            received_structure: JSON.stringify(invoices).substring(0, 300)\n        };\n    }\n    \n} catch (e) {\n    return {\n        status: 'error',\n        message: 'Failed to parse invoices_json: ' + e.message,\n        error_stack: e.stack,\n        received_type: typeof input.invoices_json\n    };\n}\n\nconst result = processSupplierInvoices(invoices, supplierId);\n\nreturn result;"
                        },
                        "metadata": {
                            "designer": {
                                "x": 2700,
                                "y": 300,
                                "name": "ניתוח חשבוניות ספק",
                                "messages": [
                                    {
                                        "category": "reference",
                                        "severity": "warning",
                                        "message": "Referenced module 'Make Code - Run code' [65] is not accessible."
                                    }
                                ]
                            },
                            "restore": {
                                "expect": {
                                    "input": {
                                        "items": [
                                            null,
                                            null
                                        ]
                                    },
                                    "language": {
                                        "mode": "chose",
                                        "label": "JavaScript"
                                    },
                                    "inputFormat": {
                                        "label": "Code editor"
                                    }
                                }
                            },
                            "expect": [
                                {
                                    "name": "language",
                                    "type": "select",
                                    "label": "Language",
                                    "required": true,
                                    "validate": {
                                        "enum": [
                                            "javascript",
                                            "python"
                                        ]
                                    }
                                },
                                {
                                    "name": "input",
                                    "spec": {
                                        "name": "value",
                                        "spec": [
                                            {
                                                "name": "name",
                                                "type": "text",
                                                "label": "Name",
                                                "required": true,
                                                "validate": {
                                                    "max": 32,
                                                    "min": 1,
                                                    "pattern": "^[a-zA-Z0-9_]{1,32}$"
                                                }
                                            },
                                            {
                                                "name": "value",
                                                "type": "any",
                                                "label": "Value",
                                                "required": true
                                            }
                                        ],
                                        "type": "collection",
                                        "label": "Variable"
                                    },
                                    "type": "array",
                                    "label": "Input"
                                },
                                {
                                    "name": "dependencies",
                                    "spec": {
                                        "name": "value",
                                        "type": "text",
                                        "label": "Dependency",
                                        "required": true,
                                        "validate": {
                                            "max": 214,
                                            "min": 1,
                                            "pattern": "^[A-Za-z0-9_@\\./<>\\=\\!~\\^+\\-]{1,214}$"
                                        }
                                    },
                                    "type": "array",
                                    "label": "Additional dependencies (Enterprise plans only)"
                                },
                                {
                                    "name": "inputFormat",
                                    "type": "select",
                                    "label": "Input format",
                                    "required": true,
                                    "validate": {
                                        "enum": [
                                            "editor",
                                            "string"
                                        ]
                                    }
                                },
                                {
                                    "name": "codeEditorJavascript",
                                    "type": "editor",
                                    "label": "Code",
                                    "required": true
                                }
                            ]
                        }
                    },
                    {
                        "id": 104,
                        "module": "code:ExecuteCode",
                        "version": 0,
                        "parameters": {},
                        "mapper": {
                            "input": [
                                {
                                    "name": "supplier_id",
                                    "value": "{{65.result.invoices_summary[].SUPNAME}}"
                                },
                                {
                                    "name": "invoices_json",
                                    "value": "{{65.result.cleaned_json}}"
                                }
                            ],
                            "language": "javascript",
                            "inputFormat": "editor",
                            "dependencies": [],
                            "codeEditorJavascript": "// קוד JavaScript למייק - ניתוח חשבוניות ספק - גרסה 1.1\n// עדכון: מיזוג תבניות זהות\n\n// פונקציה לזיהוי סוג מסמך\nfunction identifyDocumentType(invoice) {\n    // תיקון 1: זיהוי יבוא לפי IMPFNUM\n    const hasImport = !!invoice.IMPFNUM;\n    \n    // תיקון 2: איסוף כל החשבונות (לא רק הראשון)\n    const accnames = new Set();\n    let hasDateRange = false;\n    let hasBudcode = false;\n    let hasPdaccname = false;\n    \n    if (invoice.PINVOICEITEMS || invoice.PINVOICEITEMS_SUBFORM) {\n        const items = invoice.PINVOICEITEMS || invoice.PINVOICEITEMS_SUBFORM;\n        items.forEach(item => {\n            if (item.ACCNAME) accnames.add(item.ACCNAME);\n            if (item.FROMDATE || item.TODATE) hasDateRange = true;\n            if (item.BUDCODE) hasBudcode = true;\n            if (item.PDACCNAME) hasPdaccname = true;\n        });\n    }\n    \n    // בדיקת PIVDOC (תמיכה גם ב-PIVDOC_SUBFORM)\n    // שינוי: has_pivdoc → has_doc\n    const hasDoc = !!((invoice.PIVDOC && invoice.PIVDOC.length > 0) || \n                      (invoice.PIVDOC_SUBFORM && invoice.PIVDOC_SUBFORM.length > 0) ||\n                      invoice.DOCNO);\n    \n    // תיקון 2: בניית type_key בלי PARTNAME\n    const accnamesSorted = Array.from(accnames).sort().join(',');\n    \n    return {\n        type_key: `${hasImport ? 'IMP' : 'REG'}_ACC_${accnamesSorted}_DR_${hasDateRange}_BUD_${hasBudcode}_PD_${hasPdaccname}_DOC_${hasDoc}`,\n        has_import: hasImport,\n        accnames: Array.from(accnames),\n        has_date_range: hasDateRange,\n        has_budcode: hasBudcode,\n        has_pdaccname: hasPdaccname,\n        has_doc: hasDoc\n    };\n}\n\n// תיקון 9: ניתוח PIVDOC_SUBFORM\nfunction analyzePivdoc(invoice) {\n    // תמיכה גם ב-PIVDOC וגם ב-PIVDOC_SUBFORM\n    let pivdocItems = invoice.PIVDOC || invoice.PIVDOC_SUBFORM;\n    \n    if (!pivdocItems || pivdocItems.length === 0) {\n        return null;\n    }\n    \n    // אם PIVDOC_SUBFORM מגיע כמחרוזות JSON - לעשות parse\n    if (typeof pivdocItems[0] === 'string') {\n        try {\n            pivdocItems = pivdocItems.map(item => JSON.parse(item));\n        } catch (e) {\n            return null;\n        }\n    }\n    \n    const booknums = pivdocItems.map(item => item.BOOKNUM).filter(b => b);\n    const headerBooknum = invoice.BOOKNUM;\n    \n    if (booknums.length === 0) {\n        return null;\n    }\n    \n    // זיהוי תבנית BOOKNUM\n    const sampleBooknum = booknums[0];\n    let pattern = sampleBooknum\n        .replace(/[A-Z]/g, 'X')\n        .replace(/[a-z]/g, 'x')\n        .replace(/[0-9]/g, '#')\n        .replace(/[א-ת]/g, 'ע');\n    \n    // בדיקת התאמה לכותרת\n    const booknumMatchesHeader = booknums.includes(headerBooknum);\n    \n    return {\n        booknum_pattern: pattern,\n        booknum_matches_header: booknumMatchesHeader,\n        sample_booknum: sampleBooknum,\n        total_pivdoc_items: booknums.length,\n        note: \"בדוק אם יש קידומות (Sla, INV, וכו') שצריך להסיר מ-BOOKNUM במסמך האמיתי\"\n    };\n}\n\n// תיקון 8: ניתוח שורת פריט ראשונה\nfunction analyzeFirstItem(invoice) {\n    const items = invoice.PINVOICEITEMS || invoice.PINVOICEITEMS_SUBFORM;\n    if (!items || items.length === 0) {\n        return null;\n    }\n    \n    const firstItem = items[0];\n    const headerCode = invoice.CODE;\n    \n    const analysis = {};\n    \n    // בדיקת ICODE - רק אם שונה מ-CODE בכותרת\n    if (firstItem.ICODE && firstItem.ICODE !== headerCode) {\n        analysis.icode_differs = true;\n        analysis.icode_value = firstItem.ICODE;\n    }\n    \n    // שמירת PRSOURCENAME\n    if (firstItem.PRSOURCENAME) {\n        analysis.prsourcename = firstItem.PRSOURCENAME;\n    }\n    \n    return Object.keys(analysis).length > 0 ? analysis : null;\n}\n\nfunction deepAnalyzeSupplier(invoices) {\n    const analysis = {\n        supplier_name: '',\n        all_data: invoices,\n        partnames: {},\n        fixed_values: {},\n        has_doc: false,\n        has_pivordi: false,\n        has_delivery_notes: false,\n        has_docno: false,\n        has_ordname: false,\n        has_sdinumit: false,\n        has_impfnum: false,\n        date_format: null,\n        document_types: [],\n        pivdoc_analysis: null,\n        first_item_analysis: null\n    };\n    \n    const docTypesSeen = new Map();\n    \n    // ניתוח כל החשבוניות\n    invoices.forEach(data => {\n        // שם ספק\n        if (!analysis.supplier_name && data.SUPDES) {\n            analysis.supplier_name = data.SUPDES;\n        }\n        \n        // זיהוי סוג מסמך\n        const docType = identifyDocumentType(data);\n        if (!docTypesSeen.has(docType.type_key)) {\n            docTypesSeen.set(docType.type_key, {\n                ...docType,\n                sample: data\n            });\n        }\n        \n        // תיקון 9: ניתוח PIVDOC (רק פעם אחת) - תמיכה ב-PIVDOC_SUBFORM\n        if (!analysis.pivdoc_analysis) {\n            const hasPivdocData = (data.PIVDOC && data.PIVDOC.length > 0) || \n                                  (data.PIVDOC_SUBFORM && data.PIVDOC_SUBFORM.length > 0);\n            if (hasPivdocData) {\n                analysis.pivdoc_analysis = analyzePivdoc(data);\n            }\n        }\n        \n        // תיקון 8: ניתוח שורת פריט ראשונה (רק פעם אחת)\n        if (!analysis.first_item_analysis) {\n            analysis.first_item_analysis = analyzeFirstItem(data);\n        }\n        \n        // זיהוי שדות מיוחדים - שינוי: has_pivdoc → has_doc\n        if ((data.PIVDOC && data.PIVDOC.length > 0) || \n            (data.PIVDOC_SUBFORM && data.PIVDOC_SUBFORM.length > 0) ||\n            data.DOCNO) {\n            analysis.has_doc = true;\n        }\n        if (data.PIVORDI && data.PIVORDI.length > 0) analysis.has_pivordi = true;\n        if (data.SDINUMIT) analysis.has_sdinumit = true;\n        if (data.DOCNO) analysis.has_docno = true;\n        if (data.ORDNAME) analysis.has_ordname = true;\n        if (data.IMPFNUM) analysis.has_impfnum = true;\n        \n        // זיהוי פורמט תאריך (רק פעם אחת)\n        if (!analysis.date_format && data.IVDATE) {\n            const dateStr = String(data.IVDATE);\n            if (dateStr.includes('/')) {\n                analysis.date_format = 'DD/MM/YY';\n            } else if (dateStr.includes('-')) {\n                analysis.date_format = 'YYYY-MM-DD';\n            }\n        }\n    });\n    \n    // תיקון 3: בדיקה אם יש תיק או תעודות משלוח\n    analysis.has_delivery_notes = analysis.has_sdinumit || analysis.has_docno;\n    analysis.has_linked_documents = analysis.has_doc;\n    \n    // תיקון 3: רק אם אין תיק ואין תעודות - נותח מק״טים\n    const needsPartnameAnalysis = !analysis.has_linked_documents && !analysis.has_delivery_notes;\n    \n    if (needsPartnameAnalysis) {\n        invoices.forEach(data => {\n            const items = data.PINVOICEITEMS || data.PINVOICEITEMS_SUBFORM;\n            if (items) {\n                items.forEach(item => {\n                    const partname = item.PARTNAME || '';\n                    if (partname) {\n                        if (!analysis.partnames[partname]) {\n                            analysis.partnames[partname] = {\n                                accnames: new Set(),\n                                has_pdaccname: false,\n                                sample_pdes: new Set()\n                            };\n                        }\n                        \n                        if (item.ACCNAME) {\n                            analysis.partnames[partname].accnames.add(item.ACCNAME);\n                        }\n                        \n                        if (item.PDACCNAME) {\n                            analysis.partnames[partname].has_pdaccname = true;\n                        }\n                        \n                        if (item.PDES) {\n                            const pdes = item.PDES.substring(0, 50);\n                            analysis.partnames[partname].sample_pdes.add(pdes);\n                        }\n                    }\n                });\n            }\n        });\n    }\n    \n    // המרת סוגי המסמכים למערך\n    analysis.document_types = Array.from(docTypesSeen.values());\n    \n    // זיהוי ערכים קבועים\n    const checkFields = ['ICODE', 'FNCPATNAME', 'TAXCODE'];\n    \n    checkFields.forEach(field => {\n        const values = new Set();\n        \n        invoices.forEach(data => {\n            const items = data.PINVOICEITEMS || data.PINVOICEITEMS_SUBFORM;\n            const cont = data.PINVOICESCONT || data.PINVOICESCONT_SUBFORM;\n            \n            if (field === 'ICODE' && items) {\n                items.forEach(item => {\n                    if (item[field]) values.add(String(item[field]));\n                });\n            }\n            if (['FNCPATNAME', 'TAXCODE'].includes(field) && cont) {\n                cont.forEach(c => {\n                    if (c[field]) values.add(String(c[field]));\n                });\n            }\n        });\n        \n        if (values.size === 1) {\n            analysis.fixed_values[field] = Array.from(values)[0];\n        }\n    });\n    \n    return analysis;\n}\n\n// *** פונקציה חדשה: בדיקה אם תבניות צריכות להתמזג ***\nfunction shouldMergeTemplates(type1, type2) {\n    // השווה את כל השדות חוץ מ-has_doc ו-type_key\n    const fieldsToCompare = ['has_import', 'has_date_range', 'has_budcode', 'has_pdaccname'];\n    \n    // בדוק אם כל השדות זהים\n    for (const field of fieldsToCompare) {\n        if (type1[field] !== type2[field]) {\n            return false;\n        }\n    }\n    \n    // בדוק אם accnames זהים\n    const accnames1 = (type1.accnames || []).sort().join(',');\n    const accnames2 = (type2.accnames || []).sort().join(',');\n    \n    if (accnames1 !== accnames2) {\n        return false;\n    }\n    \n    // אם הגענו לכאן - כל השדות זהים, ההבדל הוא רק במבנה התעודות\n    return true;\n}\n\n// *** פונקציה חדשה: מיזוג תבניות זהות ***\nfunction mergeIdenticalTemplates(documentTypes) {\n    if (documentTypes.length <= 1) {\n        return documentTypes;\n    }\n    \n    const merged = [];\n    const processed = new Set();\n    \n    for (let i = 0; i < documentTypes.length; i++) {\n        if (processed.has(i)) continue;\n        \n        let currentType = { ...documentTypes[i] };\n        let hasMerged = false;\n        \n        // חפש תבניות דומות\n        for (let j = i + 1; j < documentTypes.length; j++) {\n            if (processed.has(j)) continue;\n            \n            if (shouldMergeTemplates(currentType, documentTypes[j])) {\n                hasMerged = true;\n                processed.add(j);\n            }\n        }\n        \n        // אם מוזגו תבניות - הוסף הערה\n        if (hasMerged) {\n            currentType.doc_variations = \"תעודה אחת (DOCNO בכותרת) או מרובות (PIVDOC_SUBFORM)\";\n        }\n        \n        merged.push(currentType);\n        processed.add(i);\n    }\n    \n    return merged;\n}\n\nfunction createAdvancedConfig(supplierId, analysis) {\n    const config = {\n        // תיקון 4: supplier_config מפושט\n        supplier_config: {\n            supplier_code: supplierId,\n            supplier_name: analysis.supplier_name\n        },\n        structure: {\n            has_purchase_orders: analysis.has_pivordi || analysis.has_ordname,\n            has_delivery_notes: analysis.has_delivery_notes,\n            has_linked_documents: analysis.has_linked_documents,\n            has_import: analysis.has_impfnum\n        },\n        // תיקון 5: rules - רק invoice_date_format\n        rules: {\n            invoice_date_format: analysis.date_format || \"DD/MM/YY\"\n        },\n        critical_patterns: {\n            fixed_values_always: analysis.fixed_values\n        },\n        document_types: []\n    };\n    \n    // תיקון 8: הוספת ניתוח שורת פריט ראשונה\n    if (analysis.first_item_analysis) {\n        config.first_item_patterns = analysis.first_item_analysis;\n    }\n    \n    // תיקון 9: הוספת ניתוח PIVDOC\n    if (analysis.pivdoc_analysis) {\n        config.pivdoc_analysis = analysis.pivdoc_analysis;\n    }\n    \n    // תיקון 7: הוספת סוגי מסמכים (בלי partname/accname אם יבוא)\n    // שינוי: has_pivdoc → has_doc\n    analysis.document_types.forEach(docType => {\n        const typeInfo = {\n            type: docType.has_import ? 'יבוא' : 'חשבונית רגילה',\n            has_import: docType.has_import,\n            has_date_range: docType.has_date_range,\n            has_budcode: docType.has_budcode,\n            has_pdaccname: docType.has_pdaccname,\n            has_doc: docType.has_doc\n        };\n        \n        // הוספת doc_variations אם קיים\n        if (docType.doc_variations) {\n            typeInfo.doc_variations = docType.doc_variations;\n        }\n        \n        // תיקון 7: רק אם לא יבוא - נוסיף accnames\n        if (!docType.has_import) {\n            typeInfo.accnames = docType.accnames;\n        }\n        \n        config.document_types.push(typeInfo);\n    });\n    \n    // תיקון 6: הוספת כללים לפי מק״ט (רק אם אין תיק)\n    const needsPartnameRules = !analysis.has_linked_documents && !analysis.has_delivery_notes;\n    \n    if (needsPartnameRules && Object.keys(analysis.partnames).length > 0) {\n        const partnameRules = {};\n        \n        Object.keys(analysis.partnames).forEach(partname => {\n            const info = analysis.partnames[partname];\n            \n            // תיקון 6: בלי usage_count ו-price_range\n            partnameRules[partname] = {\n                accnames: Array.from(info.accnames),\n                has_pdaccname: info.has_pdaccname,\n                sample_description: Array.from(info.sample_pdes)[0] || ''\n            };\n        });\n        \n        config.critical_patterns.partname_rules = partnameRules;\n    }\n    \n    return config;\n}\n\nfunction createMultiSampleTemplate(analysis) {\n    const typesSeen = new Set();\n    const samples = [];\n    \n    // בחירת דוגמה אחת לכל סוג מסמך\n    analysis.document_types.forEach(docType => {\n        if (!typesSeen.has(docType.type_key)) {\n            let sample = JSON.parse(JSON.stringify(docType.sample)); // העתקה עמוקה\n            \n            // תיקון 3: מחיקת PINVOICEITEMS אם יש תיק או תעודות\n            if (analysis.has_linked_documents || analysis.has_delivery_notes) {\n                delete sample.PINVOICEITEMS;\n                delete sample.PINVOICEITEMS_SUBFORM;\n            }\n            \n            // מחיקת PIVDOC_SUBFORM המקורי אם הוא מחרוזות\n            if (sample.PIVDOC_SUBFORM && typeof sample.PIVDOC_SUBFORM[0] === 'string') {\n                // להשאיר אבל לפרמט כאובייקטים\n                try {\n                    sample.PIVDOC_SUBFORM = sample.PIVDOC_SUBFORM.map(item => \n                        typeof item === 'string' ? JSON.parse(item) : item\n                    );\n                } catch (e) {\n                    // אם נכשל - למחוק\n                    delete sample.PIVDOC_SUBFORM;\n                }\n            }\n            \n            samples.push(sample);\n            typesSeen.add(docType.type_key);\n        }\n    });\n    \n    // אם אין דוגמאות, לקחת את הראשונה\n    if (samples.length === 0 && analysis.all_data.length > 0) {\n        let sample = JSON.parse(JSON.stringify(analysis.all_data[0]));\n        \n        // תיקון 3: מחיקת PINVOICEITEMS אם יש תיק או תעודות\n        if (analysis.has_linked_documents || analysis.has_delivery_notes) {\n            delete sample.PINVOICEITEMS;\n            delete sample.PINVOICEITEMS_SUBFORM;\n        }\n        \n        // מחיקת PIVDOC_SUBFORM המקורי אם הוא מחרוזות\n        if (sample.PIVDOC_SUBFORM && typeof sample.PIVDOC_SUBFORM[0] === 'string') {\n            try {\n                sample.PIVDOC_SUBFORM = sample.PIVDOC_SUBFORM.map(item => \n                    typeof item === 'string' ? JSON.parse(item) : item\n                );\n            } catch (e) {\n                delete sample.PIVDOC_SUBFORM;\n            }\n        }\n        \n        samples.push(sample);\n    }\n    \n    return {\n        PINVOICES: samples,\n        document_types_count: samples.length\n    };\n}\n\n// תיקון חדש: פונקציה ליצירת recommended_samples\nfunction createRecommendedSamples(analysis) {\n    const recommendations = [];\n    \n    analysis.document_types.forEach((docType, index) => {\n        const sample = docType.sample;\n        const booknum = sample.BOOKNUM || 'לא זוהה';\n        const ivnum = sample.IVNUM || 'לא זוהה';\n        \n        // תיאור התבנית\n        let templateDesc = docType.has_import ? 'יבוא' : 'חשבונית רגילה';\n        const characteristics = [];\n        \n        if (docType.has_date_range) characteristics.push('טווח תאריכים');\n        if (docType.has_budcode) characteristics.push('תקציב');\n        if (docType.has_pdaccname) characteristics.push('חשבון נגדי');\n        if (docType.has_doc) characteristics.push('תעודות');\n        \n        if (characteristics.length > 0) {\n            templateDesc += ' - ' + characteristics.join(', ');\n        }\n        \n        const recommendation = {\n            template_number: index + 1,\n            template_description: templateDesc,\n            sample_ivnum: ivnum,\n            sample_booknum: booknum,\n            sample_ivdate: sample.IVDATE || '',\n            sample_debit: sample.DEBIT || '',\n            characteristics: {\n                has_import: docType.has_import,\n                has_date_range: docType.has_date_range,\n                has_budcode: docType.has_budcode,\n                has_pdaccname: docType.has_pdaccname,\n                has_doc: docType.has_doc,\n                accnames: docType.accnames || []\n            }\n        };\n        \n        // הוספת הערה אם יש doc_variations\n        if (docType.doc_variations) {\n            recommendation.note = docType.doc_variations;\n        }\n        \n        recommendations.push(recommendation);\n    });\n    \n    return {\n        total_templates: recommendations.length,\n        note: \"יש לקחת מסמך אמיתי אחד לכל תבנית שמופיעה למטה\",\n        samples: recommendations\n    };\n}\n\n// הפונקציה הראשית\nfunction processSupplierInvoices(invoicesJson, supplierId) {\n    try {\n        let invoices = invoicesJson;\n        if (typeof invoicesJson === 'string') {\n            invoices = JSON.parse(invoicesJson);\n        }\n        \n        if (!Array.isArray(invoices)) {\n            throw new Error('invoices_json must be an array');\n        }\n        \n        const analysis = deepAnalyzeSupplier(invoices);\n        \n        // *** שלב חדש: מיזוג תבניות זהות ***\n        analysis.document_types = mergeIdenticalTemplates(analysis.document_types);\n        \n        const config = createAdvancedConfig(supplierId, analysis);\n        const template = createMultiSampleTemplate(analysis);\n        const recommended = createRecommendedSamples(analysis);\n        \n        return {\n            status: 'success',\n            supplier_id: supplierId,\n            supplier_name: analysis.supplier_name,\n            json_files_analyzed: invoices.length,\n            templates_detected: template.document_types_count,\n            config: config,\n            template: template,\n            recommended_samples: recommended\n        };\n        \n    } catch (error) {\n        return {\n            status: 'error',\n            message: error.message,\n            stack: error.stack\n        };\n    }\n}\n\n// קוד הרצה למייק\nconst supplierId = input.supplier_id;\n\nlet invoices;\ntry {\n    let rawData = input.invoices_json;\n    \n    if (rawData && typeof rawData === 'object' && rawData.type === 'Buffer' && Array.isArray(rawData.data)) {\n        const uint8Array = new Uint8Array(rawData.data);\n        const decoder = new TextDecoder('utf-8');\n        const text = decoder.decode(uint8Array);\n        invoices = JSON.parse(text);\n    }\n    else if (typeof rawData === 'string') {\n        invoices = JSON.parse(rawData);\n    }\n    else {\n        invoices = rawData;\n    }\n    \n    if (!Array.isArray(invoices)) {\n        return {\n            status: 'error',\n            message: 'invoices_json must be an array after parsing. Received: ' + typeof invoices,\n            received_structure: JSON.stringify(invoices).substring(0, 300)\n        };\n    }\n    \n} catch (e) {\n    return {\n        status: 'error',\n        message: 'Failed to parse invoices_json: ' + e.message,\n        error_stack: e.stack,\n        received_type: typeof input.invoices_json\n    };\n}\n\nconst result = processSupplierInvoices(invoices, supplierId);\n\nreturn result;"
                        },
                        "metadata": {
                            "designer": {
                                "x": 3000,
                                "y": 300,
                                "name": "ניתוח חשבוניות ספק",
                                "messages": [
                                    {
                                        "category": "reference",
                                        "severity": "warning",
                                        "message": "Referenced module 'Make Code - Run code' [65] is not accessible."
                                    }
                                ]
                            },
                            "restore": {
                                "expect": {
                                    "input": {
                                        "items": [
                                            null,
                                            null
                                        ]
                                    },
                                    "language": {
                                        "mode": "chose",
                                        "label": "JavaScript"
                                    },
                                    "inputFormat": {
                                        "label": "Code editor"
                                    }
                                }
                            },
                            "expect": [
                                {
                                    "name": "language",
                                    "type": "select",
                                    "label": "Language",
                                    "required": true,
                                    "validate": {
                                        "enum": [
                                            "javascript",
                                            "python"
                                        ]
                                    }
                                },
                                {
                                    "name": "input",
                                    "spec": {
                                        "name": "value",
                                        "spec": [
                                            {
                                                "name": "name",
                                                "type": "text",
                                                "label": "Name",
                                                "required": true,
                                                "validate": {
                                                    "max": 32,
                                                    "min": 1,
                                                    "pattern": "^[a-zA-Z0-9_]{1,32}$"
                                                }
                                            },
                                            {
                                                "name": "value",
                                                "type": "any",
                                                "label": "Value",
                                                "required": true
                                            }
                                        ],
                                        "type": "collection",
                                        "label": "Variable"
                                    },
                                    "type": "array",
                                    "label": "Input"
                                },
                                {
                                    "name": "dependencies",
                                    "spec": {
                                        "name": "value",
                                        "type": "text",
                                        "label": "Dependency",
                                        "required": true,
                                        "validate": {
                                            "max": 214,
                                            "min": 1,
                                            "pattern": "^[A-Za-z0-9_@\\./<>\\=\\!~\\^+\\-]{1,214}$"
                                        }
                                    },
                                    "type": "array",
                                    "label": "Additional dependencies (Enterprise plans only)"
                                },
                                {
                                    "name": "inputFormat",
                                    "type": "select",
                                    "label": "Input format",
                                    "required": true,
                                    "validate": {
                                        "enum": [
                                            "editor",
                                            "string"
                                        ]
                                    }
                                },
                                {
                                    "name": "codeEditorJavascript",
                                    "type": "editor",
                                    "label": "Code",
                                    "required": true
                                }
                            ]
                        }
                    },
                    {
                        "id": 105,
                        "module": "code:ExecuteCode",
                        "version": 0,
                        "parameters": {},
                        "mapper": {
                            "input": [
                                {
                                    "name": "supplier_id",
                                    "value": "{{65.result.invoices_summary[].SUPNAME}}"
                                },
                                {
                                    "name": "invoices_json",
                                    "value": "{{65.result.cleaned_json}}"
                                }
                            ],
                            "language": "javascript",
                            "inputFormat": "editor",
                            "dependencies": [],
                            "codeEditorJavascript": "// Supplier Data Learning - גרסה 1.2\n// תאריך: 28 אוקטובר 2025\n// עדכונים: מבנה JSON חדש, לוגיקה משופרת, תמיכה ברכבים, DEBIT כתבנית נפרדת\n\n// ============================================================================\n// פונקציות עזר - המרת תאריכים\n// ============================================================================\n\nfunction convertDateToFormat(dateStr) {\n    if (!dateStr) return '';\n    \n    // אם כבר בפורמט DD/MM/YY\n    if (typeof dateStr === 'string' && dateStr.match(/^\\d{2}\\/\\d{2}\\/\\d{2}$/)) {\n        return dateStr;\n    }\n    \n    // אם ISO format\n    const date = new Date(dateStr);\n    if (isNaN(date.getTime())) return dateStr;\n    \n    const day = String(date.getDate()).padStart(2, '0');\n    const month = String(date.getMonth() + 1).padStart(2, '0');\n    const year = String(date.getFullYear()).slice(-2);\n    \n    return `${day}/${month}/${year}`;\n}\n\n// ============================================================================\n// פונקציה לזיהוי סוג מסמך + DEBIT\n// ============================================================================\n\nfunction identifyDocumentType(invoice) {\n    const hasImport = !!invoice.IMPFNUM;\n    const debitType = invoice.DEBIT || 'D';\n    \n    const accnames = new Set();\n    let hasDateRange = false;\n    let hasBudcode = false;\n    let hasPdaccname = false;\n    \n    if (invoice.PINVOICEITEMS || invoice.PINVOICEITEMS_SUBFORM) {\n        const items = invoice.PINVOICEITEMS || invoice.PINVOICEITEMS_SUBFORM;\n        items.forEach(item => {\n            if (item.ACCNAME) accnames.add(item.ACCNAME);\n            if (item.FROMDATE || item.TODATE) hasDateRange = true;\n            if (item.BUDCODE) hasBudcode = true;\n            if (item.PDACCNAME) hasPdaccname = true;\n        });\n    }\n    \n    const hasDoc = !!((invoice.PIVDOC && invoice.PIVDOC.length > 0) || \n                      (invoice.PIVDOC_SUBFORM && invoice.PIVDOC_SUBFORM.length > 0) ||\n                      invoice.DOCNO);\n    \n    const accnamesSorted = Array.from(accnames).sort().join(',');\n    \n    return {\n        type_key: `${hasImport ? 'IMP' : 'REG'}_${debitType}_ACC_${accnamesSorted}_DR_${hasDateRange}_BUD_${hasBudcode}_PD_${hasPdaccname}_DOC_${hasDoc}`,\n        has_import: hasImport,\n        debit_type: debitType,\n        accnames: Array.from(accnames),\n        has_date_range: hasDateRange,\n        has_budcode: hasBudcode,\n        has_pdaccname: hasPdaccname,\n        has_doc: hasDoc\n    };\n}\n\n// ============================================================================\n// ניתוח inventory_management\n// ============================================================================\n\nfunction analyzeInventoryManagement(invoices) {\n    const prsourcenames = new Set();\n    \n    invoices.forEach(invoice => {\n        const items = invoice.PINVOICEITEMS || invoice.PINVOICEITEMS_SUBFORM;\n        if (items && items.length > 0 && items[0].PRSOURCENAME) {\n            prsourcenames.add(items[0].PRSOURCENAME);\n        }\n    });\n    \n    // אם כל החשבוניות עם אותו PRSOURCENAME\n    if (prsourcenames.size === 1) {\n        const value = Array.from(prsourcenames)[0];\n        if (value === 'קבלה למלאי') return 'managed_inventory';\n        if (value === 'ידני') return 'not_managed_inventory';\n    }\n    \n    return 'not_managed_inventory'; // ברירת מחדל\n}\n\n// ============================================================================\n// חילוץ מידע ספק (vendor_tax_id, phone, email)\n// ============================================================================\n\nfunction extractSupplierInfo(invoices) {\n    const info = {\n        vendor_tax_id_reference: '',\n        supplier_phone: '',\n        supplier_email: ''\n    };\n    \n    for (const invoice of invoices) {\n        const cont = invoice.PINVOICESCONT || invoice.PINVOICESCONT_SUBFORM;\n        if (cont && cont.length > 0) {\n            if (!info.vendor_tax_id_reference && cont[0].IVREF) {\n                info.vendor_tax_id_reference = cont[0].IVREF;\n            }\n            if (!info.supplier_phone && cont[0].PHONE) {\n                info.supplier_phone = cont[0].PHONE;\n            }\n            if (!info.supplier_email && cont[0].EMAIL) {\n                info.supplier_email = cont[0].EMAIL;\n            }\n        }\n        \n        if (info.vendor_tax_id_reference && info.supplier_phone && info.supplier_email) {\n            break;\n        }\n    }\n    \n    return info;\n}\n\n// ============================================================================\n// ניתוח חוקי רכבים\n// ============================================================================\n\nfunction analyzeVehicleRules(invoices) {\n    const vehicleData = {};\n    \n    invoices.forEach(invoice => {\n        const items = invoice.PINVOICEITEMS || invoice.PINVOICEITEMS_SUBFORM;\n        if (!items) return;\n        \n        items.forEach(item => {\n            if (item.PARTNAME !== 'car') return;\n            \n            // חילוץ מספר רכב מ-ACCDES\n            const accdes = item.ACCDES || '';\n            const vehicleMatch = accdes.match(/^(\\d{3}-\\d{2}-\\d{3})/);\n            \n            if (vehicleMatch && item.ACCNAME) {\n                const vehicleNumber = vehicleMatch[1];\n                \n                if (!vehicleData[vehicleNumber]) {\n                    vehicleData[vehicleNumber] = {\n                        accname: item.ACCNAME,\n                        accdes: accdes,\n                        vatflag_values: new Set(),\n                        specialvatflag_values: new Set(),\n                        has_fromdate: new Set(),\n                        has_todate: new Set(),\n                        has_pdaccname: new Set()\n                    };\n                }\n                \n                const vd = vehicleData[vehicleNumber];\n                if (item.VATFLAG) vd.vatflag_values.add(item.VATFLAG);\n                if (item.SPECIALVATFLAG) vd.specialvatflag_values.add(item.SPECIALVATFLAG);\n                vd.has_fromdate.add(!!item.FROMDATE);\n                vd.has_todate.add(!!item.TODATE);\n                vd.has_pdaccname.add(!!item.PDACCNAME);\n            }\n        });\n    });\n    \n    // המרה לפורמט סופי\n    const vehicleRules = {};\n    Object.keys(vehicleData).forEach(vehicleNumber => {\n        const vd = vehicleData[vehicleNumber];\n        \n        vehicleRules[vehicleNumber] = {\n            accname: vd.accname,\n            accdes: vd.accdes,\n            vat_pattern: {\n                VATFLAG: vd.vatflag_values.size === 1 ? Array.from(vd.vatflag_values)[0] : 'varies',\n                SPECIALVATFLAG: vd.specialvatflag_values.size === 1 ? Array.from(vd.specialvatflag_values)[0] : 'varies'\n            },\n            date_range_pattern: vd.has_fromdate.has(true) ? 'sometimes' : 'never',\n            pdaccname_pattern: vd.has_pdaccname.has(true) ? 'sometimes' : 'never'\n        };\n    });\n    \n    return vehicleRules;\n}\n\n// ============================================================================\n// ניתוח עמוק של ספק\n// ============================================================================\n\nfunction deepAnalyzeSupplier(invoices) {\n    const analysis = {\n        supplier_name: '',\n        supplier_info: {},\n        all_data: invoices,\n        partnames: {},\n        vehicle_rules: {},\n        has_doc: false,\n        has_pivordi: false,\n        has_delivery_notes: false,\n        has_docno: false,\n        has_ordname: false,\n        has_sdinumit: false,\n        has_impfnum: false,\n        inventory_management: 'not_managed_inventory',\n        document_types: [],\n        totquant_sample: 0\n    };\n    \n    const docTypesSeen = new Map();\n    \n    // שם ספק ומידע\n    if (invoices.length > 0 && invoices[0].SUPDES) {\n        analysis.supplier_name = invoices[0].SUPDES;\n    }\n    \n    analysis.supplier_info = extractSupplierInfo(invoices);\n    analysis.inventory_management = analyzeInventoryManagement(invoices);\n    \n    // ניתוח כל החשבוניות\n    invoices.forEach(data => {\n        const docType = identifyDocumentType(data);\n        if (!docTypesSeen.has(docType.type_key)) {\n            docTypesSeen.set(docType.type_key, {\n                ...docType,\n                sample: data\n            });\n        }\n        \n        // זיהוי שדות מיוחדים\n        if ((data.PIVDOC && data.PIVDOC.length > 0) || \n            (data.PIVDOC_SUBFORM && data.PIVDOC_SUBFORM.length > 0) ||\n            data.DOCNO) {\n            analysis.has_doc = true;\n        }\n        if (data.PIVORDI && data.PIVORDI.length > 0) analysis.has_pivordi = true;\n        if (data.SDINUMIT) analysis.has_sdinumit = true;\n        if (data.DOCNO) analysis.has_docno = true;\n        if (data.ORDNAME) analysis.has_ordname = true;\n        if (data.IMPFNUM) analysis.has_impfnum = true;\n        \n        // TOTQUANT לדוגמה\n        if (data.TOTQUANT && !analysis.totquant_sample) {\n            analysis.totquant_sample = data.TOTQUANT;\n        }\n    });\n    \n    analysis.has_delivery_notes = analysis.has_sdinumit || analysis.has_docno;\n    \n    // ניתוח מקטים (רק אם אין תעודות)\n    const needsPartnameAnalysis = !analysis.has_doc && !analysis.has_delivery_notes;\n    \n    if (needsPartnameAnalysis) {\n        invoices.forEach(data => {\n            const items = data.PINVOICEITEMS || data.PINVOICEITEMS_SUBFORM;\n            if (items) {\n                items.forEach(item => {\n                    const partname = item.PARTNAME || '';\n                    if (partname && partname !== 'car') {\n                        if (!analysis.partnames[partname]) {\n                            analysis.partnames[partname] = {\n                                accnames: new Set(),\n                                has_pdaccname: false,\n                                sample_pdes: new Set()\n                            };\n                        }\n                        \n                        if (item.ACCNAME) {\n                            analysis.partnames[partname].accnames.add(item.ACCNAME);\n                        }\n                        if (item.PDACCNAME) {\n                            analysis.partnames[partname].has_pdaccname = true;\n                        }\n                        if (item.PDES) {\n                            analysis.partnames[partname].sample_pdes.add(item.PDES.substring(0, 50));\n                        }\n                    }\n                });\n            }\n        });\n    }\n    \n    // ניתוח רכבים\n    analysis.vehicle_rules = analyzeVehicleRules(invoices);\n    \n    analysis.document_types = Array.from(docTypesSeen.values());\n    \n    return analysis;\n}\n\n// ============================================================================\n// בדיקה אם תבניות צריכות להתמזג (רק הבדל במקטים/חשבונות)\n// ============================================================================\n\nfunction shouldMergeTemplates(type1, type2) {\n    const fieldsToCompare = ['has_import', 'debit_type', 'has_date_range', 'has_budcode', 'has_pdaccname', 'has_doc'];\n    \n    for (const field of fieldsToCompare) {\n        if (type1[field] !== type2[field]) {\n            return false;\n        }\n    }\n    \n    return true;\n}\n\n// ============================================================================\n// מיזוג תבניות זהות (שההבדל רק במקטים)\n// ============================================================================\n\nfunction mergeIdenticalTemplates(documentTypes) {\n    if (documentTypes.length <= 1) {\n        return documentTypes;\n    }\n    \n    const merged = [];\n    const processed = new Set();\n    \n    for (let i = 0; i < documentTypes.length; i++) {\n        if (processed.has(i)) continue;\n        \n        let currentType = { ...documentTypes[i] };\n        const allAccnames = new Set(currentType.accnames || []);\n        let allSamples = [currentType.sample];\n        \n        for (let j = i + 1; j < documentTypes.length; j++) {\n            if (processed.has(j)) continue;\n            \n            if (shouldMergeTemplates(currentType, documentTypes[j])) {\n                // מיזוג accnames\n                (documentTypes[j].accnames || []).forEach(acc => allAccnames.add(acc));\n                allSamples.push(documentTypes[j].sample);\n                processed.add(j);\n            }\n        }\n        \n        currentType.accnames = Array.from(allAccnames);\n        currentType.all_samples = allSamples;\n        \n        merged.push(currentType);\n        processed.add(i);\n    }\n    \n    return merged;\n}\n\n// ============================================================================\n// חישוב type (סוג מסמך) לפי מבנה\n// ============================================================================\n\nfunction calculateDocumentType(docType) {\n    if (docType.debit_type === 'C') {\n        if (docType.has_import) {\n            return 'זיכוי יבוא';\n        }\n        if (docType.has_doc) {\n            return 'זיכוי עם תעודות ללא פירוט';\n        }\n        return 'זיכוי רגיל עם פירוט';\n    }\n    \n    if (docType.has_import) {\n        if (docType.has_doc) {\n            return 'חשבונית עם תיק יבוא עם תעודות';\n        }\n        return 'חשבונית עם תיק יבוא - הוצאות ללא תעודות';\n    }\n    \n    if (docType.has_doc) {\n        return 'חשבונית עם תעודות ללא פירוט';\n    }\n    \n    return 'חשבונית רגילה עם פירוט';\n}\n\n// ============================================================================\n// יצירת config מתקדם\n// ============================================================================\n\nfunction createAdvancedConfig(supplierId, analysis) {\n    const config = {\n        supplier_config: {\n            supplier_code: supplierId,\n            supplier_name: analysis.supplier_name,\n            vendor_tax_id_reference: analysis.supplier_info.vendor_tax_id_reference\n        },\n        structure: [],\n        rules: {\n            invoice_date_format: 'DD/MM/YY',\n            doc_variation: analysis.has_doc ? 'תעודה אחת (DOCNO) או מרובות (PIVDOC_SUBFORM) - שניהם בתבנית' : '',\n            validation_data: {\n                TOTQUANT: analysis.totquant_sample\n            },\n            critical_patterns: {\n                vehicle_rules: Object.keys(analysis.vehicle_rules).length > 0 ? {\n                    partname: 'car',\n                    vehicle_account_mapping: analysis.vehicle_rules\n                } : {},\n                partname_rules: {}\n            }\n        },\n        document_types: []\n    };\n    \n    // מיזוג תבניות\n    const mergedTypes = mergeIdenticalTemplates(analysis.document_types);\n    \n    // יצירת structure ו-document_types\n    mergedTypes.forEach(docType => {\n        // has_purchase_orders לפי הכלל החדש (סעיף 1)\n        let hasPurchaseOrders = false;\n        if (docType.has_import) {\n            hasPurchaseOrders = true; // יבוא - תמיד\n        } else if (!docType.has_doc && !analysis.has_delivery_notes && analysis.has_ordname) {\n            hasPurchaseOrders = true; // אין תעודות אבל יש הזמנה\n        }\n        \n        const structureItem = {\n            has_import: docType.has_import,\n            has_purchase_orders: hasPurchaseOrders,\n            has_doc: docType.has_doc,\n            has_date_range: docType.has_date_range,\n            has_budcode: docType.has_budcode,\n            has_pdaccname: docType.has_pdaccname,\n            inventory_management: analysis.inventory_management,\n            debit_type: docType.debit_type\n        };\n        \n        config.structure.push(structureItem);\n        \n        const documentTypeItem = {\n            type: calculateDocumentType(docType),\n            accnames: docType.accnames\n        };\n        \n        config.document_types.push(documentTypeItem);\n    });\n    \n    // הוספת partname_rules (רק אם אין תעודות ויש מקטים)\n    if (!analysis.has_doc && !analysis.has_delivery_notes && Object.keys(analysis.partnames).length > 0) {\n        const partnameRules = {};\n        \n        Object.keys(analysis.partnames).forEach(partname => {\n            const info = analysis.partnames[partname];\n            partnameRules[partname] = {\n                accnames: Array.from(info.accnames),\n                has_pdaccname: info.has_pdaccname,\n                sample_description: Array.from(info.sample_pdes)[0] || ''\n            };\n        });\n        \n        config.rules.critical_patterns.partname_rules = partnameRules;\n    }\n    \n    return config;\n}\n\n// ============================================================================\n// ניקוי תבנית - רק שדות רלוונטיים\n// ============================================================================\n\nfunction cleanTemplate(sample, analysis, docType) {\n    const cleaned = {\n        SUPNAME: sample.SUPNAME,\n        CODE: sample.CODE,\n        DEBIT: sample.DEBIT,\n        IVDATE: convertDateToFormat(sample.IVDATE),\n        BOOKNUM: sample.BOOKNUM\n    };\n    \n    // DOCNO אם יש תעודה אחת\n    if (sample.DOCNO) {\n        cleaned.DOCNO = sample.DOCNO;\n    }\n    \n    // ORDNAME רק אם צריך הזמנה\n    if (docType.has_import || (!docType.has_doc && !analysis.has_delivery_notes && analysis.has_ordname)) {\n        if (sample.ORDNAME) {\n            cleaned.ORDNAME = sample.ORDNAME;\n        }\n    }\n    \n    // IMPFNUM אם יבוא\n    if (docType.has_import && sample.IMPFNUM) {\n        cleaned.IMPFNUM = sample.IMPFNUM;\n    }\n    \n    // SDINUMIT אם יש\n    if (sample.SDINUMIT) {\n        cleaned.SDINUMIT = sample.SDINUMIT;\n    }\n    \n    // DETAILS אם יש\n    if (sample.DETAILS) {\n        cleaned.DETAILS = sample.DETAILS;\n    }\n    \n    // PIVDOC_SUBFORM אם יש תעודות מרובות\n    if (docType.has_doc) {\n        cleaned.PIVDOC_SUBFORM = [\n            {\n                DOCNO: '',\n                BOOKNUM: ''\n            }\n        ];\n    }\n    \n    // PINVOICEITEMS_SUBFORM אם אין תעודות\n    if (!docType.has_doc && !analysis.has_delivery_notes) {\n        const items = sample.PINVOICEITEMS || sample.PINVOICEITEMS_SUBFORM;\n        if (items && items.length > 0) {\n            cleaned.PINVOICEITEMS_SUBFORM = items.map(item => {\n                const cleanedItem = {\n                    PARTNAME: item.PARTNAME,\n                    PDES: item.PDES,\n                    TQUANT: item.TQUANT,\n                    TUNITNAME: item.TUNITNAME,\n                    PRICE: item.PRICE,\n                    VATFLAG: item.VATFLAG,\n                    ACCNAME: item.ACCNAME\n                };\n                \n                // ICODE רק אם שונה מכותרת\n                if (item.ICODE && item.ICODE !== sample.CODE) {\n                    cleanedItem.ICODE = item.ICODE;\n                }\n                \n                if (item.SPECIALVATFLAG) cleanedItem.SPECIALVATFLAG = item.SPECIALVATFLAG;\n                if (item.BUDCODE) cleanedItem.BUDCODE = item.BUDCODE;\n                if (item.FROMDATE) cleanedItem.FROMDATE = item.FROMDATE;\n                if (item.TODATE) cleanedItem.TODATE = item.TODATE;\n                if (item.PDACCNAME) cleanedItem.PDACCNAME = item.PDACCNAME;\n                \n                return cleanedItem;\n            });\n        }\n    }\n    \n    // PINVOICESCONT_SUBFORM - רק אם יש שדות רלוונטיים\n    const cont = sample.PINVOICESCONT || sample.PINVOICESCONT_SUBFORM;\n    if (cont && cont.length > 0) {\n        const fncpatname = cont[0].FNCPATNAME;\n        // רק אם FNCPATNAME שונה מ\"חסמ\"\n        if (fncpatname && fncpatname !== 'חסמ') {\n            cleaned.PINVOICESCONT_SUBFORM = [{\n                FNCPATNAME: fncpatname\n            }];\n        }\n    }\n    \n    return cleaned;\n}\n\n// ============================================================================\n// יצירת תבנית מרובה\n// ============================================================================\n\nfunction createMultiSampleTemplate(analysis) {\n    const mergedTypes = mergeIdenticalTemplates(analysis.document_types);\n    const samples = [];\n    \n    mergedTypes.forEach(docType => {\n        // אם יש מיזוג תבניות (פירוט) - לקחת כל הרשומות השונות\n        if (docType.all_samples && docType.all_samples.length > 1 && !docType.has_doc) {\n            // מיזוג כל הפריטים מכל הדוגמאות\n            const allItems = [];\n            const seenItems = new Set();\n            \n            docType.all_samples.forEach(sample => {\n                const items = sample.PINVOICEITEMS || sample.PINVOICEITEMS_SUBFORM;\n                if (items) {\n                    items.forEach(item => {\n                        const itemKey = `${item.PARTNAME}_${item.ACCNAME}`;\n                        if (!seenItems.has(itemKey)) {\n                            allItems.push(item);\n                            seenItems.add(itemKey);\n                        }\n                    });\n                }\n            });\n            \n            // יצירת תבנית אחת עם כל הפריטים\n            const baseSample = docType.all_samples[0];\n            const cleanedSample = cleanTemplate(baseSample, analysis, docType);\n            \n            if (allItems.length > 0) {\n                cleanedSample.PINVOICEITEMS_SUBFORM = allItems.map(item => {\n                    const cleanedItem = {\n                        PARTNAME: item.PARTNAME,\n                        PDES: item.PDES,\n                        TQUANT: item.TQUANT,\n                        TUNITNAME: item.TUNITNAME,\n                        PRICE: item.PRICE,\n                        VATFLAG: item.VATFLAG,\n                        ACCNAME: item.ACCNAME\n                    };\n                    \n                    if (item.ICODE && item.ICODE !== baseSample.CODE) {\n                        cleanedItem.ICODE = item.ICODE;\n                    }\n                    if (item.SPECIALVATFLAG) cleanedItem.SPECIALVATFLAG = item.SPECIALVATFLAG;\n                    if (item.BUDCODE) cleanedItem.BUDCODE = item.BUDCODE;\n                    if (item.FROMDATE) cleanedItem.FROMDATE = item.FROMDATE;\n                    if (item.TODATE) cleanedItem.TODATE = item.TODATE;\n                    if (item.PDACCNAME) cleanedItem.PDACCNAME = item.PDACCNAME;\n                    \n                    return cleanedItem;\n                });\n            }\n            \n            samples.push(cleanedSample);\n        } else {\n            // תבנית רגילה\n            const sample = docType.sample;\n            samples.push(cleanTemplate(sample, analysis, docType));\n        }\n    });\n    \n    return {\n        PINVOICES: samples,\n        document_types_count: samples.length\n    };\n}\n\n// ============================================================================\n// יצירת דוגמאות מומלצות (אקראיות)\n// ============================================================================\n\nfunction createRecommendedSamples(analysis) {\n    const mergedTypes = mergeIdenticalTemplates(analysis.document_types);\n    const samples = [];\n    \n    mergedTypes.forEach(() => {\n        // בחירה אקראית מתוך כל החשבוניות\n        const randomIndex = Math.floor(Math.random() * analysis.all_data.length);\n        const randomInvoice = analysis.all_data[randomIndex];\n        \n        samples.push({\n            sample_ivnum: randomInvoice.IVNUM || '',\n            sample_booknum: randomInvoice.BOOKNUM || ''\n        });\n    });\n    \n    return {\n        samples: samples\n    };\n}\n\n// ============================================================================\n// הפונקציה הראשית\n// ============================================================================\n\nfunction processSupplierInvoices(invoicesJson, supplierId) {\n    try {\n        let invoices = invoicesJson;\n        if (typeof invoicesJson === 'string') {\n            invoices = JSON.parse(invoicesJson);\n        }\n        \n        if (!Array.isArray(invoices)) {\n            throw new Error('invoices_json must be an array');\n        }\n        \n        const analysis = deepAnalyzeSupplier(invoices);\n        const config = createAdvancedConfig(supplierId, analysis);\n        const template = createMultiSampleTemplate(analysis);\n        const recommended = createRecommendedSamples(analysis);\n        \n        return {\n            status: 'success',\n            supplier_id: supplierId,\n            supplier_name: analysis.supplier_name,\n            vendor_tax_id_reference: analysis.supplier_info.vendor_tax_id_reference,\n            supplier_phone: analysis.supplier_info.supplier_phone,\n            supplier_email: analysis.supplier_info.supplier_email,\n            json_files_analyzed: invoices.length,\n            templates_detected: template.document_types_count,\n            config: config,\n            template: template,\n            recommended_samples: recommended\n        };\n        \n    } catch (error) {\n        return {\n            status: 'error',\n            message: error.message,\n            stack: error.stack\n        };\n    }\n}\n\n// ============================================================================\n// קוד הרצה למייק\n// ============================================================================\n\nconst supplierId = input.supplier_id;\n\nlet invoices;\ntry {\n    let rawData = input.invoices_json;\n    \n    if (rawData && typeof rawData === 'object' && rawData.type === 'Buffer' && Array.isArray(rawData.data)) {\n        const uint8Array = new Uint8Array(rawData.data);\n        const decoder = new TextDecoder('utf-8');\n        const text = decoder.decode(uint8Array);\n        invoices = JSON.parse(text);\n    }\n    else if (typeof rawData === 'string') {\n        invoices = JSON.parse(rawData);\n    }\n    else {\n        invoices = rawData;\n    }\n    \n    if (!Array.isArray(invoices)) {\n        return {\n            status: 'error',\n            message: 'invoices_json must be an array after parsing. Received: ' + typeof invoices,\n            received_structure: JSON.stringify(invoices).substring(0, 300)\n        };\n    }\n    \n} catch (e) {\n    return {\n        status: 'error',\n        message: 'Failed to parse invoices_json: ' + e.message,\n        error_stack: e.stack,\n        received_type: typeof input.invoices_json\n    };\n}\n\nconst result = processSupplierInvoices(invoices, supplierId);\n\nreturn result;"
                        },
                        "metadata": {
                            "designer": {
                                "x": 3300,
                                "y": 300,
                                "name": "ניתוח חשבוניות ספק",
                                "messages": [
                                    {
                                        "category": "reference",
                                        "severity": "warning",
                                        "message": "Referenced module 'Make Code - Run code' [65] is not accessible."
                                    }
                                ]
                            },
                            "restore": {
                                "expect": {
                                    "input": {
                                        "items": [
                                            null,
                                            null
                                        ]
                                    },
                                    "language": {
                                        "mode": "chose",
                                        "label": "JavaScript"
                                    },
                                    "inputFormat": {
                                        "label": "Code editor"
                                    }
                                }
                            },
                            "expect": [
                                {
                                    "name": "language",
                                    "type": "select",
                                    "label": "Language",
                                    "required": true,
                                    "validate": {
                                        "enum": [
                                            "javascript",
                                            "python"
                                        ]
                                    }
                                },
                                {
                                    "name": "input",
                                    "spec": {
                                        "name": "value",
                                        "spec": [
                                            {
                                                "name": "name",
                                                "type": "text",
                                                "label": "Name",
                                                "required": true,
                                                "validate": {
                                                    "max": 32,
                                                    "min": 1,
                                                    "pattern": "^[a-zA-Z0-9_]{1,32}$"
                                                }
                                            },
                                            {
                                                "name": "value",
                                                "type": "any",
                                                "label": "Value",
                                                "required": true
                                            }
                                        ],
                                        "type": "collection",
                                        "label": "Variable"
                                    },
                                    "type": "array",
                                    "label": "Input"
                                },
                                {
                                    "name": "dependencies",
                                    "spec": {
                                        "name": "value",
                                        "type": "text",
                                        "label": "Dependency",
                                        "required": true,
                                        "validate": {
                                            "max": 214,
                                            "min": 1,
                                            "pattern": "^[A-Za-z0-9_@\\./<>\\=\\!~\\^+\\-]{1,214}$"
                                        }
                                    },
                                    "type": "array",
                                    "label": "Additional dependencies (Enterprise plans only)"
                                },
                                {
                                    "name": "inputFormat",
                                    "type": "select",
                                    "label": "Input format",
                                    "required": true,
                                    "validate": {
                                        "enum": [
                                            "editor",
                                            "string"
                                        ]
                                    }
                                },
                                {
                                    "name": "codeEditorJavascript",
                                    "type": "editor",
                                    "label": "Code",
                                    "required": true
                                }
                            ]
                        }
                    }
                ],
                [
                    {
                        "id": 151,
                        "module": "leonai-priority:CreateDoc",
                        "version": 1,
                        "parameters": {
                            "__IMTCONN__": 12833505
                        },
                        "mapper": {
                            "form": "PINVOICES",
                            "NOSEND": "Y",
                            "search": {
                                "DEBIT": "{{var.input.DEBIT}}",
                                "IVNUM": "{{var.input.IVNUM}}",
                                "PIVTYPE": "P"
                            },
                            "EXTFILEDES": "{{13.name}}",
                            "EXTFILENAME": "{{13.data}}"
                        },
                        "metadata": {
                            "designer": {
                                "x": 1183,
                                "y": -674,
                                "messages": [
                                    {
                                        "category": "reference",
                                        "severity": "error",
                                        "message": "Module references non-existing module '13'."
                                    },
                                    {
                                        "category": "link",
                                        "severity": "warning",
                                        "message": "The module is not connected to the data flow."
                                    }
                                ]
                            },
                            "restore": {
                                "expect": {
                                    "form": {
                                        "mode": "chose",
                                        "label": "חשבוניות ספק מרכזות"
                                    }
                                },
                                "parameters": {
                                    "__IMTCONN__": {
                                        "data": {
                                            "scoped": "true",
                                            "connection": "leonai-priority3"
                                        },
                                        "label": "PALYAM NEW  Priority API connection (a011204, tabula.ini)"
                                    }
                                }
                            },
                            "parameters": [
                                {
                                    "name": "__IMTCONN__",
                                    "type": "account:leonai-priority3",
                                    "label": "Connection",
                                    "required": true
                                }
                            ],
                            "expect": [
                                {
                                    "name": "form",
                                    "type": "select",
                                    "label": "Forms",
                                    "required": true
                                },
                                {
                                    "name": "hevra",
                                    "type": "text",
                                    "label": "Company \\ Environment"
                                },
                                {
                                    "name": "search",
                                    "spec": [
                                        {
                                            "name": "IVNUM",
                                            "type": "text",
                                            "label": "מס. פנימי",
                                            "required": true
                                        },
                                        {
                                            "name": "DEBIT",
                                            "type": "text",
                                            "label": "חיוב/זכוי",
                                            "required": true
                                        },
                                        {
                                            "name": "PIVTYPE",
                                            "type": "hidden",
                                            "label": "סוג",
                                            "required": true
                                        }
                                    ],
                                    "type": "collection",
                                    "label": "Types"
                                },
                                {
                                    "name": "EXTFILEDES",
                                    "type": "text",
                                    "label": "File name",
                                    "required": true
                                },
                                {
                                    "name": "EXTFILENAME",
                                    "type": "buffer",
                                    "label": "File path / file data",
                                    "required": true
                                },
                                {
                                    "name": "NOSEND",
                                    "type": "text",
                                    "label": "Don't send?"
                                },
                                {
                                    "name": "STATUS",
                                    "type": "text",
                                    "label": "Status"
                                },
                                {
                                    "name": "EI_COND",
                                    "type": "text",
                                    "label": "Electronic interface delivery"
                                },
                                {
                                    "name": "suffix",
                                    "type": "text",
                                    "label": "File Suffix",
                                    "validate": {
                                        "max": 4,
                                        "min": 3
                                    }
                                },
                                {
                                    "name": "form",
                                    "type": "select",
                                    "label": "Forms",
                                    "required": true
                                },
                                {
                                    "name": "hevra",
                                    "type": "text",
                                    "label": "Company \\ Environment"
                                },
                                {
                                    "name": "search",
                                    "spec": [
                                        {
                                            "name": "IVNUM",
                                            "type": "text",
                                            "label": "מס. פנימי",
                                            "required": true
                                        },
                                        {
                                            "name": "DEBIT",
                                            "type": "text",
                                            "label": "חיוב/זכוי",
                                            "required": true
                                        },
                                        {
                                            "name": "PIVTYPE",
                                            "type": "hidden",
                                            "label": "סוג",
                                            "required": true
                                        }
                                    ],
                                    "type": "collection",
                                    "label": "Types"
                                },
                                {
                                    "name": "EXTFILEDES",
                                    "type": "text",
                                    "label": "File name",
                                    "required": true
                                },
                                {
                                    "name": "EXTFILENAME",
                                    "type": "buffer",
                                    "label": "File path / file data",
                                    "required": true
                                },
                                {
                                    "name": "NOSEND",
                                    "type": "text",
                                    "label": "Don't send?"
                                },
                                {
                                    "name": "STATUS",
                                    "type": "text",
                                    "label": "Status"
                                },
                                {
                                    "name": "EI_COND",
                                    "type": "text",
                                    "label": "Electronic interface delivery"
                                },
                                {
                                    "name": "suffix",
                                    "type": "text",
                                    "label": "File Suffix",
                                    "validate": {
                                        "max": 4,
                                        "min": 3
                                    }
                                }
                            ],
                            "interface": [
                                {
                                    "name": "make",
                                    "spec": [
                                        {
                                            "name": "sufFix",
                                            "type": "text",
                                            "label": "File Suffix"
                                        },
                                        {
                                            "name": "fileData",
                                            "type": "buffer",
                                            "label": "File Data",
                                            "semantic": "file:data"
                                        },
                                        {
                                            "name": "fileName",
                                            "type": "text",
                                            "label": "File Name"
                                        },
                                        {
                                            "name": "fullname",
                                            "type": "filename",
                                            "label": "Full Filename",
                                            "semantic": "file:name"
                                        }
                                    ],
                                    "type": "collection",
                                    "label": "Make"
                                },
                                {
                                    "name": "priority",
                                    "spec": [
                                        {
                                            "name": "EXTFILEDES",
                                            "type": "text",
                                            "label": "שם קובץ"
                                        },
                                        {
                                            "name": "EXTFILENUM",
                                            "type": "number",
                                            "label": "מספר מסמך"
                                        },
                                        {
                                            "name": "EXTFILENAME",
                                            "type": "text",
                                            "label": "נתיב הקובץ"
                                        },
                                        {
                                            "name": "SUFFIX",
                                            "type": "text",
                                            "label": "סיומת"
                                        },
                                        {
                                            "name": "CURDATE",
                                            "type": "date",
                                            "label": "תאריך יצירת המסמך"
                                        },
                                        {
                                            "name": "NOSEND",
                                            "type": "text",
                                            "label": "לא לשלוח"
                                        },
                                        {
                                            "name": "STATUS",
                                            "type": "text",
                                            "label": "סטטוס"
                                        },
                                        {
                                            "name": "FILESIZE",
                                            "type": "number",
                                            "label": "גודל קובץ בבתים"
                                        },
                                        {
                                            "name": "EI_COND",
                                            "type": "text",
                                            "label": "משלוח בממשק אלקטרוני"
                                        },
                                        {
                                            "name": "USERLOGIN",
                                            "type": "text",
                                            "label": "עודכן ע\"י"
                                        },
                                        {
                                            "name": "UDATE",
                                            "type": "date",
                                            "label": "ת. עדכון אחרון"
                                        },
                                        {
                                            "name": "LUSERLOGIN",
                                            "type": "text",
                                            "label": "נעול ע\"י"
                                        },
                                        {
                                            "name": "SCAN_PRIORISCAN",
                                            "type": "text",
                                            "label": "פריורי סקאן"
                                        },
                                        {
                                            "name": "NGV_SIGNATURE2",
                                            "type": "text",
                                            "label": "חתימה?"
                                        },
                                        {
                                            "name": "NGV_ADDRESS",
                                            "type": "text",
                                            "label": "כתובת (נייד)"
                                        },
                                        {
                                            "name": "NGV_LATITUDE",
                                            "type": "number",
                                            "label": "קו רוחב (נייד)"
                                        },
                                        {
                                            "name": "NGV_LONGITUDE",
                                            "type": "number",
                                            "label": "קו אורך (נייד)"
                                        },
                                        {
                                            "name": "SCAN_APIUSERLOGIN",
                                            "type": "text",
                                            "label": "שם מייבא הנספח"
                                        },
                                        {
                                            "name": "SCAN_UDATEAPI",
                                            "type": "date",
                                            "label": "ת. יבוא הנספח"
                                        }
                                    ],
                                    "type": "collection",
                                    "label": "Priority"
                                }
                            ]
                        }
                    },
                    {
                        "id": 152,
                        "module": "leonai-priority:getItemsForms",
                        "version": 1,
                        "parameters": {
                            "__IMTCONN__": 12833505
                        },
                        "mapper": {
                            "form": "ACCOUNTS",
                            "limit": "1"
                        },
                        "metadata": {
                            "designer": {
                                "x": 2821,
                                "y": -243
                            },
                            "restore": {
                                "expect": {
                                    "form": {
                                        "mode": "chose",
                                        "label": "חשבונות ראשיים"
                                    },
                                    "orderby": {
                                        "mode": "chose",
                                        "label": "Empty"
                                    },
                                    "selection": {
                                        "mode": "chose"
                                    }
                                },
                                "parameters": {
                                    "__IMTCONN__": {
                                        "data": {
                                            "scoped": "true",
                                            "connection": "leonai-priority3"
                                        },
                                        "label": "PALYAM NEW  Priority API connection (a011204, tabula.ini)"
                                    }
                                }
                            },
                            "parameters": [
                                {
                                    "name": "__IMTCONN__",
                                    "type": "account:leonai-priority3",
                                    "label": "Connection",
                                    "required": true
                                }
                            ],
                            "expect": [
                                {
                                    "name": "limit",
                                    "type": "number",
                                    "label": "Limit",
                                    "required": true
                                },
                                {
                                    "name": "skip",
                                    "type": "number",
                                    "label": "Skip"
                                },
                                {
                                    "name": "form",
                                    "type": "select",
                                    "label": "Form",
                                    "required": true
                                },
                                {
                                    "name": "hevra",
                                    "type": "text",
                                    "label": "Company \\ Environment"
                                },
                                {
                                    "name": "column",
                                    "type": "filter",
                                    "label": "Filters",
                                    "options": {
                                        "store": [
                                            {
                                                "label": "חשבון",
                                                "value": "ACCNAME::text"
                                            },
                                            {
                                                "label": "תאור חשבון",
                                                "value": "ACCDES::text"
                                            },
                                            {
                                                "label": "תאור חשבון (אנגלית)",
                                                "value": "EACCDES::text"
                                            },
                                            {
                                                "label": "יתרה במטבע חשבון",
                                                "value": "BALANCE3::number"
                                            },
                                            {
                                                "label": "מטבע החשבון",
                                                "value": "CODE::text"
                                            },
                                            {
                                                "label": "יתרה ב{LC.F}",
                                                "value": "BALANCE1::number"
                                            },
                                            {
                                                "label": "יתרה ב{FC.F}",
                                                "value": "BALANCE2::number"
                                            },
                                            {
                                                "label": "חתך",
                                                "value": "ACNGCODE::text"
                                            },
                                            {
                                                "label": "תאור חתך",
                                                "value": "ACNGDES::text"
                                            },
                                            {
                                                "label": "תבנית",
                                                "value": "ACCNAMEPATNAME::text"
                                            },
                                            {
                                                "label": "סעיף בדו\"ח מס",
                                                "value": "VATSECCODE::text"
                                            },
                                            {
                                                "label": "סעיף למאזן בוחן",
                                                "value": "TRIALBALCODE::text"
                                            },
                                            {
                                                "label": "כותרת למאזן בוחן",
                                                "value": "TRIALBALDES::text"
                                            },
                                            {
                                                "label": "תוצאתי?",
                                                "value": "BALFLAG::text"
                                            },
                                            {
                                                "label": "סעיף מאזן/רווח והפסד",
                                                "value": "SECNAME::text"
                                            },
                                            {
                                                "label": "כותרת מאזן/רווח והפ.",
                                                "value": "ACCTYPENAME::text"
                                            },
                                            {
                                                "label": "שיוך למאזן/רווח והפ.",
                                                "value": "BALTYPEDES::text"
                                            },
                                            {
                                                "label": "סניף",
                                                "value": "BRANCHNAME::text"
                                            },
                                            {
                                                "label": "תאור הסניף",
                                                "value": "BRANCHDES::text"
                                            },
                                            {
                                                "label": "קוד תזרים",
                                                "value": "CASHFLOWCODE::text"
                                            },
                                            {
                                                "label": "מבוטל ?",
                                                "value": "CLOSED::text"
                                            },
                                            {
                                                "label": "סגירה עד תאריך",
                                                "value": "CLOSEDATE::date"
                                            },
                                            {
                                                "label": "רב מטבעי",
                                                "value": "MULTICURFLAG::text"
                                            },
                                            {
                                                "label": "תקציב ראשי",
                                                "value": "BUDCODE::text"
                                            },
                                            {
                                                "label": "לחייב מילוי תקציב?",
                                                "value": "BUDGETFLAG::text"
                                            },
                                            {
                                                "label": "תוכנת מקור",
                                                "value": "DNAME::text"
                                            },
                                            {
                                                "label": "מספרו במערכת קודמת",
                                                "value": "OLDNAME::text"
                                            },
                                            {
                                                "label": "הכנסות/הוצאות מראש?",
                                                "value": "PDFLAG::text"
                                            },
                                            {
                                                "label": "חש' יעד ברירת מחדל",
                                                "value": "PDACCNAME::text"
                                            },
                                            {
                                                "label": "קוד חש' בנק לתזרים",
                                                "value": "CASHNAME::text"
                                            },
                                            {
                                                "label": "תת חברה",
                                                "value": "COMPANYNAME::text"
                                            },
                                            {
                                                "label": "שם תת חברה",
                                                "value": "COMPANYDES::text"
                                            },
                                            {
                                                "label": "חשבון בחברה ראשית",
                                                "value": "FATACCNAME::text"
                                            },
                                            {
                                                "label": "תאור חשבון",
                                                "value": "FATACCDES::text"
                                            },
                                            {
                                                "label": "מספר חברה/זהות",
                                                "value": "IDNUM::text"
                                            },
                                            {
                                                "label": "מרכז רווח/עלות",
                                                "value": "COSTCNAME::text"
                                            },
                                            {
                                                "label": "תאור מרכז רווח/עלות",
                                                "value": "COSTCDES::text"
                                            },
                                            {
                                                "label": "מרכז רווח/עלות 2",
                                                "value": "COSTCNAME2::text"
                                            },
                                            {
                                                "label": "תאור מרכז רווח/עלות2",
                                                "value": "COSTCDES2::text"
                                            },
                                            {
                                                "label": "מרכז רווח/עלות 3",
                                                "value": "COSTCNAME3::text"
                                            },
                                            {
                                                "label": "תאור מרכז רווח/עלות3",
                                                "value": "COSTCDES3::text"
                                            },
                                            {
                                                "label": "מרכז רווח/עלות 4",
                                                "value": "COSTCNAME4::text"
                                            },
                                            {
                                                "label": "תאור מרכז רווח/עלות4",
                                                "value": "COSTCDES4::text"
                                            },
                                            {
                                                "label": "מרכז רווח/עלות 5",
                                                "value": "COSTCNAME5::text"
                                            },
                                            {
                                                "label": "תאור מרכז רווח/עלות5",
                                                "value": "COSTCDES5::text"
                                            },
                                            {
                                                "label": "עץ מרכזי רווח/עלות",
                                                "value": "COSTCTREECODE::text"
                                            },
                                            {
                                                "label": "תאור עץ מרכזי רווח",
                                                "value": "COSTCTREEDES::text"
                                            },
                                            {
                                                "label": "חשבון חסוי?",
                                                "value": "CONFIDENTIAL::text"
                                            },
                                            {
                                                "label": "סעיף בטופס 6111",
                                                "value": "FORM6111::text"
                                            },
                                            {
                                                "label": "הכנת תשלומים לחשבון?",
                                                "value": "OPENQIV::text"
                                            },
                                            {
                                                "label": "מניעת תנועות ידניות?",
                                                "value": "NOTMANUALFLAG::text"
                                            },
                                            {
                                                "label": "מנע רישום המ. דחויות",
                                                "value": "PDFLAG2::text"
                                            },
                                            {
                                                "label": "קוד מע\"מ",
                                                "value": "TAXCODE::text"
                                            },
                                            {
                                                "label": "תאור מע\"מ",
                                                "value": "TAXDES::text"
                                            },
                                            {
                                                "label": "קוד קבוצת מס",
                                                "value": "TAXGROUPCODE::text"
                                            },
                                            {
                                                "label": "קבוצת מס",
                                                "value": "TAXGROUPDES::text"
                                            },
                                            {
                                                "label": "קוד תיבת מס",
                                                "value": "TAXBOXCODE::text"
                                            },
                                            {
                                                "label": "כותרת תיבה",
                                                "value": "TAXBOXDES::text"
                                            },
                                            {
                                                "label": "ארץ",
                                                "value": "COUNTRYNAME::text"
                                            },
                                            {
                                                "label": "קוד סוג הוצאה",
                                                "value": "EXPENSECODE::text"
                                            },
                                            {
                                                "label": "תאור סוג הוצאה",
                                                "value": "EXPENSENAME::text"
                                            },
                                            {
                                                "label": "% הוצאה מוכרת",
                                                "value": "DEDUCTEXPPERIT::number"
                                            },
                                            {
                                                "label": "% מוכר כהוצאה-EU",
                                                "value": "DEDUCTEXPPEREU::number"
                                            },
                                            {
                                                "label": "קוד קיבוץ SAT",
                                                "value": "SATCODE::text"
                                            },
                                            {
                                                "label": "תאור קיבוץ SAT",
                                                "value": "SATDES::text"
                                            },
                                            {
                                                "label": "אופי החשבון (מקסיקו)",
                                                "value": "NATUR::text"
                                            },
                                            {
                                                "label": "תאריך פתיחה",
                                                "value": "CREATEDDATE::date"
                                            },
                                            {
                                                "label": "להחריג מד.מע\"מ-אנגל.",
                                                "value": "VATEXCLUDEFLAG::text"
                                            },
                                            {
                                                "label": "קוד טקסונומיה",
                                                "value": "TAXONOMYCODE::text"
                                            },
                                            {
                                                "label": "תאור טקסונומיה",
                                                "value": "TAXONOMYDES::text"
                                            },
                                            {
                                                "label": "חשבון COGS בלבד?",
                                                "value": "ACCCOGS::text"
                                            },
                                            {
                                                "label": "קוד טופס 281.5",
                                                "value": "FORM2815CODE::text"
                                            },
                                            {
                                                "label": "תאור טופס 281.5",
                                                "value": "FORM2815DES::text"
                                            },
                                            {
                                                "label": "מספר חשבון לפריקה",
                                                "value": "ACCFOREXPORT::text"
                                            },
                                            {
                                                "label": "לא פעיל",
                                                "value": "INACTIVE::text"
                                            },
                                            {
                                                "label": "נתון תשתית",
                                                "value": "FROMSYNC::text"
                                            },
                                            {
                                                "label": "שם קובץ לסריקה",
                                                "value": "SCAN_ATTACHFN::text"
                                            },
                                            {
                                                "label": "חשבון (ID)",
                                                "value": "ACCOUNT::number"
                                            }
                                        ],
                                        "operators": [
                                            {
                                                "label": "Basic operators",
                                                "options": [
                                                    {
                                                        "label": "Exists",
                                                        "value": "exist"
                                                    },
                                                    {
                                                        "label": "Does not exist",
                                                        "value": "notexist"
                                                    }
                                                ]
                                            },
                                            {
                                                "label": "Text operators",
                                                "options": [
                                                    {
                                                        "label": "Equal to",
                                                        "value": "eq"
                                                    },
                                                    {
                                                        "label": "Not equal to",
                                                        "value": "ne"
                                                    },
                                                    {
                                                        "label": "Contains",
                                                        "value": "contains"
                                                    },
                                                    {
                                                        "label": "Does not Contain",
                                                        "value": "notcontains"
                                                    },
                                                    {
                                                        "label": "Start with",
                                                        "value": "startwith"
                                                    },
                                                    {
                                                        "label": "Does not start with",
                                                        "value": "notstartwith"
                                                    }
                                                ]
                                            },
                                            {
                                                "label": "Numbers operators",
                                                "options": [
                                                    {
                                                        "label": "Equal to",
                                                        "value": "eq"
                                                    },
                                                    {
                                                        "label": "Not equal to",
                                                        "value": "ne"
                                                    },
                                                    {
                                                        "label": "Greater than",
                                                        "value": "gt"
                                                    },
                                                    {
                                                        "label": "Less than",
                                                        "value": "lt"
                                                    },
                                                    {
                                                        "label": "Greater than or equal to",
                                                        "value": "ge"
                                                    },
                                                    {
                                                        "label": "Less than or equal to",
                                                        "value": "le"
                                                    }
                                                ]
                                            },
                                            {
                                                "label": "Datetime operators",
                                                "options": [
                                                    {
                                                        "label": "Equal to",
                                                        "value": "eq"
                                                    },
                                                    {
                                                        "label": "Not equal to",
                                                        "value": "ne"
                                                    },
                                                    {
                                                        "label": "Greater than",
                                                        "value": "gt"
                                                    },
                                                    {
                                                        "label": "Less than",
                                                        "value": "lt"
                                                    },
                                                    {
                                                        "label": "Greater than or equal to",
                                                        "value": "ge"
                                                    },
                                                    {
                                                        "label": "Less than or equal to",
                                                        "value": "le"
                                                    }
                                                ]
                                            }
                                        ]
                                    }
                                },
                                {
                                    "name": "orderby",
                                    "type": "select",
                                    "label": "Order by"
                                },
                                {
                                    "name": "since",
                                    "type": "text",
                                    "label": "Modified Since"
                                },
                                {
                                    "name": "selection",
                                    "type": "select",
                                    "label": "Get specified field\\s",
                                    "multiple": true
                                },
                                {
                                    "name": "subforms",
                                    "spec": [
                                        {
                                            "name": "table",
                                            "type": "select",
                                            "label": "Sub-Form",
                                            "dynamic": true,
                                            "options": {
                                                "store": []
                                            },
                                            "required": true
                                        }
                                    ],
                                    "type": "array",
                                    "label": "Sub-Forms Expend"
                                }
                            ],
                            "interface": [
                                {
                                    "name": "ACCNAME",
                                    "type": "text",
                                    "label": "‫חשבון‬"
                                },
                                {
                                    "name": "ACCDES",
                                    "type": "text",
                                    "label": "‫תאור חשבון‬"
                                },
                                {
                                    "name": "EACCDES",
                                    "type": "text",
                                    "label": "‫תאור חשבון (אנגלית)‬"
                                },
                                {
                                    "name": "BALANCE3",
                                    "type": "number",
                                    "label": "‫יתרה במטבע חשבון‬"
                                },
                                {
                                    "name": "CODE",
                                    "type": "text",
                                    "label": "‫מטבע החשבון‬"
                                },
                                {
                                    "name": "BALANCE1",
                                    "type": "number",
                                    "label": "‫יתרה ב{LC.F}‬"
                                },
                                {
                                    "name": "BALANCE2",
                                    "type": "number",
                                    "label": "‫יתרה ב{FC.F}‬"
                                },
                                {
                                    "name": "ACNGCODE",
                                    "type": "text",
                                    "label": "‫חתך‬"
                                },
                                {
                                    "name": "ACNGDES",
                                    "type": "text",
                                    "label": "‫תאור חתך‬"
                                },
                                {
                                    "name": "ACCNAMEPATNAME",
                                    "type": "text",
                                    "label": "‫תבנית‬"
                                },
                                {
                                    "name": "VATSECCODE",
                                    "type": "text",
                                    "label": "‫סעיף בדו\"ח מס‬"
                                },
                                {
                                    "name": "TRIALBALCODE",
                                    "type": "text",
                                    "label": "‫סעיף למאזן בוחן‬"
                                },
                                {
                                    "name": "TRIALBALDES",
                                    "type": "text",
                                    "label": "‫כותרת למאזן בוחן‬"
                                },
                                {
                                    "name": "BALFLAG",
                                    "type": "text",
                                    "label": "‫תוצאתי?‬"
                                },
                                {
                                    "name": "SECNAME",
                                    "type": "text",
                                    "label": "‫סעיף מאזן/רווח והפסד‬"
                                },
                                {
                                    "name": "ACCTYPENAME",
                                    "type": "text",
                                    "label": "‫כותרת מאזן/רווח והפ.‬"
                                },
                                {
                                    "name": "BALTYPEDES",
                                    "type": "text",
                                    "label": "‫שיוך למאזן/רווח והפ.‬"
                                },
                                {
                                    "name": "BRANCHNAME",
                                    "type": "text",
                                    "label": "‫סניף‬"
                                },
                                {
                                    "name": "BRANCHDES",
                                    "type": "text",
                                    "label": "‫תאור הסניף‬"
                                },
                                {
                                    "name": "CASHFLOWCODE",
                                    "type": "text",
                                    "label": "‫קוד תזרים‬"
                                },
                                {
                                    "name": "CLOSED",
                                    "type": "text",
                                    "label": "‫מבוטל ?‬"
                                },
                                {
                                    "name": "CLOSEDATE",
                                    "type": "date",
                                    "label": "‫סגירה עד תאריך‬"
                                },
                                {
                                    "name": "MULTICURFLAG",
                                    "type": "text",
                                    "label": "‫רב מטבעי‬"
                                },
                                {
                                    "name": "BUDCODE",
                                    "type": "text",
                                    "label": "‫תקציב ראשי‬"
                                },
                                {
                                    "name": "BUDGETFLAG",
                                    "type": "text",
                                    "label": "‫לחייב מילוי תקציב?‬"
                                },
                                {
                                    "name": "DNAME",
                                    "type": "text",
                                    "label": "‫תוכנת מקור‬"
                                },
                                {
                                    "name": "OLDNAME",
                                    "type": "text",
                                    "label": "‫מספרו במערכת קודמת‬"
                                },
                                {
                                    "name": "PDFLAG",
                                    "type": "text",
                                    "label": "‫הכנסות/הוצאות מראש?‬"
                                },
                                {
                                    "name": "PDACCNAME",
                                    "type": "text",
                                    "label": "‫חש' יעד ברירת מחדל‬"
                                },
                                {
                                    "name": "CASHNAME",
                                    "type": "text",
                                    "label": "‫קוד חש' בנק לתזרים‬"
                                },
                                {
                                    "name": "COMPANYNAME",
                                    "type": "text",
                                    "label": "‫תת חברה‬"
                                },
                                {
                                    "name": "COMPANYDES",
                                    "type": "text",
                                    "label": "‫שם תת חברה‬"
                                },
                                {
                                    "name": "FATACCNAME",
                                    "type": "text",
                                    "label": "‫חשבון בחברה ראשית‬"
                                },
                                {
                                    "name": "FATACCDES",
                                    "type": "text",
                                    "label": "‫תאור חשבון‬"
                                },
                                {
                                    "name": "IDNUM",
                                    "type": "text",
                                    "label": "‫מספר חברה/זהות‬"
                                },
                                {
                                    "name": "COSTCNAME",
                                    "type": "text",
                                    "label": "‫מרכז רווח/עלות‬"
                                },
                                {
                                    "name": "COSTCDES",
                                    "type": "text",
                                    "label": "‫תאור מרכז רווח/עלות‬"
                                },
                                {
                                    "name": "COSTCNAME2",
                                    "type": "text",
                                    "label": "‫מרכז רווח/עלות 2‬"
                                },
                                {
                                    "name": "COSTCDES2",
                                    "type": "text",
                                    "label": "‫תאור מרכז רווח/עלות2‬"
                                },
                                {
                                    "name": "COSTCNAME3",
                                    "type": "text",
                                    "label": "‫מרכז רווח/עלות 3‬"
                                },
                                {
                                    "name": "COSTCDES3",
                                    "type": "text",
                                    "label": "‫תאור מרכז רווח/עלות3‬"
                                },
                                {
                                    "name": "COSTCNAME4",
                                    "type": "text",
                                    "label": "‫מרכז רווח/עלות 4‬"
                                },
                                {
                                    "name": "COSTCDES4",
                                    "type": "text",
                                    "label": "‫תאור מרכז רווח/עלות4‬"
                                },
                                {
                                    "name": "COSTCNAME5",
                                    "type": "text",
                                    "label": "‫מרכז רווח/עלות 5‬"
                                },
                                {
                                    "name": "COSTCDES5",
                                    "type": "text",
                                    "label": "‫תאור מרכז רווח/עלות5‬"
                                },
                                {
                                    "name": "COSTCTREECODE",
                                    "type": "text",
                                    "label": "‫עץ מרכזי רווח/עלות‬"
                                },
                                {
                                    "name": "COSTCTREEDES",
                                    "type": "text",
                                    "label": "‫תאור עץ מרכזי רווח‬"
                                },
                                {
                                    "name": "CONFIDENTIAL",
                                    "type": "text",
                                    "label": "‫חשבון חסוי?‬"
                                },
                                {
                                    "name": "FORM6111",
                                    "type": "text",
                                    "label": "‫סעיף בטופס 6111‬"
                                },
                                {
                                    "name": "OPENQIV",
                                    "type": "text",
                                    "label": "‫הכנת תשלומים לחשבון?‬"
                                },
                                {
                                    "name": "NOTMANUALFLAG",
                                    "type": "text",
                                    "label": "‫מניעת תנועות ידניות?‬"
                                },
                                {
                                    "name": "PDFLAG2",
                                    "type": "text",
                                    "label": "‫מנע רישום המ. דחויות‬"
                                },
                                {
                                    "name": "TAXCODE",
                                    "type": "text",
                                    "label": "‫קוד מע\"מ‬"
                                },
                                {
                                    "name": "TAXDES",
                                    "type": "text",
                                    "label": "‫תאור מע\"מ‬"
                                },
                                {
                                    "name": "TAXGROUPCODE",
                                    "type": "text",
                                    "label": "‫קוד קבוצת מס‬"
                                },
                                {
                                    "name": "TAXGROUPDES",
                                    "type": "text",
                                    "label": "‫קבוצת מס‬"
                                },
                                {
                                    "name": "TAXBOXCODE",
                                    "type": "text",
                                    "label": "‫קוד תיבת מס‬"
                                },
                                {
                                    "name": "TAXBOXDES",
                                    "type": "text",
                                    "label": "‫כותרת תיבה‬"
                                },
                                {
                                    "name": "COUNTRYNAME",
                                    "type": "text",
                                    "label": "‫ארץ‬"
                                },
                                {
                                    "name": "EXPENSECODE",
                                    "type": "text",
                                    "label": "‫קוד סוג הוצאה‬"
                                },
                                {
                                    "name": "EXPENSENAME",
                                    "type": "text",
                                    "label": "‫תאור סוג הוצאה‬"
                                },
                                {
                                    "name": "DEDUCTEXPPERIT",
                                    "type": "number",
                                    "label": "‫% הוצאה מוכרת‬"
                                },
                                {
                                    "name": "DEDUCTEXPPEREU",
                                    "type": "number",
                                    "label": "‫% מוכר כהוצאה-EU‬"
                                },
                                {
                                    "name": "SATCODE",
                                    "type": "text",
                                    "label": "‫קוד קיבוץ SAT‬"
                                },
                                {
                                    "name": "SATDES",
                                    "type": "text",
                                    "label": "‫תאור קיבוץ SAT‬"
                                },
                                {
                                    "name": "NATUR",
                                    "type": "text",
                                    "label": "‫אופי החשבון (מקסיקו)‬"
                                },
                                {
                                    "name": "CREATEDDATE",
                                    "type": "date",
                                    "label": "‫תאריך פתיחה‬"
                                },
                                {
                                    "name": "VATEXCLUDEFLAG",
                                    "type": "text",
                                    "label": "‫להחריג מד.מע\"מ-אנגל.‬"
                                },
                                {
                                    "name": "TAXONOMYCODE",
                                    "type": "text",
                                    "label": "‫קוד טקסונומיה‬"
                                },
                                {
                                    "name": "TAXONOMYDES",
                                    "type": "text",
                                    "label": "‫תאור טקסונומיה‬"
                                },
                                {
                                    "name": "ACCCOGS",
                                    "type": "text",
                                    "label": "‫חשבון COGS בלבד?‬"
                                },
                                {
                                    "name": "FORM2815CODE",
                                    "type": "text",
                                    "label": "‫קוד טופס 281.5‬"
                                },
                                {
                                    "name": "FORM2815DES",
                                    "type": "text",
                                    "label": "‫תאור טופס 281.5‬"
                                },
                                {
                                    "name": "ACCFOREXPORT",
                                    "type": "text",
                                    "label": "‫מספר חשבון לפריקה‬"
                                },
                                {
                                    "name": "INACTIVE",
                                    "type": "text",
                                    "label": "‫לא פעיל‬"
                                },
                                {
                                    "name": "FROMSYNC",
                                    "type": "text",
                                    "label": "‫נתון תשתית‬"
                                },
                                {
                                    "name": "SCAN_ATTACHFN",
                                    "type": "text",
                                    "label": "‫שם קובץ לסריקה‬"
                                },
                                {
                                    "name": "ACCOUNT",
                                    "type": "number",
                                    "label": "‫חשבון (ID)‬"
                                }
                            ]
                        }
                    }
                ]
            ]
        },
        "zone": "eu2.make.com",
        "notes": []
    },
    "io": {
        "input_spec": [
            {
                "help": "",
                "name": "SUPNAME",
                "type": "text",
                "label": "",
                "default": "",
                "required": false,
                "multiline": false
            },
            {
                "help": "",
                "name": "IVNUM",
                "type": "text",
                "label": "",
                "default": "",
                "required": false,
                "multiline": false
            },
            {
                "help": "",
                "name": "BOOKNUM",
                "type": "text",
                "label": "",
                "default": "",
                "required": false,
                "multiline": false
            },
            {
                "help": "",
                "name": "SUPPLIER_ID",
                "type": "text",
                "label": "",
                "default": "",
                "required": false,
                "multiline": false
            },
            {
                "help": "",
                "name": "DOCNO",
                "type": "text",
                "label": "",
                "default": "",
                "required": false,
                "multiline": false
            },
            {
                "help": "",
                "name": "LIMIT",
                "type": "number",
                "label": "",
                "default": null,
                "required": false
            },
            {
                "help": "",
                "name": "branch",
                "type": "text",
                "label": "",
                "default": "main",
                "required": false,
                "multiline": false
            }
        ],
        "output_spec": [
            {
                "help": "",
                "name": "errors",
                "type": "text",
                "label": "",
                "default": "",
                "required": false,
                "multiline": false
            },
            {
                "help": "",
                "name": "SUPNAME",
                "type": "text",
                "label": "",
                "default": "",
                "required": false,
                "multiline": false
            },
            {
                "help": "",
                "name": "SUPPLIER_ID",
                "type": "text",
                "label": "",
                "default": "",
                "required": false,
                "multiline": false
            },
            {
                "help": "",
                "name": "HTTP_ANSWER",
                "spec": {
                    "type": "text",
                    "default": "",
                    "required": false,
                    "multiline": false
                },
                "type": "array",
                "label": "",
                "required": false
            },
            {
                "help": "",
                "name": "learned_config",
                "type": "dynamicCollection",
                "label": "",
                "default": "",
                "required": false
            },
            {
                "help": "",
                "name": "docs_list",
                "type": "text",
                "label": "",
                "default": "",
                "required": false,
                "multiline": false
            },
            {
                "help": "",
                "name": "import_files",
                "spec": {
                    "type": "text",
                    "default": "",
                    "required": false,
                    "multiline": true
                },
                "type": "array",
                "label": "",
                "required": false
            }
        ]
    }
}
